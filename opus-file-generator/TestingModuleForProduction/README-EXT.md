Okay, I've analyzed the provided JavaScript modules and CSS. Here's a rewritten `README.md` that aims to be accurate and comprehensive, with separate sections for User Instructions and Developer Reference.

---

# Audional Art Player

## Overview

The Audional Art Player is a web application designed to showcase "Audional Art" – an experience combining a static visual (image) with dynamically interactive audio. Users can engage with the audio through a control panel, extensive keyboard shortcuts, or even a MIDI controller. The application features real-time manipulation of audio parameters such as tempo, pitch, volume, playback direction, and a unique scheduling multiplier for rhythmic variations.

The core image and audio data are typically embedded directly within the HTML as Base64 strings, allowing for a self-contained presentation. If no image is provided, the application gracefully falls back to a simple audio play button. The user interface is dynamically constructed by JavaScript, offering a clean and responsive experience.

## Features

*   **Embedded & External Media:** Supports embedded Base64 image and audio (Opus preferred), as well as loading from URLs.
*   **Interactive Playback:**
    *   Click the main image or use a button to toggle audio looping.
    *   "Play Once" button for single playback.
    *   Toggle reverse audio playback.
*   **Rich Audio Controls:**
    *   **Volume:** Adjust master volume (0% to 150%).
    *   **Tempo (BPM):** Control playback speed, primarily affecting how often 'one-shot' samples are retriggered in a loop (1-400 BPM).
    *   **Pitch:** Adjust playback rate, altering perceived pitch (0.01x to 10.0x).
    *   **Multiplier:** Subdivide the beat for faster retriggering of 'one-shot' samples when looped (e.g., x2 for 8th notes if tempo implies quarter notes). Values from x1 to x32 (via specific key inputs).
*   **Keyboard Shortcuts:** Comprehensive shortcuts for nearly all audio controls and playback actions.
*   **MIDI Input:** Connect a MIDI controller to play the audio sample at different pitches, mapped from MIDI notes.
*   **Dynamic UI:** The user interface, including controls and metadata, is generated by JavaScript.
*   **Responsive Design:** Layout adapts to various screen sizes, from desktop to mobile.
*   **Info Panel:** A toggleable side panel displays a handy list of keyboard shortcuts.
*   **Visual Feedback:** The main image briefly animates (shakes) when audio is triggered.
*   **Error Display:** User-friendly error messages appear in the UI if issues arise.
*   **Fallback Player:** If no image data is available, a simple "Play Audio" button is displayed.

## User Instructions

### Prerequisites

*   A modern web browser with support for:
    *   Web Audio API
    *   ES6 Modules
    *   Web MIDI API (required for MIDI controller functionality)

### Running the Application

1.  **Obtain Files:** Ensure you have all the project files (`index.html` or `abbreviatedIndex.html`, `style.css`, and all `.js` files: `main.js`, `audioProcessor.js`, `uiUpdater.js`, `layout.js`, `keyboardShortcuts.js`, `midiHandler.js`, `utils.js`, `playButton.js`).
2.  **Serve Locally:** Due to browser security restrictions with ES6 modules (`file:///` URLs), you need to serve the files from a local web server.
    *   If Node.js is installed, open a terminal in the project directory and run: `npx http-server`
    *   Alternatively, use Python's built-in server: `python -m http.server` (or `python3 -m http.server`).
    *   VS Code users can use the "Live Server" extension.
3.  **Open in Browser:** Navigate to the local address provided by your server (e.g., `http://localhost:8080` or `http://localhost:8000`).

### Main Interface

The application is typically laid out with a central image area flanked by control and reference columns (on wider screens) or stacked vertically on smaller screens.

*   **Image Area (Center):**
    *   Displays the main visual.
    *   **Clicking the image** toggles the audio loop on or off.
    *   The image briefly animates when audio is triggered.

*   **Controls Panel (Left Column / Top on Mobile):**
    *   **Title Bar:** Displays "Audional Art".
        *   **ℹ️ (Info) Button:** Toggles the visibility of both the Controls Panel and the Reference Panel.
    *   **Audio Metadata:** Shows information about the embedded audio, such as Instrument, Note, and original Frequency.
    *   **Error Display:** Any operational errors will be shown here.
    *   **Playback Buttons:**
        *   `Play Once`: Plays the audio sample a single time.
        *   `Play Loop: On/Off`: Toggles continuous looping of the audio.
        *   `Reverse: On/Off`: Toggles reverse playback of the audio.
    *   **Control Sliders:**
        *   `Volume`: Adjusts the master volume.
        *   `Tempo`: Sets the Beats Per Minute. For samples that are retriggered by the scheduler (typically 'one-shot' samples), this controls the retrigger rate.
        *   `Pitch`: Modifies the playback rate of the audio, affecting its pitch.
        *   `Multiplier`: When looping 'one-shot' samples, this value (e.g., x1, x2, x4, x8) determines how many times the sample is triggered per beat defined by the tempo. For example, a x2 multiplier effectively plays 8th notes if the tempo is set for quarter notes.
    *   **MIDI Controls:**
        *   `MIDI In:`: A dropdown menu to select an available MIDI input device.
        *   `MIDI Status`: Displays the current status of the MIDI connection (e.g., "Connected: [Device Name]", "MIDI devices available.", "Unavailable").

*   **Reference Panel (Right Column / Bottom on Mobile):**
    *   Provides a quick reference for all available keyboard shortcuts.
    *   Can be hidden/shown using the "ℹ️" button in the Controls Panel.

### Keyboard Shortcuts

Shortcuts are active when an input field, textarea, or select dropdown is *not* focused.

*   **General Playback:**
    *   `Spacebar`: Play sample once.
    *   `R`: Toggle Reverse Playback.
    *   `I`: Toggle visibility of Controls and Reference panels.
*   **Volume & Mute:**
    *   `Arrow Up`: Increase Volume.
    *   `Arrow Down`: Decrease Volume.
    *   `M`: Toggle Mute/Unmute.
*   **Tempo (BPM):**
    *   `Shift` + `=` / `+`: Increase Tempo (+1 BPM).
    *   `Shift` + `-` / `_`: Decrease Tempo (-1 BPM).
    *   `Ctrl/Cmd` + `Shift` + `=` / `+`: Increase Tempo (+10 BPM).
    *   `Ctrl/Cmd` + `Shift` + `-` / `_`: Decrease Tempo (-10 BPM).
*   **Pitch / Playback Rate:**
    *   `Shift` + `]` / `}`: Increase Pitch slightly (linear step).
    *   `Shift` + `[` / `{`: Decrease Pitch slightly (linear step).
    *   `Ctrl/Cmd` + `Shift` + `]` / `}`: Increase Pitch by one semitone.
    *   `Ctrl/Cmd` + `Shift` + `[` / `{`: Decrease Pitch by one semitone.
    *   `=`: Double Current Pitch (x2 multiplier).
    *   `-`: Halve Current Pitch (x0.5 multiplier).
    *   `0`: Reset Pitch to original (1.0x).
*   **Schedule Multiplier:**
    *   `1`: Set Multiplier to x1.
    *   `2`: Set Multiplier to x2.
    *   `3`: Set Multiplier to x3.
    *   `4`: Set Multiplier to x4.
    *   `5`: Set Multiplier to x8.
    *   `6`: Set Multiplier to x16.
    *   `7`: Set Multiplier to x32.
    *   `8`: Set Multiplier to x8.

*(Note: `Ctrl` on Windows/Linux typically corresponds to `Cmd` on macOS for shortcuts involving `Ctrl/Cmd`.)*

### MIDI Usage

1.  **Connect Device:** Connect your MIDI controller to your computer.
2.  **Device Selection:**
    *   The application will attempt to auto-connect to the first available MIDI device.
    *   If you have multiple devices or auto-connect fails, select your desired MIDI input from the "MIDI In:" dropdown in the Controls Panel.
    *   The "MIDI Status" will update to reflect the connection.
3.  **Play Notes:** Playing notes on your MIDI controller will trigger the audio sample. The pitch of the sample will be adjusted to correspond to the MIDI note played, based on the original sample's defined frequency.

### Fallback "Play Button" Mode

If the Audional Art piece is configured without an image, the main interactive player interface will not be shown. Instead, a large "▶️ Play Audio" button will appear, along with any provided audio metadata. This button allows for simple play/pause functionality of the audio.

## Developer Reference

### Technology Stack

*   **HTML5:** Base structure.
*   **CSS3:** Styling, layout, animations (Flexbox, Grid, CSS Variables).
*   **JavaScript (ES6+ Modules):** Core application logic, DOM manipulation, event handling.
*   **Web Audio API:** All audio decoding, processing, playback, and scheduling.
*   **Web MIDI API:** MIDI input handling and device management.

### Project Structure

*   `index.html` (or similar, e.g., `abbreviatedIndex.html`): Main HTML file. Contains placeholders for dynamic content, embedded Base64 media, and script/style links.
*   `style.css`: All CSS rules for styling, responsiveness, and animations.
*   **JavaScript Modules (`.js` files):**
    *   `main.js`: Main application entry point. Orchestrates initialization of all modules, handles data loading (Base64/URL), sets up global event listeners, and manages overall application flow.
    *   `layout.js`: Dynamically builds the HTML structure of the application (controls column, image area, reference panel). Manages default values for UI controls.
    *   `audioProcessor.js`: Core audio engine. Handles decoding, playback (once, looped), reversing, volume, tempo, pitch, and the scheduling multiplier. Includes an internal `timingManager` for precise looping of 'one-shot' samples. Converts MIDI notes to playback rates.
    *   `uiUpdater.js`: Manages all updates to the UI, such as slider value displays, button states/text, error messages, and image source. Also contains the `triggerAnimation` function for the image shake effect.
    *   `keyboardShortcuts.js`: Manages all keyboard input for controlling application features, mapping key combinations to specific actions.
    *   `midiHandler.js`: Initializes and manages Web MIDI API access, device selection, and parsing of incoming MIDI messages.
    *   `utils.js`: Provides utility functions (e.g., `base64ToArrayBuffer`, `clamp`, `createElement`, `_isInputFocused`, `addListener`).
    *   `playButton.js`: A standalone script that provides a simple play/pause button interface if no primary image data (`imageBase64`) is defined for the full player experience.

### Core Logic Flows

*   **Initialization (`main.js` -> `bootstrap`):**
    1.  DOM Ready: `bootstrap()` is called.
    2.  `buildLayout()` (`layout.js`): Constructs the main HTML structure within the `#app` container.
    3.  `initializeApp()`:
        *   Locates essential DOM elements.
        *   `ui.init()`: `uiUpdater.js` caches its element references.
        *   **Data Loading:**
            *   Image: Checks global `audionalVisualBase64`, then `imageScript`, then `imageURL`.
            *   Audio: Checks global `audionalBase64_Opus`, then `audioScript`, then `audioURL` (which is fetched).
            *   If audio is missing, controls are disabled. If image is missing, `mainImage` might not be shown, or `playButton.js` takes over if `imageBase64` is explicitly empty/undefined.
        *   `audio.init()`: `audioProcessor.js` decodes audio, sets up `AudioContext`, prepares buffers (original and reversed), and initializes the `timingManager`.
        *   `midiHandler.init()`: Sets up MIDI.
        *   `keyboardShortcuts.init()`: Attaches keyboard listeners.
        *   `setupEventListeners()`: Attaches event listeners to UI elements (buttons, sliders).
        *   Initial UI state is set (slider values, button texts).
*   **User Clicks Image (Toggle Loop):**
    1.  `#main-image` click event triggers `handleLoopToggle()` in `main.js`.
    2.  `audio.resumeContext()` is called (browser requirement for user-initiated audio).
    3.  If not looping, `audio.startLoop()` is called; else `audio.stopLoop()`.
    4.  `ui.updateLoopButton()` updates the button's appearance.
*   **Audio Looping (`audioProcessor.js` -> `startLoop`):**
    *   **'one-shot' sample type:** `timingManager.startLoop()` is used with a callback that calls `_play()`. The `timingManager` then repeatedly calls this at intervals based on `currentTempo` and the `scheduleMultiplier`.
    *   **'loop' sample type:** `timingManager.startLoop()` is called with an empty callback (to keep its state managed), and `_play()` is called once with its `loop` parameter set to `true`, utilizing the native `AudioBufferSourceNode.loop` property.
*   **Keyboard Shortcut (e.g., Adjust Tempo):**
    1.  `keydown` event on `document`.
    2.  `keyboardShortcuts.js` -> `handleKey()`:
        *   Checks if an input is focused via `_isInputFocused()`.
        *   Identifies key and modifiers.
        *   Calls `adjustTempo(stepAmount)`.
    3.  `adjustTempo()`:
        *   Validates `tempoRef` slider.
        *   Clamps new tempo value.
        *   Calls `applyChange()` which then calls `audio.setTempo()` and `ui.updateTempoDisplay()`.

### Embedding Media & Data Sources

The application loads media primarily from global JavaScript variables defined in the main HTML file.

*   **Image Data:** Loaded in the following order of preference:
    1.  `window.audionalVisualBase64` (raw Base64 string)
    2.  `window.imageScript` (raw Base64 string, alternative variable name)
    3.  `window.imageURL` (URL string, fetched by setting `img.src`)
*   **Audio Data (Opus Preferred):** Loaded in the following order of preference:
    1.  `window.audionalBase64_Opus` (raw Base64 string for Opus audio)
    2.  `window.audioScript` (raw Base64 string, alternative variable name, assumed Opus or compatible)
    3.  `window.audioURL` (URL string, fetched via `fetch` API, content type determined from response or defaults to `audio/opus`)

**To Update Embedded Media:**
Modify the JavaScript constants/variables (e.g., `const imageBase64 = \`...\`;`, `const audioBase64_Opus = \`...\`;`) in your main HTML file. Provide only the raw Base64 data without the `data:[MIME_TYPE];base64,` prefix, as the application typically adds this.

**Audio Metadata (Required by `audioProcessor.js`):**
The `audioProcessor.js` module relies on specific HTML elements (expected to be within the initial HTML, typically in a `div.audio-metadata`) for configuration:
*   `<span id="audio-meta-frequency">...</span>`: **Crucial.** The original frequency (in Hz) of the audio sample. Used for accurate pitch calculations, especially for MIDI note mapping.
*   `<span id="audio-meta-sample-type">...</span>` or `<span id="audio-meta-loop">...</span>`: Defines the sample's looping behavior.
    *   If its `textContent.trim().toLowerCase()` is `loop` (for `sample-type`) or `yes` (for `loop` id), the sample is treated as a 'loop' type, using native Web Audio looping.
    *   Otherwise, or if missing, it defaults to 'one-shot', where looping is handled by the internal `timingManager` retriggering the sample.
*   Other metadata like `<span id="audio-meta-instrument">...</span>` and `<span id="audio-meta-note">...</span>` are for display purposes.
The `layout.js` module's `pruneMetadataForDisplay()` function may simplify some of this metadata after it's moved into the dynamic layout.

### Key Module Details

*   **`audioProcessor.js` - `timingManager`:** This internal component is essential for rhythmic playback of 'one-shot' samples. It schedules events with high precision based on the current tempo and the `scheduleMultiplier`. The multiplier effectively subdivides the main beat defined by the tempo.
*   **`layout.js` - Default Values:** Defines default, min, and max values for all sliders (Volume, Tempo, Pitch, Multiplier) which are used when creating the control groups.
*   **`keyboardShortcuts.js` - `MULT_MAP`:** This object maps numeric keys (1-8) to specific integer multiplier values for the `setMultiplier` action. Note that keys `5` and `8` both map to a multiplier of `8`, while `6` and `7` map to `16` and `32` respectively.
*   **`playButton.js` Activation:** This script activates if `window.audioBase64_Opus` is defined, but `window.imageBase64` is undefined or an empty string. It then takes over the `#app` container to display a simple play/pause interface.

### Styling (`style.css`)

*   Uses CSS Custom Properties (variables) for theming (e.g., `--control-bg`, `--button-bg`).
*   Employs CSS Grid for the main page layout (`.main-layout`).
*   Flexbox is used for arranging items within components (e.g., `.control-group`, `.title-bar`).
*   Includes styles for hidden states of side columns with opacity and visibility transitions.
*   Defines the `.shake-all-directions-animation` keyframes used for image feedback on audio playback.
*   Responsive design is handled via `@media` queries, adjusting layout for tablets and mobile devices.

### Potential Improvements / Future Work

*   **Build Process:** Implement a build system (e.g., Webpack, Rollup, Parcel) for bundling, minification, and potentially transpilation or managing dependencies.
*   **State Management:** For enhanced complexity, a dedicated state management library could be beneficial.
*   **User Media Upload:** Allow users to load their own image and audio files directly through the browser.
*   **Advanced Visualizations:** Integrate WebGL or Canvas API for dynamic audio-reactive visuals beyond the simple image shake.
*   **Testing Framework:** Introduce unit and integration tests (e.g., Jest, Playwright).
*   **Accessibility (A11y):** Conduct a thorough accessibility audit and implement ARIA attributes and focus management improvements.
*   **Theming:** Expand on CSS variables to allow for easier theming or user-selectable themes.
*   **Error Granularity:** Provide more specific error messages to the user.

## License



---