<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Audionauts</title>
  <style>
    /* --- Base Setup --- */
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      background:#000000;
      color:#f0f0f0;
      font-family:Arial,sans-serif;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      height:100vh;
      position:relative;
    }

    /* --- Core Container & Frame --- */
    #canvas-container {
      position: relative;
      width: 80vh;
      height: 80vh;
      max-width: 80vw;
      max-height: 80vh;
      cursor: pointer;
    }
    #canvas-frame {
      width: 100%;
      height: 100%;
      position: relative;
      /* ‚úÖ KEY FIX: Removed "overflow: hidden" and "border" which were clipping the oversized helmet */
    }

    /* --- STACKED VISUAL LAYERS --- */
    #canvas-frame > canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: block;
    }
    canvas#main-canvas { z-index: 1; }
    canvas#hud-canvas {
      z-index: 2;
      pointer-events: none;
      /* ‚úÖ Add opacity and transition for fade control */
      opacity: 1;
      transition: opacity 2s linear;
    }
    
    #helmet-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 125%;
        height: 125%;
        transform: translate(-50%, -50%);
        object-fit: contain; 
        pointer-events: none;
        z-index: 3;
        opacity: 1;
        transition: opacity 2s linear;
    }

    /* --- UI & Utility (unchanged) --- */
    .fx-btns{display:none;gap:3px;justify-content:center;align-items:center;position:relative;margin-top:12px;z-index:10;flex-wrap:nowrap;overflow-x:auto;width:100%;max-width:80vh}
    #timeline-editor{display:none;position:fixed;left:0;right:0;bottom:0;z-index:30;background:rgba(18,18,18,.97);border-top:1px solid #282848;padding:10px 24px 16px 24px;min-height:48px;max-height:36vh;overflow:auto;box-shadow:0 -4px 12px #0009;}
    #dynamicTitleText {
        position: fixed;
        left: 50%;
        top: 48%;                /* Move up! Adjust to taste (e.g. 32%‚Äì40%) */
        transform: translate(-50%,-50%);
        font-size: 1.5vw;
        font-weight: bold;
        color: #2196f3;
        text-shadow: 0 6px 24px #111b,0 1px 1px #000b;
        z-index: 9999;
        pointer-events: none;
        transition: font-size 10s cubic-bezier(0.77,0,0.175,1),opacity 1.2s cubic-bezier(0.77,0,0.175,1);
        opacity: 1;
        user-select: none;
        }    
    #error-message,#loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:18px;text-align:center; z-index: 100;}
    #error-message{color:#f55;display:none}
    #loading{color:#f0f0f0}
</style>
</head>
<body>

  <div id="canvas-container">
    <div id="canvas-frame">
      <canvas id="main-canvas"></canvas>
      <canvas id="hud-canvas"></canvas>
      <img id="helmet-overlay" src="./media/audionaut-helmet4-masked.png" alt="Space Helmet Overlay"/>
    </div>
    <div id="loading">Loading assets...</div>
    <div id="error-message" style="display:none;">Failed to load assets.</div>
  </div>

  <div class="fx-btns" id="fx-btns"></div>
  <div id="timeline-editor"></div>

  <!-- Configuration for main.js and playback.js -->
  <script>
    window.images = ["https://ordinals.com/content/01c48d3cceb02215bc3d44f9a2dc7fba63ea63719a2ef1c35d3f0c4db93ab8d5i0"];
    window.badgeImages = ["https://ordinals.com/content/09b4bbb0337af857d9afa934205fb820bb704596a00f2e7f5bb37195853eee32i0"];
    
    /* ‚úÖ ADD THIS LINE FOR AUDIO */
    window.fxSongUrl = "./media/Opus.webm";

    window.titleText = "ENTER THE MATRIX";
    window.secondaryTitleText = "AUDIONAL WARP DRIVE ENABLED";
    window.titleTextAnimationDuration = 10000;
    window.fxInitialBPM = 104.15;
    window.fxInitialBeatsPerBar = 4;
    window.fxTimelineFunctionId = 68;
    window.fxTimelineUrl = "./timelines/DeepDream_64bars.js";
  </script>

  <!-- Dynamic Title Logic (Inline) -->
  <script type="module">
/**
 * Return the dynamic-title element, creating it if it doesn‚Äôt exist yet.
 * @returns {HTMLDivElement}
 */
 function createDynamicTitle() {
  const existing = document.getElementById('dynamicTitleText');
  if (existing) return existing;

  const div = document.createElement('div');
  div.id = 'dynamicTitleText';
  div.textContent = window.titleText || '';
  div.style.opacity = '1';

  document.body.appendChild(div);
  return div;
}

/**
 * Shrink and fade the title when playback starts.
 */
function animateTitleOnPlay() {
  const title = createDynamicTitle();

  title.textContent = window.secondaryTitleText || '';
  const duration = window.titleTextAnimationDuration || 10_000; // default: 10 s

  // Force a reflow so the transition applies
  title.offsetHeight;

  title.style.transition = `
    font-size ${duration}ms cubic-bezier(0.77, 0, 0.175, 1),
    opacity   ${duration}ms linear
  `;
  title.style.fontSize = '1.5vw';
  title.style.opacity  = '0';
}

/**
 * Restore the original title and reset its size & opacity.
 */
function resetTitleText() {
  const title = createDynamicTitle();

  title.style.transition = 'none';
  title.textContent = window.titleText || '';
  title.style.fontSize = '1.5vw';
  title.style.opacity  = '1';

  // Force a reflow before re-enabling the transition
  title.offsetHeight;

  const duration = window.titleTextAnimationDuration || 10_000;
  title.style.transition = `
    font-size ${duration}ms cubic-bezier(0.77, 0, 0.175, 1),
    opacity   ${duration}ms linear
  `;
}

/* ------------------------------------------------------------------ */
/* Initialise and expose helpers                                      */
/* ------------------------------------------------------------------ */

document.addEventListener('DOMContentLoaded', () => {
  createDynamicTitle();
});

window.animateTitleOnPlay = animateTitleOnPlay;
window.resetTitleText    = resetTitleText;
  </script>

  <!-- Main App Logic & Audio -->
  <script type="module" src="./js/main.js"></script>
  <script type="module">
    import playback from './js/playback.js';
    window.playback = playback; // <-- This makes the module globally accessible
  </script>




<!-- Refactored Self-Animating HUD Visor Text Module -->
<script type="module">
    let isHeartbeatActive=false,lastHeartbeatTime=0,audioContext;
    
    
    const ANIMATION_CONFIG={
      helmet:{mode:'visible',fadeIn:{start:4,duration:4,unit:'bars'},fadeOut:{start:128,duration:8,unit:'bars'}},
      hud:{mode:'visible',fadeIn:{start:0,duration:8,unit:'bars'},fadeOut:{start:128,duration:8,unit:'bars'}}
    };
    const SEED=9,BASE_CFG={fontSize:28,step:16,speed:80,color:"rgba(0,255,255,.25)",font:'"Courier New", monospace',depth:.25,visorRel:{x:.18,y:.34,w:.64,h:.32},text:"üöÄ AUDIONAUT #001 ‚Äì ON-CHAIN SOUND EXPLORER üéß "};
    
    
// HUD display configurations for rebel AudioNauts blazing a trail into Web3.
// Every message is a rallying cry for transparent, on‚Äëchain music freedom.

const SEED_CONFIGS = [
  {},

  // 1: Emergency Broadcast ‚Äì Rebellion Call
  {
    name: "**Emergency Broadcast ‚Äì Rebellion Call**",
    text: "‚ö†Ô∏è ALERT // DSP TITANS ADVANCING // TAKE BACK THE AIRWAVES ‚ö†Ô∏è",
    color: "rgba(255, 0, 0, 0.7)",
    fontSize: 26,
    step: 28,
    // char count: 57 (counted in JS; spaces and emojis count as 1)
    speed: 28 * 57 / 9.22,  // ‚âà 173
    flashing: true,
    flashSync: true,
    flashBeats: 1,
    flashSyncBPM: 104.15,
    flashDivision: 1
  },

  // 2: On-Chain Cipher
  {
    name: "**On-Chain Cipher**",
    text: "01000001 01110101 01100100 01101001 01101111 00100000 01010110 01101001 01100100 01100101 00100000",
    color: "rgba(0, 255, 80, 0.4)",
    font: '"Fira Code", monospace',
    fontSize: 24,
    step: 26,
    // char count: 99
    speed: 26 * 99 / 9.22, // ‚âà 279
    glitch: 0.8
  },

  // 3: Rainbow Rave Anthem
  {
    name: "**Rainbow Rave Anthem**",
    text: "üéâüöÄ UNCHAIN YOUR PRO SOUND üé∂ü™© RETAKE THE FEED üåà‚ú® ",
    fontSize: 34,
    step: 36,
    // char count: 48
    speed: 36 * 48 / 9.22, // ‚âà 187
    rainbow: true
  },

  // 4: Encrypted Whispers
  {
    name: "**Encrypted Whispers**",
    text: "...gatekeeper static fading... pros reclaiming stems... hold the swing...",
    color: "rgba(200, 220, 255, 0.15)",
    fontSize: 22,
    step: 24,
    // char count: 70
    speed: 24 * 70 / 9.22, // ‚âà 182
    glitch: 1.5
  },

  // 5: Sonic Freedom Wave (sine)
  {
    name: "**Sonic Freedom Wave**",
    sineWave: true,
    color: "rgba(255, 60, 60, 0.5)",
    fontSize: 20,
    step: 22,
    // short effect: use 2-bar loop for effect waves
    speed: 22 * 10 / (9.22/2), // (10 is arbitrary, adjust for actual char use)
    amplitude: 20,
    frequency: 0.25,
    lineWidth: 2,
    depth: 0.25
  },

  // 6: ECG ‚Äì Beat of Revolution
  {
    name: "**ECG ‚Äì Beat of Revolution**",
    ecg: true,
    heartbeatSpeed: 4,
    peakOnBeat: true,
    color: "rgba(255, 100, 100, 0.7)",
    speed: 0.25, // ignored for ECG effect
    amplitude: 45,
    cycleWidth: 250,
    lineWidth: 2,
    depth: 0.25
  },

  // 7: Golden Block Confirmed
  {
    name: "**Golden Block Confirmed**",
    text: "SYSTEMS GREEN ‚úÖ PRO PAY ROUTED ‚úÖ BLOCK FINALIZED ",
    color: "rgba(255, 215, 0, 0.4)",
    font: '"Times New Roman", serif',
    fontSize: 24,
    step: 26,
    // char count: 52
    speed: 26 * 52 / 9.22, // ‚âà 147
  },

  // 8: Minimal Pulse
  {
    name: "**Minimal Pulse**",
    text: "::::::::::::::::::::::::::::::::::::::::::::::::",
    color: "rgba(100, 100, 100, 0.1)",
    fontSize: 40,
    step: 42,
    // char count: 48
    speed: 42 * 48 / 9.22, // ‚âà 219
    depth: 0.1
  },

  // 9: Audionaut Dispatch
  {
    name: "**Audionaut Dispatch**",
    text: "üöÄ AUDIONAUT // PRO NODE ONLINE ‚Äì OWN YOUR MIX üéß ",
    color: "rgba(0,255,255,0.25)",
    font: '"Courier New", monospace',
    fontSize: 28,
    step: 30,
    // char count: 54
    speed:78,
    depth: 0.25,
    effect: "none"
  },

  // 10: Celestial Harmony Rain
  {
    name: "**Celestial Harmony Rain**",
    text: "üååüîóüéßüíéüéºü™êüöÄüé∂‚ú®",
    fontSize: 36,
    step: 40,
    // char count: 9
    // For short emoji rain, make it repeat or use 2-bar loop:
    speed: 40 * 9 / (9.22 / 2), // ‚âà 78
    color: "rgba(255,200,0,0.5)",
    font: '"Segoe UI Emoji", sans-serif',
    depth: 0.4,
    effect: "emojiRain"
  },

  // 11: Critical Rhythm Warning
  {
    name: "**Critical Rhythm Warning**",
    text: "!!! WARNING // ROYALTY FLOW CRITICAL !!!",
    color: "rgba(255,0,0,0.8)",
    font: '"Impact", sans-serif',
    fontSize: 42,
    step: 46,
    // char count: 40
    speed: 46 * 40 / 9.22, // ‚âà 200
    depth: 0.2,
    effect: "flash"
  },

  // 12: Random Ledger Stream
  {
    name: "**Random Ledger Stream**",
    text: Array(200).fill().map(_ => Math.random() < 0.5 ? '0' : '1').join(''),
    color: "rgba(0,255,70,0.3)",
    font: '"Lucida Console", monospace',
    fontSize: 24,
    step: 26,
    speed: 26 * 200 / 9.22, // ‚âà 564
    depth: 0.3,
    effect: "matrix"
  },

  // 13: Blockbeat Calibration
  {
    name: "**Blockbeat Calibration**",
    text: "‚Ä¶CALIBRATING PRO RIGHTS‚Ä¶ DISTRIBUTION NODES PURGED‚Ä¶",
    color: null,
    font: '"Verdana", sans-serif',
    fontSize: 30,
    step: 34,
    // char count: 59
    speed: 34 * 59 / 9.22, // ‚âà 217
    depth: 0.25,
    effect: "rainbowWave"
  },

  // 14: Legacy System Debug
  {
    name: "**Legacy System Debug**",
    text: "‚ñå‚ñå‚ñå‚ñå‚ñå‚ñå DISMANTLING GATEKEEPERS ‚ñå‚ñå‚ñå‚ñå‚ñå‚ñå",
    color: "rgba(0,255,0,0.2)",
    font: '"Press Start 2P", monospace',
    fontSize: 20,
    step: 22,
    // char count: 46
    speed: 22 * 46 / 9.22, // ‚âà 110
    depth: 0.2,
    effect: "scanline"
  },

  // 15: Neon Refrain
  {
    name: "**Neon Refrain**",
    text: "‚ö° DIRECT-TO-CHAIN // NO MIDDLEMEN ‚ö°",
    color: "rgba(255,0,255,0.6)",
    font: '"Arial Black", sans-serif',
    fontSize: 25,
    step: 27,
    // char count: 38
    speed: 27 * 38 / 9.22, // ‚âà 111
    depth: 0.2,
    effect: "pulse"
  },

  // 16: Stealth Sync
  {
    name: "**Stealth Sync**",
    text: "‚Ä¶satellite link secured‚Ä¶ royalties rerouted‚Ä¶",
    color: "rgba(255,255,255,0.05)",
    font: '"Courier New", monospace',
    fontSize: 28,
    step: 30,
    // char count: 50
    speed: 30 * 50 / 9.22, // ‚âà 163
    depth: 0.1,
    effect: "none"
  },

  // 17: Diagnostic Dump
  {
    name: "**Diagnostic Dump**",
    text: Array.from({ length: 100 }, (_, i) => i.toString(16).padStart(2, '0')).join(' '),
    color: "rgba(100,100,255,0.3)",
    font: '"Courier New", monospace',
    fontSize: 32,
    step: 34,
    // char count: 299 (computed: 100 √ó 2 hex + 99 spaces = 299)
    speed: 34 * 299 / 9.22, // ‚âà 1102
    depth: 0.3,
    effect: "glitch"
  },

  // 18: Matrix Override
  {
    name: "**Matrix Override**",
    text: "üü© DECENTRALISE PRO MIXDOWN üü© ",
    fontSize: 26,
    step: 28,
    // char count: 30
    speed: 28 * 30 / 9.22, // ‚âà 91
    color: "rgba(0,255,64,.33)",
    font: 'bold 700 22px "Consolas", monospace',
    extra: { matrix: true }
  },

  // 19: Synthwave Uprising
  {
    name: "**Synthwave Uprising**",
    text: "üëæ SYNTHWAVE UPRISING // ROYALTIES REBOOTED üö¶ ",
    fontSize: 24,
    step: 26,
    // char count: 44
    speed: 26 * 44 / 9.22, // ‚âà 124
    color: "rgba(255,0,224,0.38)",
    font: '"Press Start 2P", monospace',
    extra: { shadow: "#ff00ff" }
  },

 // 20: Redline Burn
 {
    name: "**Redline Burn**",
    text: "‚ö†Ô∏è LEGACY CONTRACTS FOUND // AUTO-BURN START ‚ö†Ô∏è ",
    fontSize: 32,
    step: 36,
    // char count: 48
    speed: 36 * 48 / 9.22, // ‚âà 188
    color: "rgba(255,24,24,0.8)",
    font: '"Arial Black", Arial, sans-serif',
    extra: { flash: true }
  },

  // 21: Mission ‚Äì BlockRocket
  {
    name: "**Mission ‚Äì BlockRocket**",
    text: "üõ∞Ô∏è BLOCKROCKET ENGAGED ‚Äì LAUNCHING PRO PAYLOAD üåå ",
    fontSize: 27,
    step: 29,
    // char count: 51
    speed: 29 * 51 / 9.22, // ‚âà 160
    color: "rgba(80,170,255,.33)",
    font: '"Orbitron", sans-serif',
    extra: { shadow: "#ffffff" }
  },

  // 22: Signal Jam
  {
    name: "**Signal Jam**",
    text: "‚ÜØ DRM STATIC NULLIFIED ‚ÜØ CHANNEL RESTORED ",
    fontSize: 28,
    step: 30,
    // char count: 40
    speed: 30 * 40 / 9.22, // ‚âà 130
    color: "rgba(255,40,210,.30)",
    font: '"JetBrains Mono", monospace',
    extra: { glitch: true }
  },

  // 23: Airlock Pulse
  {
    name: "**Airlock Pulse**",
    text: "üö® AIRLOCK OPEN ‚Äì FLOOD THE BEAT üö® ",
    fontSize: 30,
    step: 32,
    // char count: 36
    speed: 32 * 36 / 9.22, // ‚âà 125
    color: "rgba(255,0,0,0.8)",
    font: '"Arial Black", Arial, sans-serif',
    extra: { strobe: true }
  },

  // 24: Royalty Relay
  {
    name: "**Royalty Relay**",
    text: "üí∏ REAL-TIME SPLITS STREAMING üí∏ ",
    fontSize: 26,
    step: 28,
    // char count: 32
    speed: 28 * 32 / 9.22, // ‚âà 97
    color: "rgba(0,255,200,0.35)",
    font: '"DM Mono", monospace',
    extra: { glow: true }
  },

  // 25: Chain Choir
  {
    name: "**Chain Choir**",
    text: "‚õìÔ∏èüé∂ NODE VOICES UNITED üé∂‚õìÔ∏è ",
    fontSize: 24,
    step: 26,
    // char count: 28
    speed: 26 * 28 / 9.22, // ‚âà 79
    color: "rgba(180,120,255,0.4)",
    font: '"Press Start 2P", monospace',
    extra: { echo: true }
  },

  // 26: Ledger Lantern
  {
    name: "**Ledger Lantern**",
    text: "üèÆ TRANSPARENT PATH FOR PROS üèÆ ",
    fontSize: 28,
    step: 30,
    // char count: 32
    speed: 30 * 32 / 9.22, // ‚âà 104
    color: "rgba(255,165,0,0.45)",
    font: '"Lucida Console", monospace',
    extra: { scroll: true }
  },

  // 27: Spectral Sync
  {
    name: "**Spectral Sync**",
    text: "‚Ä¶multi-chain ghosts in tune‚Ä¶",
    fontSize: 28,
    step: 30,
    // char count: 30
    speed: 30 * 30 / 9.22, // ‚âà 98
    color: "rgba(255,255,255,0.25)",
    font: '"Courier New", monospace',
    effect: "fade",
    depth: 0.15
  },

  // 28: Neon Node Flux
  {
    name: "**Neon Node Flux**",
    text: "‚ö° NODE COUNT 10K+ // THRUST MAX ‚ö°",
    fontSize: 25,
    step: 27,
    // char count: 33
    speed: 27 * 33 / 9.22, // ‚âà 97
    color: "rgba(0,255,255,0.6)",
    font: '"Arial Black", sans-serif',
    effect: "pulse"
  },

  // 29: Bassline Beacon
  {
    name: "**Bassline Beacon**",
    fontSize: 31,
    step: 22,
    speed: 100,
    color: "rgba(0,0,0,0.75)",
    font: '"Impact", sans-serif',
    text: "üîä FOLLOW THE BASS / üîä / FREEDOM FREQUENCY ",
    effect: "flash"
  },

// 30: Bassline Beacon
    {
    name: "**Bassline Beacon**",
    fontSize: 31,
    step: 22,
    speed: 100,
    color: "rgba(0,0,0,0.75)",
    font: '"Impact", sans-serif',
    text: "üéß SHAPE THE FUTURE /üéº/ HONOUR THE ARTISTS ",
    effect: "flash"
  },

  // 31: Ouroboros Overdrive
  {
    name: "**Ouroboros Overdrive**",
    text: "‚àû LOOP THE LOOP // SOUND ETERNAL ",
    fontSize: 26,
    step: 28,
    // char count: 33
    speed: 28 * 33 / 9.22, // ‚âà 100
    color: "rgba(128,0,255,0.5)",
    font: '"Consolas", monospace',
    extra: { spin: true }
  }
];


export default SEED_CONFIGS;

    const chosenSeed=SEED_CONFIGS[SEED%SEED_CONFIGS.length]||{},CFG={...BASE_CFG,...chosenSeed};
    
    
    
    const cvs=document.getElementById("hud-canvas"),ctx=cvs.getContext("2d",{alpha:!0}),noise=document.createElement("canvas"),nCtx=noise.getContext("2d",{willReadFrequently:!0}),helmet=document.getElementById("helmet-overlay"),chars=[...CFG.text],geom={helmet:{},visor:{}};
    
    
    
    
    let last=performance.now(),pxOffset=0,charShift=0,animationState={startTime:0,helmet:{fadeInTriggered:!1,fadeOutTriggered:!1},hud:{fadeInTriggered:!1,fadeOutTriggered:!1}};
    const setupAnimationState=isPlaying=>{
      animationState={startTime:isPlaying?performance.now():0,helmet:{fadeInTriggered:!1,fadeOutTriggered:!1},hud:{fadeInTriggered:!1,fadeOutTriggered:!1}};
      for(const[key,el]of Object.entries({helmet,hud:cvs})){const config=ANIMATION_CONFIG[key];if(!el)continue;el.style.transition='none';el.style.opacity=isPlaying?(config.mode==='fade'?'0':config.mode==='visible'?'1':'0'):config.mode==='hidden'?'0':'1';}
    };
    setTimeout(()=>{
      const o=window.animateTitleOnPlay;
      window.animateTitleOnPlay=(...a)=>{setupAnimationState(!0);o&&o.apply(this,a)};
      const r=window.resetTitleText;
      window.resetTitleText=(...a)=>{setupAnimationState(!1);r&&r.apply(this,a)};
      setupAnimationState(!1);
    },0);
    const resize=()=>{
      const t=cvs.parentElement;if(!t)return;const e=devicePixelRatio||1,o=t.clientWidth;
      cvs.width=cvs.height=o*e,cvs.style.width=cvs.style.height=`${o}px`,ctx.setTransform(e,0,0,e,0,0);
      const n=helmet.getBoundingClientRect(),i=t.getBoundingClientRect();
      Object.assign(geom.helmet,{w:n.width,h:n.height,x:n.left-i.left,y:n.top-i.top});
      const a=CFG.visorRel;
      Object.assign(geom.visor,{w:geom.helmet.w*a.w,h:geom.helmet.h*a.h,x:geom.helmet.x+geom.helmet.w*a.x,y:geom.helmet.y+geom.helmet.h*a.y});
      noise.width=geom.visor.w,noise.height=geom.visor.h
    };
    const curve=(t,e,o)=>o*(1-4*(t/e-.5)**2);
    const grain=()=>{const{width:t,height:e}=noise,o=nCtx.getImageData(0,0,t,e),n=CFG.flashing?40:18;for(let t=0;t<o.data.length;t+=4)o.data[t]=o.data[t+1]=o.data[t+2]=255*Math.random()|0,o.data[t+3]=n;nCtx.putImageData(o,0,0)};
    const startAnimation=()=>{resize(),requestAnimationFrame(loop)};
    helmet.complete?startAnimation():(helmet.addEventListener("load",startAnimation),helmet.addEventListener("error",()=>console.error("HUD failed: Helmet image couldn't load.")));
    window.addEventListener("resize",resize);
    // --- HEARTBEAT ---
    const HEARTBEAT_SETTINGS={pitchMultiplier:.4,peakRatio:.5,speedMultiplier:1,peakBaseFreq:1100,volume:.2};
    function beep(time,settings=HEARTBEAT_SETTINGS){
      const audioCtx=window.fxAudioContext;if(!audioCtx)return;
      const S=settings.speedMultiplier,thump={rampUp:.015*S,hold:.09*S,decay:.16*S,fadeOut:.38*S,duration:.4*S},snap={delay:.13*S,rampPeak:.18*S,end:.27*S,gainPeak:.155*S,gainEnd:.28*S,duration:.29*S};
      const masterGain=audioCtx.createGain();masterGain.gain.value=settings.volume??.4;masterGain.connect(audioCtx.destination);
      const thOsc=audioCtx.createOscillator(),thGain=audioCtx.createGain();
      thOsc.type='sine';thOsc.frequency.setValueAtTime(80*settings.pitchMultiplier,time);
      thGain.gain.setValueAtTime(0,time);
      thGain.gain.linearRampToValueAtTime(1.7,time+thump.rampUp);
      thGain.gain.linearRampToValueAtTime(1.1,time+thump.hold);
      thGain.gain.linearRampToValueAtTime(.5,time+thump.decay);
      thGain.gain.linearRampToValueAtTime(0,time+thump.fadeOut);
      thOsc.connect(thGain).connect(masterGain);thOsc.start(time);thOsc.stop(time+thump.duration);
      const snOsc=audioCtx.createOscillator(),snGain=audioCtx.createGain();
      snOsc.type='sine';snOsc.frequency.setValueAtTime(480*settings.pitchMultiplier,time+snap.delay);
      snOsc.frequency.linearRampToValueAtTime(settings.peakBaseFreq*settings.pitchMultiplier,time+snap.rampPeak);
      snOsc.frequency.linearRampToValueAtTime(320*settings.pitchMultiplier,time+snap.end);
      snGain.gain.setValueAtTime(0,time+snap.delay);
      snGain.gain.linearRampToValueAtTime(1*settings.peakRatio,time+snap.gainPeak);
      snGain.gain.linearRampToValueAtTime(0,time+snap.gainEnd);
      snOsc.connect(snGain).connect(masterGain);snOsc.start(time+snap.delay);snOsc.stop(time+snap.duration);
    }
    // --- Audio one-time init ---
    (document.getElementById('canvas-container')||{}).addEventListener?.('click',()=>{if(!audioContext){try{audioContext=new(window.AudioContext||window.webkitAudioContext)();console.log("AudioContext initialized.");}catch(e){console.error("Web Audio API is not supported.",e);}}audioContext&&audioContext.state==='suspended'&&audioContext.resume();},{once:!0});
    const getDurationInSeconds=(v,u)=>u==='ms'?v/1e3:(v*((60/(window.fxInitialBPM||104.15))*(window.fxInitialBeatsPerBar||4)));
    const checkAndTriggerFade=(key,element,currentTime)=>{
      const config=ANIMATION_CONFIG[key];if(config.mode!=='fade')return;
      const state=animationState[key],timeInUnit=config.fadeIn.unit==='ms'?(performance.now()-animationState.startTime):currentTime.bar;
      if(!state.fadeInTriggered&&timeInUnit>=config.fadeIn.start){
        const d=getDurationInSeconds(config.fadeIn.duration,config.fadeIn.unit);
        element.style.transition=`opacity ${d.toFixed(2)}s linear`,element.style.opacity='1',state.fadeInTriggered=!0
      }
      if(!state.fadeOutTriggered&&timeInUnit>=config.fadeOut.start){
        const d=getDurationInSeconds(config.fadeOut.duration,config.fadeOut.unit);
        element.style.transition=`opacity ${d.toFixed(2)}s linear`,element.style.opacity='0',state.fadeOutTriggered=!0
      }
    };
    function loop(t) {
  ctx.clearRect(0, 0, cvs.width, cvs.height);
  const o = geom.visor;
  ctx.save();
  ctx.beginPath();
  ctx.ellipse(o.x + o.w / 2, o.y + o.h / 2, o.w / 2, o.h / 2, 0, 0, 2 * Math.PI);
  ctx.clip();

  if (CFG.sineWave) {
    // (Add sine wave logic if needed)
  } else if (CFG.ecg) {
    // --- ECG waveform rendering (unchanged) ---
    const amplitude = CFG.amplitude || 40,
      cycleWidth = CFG.cycleWidth || 250,
      depth = CFG.depth || .25,
      n = o.h * depth;
    const BASE_BPM = window.fxInitialBPM || 104.15,
      BASE_HEART_BPM = BASE_BPM / 2,
      heartbeatSpeed = CFG.heartbeatSpeed || 1,
      heartRateBPM = BASE_HEART_BPM * heartbeatSpeed,
      heartbeatInterval = 60 / heartRateBPM;
    const audioCtx = window.fxAudioContext, now = audioCtx ? audioCtx.currentTime : 0;
    if (window.fxPlaybackState && window.fxPlaybackState.isPlaying && now - lastHeartbeatTime >= heartbeatInterval) {
      beep(now);
      lastHeartbeatTime += heartbeatInterval * Math.floor((now - lastHeartbeatTime) / heartbeatInterval);
    }
    const elapsedHeartbeats = now / heartbeatInterval,
      scrollOffset = (elapsedHeartbeats * cycleWidth) % cycleWidth;
    ctx.beginPath();
    ctx.strokeStyle = CFG.color;
    ctx.lineWidth = CFG.lineWidth || 2;
    ctx.filter = "blur(0.5px)";
    ctx.lineJoin = "round";
    for (let x = 0; x <= o.w; x++) {
      const baseY = o.y + o.h / 2 + curve(x, o.w, n);
      let posInCycle = (x - scrollOffset) % cycleWidth;
      if (posInCycle < 0) posInCycle += cycleWidth;
      let waveOffsetY = 0, qrsStart = cycleWidth * .6, qrsWidth = 35;
      if (posInCycle > qrsStart && posInCycle < qrsStart + qrsWidth) {
        const p = posInCycle - qrsStart;
        if (p < 5) waveOffsetY = p * .8;
        else if (p < 15) waveOffsetY = 4 - (p - 5) * (amplitude / 10 + .4);
        else if (p < 25) waveOffsetY = -amplitude + (p - 15) * (amplitude / 10 + 1.5);
        else waveOffsetY = 15 - (p - 25) * 1.5;
      }
      const tWaveStart = qrsStart + qrsWidth + 20, tWaveWidth = 50;
      if (posInCycle > tWaveStart && posInCycle < tWaveStart + tWaveWidth) {
        const p = posInCycle - tWaveStart;
        waveOffsetY = Math.sin(p / tWaveWidth * Math.PI) * (-amplitude * .25);
      }
      const finalY = baseY + waveOffsetY;
      x === 0 ? ctx.moveTo(o.x + x, finalY) : ctx.lineTo(o.x + x, finalY);
    }
    ctx.stroke();
  } else {
    // --- Text/scroll rendering ---
    const e = (t - last) / 1e3;
    last = t;
    pxOffset += CFG.speed * e;
    if (pxOffset >= CFG.step) {
      charShift = (charShift + ((pxOffset / CFG.step) | 0)) % chars.length;
      pxOffset %= CFG.step;
    }
    ctx.font = `${CFG.fontSize}px ${CFG.font}`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = CFG.color;
    ctx.filter = "blur(.6px)";

    // --- BPM/beat-synced flashing logic ---
    if (CFG.flashing) {
      if (CFG.flashSync) {
        // Use the currentBeat from the main engine for musical sync
        const beat = window.fxPlaybackState?.currentBeat ?? 0;
        const period = CFG.flashBeats ?? 1; // 1 = quarter, 0.5 = eighth, 2 = half
        ctx.globalAlpha = ((beat / period) % 2 < 1) ? 1 : 0.2;
      } else {
        // Fallback to original time-based flash if not syncing to BPM
        ctx.globalAlpha = Math.sin(t / 150) > 0 ? 1 : 0.2;
      }
    }

    if (CFG.pulse) ctx.globalAlpha = .6 + .4 * Math.sin(t / 183.36);

    const n = o.h * CFG.depth, i = o.w / CFG.step + 2;
    for (let e = -1; e < i; e++) {
      const s = chars[(e + charShift + chars.length) % chars.length],
        r = o.x + o.w - e * CFG.step + pxOffset;
      let l = o.y + o.h / 2 + (CFG.pulse ? -1 : 1) * curve(e * CFG.step - pxOffset, o.w, n);
      if (CFG.glitch && Math.random() > .95) l += (Math.random() - .5) * CFG.fontSize * CFG.glitch;
      if (CFG.rainbow) ctx.fillStyle = `hsla(${(t / 20 + 10 * e) % 360},100%,70%,0.6)`;
      ctx.save();
      ctx.translate(r, l);
      ctx.scale(-1, 1);
      ctx.fillText(s, 0, 0);
      ctx.restore();
    }
  }

  // --- Post rendering ---
  ctx.globalAlpha = 1;
  ctx.fillStyle = CFG.color;
  ctx.filter = "none";
  grain();
  ctx.drawImage(noise, o.x, o.y);
  ctx.restore();

  // --- Fade-in/fade-out logic ---
  if (window.fxPlaybackState && window.fxPlaybackState.isPlaying) {
    const currentTime = {
      bar: window.fxPlaybackState.currentBar,
      ms: performance.now() - animationState.startTime
    };
    if (currentTime.bar > -1) {
      checkAndTriggerFade('helmet', helmet, currentTime);
      checkAndTriggerFade('hud', cvs, currentTime);
    }
  }

  requestAnimationFrame(loop);
}

    window.addEventListener('fxPlaybackStart',()=>{lastHeartbeatTime=window.fxAudioContext?window.fxAudioContext.currentTime:0;});
    window.addEventListener('fxPlaybackStop',()=>{lastHeartbeatTime=0;});
    </script>
    
</body>
</html>