<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Pixel Art Helmet Creator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .main-container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    .tools-panel {
      padding: 10px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-height: 90vh; /* Prevent overflow */
      overflow-y: auto;  /* Add scrollbar if needed */
    }
    .tools-panel fieldset {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      margin: 0;
    }
    .tools-panel legend {
      font-weight: bold;
      padding: 0 5px;
    }
    .tool-button, .color-button, .action-button, .style-button {
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 5px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
      cursor: pointer;
      border-radius: 4px;
      text-align: left;
    }
    .tool-button:hover, .color-button:hover, .action-button:hover, .style-button:hover {
        background-color: #e9e9e9; /* Add hover effect */
    }
    .tool-button.active, .color-button.active {
      background-color: #007BFF;
      color: white;
      border-color: #0056b3;
    }
    #color-picker-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    #color-picker {
        height: 35px;
        width: 50px;
        padding: 2px;
    }
    .layer-visibility label {
        display: block;
        margin-bottom: 5px;
    }
    #grid-container {
      display: flex;
      flex-wrap: wrap;
      width: 640px;
      height: 640px;
      background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      border: 2px solid #999;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .cell {
      width: 10px;
      height: 10px;
      box-sizing: border-box;
    }
    .io-section {
        width: 100%;
        max-width: 900px; /* Adjust as needed */
        margin-top: 20px;
        padding: 10px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #template-io {
      display: block;
      width: calc(100% - 10px);
      height: 80px;
      font-family: monospace;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Advanced Pixel Art Helmet Creator</h1>
  <div class="main-container">
    <div class="tools-panel">
      <fieldset>
        <legend>Paint Tools</legend>
        <div id="color-picker-wrapper">
            <input type="color" id="color-picker" value="#FF0000">
            <button class="tool-button" id="paint-tool">Paint Color</button>
        </div>
        <button class="color-button" data-color="#000000">Paint Black</button>
        <button class="color-button" data-color="#FFFFFF">Paint White</button>
        <button class="color-button" data-color="transparent">Eraser (Transparent)</button>
      </fieldset>
      <fieldset>
        <legend>Layer Assignment</legend>
        <button class="tool-button" data-layer="1">Set to Helmet</button>
        <button class="tool-button" data-layer="2">Set to A-Logo</button>
        <button class="tool-button" data-layer="3">Set to A-Shadow</button>
        <button class="tool-button" data-layer="4">Set to B.A.M.</button>
        <button class="tool-button" data-layer="5">Set to B.A.M. Shadow</button>
      </fieldset>
      <!-- NEW: Styles Section -->
      <fieldset>
        <legend>üé® Style Variants</legend>
        <h4>üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø British</h4>
        <button class="style-button" data-style="Union Jack: Classic">Classic</button>
        <button class="style-button" data-style="Union Jack: Navy Core">Navy Core</button>
        <button class="style-button" data-style="Union Jack: Inverted">Inverted</button>
      
        <h4>üî• Fire & Lava</h4>
        <button class="style-button" data-style="Lava: Crimson Core">Crimson</button>
        <button class="style-button" data-style="Lava: Orange Glow">Orange</button>
        <button class="style-button" data-style="Lava: Deep Magenta">Magenta</button>
      
        <h4>üåà Rainbow</h4>
        <button class="style-button" data-style="Rainbow: Swirl">Swirl</button>
        <button class="style-button" data-style="Rainbow: Vertical">Vertical</button>
        <button class="style-button" data-style="Rainbow: Horizontal Pulse">Pulse</button>
      
        <h4>‚ö° Neon</h4>
        <button class="style-button" data-style="Neon: Cyber Teal">Cyber Teal</button>
        <button class="style-button" data-style="Neon: Electric Pink">Electric Pink</button>
        <button class="style-button" data-style="Neon: Acid Green">Acid Green</button>
      
        <h4>üåå Galaxy</h4>
        <button class="style-button" data-style="Galaxy: Deep Blue">Deep Blue</button>
        <button class="style-button" data-style="Galaxy: Purple Nebula">Purple Nebula</button>
        <button class="style-button" data-style="Galaxy: Solar Flare">Solar Flare</button>
      
        <h4>üé® Metallic</h4>
        <button class="style-button" data-style="Golden: Royal">Golden</button>
        <button class="style-button" data-style="Silver: Chrome">Silver</button>
        <button class="style-button" data-style="Copper: Rustic">Copper</button>
      
        <h4>üü£ Geometric</h4>
        <button class="style-button" data-style="Checker: Hot">Hot Checker</button>
        <button class="style-button" data-style="Checker: Cool">Cool Checker</button>
        <button class="style-button" data-style="Grid: Cyber Matrix">Cyber Grid</button>
      </fieldset>
      <fieldset>
          <legend>Layer Visibility</legend>
          <div id="layer-visibility-controls" class="layer-visibility"></div>
      </fieldset>
    </div>
    <div id="grid-container"></div>
  </div>
  <div class="io-section">
      <h3>Import / Export</h3>
      <input type="file" accept="image/png" id="image-input" style="display: none;"/>
      <button id="analyze-button" class="action-button">Import & Analyze Image</button>
      <button id="export-button" class="action-button">Export Design as PNG</button>
      <h3>Template Data</h3>
      <button id="load-embedded-template-button" class="action-button">Load Embedded Template</button>
      <button id="load-template-button" class="action-button">Load Template from Text</button>
      <button id="generate-template-button" class="action-button">Generate Template to Text</button>
      <textarea id="template-io" placeholder="Generate or paste a multi-layer template here."></textarea>
  </div>
  <script>
    // --- SETUP & CONSTANTS ---
    const GRID_SIZE = 64;
    const TOTAL_PIXELS = GRID_SIZE * GRID_SIZE;
    const EMBEDDED_TEMPLATE_DATA = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,3,1,1,2,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,3,1,1,2,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,3,1,1,2,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,3,1,1,2,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,1,1,0,0,0,0,0,1,1,1,1,1,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,1,1,1,1,1,1,0,0,0,1,1,1,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,1,1,1,0,0,0,0,0,1,1,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,4,5,1,1,1,1,4,4,5,1,1,1,4,5,1,1,4,5,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,4,5,5,4,5,1,1,4,5,1,4,5,1,1,4,4,5,4,4,5,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,4,4,4,5,1,1,1,4,5,1,4,5,1,1,4,5,4,5,4,5,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,4,5,5,4,5,1,1,4,4,4,4,5,1,1,4,5,4,5,4,5,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,4,4,4,5,1,4,5,4,5,1,4,5,4,5,4,5,1,1,4,5,4,5,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
  
    const LAYER_TYPES = {
      BG: 0,
      HELMET: 1,
      LOGO_A: 2,
      LOGO_A_SHADOW: 3,
      TEXT_BAM: 4,
      TEXT_BAM_SHADOW: 5,
    };
  
    const LAYER_DEFINITIONS = {
      [LAYER_TYPES.BG]: { name: 'Background', defaultColor: 'transparent' },
      [LAYER_TYPES.HELMET]: { name: 'Helmet', defaultColor: '#000000' },
      [LAYER_TYPES.LOGO_A]: { name: 'A-Logo', defaultColor: '#808080' },
      [LAYER_TYPES.LOGO_A_SHADOW]: { name: 'A-Shadow', defaultColor: '#606060' },
      [LAYER_TYPES.TEXT_BAM]: { name: 'B.A.M.', defaultColor: '#A9A9A9' },
      [LAYER_TYPES.TEXT_BAM_SHADOW]: { name: 'B.A.M. Shadow', defaultColor: '#898989' },
    };
  
    // --- STYLE PALETTES ---
    const STYLES = {
    // === üü•üü¶ UNION JACK & BRITISH THEMES ===
    "Union Jack: Classic": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const cx = 31.5, cy = 31.5;
        const dx = Math.abs(x - cx);
        const dy = Math.abs(y - cy);
        const diag1 = Math.abs(x - y);
        const diag2 = Math.abs((63 - x) - y);
        const band = 5;
        if (dx < band || dy < band) return "#FFFFFF";
        if (diag1 < band || diag2 < band) return "#C8102E";
        return "#0052A3";
        },
        [LAYER_TYPES.LOGO_A]: "#FFFFFF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#A0A0A0",
        [LAYER_TYPES.TEXT_BAM]: "#FFFFFF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#A0A0A0"
    },
    "Union Jack: Navy Core": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const dist = Math.sqrt((x - 32)**2 + (y - 32)**2);
        const diag1 = Math.abs(x - y);
        const diag2 = Math.abs((63 - x) - y);
        if (diag1 < 6 || diag2 < 6) return dist < 20 ? "#FF0000" : "#FFFFFF";
        return dist < 30 ? "#002255" : "#001133";
        },
        [LAYER_TYPES.LOGO_A]: "#FFFFFF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#003366",
        [LAYER_TYPES.TEXT_BAM]: "#FFFFFF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#003366"
    },
    "Union Jack: Inverted": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const diag1 = Math.abs(x - y);
        const diag2 = Math.abs((63 - x) - y);
        if (diag1 < 6 || diag2 < 6) return "#0052A3";
        if (x % 14 < 7 || y % 14 < 7) return "#C8102E";
        return "#FFFFFF";
        },
        [LAYER_TYPES.LOGO_A]: "#0052A3",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#003366",
        [LAYER_TYPES.TEXT_BAM]: "#C8102E",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#900020"
    },

    // === üî• LAVA / FIRE THEMES ===
    "Lava: Crimson Core": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const r = Math.sqrt((x - 32)**2 + (y - 32)**2);
        if (r < 8) return "#FF0000";
        if (r < 16) return "#FF4400";
        if (r < 24) return "#FF6600";
        if (r < 32) return "#FF8800";
        return "#CC5500";
        },
        [LAYER_TYPES.LOGO_A]: "#FFFFFF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#663300",
        [LAYER_TYPES.TEXT_BAM]: "#FFFFFF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#663300"
    },
    "Lava: Orange Glow": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const r = Math.sqrt((x - 32)**2 + (y - 32)**2);
        if (r < 8) return "#FFAA00";
        if (r < 16) return "#FF8800";
        if (r < 24) return "#FF6600";
        if (r < 32) return "#FF4400";
        return "#CC3300";
        },
        [LAYER_TYPES.LOGO_A]: "#FFFFFF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#664400",
        [LAYER_TYPES.TEXT_BAM]: "#FFFFFF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#664400"
    },
    "Lava: Deep Magenta": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const r = Math.sqrt((x - 32)**2 + (y - 32)**2);
        if (r < 8) return "#FF00AA";
        if (r < 16) return "#EE0088";
        if (r < 24) return "#CC0066";
        if (r < 32) return "#AA0044";
        return "#660022";
        },
        [LAYER_TYPES.LOGO_A]: "#FFFFFF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#660033",
        [LAYER_TYPES.TEXT_BAM]: "#FFFFFF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#660033"
    },

    // === üåà RAINBOW & COLORFUL ===
    "Rainbow: Swirl": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const dx = x - 32, dy = y - 32;
        const angle = Math.atan2(dy, dx);
        const hue = ((angle + Math.PI) / (2 * Math.PI) + Math.sqrt(dx*dx + dy*dy)/64) * 360;
        return `hsl(${hue}, 100%, 50%)`;
        },
        [LAYER_TYPES.LOGO_A]: "#FFFFFF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#666666",
        [LAYER_TYPES.TEXT_BAM]: "#FFFFFF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#666666"
    },
    "Rainbow: Vertical": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const hue = (x / 64) * 360;
        return `hsl(${hue}, 90%, 60%)`;
        },
        [LAYER_TYPES.LOGO_A]: "#FFFFFF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#666666",
        [LAYER_TYPES.TEXT_BAM]: "#FFFFFF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#666666"
    },
    "Rainbow: Horizontal Pulse": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const hue = (y / 64 + Math.sin(x * 0.2) * 0.2) * 360;
        return `hsl(${hue}, 95%, 55%)`;
        },
        [LAYER_TYPES.LOGO_A]: "#FFFFFF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#666666",
        [LAYER_TYPES.TEXT_BAM]: "#FFFFFF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#666666"
    },

    // === ‚ö° NEON & GLOW ===
    "Neon: Cyber Teal": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        if (x % 8 < 2 || y % 8 < 2) return "#00FFCC";
        if ((x + y) % 16 < 3) return "#FF00FF";
        return "#002233";
        },
        [LAYER_TYPES.LOGO_A]: "#00FFCC",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#008866",
        [LAYER_TYPES.TEXT_BAM]: "#FF00FF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#880088"
    },
    "Neon: Electric Pink": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        if (x % 10 < 3 || y % 10 < 3) return "#FF00FF";
        if ((x * 2 + y) % 15 < 4) return "#00FFFF";
        return "#220022";
        },
        [LAYER_TYPES.LOGO_A]: "#FF00FF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#880088",
        [LAYER_TYPES.TEXT_BAM]: "#00FFFF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#008888"
    },
    "Neon: Acid Green": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        if (x % 7 < 2 || y % 7 < 2) return "#A0FF00";
        if ((x - y) % 12 < 3) return "#FFBB00";
        return "#112200";
        },
        [LAYER_TYPES.LOGO_A]: "#A0FF00",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#558800",
        [LAYER_TYPES.TEXT_BAM]: "#FFBB00",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#886600"
    },

    // === üåå SPACE & COSMIC ===
    "Galaxy: Deep Blue": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const n = (Math.sin(x * 0.3) * Math.cos(y * 0.4) + Math.sin(x * y * 0.01)) * 15;
        return `rgb(${20 + n * 5}, ${30 + n * 8}, ${100 + n * 15})`;
        },
        [LAYER_TYPES.LOGO_A]: "#BB88FF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#440066",
        [LAYER_TYPES.TEXT_BAM]: "#BB88FF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#440066"
    },
    "Galaxy: Purple Nebula": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const n = (Math.sin(x * 0.25 + y * 0.1) + Math.cos(x * 0.15 - y * 0.2)) * 10;
        return `rgb(${80 + n * 10}, ${20 + n * 5}, ${120 + n * 12})`;
        },
        [LAYER_TYPES.LOGO_A]: "#FF88FF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#660066",
        [LAYER_TYPES.TEXT_BAM]: "#FF88FF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#660066"
    },
    "Galaxy: Solar Flare": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const r = Math.sqrt((x - 32)**2 + (y - 32)**2);
        const n = Math.sin(r * 0.3) * 20;
        if (r < 10) return "#FFFF00";
        if (r < 20) return `#FF${Math.floor(80 + n)}00`;
        if (r < 30) return `#FF${Math.floor(40 + n)}00`;
        return `#CC${Math.floor(20 + n)}00`;
        },
        [LAYER_TYPES.LOGO_A]: "#FFFFFF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#664400",
        [LAYER_TYPES.TEXT_BAM]: "#FFFFFF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#664400"
    },

    // === üé® MONO & MODERN ===
    "Golden: Royal": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const r = Math.sqrt((x - 32)**2 + (y - 32)**2);
        if (r < 10) return "#FFD700";
        if (r < 20) return "#FFC000";
        if (r < 30) return "#FFA500";
        if (r < 40) return "#CC8000";
        return "#664000";
        },
        [LAYER_TYPES.LOGO_A]: "#FFFFFF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#666666",
        [LAYER_TYPES.TEXT_BAM]: "#FFFFFF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#666666"
    },
    "Silver: Chrome": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const r = Math.sqrt((x - 32)**2 + (y - 32)**2);
        if (r < 10) return "#FFFFFF";
        if (r < 20) return "#DDDDDD";
        if (r < 30) return "#BBBBBB";
        if (r < 40) return "#999999";
        return "#666666";
        },
        [LAYER_TYPES.LOGO_A]: "#000000",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#333333",
        [LAYER_TYPES.TEXT_BAM]: "#000000",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#333333"
    },
    "Copper: Rustic": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const r = Math.sqrt((x - 32)**2 + (y - 32)**2);
        if (r < 10) return "#B87333";
        if (r < 20) return "#A0522D";
        if (r < 30) return "#8B4513";
        if (r < 40) return "#654321";
        return "#3D291A";
        },
        [LAYER_TYPES.LOGO_A]: "#FFFFFF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#444444",
        [LAYER_TYPES.TEXT_BAM]: "#FFFFFF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#444444"
    },

    // === üåÄ GEOMETRIC & ABSTRACT ===
    "Checker: Hot": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const cell = (Math.floor(x / 4) + Math.floor(y / 4)) % 2;
        return cell ? "#FF4444" : "#FFDD00";
        },
        [LAYER_TYPES.LOGO_A]: "#FFFFFF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#660000",
        [LAYER_TYPES.TEXT_BAM]: "#FFFFFF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#660000"
    },
    "Checker: Cool": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        const cell = (Math.floor(x / 4) + Math.floor(y / 4)) % 2;
        return cell ? "#0088FF" : "#00FFAA";
        },
        [LAYER_TYPES.LOGO_A]: "#FFFFFF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#004466",
        [LAYER_TYPES.TEXT_BAM]: "#FFFFFF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#004466"
    },
    "Grid: Cyber Matrix": {
        [LAYER_TYPES.HELMET]: (x, y) => {
        if (x % 8 === 0 || y % 8 === 0) return "#00FF00";
        if ((x + y) % 16 === 0) return "#00FFFF";
        return "#001100";
        },
        [LAYER_TYPES.LOGO_A]: "#00FFFF",
        [LAYER_TYPES.LOGO_A_SHADOW]: "#004444",
        [LAYER_TYPES.TEXT_BAM]: "#00FFFF",
        [LAYER_TYPES.TEXT_BAM_SHADOW]: "#004444"
    }
    };

// --- Apply Style with Pattern Support ---
    function applyStyle(styleName) {
      const palette = STYLES[styleName];
      if (!palette) {
        alert(`Style '${styleName}' not found.`);
        return;
      }
      gridData.forEach((pixel, i) => {
        if (pixel.type !== LAYER_TYPES.BG) {
          const colorFnOrValue = palette[pixel.type];
          const color = typeof colorFnOrValue === 'function'
            ? colorFnOrValue(i % GRID_SIZE, Math.floor(i / GRID_SIZE))
            : colorFnOrValue;
          if (color) {
            pixel.color = color;
          }
        }
      });
      renderGridFromData();
      alert(`Applied style: ${styleName}`);
    }
  
    // --- GLOBAL STATE ---
    let gridData = [];
    let isMouseDown = false;
    let activeTool = 'paint';
    let activeColor = '#FF0000';
    let activeLayer = LAYER_TYPES.HELMET;
    let layerVisibility = {};
  
    // --- CORE FUNCTIONS ---
    function applyTool(index) {
      if (index < 0 || index >= TOTAL_PIXELS) return;
      const currentPixel = gridData[index];
      switch (activeTool) {
        case 'paint':
          if (activeColor === 'transparent') {
            currentPixel.type = LAYER_TYPES.BG;
            currentPixel.color = 'transparent';
          } else {
            currentPixel.color = activeColor;
            if (currentPixel.type === LAYER_TYPES.BG) {
              currentPixel.type = LAYER_TYPES.HELMET;
            }
          }
          break;
        case 'set_layer':
          currentPixel.type = activeLayer;
          currentPixel.color = LAYER_DEFINITIONS[activeLayer].defaultColor;
          break;
      }
      renderGridFromData();
    }
  
    function renderGridFromData() {
      const cells = document.querySelectorAll('.cell');
      gridData.forEach((pixel, i) => {
        const finalColor = layerVisibility[pixel.type] ? pixel.color : 'transparent';
        cells[i].style.backgroundColor = finalColor;
      });
    }
  
    function initialize() {
      const gridContainer = document.getElementById('grid-container');
      const layerControlsContainer = document.getElementById('layer-visibility-controls');
  
      // Layer visibility setup
      Object.keys(LAYER_DEFINITIONS).forEach(type => {
        layerVisibility[type] = true;
        if (type == LAYER_TYPES.BG) return;
        const def = LAYER_DEFINITIONS[type];
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.dataset.layerType = type;
        checkbox.addEventListener('change', e => {
          layerVisibility[e.target.dataset.layerType] = e.target.checked;
          renderGridFromData();
        });
        label.append(checkbox, ` ${def.name}`);
        layerControlsContainer.appendChild(label);
      });
  
      // Create grid
      gridContainer.innerHTML = '';
      gridData = Array(TOTAL_PIXELS).fill().map(() => ({ type: LAYER_TYPES.BG, color: 'transparent' }));
      for (let i = 0; i < TOTAL_PIXELS; i++) {
        const cell = document.createElement('div');
        cell.classList.add('cell');
        cell.dataset.index = i;
        gridContainer.appendChild(cell);
      }
      renderGridFromData();
  
      // Events
      gridContainer.addEventListener('mousedown', e => {
        isMouseDown = true;
        if (e.target.classList.contains('cell')) applyTool(e.target.dataset.index);
      });
      gridContainer.addEventListener('mousemove', e => {
        if (isMouseDown && e.target.classList.contains('cell')) applyTool(e.target.dataset.index);
      });
      window.addEventListener('mouseup', () => isMouseDown = false);
      gridContainer.addEventListener('mouseleave', () => isMouseDown = false);
    }
  
    // Tool handlers
    function setActiveTool(tool, value, buttonEl) {
      document.querySelectorAll('.tool-button, .color-button').forEach(b => b.classList.remove('active'));
      if (buttonEl) buttonEl.classList.add('active');
      activeTool = tool;
      if (tool === 'paint') {
        activeColor = value;
        if (value !== 'transparent') document.getElementById('color-picker').value = value;
      } else if (tool === 'set_layer') {
        activeLayer = Number(value);
      }
    }
  
    document.getElementById('paint-tool').addEventListener('click', e => {
      setActiveTool('paint', document.getElementById('color-picker').value, e.currentTarget);
    });
  
    document.getElementById('color-picker').addEventListener('input', e => {
      if (document.getElementById('paint-tool').classList.contains('active')) {
        activeColor = e.target.value;
      }
    });
  
    document.querySelectorAll('.color-button').forEach(btn => {
      btn.addEventListener('click', e => setActiveTool('paint', e.currentTarget.dataset.color, e.currentTarget));
    });
  
    document.querySelectorAll('.tool-button[data-layer]').forEach(btn => {
      btn.addEventListener('click', e => setActiveTool('set_layer', e.currentTarget.dataset.layer, e.currentTarget));
    });
  
    // Style buttons
    document.querySelectorAll('.style-button').forEach(btn => {
      btn.addEventListener('click', e => applyStyle(e.currentTarget.dataset.style));
    });
  
    // Template & export
    document.getElementById('generate-template-button').addEventListener('click', () => {
      document.getElementById('template-io').value = JSON.stringify(gridData.map(p => p.type));
      alert('Template generated!');
    });
  
    document.getElementById('load-template-button').addEventListener('click', () => {
      const input = document.getElementById('template-io').value;
      try {
        const template = JSON.parse(input);
        if (Array.isArray(template) && template.length === TOTAL_PIXELS) {
          template.forEach((type, i) => {
            gridData[i].type = type;
            gridData[i].color = LAYER_DEFINITIONS[type]?.defaultColor || 'transparent';
          });
          renderGridFromData();
        }
      } catch (e) {
        alert('Invalid template.');
      }
    });
  
    document.getElementById('load-embedded-template-button').addEventListener('click', () => {
      if (EMBEDDED_TEMPLATE_DATA.length === TOTAL_PIXELS) {
        EMBEDDED_TEMPLATE_DATA.forEach((type, i) => {
          gridData[i].type = type;
          gridData[i].color = LAYER_DEFINITIONS[type]?.defaultColor || 'transparent';
        });
        renderGridFromData();
        alert('Embedded template loaded!');
      }
    });
  
    document.getElementById('export-button').addEventListener('click', () => {
      const canvas = document.createElement('canvas');
      canvas.width = GRID_SIZE; canvas.height = GRID_SIZE;
      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = false;
      gridData.forEach(({ type, color }, i) => {
        if (type !== LAYER_TYPES.BG) {
          const x = i % GRID_SIZE, y = Math.floor(i / GRID_SIZE);
          ctx.fillStyle = color;
          ctx.fillRect(x, y, 1, 1);
        }
      });
      const link = document.createElement('a');
      link.download = 'helmet.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });
  
    document.getElementById('analyze-button').addEventListener('click', () => {
      document.getElementById('image-input').click();
    });
  
    document.getElementById('image-input').addEventListener('change', e => {
      if (e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = ev => {
          const img = new Image();
          img.onload = () => {
            if (img.width !== GRID_SIZE || img.height !== GRID_SIZE) {
              alert(`${GRID_SIZE}x${GRID_SIZE} required.`);
              return;
            }
            const ctx = document.createElement('canvas').getContext('2d');
            ctx.canvas.width = GRID_SIZE; ctx.canvas.height = GRID_SIZE;
            ctx.drawImage(img, 0, 0);
            const data = ctx.getImageData(0, 0, GRID_SIZE, GRID_SIZE).data;
            for (let i = 0; i < TOTAL_PIXELS; i++) {
              const a = data[i * 4 + 3];
              if (a > 0) {
                const [r, g, b] = data.slice(i * 4, i * 4 + 3);
                gridData[i] = { type: LAYER_TYPES.HELMET, color: `rgb(${r},${g},${b})` };
              } else {
                gridData[i] = { type: LAYER_TYPES.BG, color: 'transparent' };
              }
            }
            renderGridFromData();
            alert("Image loaded. Assign layers as needed.");
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
      }
    });
  
    // Init
    initialize();
    document.getElementById('paint-tool').click();
  </script>
</body>
</html>