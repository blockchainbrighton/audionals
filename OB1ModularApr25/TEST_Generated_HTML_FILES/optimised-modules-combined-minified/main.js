// --- START OF FILE main.js ---
import*as audio from"/content/cd4a0c420d69fd9bd62f481eabb372e5be7b7fd4c0766c4778a82f093aec3c2fi0";import*as ui from"/content/4c9ce4ed23eb99654200e353b14643359bbdb69d9289187bd89da6bd0b31350di0";import*as midiHandler from"/content/12aacc5c56d69f460ae0af649d5cfa26fa981005e9706412a6f0fb62b4b16e01i0";import*as keyboardShortcuts from"/content/beaf36e7ae81d1b93947715fb54e1c810baada0719d1650caad3bb64c9e4c096i0";import{buildLayout,initReferencePanel}from"/content/4b359e02acd1f41f272effafd050559293c190d5a3893021d82b88ecce049c61i0";import{clamp,_isInputFocused,addListener,createElement}from"/content/8e485ab53465925b8a2cf7269ee5a691e0b17e13573c7e500d15b99204776936i0";const DEFAULT_TEMPO=78,DEFAULT_PITCH=1,DEFAULT_VOLUME=1,DEFAULT_MULTIPLIER=1,MIN_TEMPO=1,MAX_TEMPO=400,MIN_PITCH=.01,MAX_PITCH=10,MIN_VOLUME=0,MAX_VOLUME=1.5,MIN_MULT=1,MAX_MULT=8;function bootstrap(){console.log("--- main.js bootstrap (merged app.js) ---");const e=document.getElementById("app");if(!e)return console.error("main.js: Main container #app not found!"),void(document.body.innerHTML='<p style="color:red; padding:20px;">Fatal Error: Main container #app missing.</p>');try{buildLayout(e),console.log("main.js: Layout built successfully.")}catch(t){return console.error("main.js: Error while building layout:",t),void(e.innerHTML='<p style="color:red; padding:20px;">Fatal Error: Could not build application layout.</p>')}initializeApp()}let appContainer,mainImage,playOnceBtn,loopToggleBtn,reverseToggleBtn,tempoSlider,pitchSlider,volumeSlider,multiplierSlider,controlsContainer,infoToggleBtn,referencePanel,errorMessageDiv,midiDeviceSelect,midiStatusSpan,controlsColumn,referenceColumn;function findElements(){return[["app",e=>appContainer=document.getElementById(e)],["main-image",e=>mainImage=document.getElementById(e)],["play-once-btn",e=>playOnceBtn=document.getElementById(e)],["loop-toggle-btn",e=>loopToggleBtn=document.getElementById(e)],["reverse-toggle-btn",e=>reverseToggleBtn=document.getElementById(e)],["tempo-slider",e=>tempoSlider=document.getElementById(e)],["pitch-slider",e=>pitchSlider=document.getElementById(e)],["volume-slider",e=>volumeSlider=document.getElementById(e)],["multiplier-slider",e=>multiplierSlider=document.getElementById(e)],["controls-container",e=>controlsContainer=document.getElementById(e)],["info-toggle-btn",e=>infoToggleBtn=document.getElementById(e)],["reference-panel",e=>referencePanel=document.getElementById(e)],["error-message",e=>errorMessageDiv=document.getElementById(e)],["midi-device-select",e=>midiDeviceSelect=document.getElementById(e)],["midi-status",e=>midiStatusSpan=document.getElementById(e)],[".controls-column",e=>controlsColumn=document.querySelector(e)],[".reference-column",e=>referenceColumn=document.querySelector(e)]].forEach((([e,t])=>t(e))),!!(appContainer&&controlsContainer&&errorMessageDiv&&mainImage&&controlsColumn)||((document.getElementById("app")||document.body).innerHTML='<p style="color:red;padding:20px;">Fatal Error: Missing UI</p>',!1)}function validateAndFormatDataSource(e,t,i){if(!e||"string"!=typeof e||e.startsWith("/*"))throw new Error(`Missing or invalid ${i}`);return e.startsWith("data:")?e:t+e}function handleSliderInput(e,t,i,n=parseFloat){const a=e.target,o=n(a.value),l=n(a.min),d=n(a.max);if(isNaN(o)||isNaN(l)||isNaN(d))return;const r=clamp(o,l,d);t(r),i(r)}async function handleLoopToggle(){const e=audio.getLoopingState();await audio.resumeContext(),e?audio.stopLoop():audio.startLoop(),ui.updateLoopButton(audio.getLoopingState())}function toggleSideColumns(){controlsColumn.classList.toggle("hidden"),referenceColumn?.classList.toggle("hidden")}function handleNoteOn(e,t){const i=audio.getPlaybackRateForNote(e);i&&audio.playSampleAtRate(i,t)}function handleMidiStateChange({status:e,message:t,devices:i,selectedDeviceId:n}){if(!midiDeviceSelect||!midiStatusSpan)return;midiStatusSpan.textContent=t||e,midiStatusSpan.style.color=/error|unsupported|unavailable/.test(e)?"var(--error-color)":"",midiDeviceSelect.innerHTML="";const a=createElement("option",{value:"",textContent:"ready"===e?"-- Select MIDI Device --":"-- MIDI Unavailable --"});a.disabled=!0,midiDeviceSelect.appendChild(a),"ready"===e&&i?.length?(midiDeviceSelect.disabled=!1,a.disabled=!1,i.forEach((e=>midiDeviceSelect.appendChild(createElement("option",{value:e.id,textContent:e.name})))),midiDeviceSelect.value=n||"",midiStatusSpan.textContent=n&&i.find((e=>e.id===n))?`Connected: ${i.find((e=>e.id===n)).name}`:"MIDI devices available."):midiDeviceSelect.disabled=!0}async function initializeApp(){if(!findElements())return;let e,t;ui.init?.(),ui.clearError();try{e=validateAndFormatDataSource(imageBase64,"data:image/jpeg;base64,","imageBase64"),t=validateAndFormatDataSource(audioBase64_Opus,"data:audio/opus;base64,","audioBase64_Opus"),ui.setImageSource(e)}catch(e){return void ui.showError(e.message)}const i={tempo:clamp(+tempoSlider.value||DEFAULT_TEMPO,MIN_TEMPO,MAX_TEMPO),pitch:clamp(+pitchSlider.value||DEFAULT_PITCH,MIN_PITCH,MAX_PITCH),volume:clamp(+volumeSlider.value||DEFAULT_VOLUME,MIN_VOLUME,MAX_VOLUME),mult:clamp(+multiplierSlider.value||DEFAULT_MULTIPLIER,MIN_MULT,MAX_MULT)};tempoSlider.value=i.tempo,pitchSlider.value=i.pitch,volumeSlider.value=i.volume,multiplierSlider.value=i.mult,midiHandler.init(handleNoteOn,(()=>{}),handleMidiStateChange),await audio.init(t,i.tempo,i.pitch)&&(audio.setVolume(i.volume),referencePanel&&initReferencePanel(referencePanel),keyboardShortcuts.init?.({tempoSlider:tempoSlider,pitchSlider:pitchSlider,volumeSlider:volumeSlider,multiplierSlider:multiplierSlider}),setupEventListeners(),ui.updateTempoDisplay(i.tempo),ui.updatePitchDisplay(i.pitch),ui.updateVolumeDisplay(i.volume),ui.updateScheduleMultiplierDisplay(i.mult),ui.updateLoopButton(audio.getLoopingState()),ui.updateReverseButton(audio.getReverseState()),ui.enableControls())}function setupEventListeners(){addListener(mainImage,"click",handleLoopToggle),addListener(playOnceBtn,"click",(()=>audio.playOnce())),addListener(loopToggleBtn,"click",handleLoopToggle),addListener(reverseToggleBtn,"click",(()=>audio.resumeContext().then((()=>ui.updateReverseButton(audio.toggleReverse()))))),addListener(tempoSlider,"input",(e=>handleSliderInput(e,audio.setTempo,ui.updateTempoDisplay,parseInt))),addListener(pitchSlider,"input",(e=>handleSliderInput(e,audio.setGlobalPitch,ui.updatePitchDisplay))),addListener(volumeSlider,"input",(e=>handleSliderInput(e,audio.setVolume,ui.updateVolumeDisplay))),addListener(multiplierSlider,"input",(e=>handleSliderInput(e,audio.setScheduleMultiplier,ui.updateScheduleMultiplierDisplay,parseInt))),addListener(midiDeviceSelect,"change",(e=>midiHandler.selectDevice(e.target.value))),addListener(infoToggleBtn,"click",toggleSideColumns),window.addEventListener("keydown",(e=>{e.repeat||_isInputFocused(e.target)||e.metaKey||e.ctrlKey||e.altKey||e.shiftKey||("Space"===e.code&&(audio.playOnce(),e.preventDefault()),"i"===e.key&&(toggleSideColumns(),e.preventDefault()),"r"===e.key&&(audio.resumeContext().then((()=>ui.updateReverseButton(audio.toggleReverse()))),e.preventDefault()))}))}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",bootstrap):bootstrap();