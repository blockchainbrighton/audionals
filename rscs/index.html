<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rosie's Christmas Shop 2.0 üéÑ</title>
    <style>
        :root {
            --christmas-red: #D42426;
            --christmas-green: #165B33;
            --snow-white: #F8F9FA;
            --gold: #D4AF37;
            --text-dark: #2C3E50;
            --card-bg: #ffffff;
            
            /* UI Colors */
            --bg-progress: #e0e0e0;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;

            /* Brand Colors */
            --btn-google: #4285F4;
            --btn-amazon: #FF9900;
            --btn-etsy: #F1641E;
            --btn-vinted: #007782;
            --btn-anthro: #2d454e; 
            --btn-noths: #1a2b49;
            --btn-lavender: #7B68EE;
            --btn-space: #000000;
            --btn-whittard: #2e1a47;
            --btn-ob: #40c1ac;
            --btn-whiteco: #bbbbbb;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--snow-white);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            padding-bottom: 160px; /* Space for footer */
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--christmas-red), #b31e20);
            color: white;
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        header h1 { margin: 0; font-size: 1.8rem; font-family: 'Georgia', serif; }
        header p { margin: 5px 0 0; opacity: 0.9; font-size: 0.9rem; }

        /* Progress Bar in Header */
        .progress-container {
            margin-top: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            height: 10px;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            overflow: hidden;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background-color: var(--gold);
            width: 0%;
            transition: width 0.5s ease-in-out, background-color 0.3s;
        }

        /* Controls / Filters */
        .controls-bar {
            background: white;
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .filter-btn {
            background: none;
            border: 1px solid #ccc;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .filter-btn.active {
            background: var(--christmas-green);
            color: white;
            border-color: var(--christmas-green);
        }
        .add-custom-btn {
            background: var(--text-dark);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .category-header {
            border-bottom: 2px solid var(--christmas-green);
            color: var(--christmas-green);
            margin-top: 30px;
            margin-bottom: 20px;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .category-header:hover { opacity: 0.8; }
        .category-header .toggle-icon { font-size: 1.2rem; transition: transform 0.3s; }
        .category-header.collapsed .toggle-icon { transform: rotate(-90deg); }
        
        .section-content { display: block; }
        .section-content.hidden { display: none; }

        .sub-category {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 25px;
            margin-bottom: 10px;
            display: block;
            border-left: 3px solid var(--gold);
            padding-left: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        /* Product Card */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            border-top: 5px solid var(--christmas-green);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.12); }
        .card.main-gift { border-top: 5px solid var(--gold); background-color: #fffcf5; }
        .card.custom-item { border-top: 5px solid var(--text-dark); }

        .card.has-items { background-color: #f1f8e9; border-top-color: #81c784; opacity: 0.9; }
        
        .card.has-items::after {
            content: 'üéÅ IN BAG';
            position: absolute;
            top: 10px;
            right: 10px;
            font-weight: bold;
            color: var(--christmas-green);
            border: 2px solid var(--christmas-green);
            padding: 2px 8px;
            border-radius: 4px;
            transform: rotate(15deg);
            background: white;
            font-size: 0.7rem;
        }

        .item-number { font-size: 0.8rem; color: #999; margin-bottom: 5px; }
        .item-title { font-size: 1.15rem; font-weight: bold; margin: 0 0 5px 0; color: var(--text-dark); line-height: 1.3; }
        .item-price-est { font-weight: bold; color: var(--christmas-red); font-size: 0.95rem; margin-bottom: 10px; }
        .item-notes { font-size: 0.9rem; color: #555; margin-bottom: 15px; background: #f4f4f4; padding: 10px; border-radius: 6px; flex-grow: 1; }

        /* Purchase List within Card */
        .purchase-list-card {
            background: rgba(255,255,255,0.8);
            border: 1px solid #c8e6c9;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 10px;
        }
        .purchase-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            border-bottom: 1px dashed #ccc;
            padding: 4px 0;
        }
        .purchase-item-row:last-child { border-bottom: none; }
        .remove-x { color: #dc3545; cursor: pointer; font-weight: bold; margin-left: 10px; padding: 0 5px; }

        /* Buttons */
        .shop-links-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 5px;
            margin-top: 5px;
        }

        .btn-group { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 15px; }
        
        .search-btn {
            flex: 1 0 30%; 
            text-decoration: none;
            padding: 6px 4px;
            border-radius: 4px;
            font-size: 0.75rem;
            text-align: center;
            color: white;
            transition: opacity 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .search-btn:hover { opacity: 0.85; }

        /* Specific Button Colors */
        .btn-google { background-color: var(--btn-google); }
        .btn-amazon { background-color: var(--btn-amazon); color: black; }
        .btn-etsy { background-color: var(--btn-etsy); }
        .btn-vinted { background-color: var(--btn-vinted); }
        .btn-anthro { background-color: var(--btn-anthro); }
        .btn-noths { background-color: var(--btn-noths); }
        .btn-lavender { background-color: var(--btn-lavender); }
        .btn-space { background-color: var(--btn-space); }
        .btn-whittard { background-color: var(--btn-whittard); }
        .btn-ob { background-color: var(--btn-ob); color: black;}
        .btn-whiteco { background-color: #ddd; color: black; border: 1px solid #999; }

        .add-btn {
            width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold; background-color: var(--text-dark); color: white; transition: background 0.3s;
        }
        .card.has-items .add-btn { background-color: var(--christmas-green); }
        .card.has-items .add-btn:hover { background-color: #124a29; }

        /* Receipt Section */
        .receipt-section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            margin-top: 40px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .receipt-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .receipt-table th { text-align: left; border-bottom: 2px solid #333; padding: 8px; }
        .receipt-table td { border-bottom: 1px solid #eee; padding: 10px 8px; vertical-align: middle; }
        .receipt-price { text-align: right; font-family: monospace; font-size: 1.1em; cursor: pointer; text-decoration: underline; text-decoration-style: dotted; text-decoration-color: #aaa; }
        .receipt-price:hover { color: var(--btn-google); }

        /* Budget Footer - Glassmorphism */
        .budget-bar {
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #ccc; 
            padding: 15px 20px; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            z-index: 900;
            box-sizing: border-box;
        }
        .budget-info { display: flex; gap: 20px; }
        .budget-total { font-size: 1.2rem; font-weight: bold; color: var(--text-dark); }
        .budget-remaining { font-size: 0.9rem; color: #666; font-weight: bold; }
        
        .reset-link {
            font-size: 0.7rem; color: #999; text-decoration: underline; cursor: pointer; margin-top: 5px; display: inline-block;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; justify-content: center; align-items: center;
        }
        .modal {
            background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal h3 { margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-cancel { background: #ccc; color: black; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .btn-confirm { background: var(--christmas-green); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }

        @media (max-width: 600px) {
            .budget-bar { flex-direction: column; text-align: center; gap: 10px; padding-bottom: 20px; }
            .budget-info { width: 100%; justify-content: space-between; font-size: 0.9rem; }
            .search-btn { flex: 1 0 45%; }
            header h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

<header>
    <h1>üõçÔ∏è Rosie's Shop 2.0</h1>
    <p>Checklist, Boutique Finder & Budget Tracker</p>
    
    <div class="progress-container">
        <div class="progress-fill" id="header-progress"></div>
    </div>
</header>

<div class="controls-bar">
    <button class="filter-btn active" onclick="setFilter('all')">View All</button>
    <button class="filter-btn" onclick="setFilter('tobuy')">To Buy</button>
    <button class="filter-btn" onclick="setFilter('bought')">Purchased</button>
    <button class="add-custom-btn" onclick="openCustomModal()">+ Add Custom Item</button>
</div>

<div class="container">

    <!-- SECTION: MAIN GIFT -->
    <div class="category-header" onclick="toggleSection('sec-main')">
        <h2>üéÑ Main Gift Option <span style="font-size:0.6em; color:#666; font-weight:normal;">(Tap to toggle)</span></h2>
        <span class="toggle-icon">‚ñº</span>
    </div>
    <div class="section-content" id="sec-main">
        <div class="grid" id="main-gifts"></div>
    </div>

    <!-- SECTION: STOCKING -->
    <div class="category-header" onclick="toggleSection('sec-stocking')">
        <h2>üß¶ Stocking Fillers</h2>
        <span class="toggle-icon">‚ñº</span>
    </div>

    <div class="section-content" id="sec-stocking">
        <!-- Stocking items will be injected here with headers -->
        <div id="stocking-container"></div>
    </div>

    <!-- SECTION: CUSTOM -->
    <div class="category-header" onclick="toggleSection('sec-custom')">
        <h2>‚ú® Custom Adds</h2>
        <span class="toggle-icon">‚ñº</span>
    </div>
    <div class="section-content" id="sec-custom">
        <div class="grid" id="custom-gifts"></div>
    </div>

    <!-- RECEIPT SECTION -->
    <div class="receipt-section">
        <h3>üßæ Shopping Receipt & Breakdown</h3>
        <p style="font-size:0.8rem; color:#666;">Click a price to edit it.</p>
        <table class="receipt-table">
            <thead>
                <tr>
                    <th>Item</th>
                    <th class="receipt-price">Price Paid</th>
                </tr>
            </thead>
            <tbody id="receipt-body"></tbody>
        </table>
    </div>

</div>

<!-- Budget Footer -->
<div class="budget-bar">
    <div class="budget-info">
        <div>Items: <span id="count-display">0</span></div>
        <div>Limit: ¬£230</div>
    </div>
    <div style="text-align: right; width: 100%;">
        <div class="budget-total">
            Total: ¬£<span id="actual-total">0.00</span>
        </div>
        <div class="budget-remaining">
            Remaining: ¬£<span id="remaining-total">230.00</span>
        </div>
        <span class="reset-link" onclick="resetData()">Reset All Data</span>
    </div>
</div>

<!-- Custom Item Modal -->
<div class="modal-overlay" id="customModal">
    <div class="modal">
        <h3>Add Custom Item</h3>
        <div class="form-group">
            <label>Item Name</label>
            <input type="text" id="customName" placeholder="e.g. Cute Keyring">
        </div>
        <div class="form-group">
            <label>Estimated Price (¬£)</label>
            <input type="number" id="customPrice" placeholder="10">
        </div>
        <div class="form-group">
            <label>Category</label>
            <select id="customCat">
                <option value="main">Main Gift</option>
                <option value="stocking">Stocking Filler</option>
            </select>
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeCustomModal()">Cancel</button>
            <button class="btn-confirm" onclick="saveCustomItem()">Add Item</button>
        </div>
    </div>
</div>

<script>
    // --- DATA ---
    const defaultProducts = [
        // MAIN GIFTS
        { id: 1, cat: 'main', sub: 'main', name: "Luxury scented candle", priceMin: 35, priceMax: 60, notes: "Neom, Diptyque, Rituals.", keywords: "Neom scented candle", shops: ['space', 'anthro', 'vinted'] },
        { id: 2, cat: 'main', sub: 'main', name: "Minimalist ‚ÄúMary‚Äù figurine/print", priceMin: 30, priceMax: 60, notes: "Modern/feminist aesthetic.", keywords: "modern mary print feminist", shops: ['ob', 'noths', 'etsy'] },
        { id: 3, cat: 'main', sub: 'main', name: "Donkey/Horse pendant necklace", priceMin: 25, priceMax: 60, notes: "Dainty, elegant, silver.", keywords: "silver donkey necklace", shops: ['lavender', 'noths', 'etsy'] },
        { id: 4, cat: 'main', sub: 'main', name: "Faux-fur hot-water bottle", priceMin: 20, priceMax: 35, notes: "Cosy, premium feel.", keywords: "faux fur hot water bottle", shops: ['whiteco', 'anthro', 'vinted'] },
        { id: 5, cat: 'main', sub: 'main', name: "Soft throw / cosy blanket", priceMin: 30, priceMax: 60, notes: "Neutral colours.", keywords: "soft throw blanket neutral", shops: ['anthro', 'whiteco', 'ob'] },
        { id: 6, cat: 'main', sub: 'main', name: "Premium mint tea set + gift bag", priceMin: 6, priceMax: 12, notes: "Quality sampler set.", keywords: "premium mint tea gift set", shops: ['whittard', 'amazon'] },

        // STOCKING - Tradition
        { id: 7, cat: 'stocking', sub: 'The Tradition', name: "Fresh Orange üçä", priceMin: 0.5, priceMax: 1, notes: "Buy fresh at supermarket.", keywords: "Waitrose orange", shops: ['amazon'] },

        // STOCKING - Cosy
        { id: 8, cat: 'stocking', sub: 'Cosy / Ambience', name: "Mini scented tealight set", priceMin: 4, priceMax: 8, notes: "2-3 pack.", keywords: "tealight set scented", shops: ['anthro', 'ob', 'etsy'] },
        { id: 9, cat: 'stocking', sub: 'Cosy / Ambience', name: "Small votive / mini candle", priceMin: 5, priceMax: 12, notes: "Posh scent, boutique style.", keywords: "votive candle boutique", shops: ['space', 'vinted', 'anthro'] },
        { id: 10, cat: 'stocking', sub: 'Cosy / Ambience', name: "Decorative matchbox", priceMin: 2, priceMax: 5, notes: "Elegant matches box.", keywords: "matchbox decorative", shops: ['anthro', 'ob', 'etsy'] },
        { id: 11, cat: 'stocking', sub: 'Cosy / Ambience', name: "Mini hand cream", priceMin: 3, priceMax: 8, notes: "Neutral/floral. L'Occitane/Nuxe.", keywords: "mini hand cream travel", shops: ['space', 'vinted', 'amazon'] },
        { id: 12, cat: 'stocking', sub: 'Cosy / Ambience', name: "Room-spray (travel size)", priceMin: 5, priceMax: 12, notes: "Home fragrance.", keywords: "room spray small", shops: ['anthro', 'space', 'vinted'] },

        // STOCKING - Tea & Treats
        { id: 13, cat: 'stocking', sub: 'Tea & Treats', name: "Mint-tea sampler sachet", priceMin: 2, priceMax: 5, notes: "Small box/sachets.", keywords: "mint tea sampler", shops: ['whittard', 'amazon'] },
        { id: 14, cat: 'stocking', sub: 'Tea & Treats', name: "Loose-leaf mint tea tin", priceMin: 4, priceMax: 8, notes: "Small tin or pouch.", keywords: "loose leaf mint tea", shops: ['whittard', 'amazon'] },
        { id: 15, cat: 'stocking', sub: 'Tea & Treats', name: "Dark-chocolate mini bar", priceMin: 1.5, priceMax: 3, notes: "Lindt / Green & Black's.", keywords: "Green & Black's dark chocolate", shops: ['amazon'] },
        { id: 16, cat: 'stocking', sub: 'Tea & Treats', name: "Premium chocolate baton", priceMin: 3, priceMax: 6, notes: "Hotel Chocolat style.", keywords: "Hotel Chocolat baton", shops: ['amazon', 'ob'] },
        { id: 17, cat: 'stocking', sub: 'Tea & Treats', name: "Dark chocolate with orange", priceMin: 1.5, priceMax: 3, notes: "Festive or small bar.", keywords: "dark chocolate orange small", shops: ['amazon'] },

        // STOCKING - Beauty
        { id: 18, cat: 'stocking', sub: 'Beauty & Makeup', name: "Travel-size mascara", priceMin: 8, priceMax: 15, notes: "MAC mini or similar.", keywords: "MAC mini mascara", shops: ['space', 'vinted', 'amazon'] },
        { id: 19, cat: 'stocking', sub: 'Beauty & Makeup', name: "Nail polish", priceMin: 5, priceMax: 10, notes: "Classic winter colour.", keywords: "nail polish winter shade", shops: ['space', 'amazon', 'vinted'] },
        { id: 20, cat: 'stocking', sub: 'Beauty & Makeup', name: "Makeup sponge / tool", priceMin: 3, priceMax: 8, notes: "Mini beauty blender style.", keywords: "beauty blender mini", shops: ['space', 'amazon'] },
        { id: 21, cat: 'stocking', sub: 'Beauty & Makeup', name: "Quality lip balm", priceMin: 3, priceMax: 7, notes: "Burt's Bees, Nuxe.", keywords: "luxury lip balm", shops: ['space', 'amazon', 'vinted'] },

        // STOCKING - Hobbies
        { id: 22, cat: 'stocking', sub: 'Hobbies & Fun', name: "Mini adult colouring pad", priceMin: 5, priceMax: 10, notes: "Floral or abstract.", keywords: "adult colouring book small", shops: ['ob', 'amazon', 'etsy'] },
        { id: 23, cat: 'stocking', sub: 'Hobbies & Fun', name: "Quality Colouring Pens", priceMin: 8, priceMax: 18, notes: "Staedtler Fineliners, Stabilo, or Brush pens.", keywords: "Staedtler Triplus Fineliner set", shops: ['amazon', 'ob', 'noths'] },
        { id: 24, cat: 'stocking', sub: 'Hobbies & Fun', name: "Lego Technic / Complex Mini-Set", priceMin: 10, priceMax: 20, notes: "Technic, Speed Champions or Botanicals.", keywords: "Lego Technic small set", shops: ['amazon', 'vinted', 'google'] },
        { id: 25, cat: 'stocking', sub: 'Hobbies & Fun', name: "Pocket puzzle", priceMin: 3, priceMax: 8, notes: "Metal or wooden.", keywords: "metal brain teaser puzzle", shops: ['ob', 'amazon', 'noths'] },

        // STOCKING - Animals
        { id: 26, cat: 'stocking', sub: 'Animals & Nature', name: "Animal bookmark", priceMin: 2, priceMax: 5, notes: "Donkey or horse theme.", keywords: "donkey bookmark", shops: ['noths', 'lavender', 'etsy'] },
        { id: 27, cat: 'stocking', sub: 'Animals & Nature', name: "Animal charm", priceMin: 2, priceMax: 6, notes: "Horseshoe or donkey pendant.", keywords: "donkey charm", shops: ['lavender', 'noths', 'etsy'] },
        { id: 28, cat: 'stocking', sub: 'Animals & Nature', name: "Cute plant markers", priceMin: 3, priceMax: 8, notes: "For greenhouse.", keywords: "decorative plant markers", shops: ['noths', 'etsy', 'amazon'] },
        { id: 32, cat: 'stocking', sub: 'Animals & Nature', name: "Donkey Earrings", priceMin: 12, priceMax: 28, notes: "Sterling silver studs/dangles.", keywords: "sterling silver donkey earrings", shops: ['lavender', 'noths', 'etsy', 'amazon'] },

        // STOCKING - Fashion
        { id: 29, cat: 'stocking', sub: 'Fashion & Accessories', name: "Cosy socks", priceMin: 4, priceMax: 8, notes: "Nice pattern, not novelty.", keywords: "women cosy socks winter", shops: ['whiteco', 'anthro', 'vinted'] },
        { id: 30, cat: 'stocking', sub: 'Fashion & Accessories', name: "Hair clip", priceMin: 3, priceMax: 6, notes: "Vintage / Anthropologie vibe.", keywords: "hair clip vintage", shops: ['anthro', 'lavender', 'vinted'] },
        { id: 31, cat: 'stocking', sub: 'Fashion & Accessories', name: "Velvet or satin scrunchie", priceMin: 2, priceMax: 5, notes: "Soft texture.", keywords: "velvet scrunchie", shops: ['anthro', 'ob', 'etsy'] }
    ];

    const shopConfig = {
        'google': { name: "Google", class: "btn-google", urlPre: "https://www.google.com/search?tbm=shop&q=" },
        'amazon': { name: "Amazon", class: "btn-amazon", urlPre: "https://www.amazon.co.uk/s?k=" },
        'etsy': { name: "Etsy", class: "btn-etsy", urlPre: "https://www.etsy.com/uk/search?q=" },
        'vinted': { name: "Vinted", class: "btn-vinted", urlPre: "https://www.vinted.co.uk/catalog?search_text=" },
        'anthro': { name: "Anthropologie", class: "btn-anthro", urlPre: "https://www.anthropologie.com/en-gb/search?q=" },
        'noths': { name: "NOTHS", class: "btn-noths", urlPre: "https://www.notonthehighstreet.com/search?term=" },
        'lavender': { name: "Lavender Rm", class: "btn-lavender", urlPre: "https://thelavenderroom.co.uk/search?q=" },
        'space': { name: "Space NK", class: "btn-space", urlPre: "https://www.spacenk.com/uk/search?q=" },
        'whittard': { name: "Whittard", class: "btn-whittard", urlPre: "https://www.whittard.co.uk/search?q=" },
        'ob': { name: "Oliver Bonas", class: "btn-ob", urlPre: "https://www.oliverbonas.com/search/result?q=" },
        'whiteco': { name: "White Co.", class: "btn-whiteco", urlPre: "https://www.thewhitecompany.com/uk/search?q=" }
    };

    const maxBudget = 230;

    // --- STATE MANAGEMENT ---
    let transactions = JSON.parse(localStorage.getItem('rosieShopData_v7')) || [];
    let customProducts = JSON.parse(localStorage.getItem('rosieShopCustom_v7')) || [];
    let currentFilter = 'all'; // all, tobuy, bought

    // Migration from old version if needed
    if (transactions.length === 0 && localStorage.getItem('rosieShopData_v6')) {
        transactions = JSON.parse(localStorage.getItem('rosieShopData_v6'));
        localStorage.setItem('rosieShopData_v7', JSON.stringify(transactions));
    }

    // --- RENDER LOGIC ---
    function renderShop() {
        // Clear containers
        document.getElementById('main-gifts').innerHTML = '';
        document.getElementById('stocking-container').innerHTML = '';
        document.getElementById('custom-gifts').innerHTML = '';
        document.getElementById('receipt-body').innerHTML = '';

        // Merge defaults with custom
        const allProducts = [...defaultProducts, ...customProducts];

        // 1. Group Stocking items by sub-category
        const stockingGroups = {};
        allProducts.filter(p => p.cat === 'stocking').forEach(p => {
            const sub = p.sub || 'General';
            if(!stockingGroups[sub]) stockingGroups[sub] = [];
            stockingGroups[sub].push(p);
        });

        // 2. Render Main Gifts
        allProducts.filter(p => p.cat === 'main').forEach(p => renderCard(p, 'main-gifts'));

        // 3. Render Custom Gifts (misc)
        allProducts.filter(p => p.cat === 'custom').forEach(p => renderCard(p, 'custom-gifts'));

        // 4. Render Stocking Groups
        const stockingContainer = document.getElementById('stocking-container');
        for (const [subName, items] of Object.entries(stockingGroups)) {
            // Check if all items in this group are hidden by filter
            const visibleItems = items.filter(item => shouldShow(item));
            if(visibleItems.length === 0) continue;

            const groupDiv = document.createElement('div');
            groupDiv.innerHTML = `<span class="sub-category">${subName}</span><div class="grid" id="group-${subName.replace(/\s/g, '')}"></div>`;
            stockingContainer.appendChild(groupDiv);
            const gridId = `group-${subName.replace(/\s/g, '')}`;
            
            items.forEach(p => renderCard(p, gridId));
        }

        updateSummary();
    }

    function shouldShow(product) {
        const isPurchased = transactions.some(t => t.pid === product.id);
        if (currentFilter === 'tobuy' && isPurchased) return false;
        if (currentFilter === 'bought' && !isPurchased) return false;
        return true;
    }

    function renderCard(product, containerId) {
        if (!shouldShow(product)) return;

        const container = document.getElementById(containerId);
        const productTransactions = transactions.filter(t => t.pid === product.id);
        const isPurchased = productTransactions.length > 0;
        const cardClass = isPurchased ? 'card has-items' : 'card';
        const customClass = product.cat === 'custom' ? 'custom-item' : '';
        const btnText = isPurchased ? '‚ûï Buy Another' : 'Mark as Purchased';

        // Transactions List
        let purchasesHtml = '';
        if (isPurchased) {
            purchasesHtml = '<div class="purchase-list-card">';
            productTransactions.forEach(t => {
                purchasesHtml += `
                    <div class="purchase-item-row">
                        <span>Paid: ¬£${t.price.toFixed(2)}</span>
                        <span class="remove-x" onclick="removeTransaction(${t.uid})">‚úñ</span>
                    </div>`;
            });
            purchasesHtml += '</div>';
        }

        // Shop Buttons
        let buttonHtml = '';
        if(product.cat !== 'custom') {
            const allShops = product.shops ? product.shops : ['google', 'amazon', 'etsy'];
            if(!allShops.includes('google')) buttonHtml += createBtn('google', product.keywords);
            allShops.forEach(shopCode => {
                if(shopConfig[shopCode]) buttonHtml += createBtn(shopCode, product.keywords);
            });
        } else {
             buttonHtml = `<div style="font-size:0.8rem; color:#888;">Custom Item</div>`;
        }

        const html = `
            <div class="${cardClass} ${product.cat === 'main' ? 'main-gift' : ''} ${customClass}">
                <div class="item-title">${product.name}</div>
                ${purchasesHtml}
                <div class="item-price-est">Est: ¬£${product.priceMin.toFixed(2)}</div>
                <div class="item-notes">${product.notes || ''}</div>
                
                ${product.cat !== 'custom' ? '<div class="shop-links-label">Shop @</div>' : ''}
                <div class="btn-group">${buttonHtml}</div>
                <button class="add-btn" onclick="addTransaction(${product.id}, ${product.priceMin})">${btnText}</button>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    function createBtn(code, query) {
        const conf = shopConfig[code];
        return `<a href="${conf.urlPre}${encodeURIComponent(query)}" target="_blank" class="search-btn ${conf.class}">${conf.name}</a>`;
    }

    // --- ACTIONS ---

    function setFilter(filterType) {
        currentFilter = filterType;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        renderShop();
    }

    function toggleSection(id) {
        const el = document.getElementById(id);
        const header = el.previousElementSibling;
        if(el.classList.contains('hidden')) {
            el.classList.remove('hidden');
            header.classList.remove('collapsed');
        } else {
            el.classList.add('hidden');
            header.classList.add('collapsed');
        }
    }

    function addTransaction(pid, defaultPrice) {
        let input = prompt(`How much did you pay? (GBP)\n(Leave empty for estimate: ¬£${defaultPrice})`);
        if (input === null) return;
        let price = parseFloat(input);
        if (isNaN(price)) {
            price = input.trim() === "" ? defaultPrice : null;
        }
        if (price === null) { alert("Invalid price."); return; }

        transactions.push({ uid: Date.now(), pid: pid, price: price });
        saveData();
    }

    function removeTransaction(uid) {
        if(confirm("Remove this item from your bag?")) {
            transactions = transactions.filter(t => t.uid !== uid);
            saveData();
        }
    }

    function editTransactionPrice(uid, oldPrice) {
        let input = prompt("Update price paid:", oldPrice);
        if(input === null) return;
        let newPrice = parseFloat(input);
        if(!isNaN(newPrice)) {
            const idx = transactions.findIndex(t => t.uid === uid);
            if(idx > -1) {
                transactions[idx].price = newPrice;
                saveData();
            }
        }
    }

    // --- CUSTOM ITEMS ---
    function openCustomModal() {
        document.getElementById('customModal').style.display = 'flex';
        document.getElementById('customName').focus();
    }
    function closeCustomModal() {
        document.getElementById('customModal').style.display = 'none';
        document.getElementById('customName').value = '';
        document.getElementById('customPrice').value = '';
    }
    function saveCustomItem() {
        const name = document.getElementById('customName').value;
        const price = parseFloat(document.getElementById('customPrice').value);
        const cat = document.getElementById('customCat').value;

        if(!name || isNaN(price)) { alert("Please enter valid name and price"); return; }

        const newId = 1000 + customProducts.length + 1;
        const newItem = {
            id: newId,
            cat: cat === 'main' ? 'main' : 'custom', // if main, goes to main list, else custom section
            sub: 'Custom Adds',
            name: name,
            priceMin: price,
            priceMax: price,
            notes: "Custom added item",
            keywords: name,
            shops: []
        };
        
        customProducts.push(newItem);
        localStorage.setItem('rosieShopCustom_v7', JSON.stringify(customProducts));
        
        // Auto add transaction for it
        transactions.push({ uid: Date.now(), pid: newId, price: price });
        
        closeCustomModal();
        saveData();
    }

    // --- SUMMARY & UTILS ---

    function saveData() {
        localStorage.setItem('rosieShopData_v7', JSON.stringify(transactions));
        renderShop();
    }

    function resetData() {
        if(confirm("Are you sure? This will clear all purchases and custom items.")) {
            localStorage.removeItem('rosieShopData_v7');
            localStorage.removeItem('rosieShopCustom_v7');
            transactions = [];
            customProducts = [];
            location.reload();
        }
    }

    function updateSummary() {
        let totalSpent = 0;
        let count = 0;
        const receiptBody = document.getElementById('receipt-body');
        const allProducts = [...defaultProducts, ...customProducts];

        if (transactions.length === 0) {
            receiptBody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:#999;">Bag is empty.</td></tr>';
        }

        transactions.forEach(t => {
            totalSpent += t.price;
            count++;
            const product = allProducts.find(p => p.id === t.pid);
            const name = product ? product.name : "Unknown Item";
            receiptBody.insertAdjacentHTML('beforeend', 
                `<tr>
                    <td>${name}</td>
                    <td class="receipt-price" onclick="editTransactionPrice(${t.uid}, ${t.price.toFixed(2)})">¬£${t.price.toFixed(2)}</td>
                </tr>`
            );
        });

        const remaining = maxBudget - totalSpent;
        const percentUsed = Math.min((totalSpent / maxBudget) * 100, 100);

        // Update DOM
        document.getElementById('count-display').innerText = count;
        document.getElementById('actual-total').innerText = totalSpent.toFixed(2);
        
        const remEl = document.getElementById('remaining-total');
        remEl.innerText = remaining.toFixed(2);
        remEl.style.color = remaining < 0 ? '#dc3545' : '#28a745';

        // Progress Bar
        const bar = document.getElementById('header-progress');
        bar.style.width = percentUsed + '%';
        if(percentUsed < 75) bar.style.backgroundColor = 'var(--success)';
        else if(percentUsed < 95) bar.style.backgroundColor = 'var(--warning)';
        else bar.style.backgroundColor = 'var(--danger)';
    }

    // Initial Load
    renderShop();

</script>

</body>
</html>