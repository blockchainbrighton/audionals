(()=>{Math.PI,Math.PI,Array.isArray;var e=globalThis,{sin:t,cos:n,abs:a,PI:s,pow:o,sqrt:i,imul:r,min:l,max:c,floor:u,ceil:d,round:y}=(e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame,e.cancelAnimationFrame||e.webkitCancelAnimationFrame||e.mozCancelAnimationFrame||clearTimeout,Math),p=(e,t)=>Object.assign(document.createElement(e),t),f=e=>e?.humKey||"hum",h=e=>{const t=e?._canvas?.listShapes?.();return(Array.isArray(t)&&t.length?t:Array.isArray(e?.shapes)?e.shapes:[]).filter((t=>t!==f(e)))};var m=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML="",this._loaded=!1}connectedCallback(){if(this._loaded)return;this._loaded=!0;import("https://ordinals.com/content/04813d7748d918bd8a3069cb1823ebc9586f0ce16cd6a97a784581ec38d13062i0").then((e=>{window.Tone||!e?.default&&!e?.Tone||(window.Tone=e.default??e.Tone),this.dispatchEvent(new CustomEvent("tone-ready",{bubbles:!0,composed:!0}))})).catch((e=>console.error("Failed to load Tone.js:",e)))}};customElements.define("tone-loader",m);var v=document.documentElement.dataset.seed||"aabbccdd";document.getElementById("seedText").textContent=v;var g={humKey:"hum",_canvas:{listShapes:()=>["circle","square","butterfly","Bowditch","spiro","harmonograph","rose","hypocycloid","epicycloid","spiral","star","flower","wave","mandala","infinity","dna","tornado"]},_loader:{textContent:""},_sequencerComponent:{style:{}},_main:{style:{}},_updateControls(){},_sleep:e=>new Promise((t=>setTimeout(t,e))),state:{},defaultState:e=>({seed:e,Tone:window.Tone,chains:{},presets:{},current:null,isMuted:!1,isPlaying:!1,contextUnlocked:!1,initialBufferingStarted:!1,initialShapeBuffered:!1,volume:.8,approvedSeeds:[]})},_=function(e){Object.assign;const t=t=>{const n=e.state.chains;for(const e in n)t(n[e],e)},n=e=>new Promise((t=>setTimeout(t,e))),a=e=>e?.now?.()??0,s=t=>{e._canvas&&"object"==typeof e._canvas&&Object.assign(e._canvas,t)},o=e=>{let t=1831565813^e.length;for(let n=0;n<e.length;n++)t=Math.imul(t^e.charCodeAt(n),2654435761);return()=>(t=Math.imul(t^t>>>15,1|t),(t>>>16&65535)/65536)},i=e=>{const t=e?.context?.createAnalyser?.();if(t){t.fftSize=2048;try{t.smoothingTimeConstant=.06}catch{}}return t||null},r=e=>e<=0?-60:Math.max(-60,Math.min(0,20*Math.log10(Math.min(1,Math.max(1e-4,e))))),l=e=>{try{e?.()}catch{}},c=async e=>{try{await(e?.())}catch{}},u=/iPad|iPhone|iPod/.test(navigator.userAgent),d=u?.028:.012,y=u?.028:.008,m=e=>JSON.parse(JSON.stringify(e||{})),v=(e={})=>{const t=e.envelope||{},n=!!e.osc2;return{osc1:{type:e.osc1?.[0]||"sine",note:e.osc1?.[1]||"C3"},osc2:{enabled:n,type:e.osc2?.[0]||"sine",note:e.osc2?.[1]||"E3"},filter:{freq:e.filter??800,Q:e.filterQ??.8,type:"lowpass"},envelope:{attack:t.attack??.03,decay:t.decay??.2,sustain:t.sustain??.3,release:t.release??.2},lfo:{rate:e.lfo?.[0]??2,min:e.lfo?.[1]??100,max:e.lfo?.[2]??1200},meta:{seed:e.seed,colorSpeed:e.colorSpeed,shapeDrift:e.shapeDrift}}},g=new Set,_=(e,t)=>{g.forEach((n=>{try{n(e,m(t))}catch{}}))},S=(e,t,n=d,s)=>{if(!e||!s)return;const o=a(s);l((()=>e.cancelScheduledValues?.(o)));const i=e.value??0;l((()=>e.setValueAtTime?.(i,o))),l((()=>e.linearRampToValueAtTime?.(t,o+Math.max(.001,n))))},b=e=>{l((()=>e.stop?.())),l((()=>e.dispose?.())),l((()=>e.disconnect?.()))},w=async t=>{const n=e.state?.Tone;n&&t?.out?.gain&&(S(t.out.gain,0,d,n),await e._sleep(Math.ceil(1e3*(d+.002))));for(const e of Object.values(t||{}))b(e)},k=t=>{const{Tone:n,presets:a,keyboardSynth:s}=e.state;if(!n||!s)return;const o=a[t];if(!o)return void s.set({voice0:{oscillator:{type:"sine"},envelope:{attack:.01,decay:.2,sustain:.1,release:.1}},voice1:{oscillator:{type:"sine"},envelope:{attack:.01,decay:.2,sustain:.1,release:.1}}});const i={oscillator:{type:o.osc1.type},envelope:{...o.envelope}},r=o.osc2.enabled?{oscillator:{type:o.osc2.type},envelope:{...o.envelope}}:{volume:-1/0},l=o.lfo.rate>6?.1:o.lfo.rate>2?.05:0;s.set({voice0:i,voice1:r,vibratoRate:o.lfo.rate,vibratoAmount:l})},C=(e,t)=>{const n=o(`${e}_${t}`),a=["sine","triangle","square","sawtooth"],s=["C1","C2","E2","G2","A2","C3","E3","G3","B3","D4","F#4","A4","C5"],i=n(),r=i<.18?0:i<.56?1:i<.85?2:3,l=3===r?2+(n()>.7?1:0):1+(n()>.6?1:0),c=e=>e[n()*e.length|0],u=Array.from({length:l},(()=>[c(a),c(s)]));let d,y,p,f,h;return 0===r?(y=.07+.3*n(),p=400+400*n(),f=900+600*n(),h=700+500*n(),d={attack:.005+.03*n(),decay:.04+.08*n(),sustain:.1+.2*n(),release:.03+.1*n()}):1===r?(y=.25+8*n(),p=120+700*n(),f=1200+1400*n(),h=300+2400*n(),d={attack:.03+.4*n(),decay:.1+.7*n(),sustain:.2+.5*n(),release:.2+3*n()}):2===r?(y=6+20*n(),p=80+250*n(),f=1500+3500*n(),h=300+2400*n(),d={attack:.03+.4*n(),decay:.1+.7*n(),sustain:.2+.5*n(),release:.2+3*n()}):(y=24+36*n(),p=80+250*n(),f=1500+3500*n(),h=300+2400*n(),d={attack:2+8*n(),decay:4+20*n(),sustain:.7+.2*n(),release:8+24*n()}),{osc1:u[0],osc2:u[1]||null,filter:h,filterQ:.6+.7*n(),lfo:[y,p,f],envelope:d,colorSpeed:.06+.22*n(),shapeDrift:6e-4+.0032*n(),seed:e}},A=t=>{e.state.presets=Object.fromEntries(h(e).map((e=>{const n=C(t,e);return[e,v(n)]})))},P=async()=>{const{Tone:t,chains:n}=e.state;if(!t)return;const a=f(e);n[a]&&(await w(n[a]),delete n[a]);try{const e=new t.Oscillator("A0","sine").start(),s=new t.Filter(150,"lowpass");s.Q.value=.5;const o=new t.Volume(-25),r=i(t),l=new t.Gain(0).toDestination();e.connect(o),o.connect(s),s.connect(l),r&&s.connect(r),n[a]={osc:e,volume:o,filter:s,out:l,analyser:r}}catch(t){console.error("Error buffering hum chain",t),delete e.state.chains[a]}},E=async t=>{if(t===f(e))return P();const{Tone:n,presets:a,chains:s}=e.state,o=a[t];if(o&&n){s[t]&&(await w(s[t]),delete s[t]);try{const e=new n.Oscillator(o.osc1.note,o.osc1.type).start(),a=o.osc2?.enabled?new n.Oscillator(o.osc2.note,o.osc2.type).start():null,r=new n.Volume(5),l=new n.Filter(o.filter.freq,o.filter.type||"lowpass");l.Q&&(l.Q.value=o.filter.Q??.8);const c=new n.LFO(o.lfo.rate,o.lfo.min,o.lfo.max).start(),u=i(n),d=new n.Gain(0).toDestination();c.connect(l.frequency),a&&c.connect(a.detune),e.connect(r),a?.connect(r),r.connect(l),l.connect(d),u&&l.connect(u),s[t]={osc1:e,osc2:a,volume:r,filter:l,lfo:c,out:d,analyser:u}}catch(n){console.error("Error buffering chain for shape",t,n),delete e.state.chains[t]}}},T=(t,{updateCanvasShape:n=!0,setStateCurrent:a=n,syncCanvasPlayState:o=!0}={})=>{const{Tone:i,chains:r,current:l}=e.state,c=r[l],u=r[t];c&&c!==u&&S(c.out.gain,0,y,i),u&&S(u.out.gain,1,y,i);const d={isAudioStarted:!0};u?.analyser&&(d.analyser=u.analyser),o&&(d.isPlaying=e.state.isPlaying),s(d),n&&(t===f(e)?s({shapeKey:f(e),preset:null}):s({shapeKey:t,preset:e.state.presets[t]})),a&&(e.state.current=t),k(t)},x=()=>{t(w),e.state.chains={},e.state.current=null,l((()=>e.state.keyboardSynth?.dispose())),e.state.keyboardSynth=null},q=()=>{e.sig?.updateSequencerState?.()},M=()=>{e.sig?.stopSequence?.()},B=()=>{e.sig?.stopAudioSignature?.()},L=()=>{x(),e.state.sequencePlaying&&M(),e.state.audioSignaturePlaying&&B?.();const{seed:t,Tone:n,approvedSeeds:a}=e.state;e.state=e.defaultState(t),e.state.Tone=n,e.state.approvedSeeds=a||[],e.state.keyboardSynth=null,A(t),P();const i=h(e),r=o(t),l=i.length?i[r()*i.length|0]:f(e);s({preset:e.state.presets[l]??null,shapeKey:l,mode:"seed",isAudioStarted:!1,isPlaying:!1}),e.state.current=f(e),e._updateControls({isAudioStarted:!0,isPlaying:!1,isMuted:!1,shapeKey:f(e)}),e.state.isSequencerMode=!1,e._sequencerComponent.style.display="none",e._main.style.overflow="hidden",e.state.sequence=Array(8).fill(null),q?.()},D=async()=>{const t=e.state;if(!t.initialBufferingStarted||t.initialShapeBuffered){if(t.isPlaying)return K();if(t.contextUnlocked)return t.initialShapeBuffered?(T(f(e)),t.isPlaying=!0,e._canvas&&(e._canvas.isPlaying=!0),e._updateControls({isAudioStarted:!0,isPlaying:!0}),t._startupSigDone||(await c((()=>e._sleep(200))),l((()=>e._triggerSignatureFor?.(f(e),{loop:t.isLoopEnabled}))),setTimeout((()=>l((()=>{e.cleanupHotkeyTour?.(),e.runHotkeyTour?.({stepMs:260,holdMs:1e3})}))),60),t._startupSigDone=!0),void(e._loader.textContent="Audio resumed (hum).")):void(e._loader.textContent="Audio context unlocked, but synth not ready. Click again.");try{const a=t.Tone;if(!a)throw new Error("Tone.js not available");const s=a.getContext?.()||a.context;let o=!1;if(s?.resume?(await s.resume(),o=!0):a.start&&(await a.start(),o=!0),!o)throw new Error("Could not resume AudioContext");if(t.contextUnlocked=!0,t.initialBufferingStarted=!0,!t.keyboardSynth){t.keyboardSynth=new a.PolySynth(a.DuoSynth).toDestination();const e=r(t.volume);t.keyboardSynth.volume&&(t.keyboardSynth.volume.value=e)}await P(),T(f(e));for(const a of h(e)){if(!t.contextUnlocked)break;await c((()=>E(a))),await n(0)}t.initialShapeBuffered=!0,t.isPlaying=!0,e._canvas&&(e._canvas.isPlaying=!0),e._updateControls({isAudioStarted:!0,isPlaying:!0}),t._startupSigDone||(await c((()=>e._sleep(200))),l((()=>e._triggerSignatureFor?.(f(e),{loop:t.isLoopEnabled}))),setTimeout((()=>l((()=>{e.cleanupHotkeyTour?.(),e.runHotkeyTour?.({stepMs:260,holdMs:1e3})}))),60),t._startupSigDone=!0)}catch(e){console.error("Failed to unlock AudioContext:",e),t.contextUnlocked=!1,t.initialBufferingStarted=!1,t.initialShapeBuffered=!1}}else e._loader.textContent="Still preparing initial synth, please wait..."},K=()=>{const t=e.state;(t.isPlaying||t.initialBufferingStarted)&&(l((()=>e.cleanupHotkeyTour?.())),t.audioSignatureTimer&&(l((()=>clearTimeout(t.audioSignatureTimer))),t.audioSignatureTimer=null),t.isPlaying=t.initialBufferingStarted=t.initialShapeBuffered=!1,x(),t.sequencePlaying&&M?.(),t.audioSignaturePlaying&&B?.(),e._canvas&&(e._canvas.isPlaying=!1,e._canvas.isAudioStarted=!1),L())},F=t=>{const n=t?.detail?.shapeKey;if(!n)return;const a=e.state,o=f(e);if(a.audioSignaturePlaying||a.signatureSequencerRunning||(a._uiReturnShapeKey=n!==o?n:a._uiReturnShapeKey),!a.contextUnlocked||!a.initialShapeBuffered)return s(n===o?{shapeKey:o,preset:null,mode:"seed"}:{shapeKey:n,preset:a.presets[n],mode:"seed"}),void e._updateControls({shapeKey:n});T(n),n!==o&&s({shapeKey:n,preset:a.presets[n],mode:"live"}),e._canvas.isPlaying=!e.state.Tone?.Destination?.mute,e._updateControls({shapeKey:n}),a.current=n};return{createElement:p,_eachChain:t,_disposeChain:w,_rng:o,_setCanvas:s,_createAnalyser:i,_sleep:n,_timeNow:a,_rampLinear:S,_silenceAllChains:async(n=d)=>{const a=e.state?.Tone;a&&(t((e=>e?.out?.gain&&S(e.out.gain,0,n,a))),await e._sleep(Math.ceil(1e3*(n+.002))))},_linToDb:r,deterministicPreset:C,loadPresets:A,bufferHumChain:P,bufferShapeChain:E,setActiveChain:T,disposeAllChains:x,resetState:L,unlockAudioAndBufferInitial:D,stopAudioAndDraw:K,_onStartRequest:()=>D(),_onMuteToggle:()=>{const t=e.state,n=t.Tone;if(!n?.Destination)return;const a=!t.isMuted;n.Destination.mute=a,t.isMuted=a,e._updateControls(),s({isPlaying:t.isPlaying&&!t.isMuted}),e._loader.textContent=t.isMuted?"Muted.":"Unmuted."},_onShapeChange:F,_onVolumeChange:t=>{const n=t?.detail?.value;if("number"!=typeof n)return;const a=e.state;a.volume=Math.min(1,Math.max(0,n));const s=a.Tone,o=r(a.volume);s?.Destination?.volume&&(s.Destination.volume.value=o),a.keyboardSynth?.volume&&(a.keyboardSynth.volume.value=o),e._updateControls({volume:a.volume})},updateSequencerState:q,stopSequence:M,stopAudioSignature:B,playNote:(t,n=1)=>{const{Tone:a,keyboardSynth:s,isMuted:o}=e.state;s&&a&&!o&&s.triggerAttack(t,a.now(),n)},stopNote:t=>{const{Tone:n,keyboardSynth:a}=e.state;a&&n&&a.triggerRelease(t,n.now())},setInstrument:t=>{t&&e.state.presets[t]&&F({detail:{shapeKey:t}})},setInstrumentSilent:t=>{if(!t)return;const n=e.state;n.presets&&n.presets[t]&&(n.current=t,k(t),_(t,n.presets[t]))},getSynthState:()=>({currentShape:e.state.current,isMuted:e.state.isMuted,volume:e.state.volume,isPlaying:e.state.isPlaying,isReady:e.state.contextUnlocked&&e.state.initialShapeBuffered,presets:Object.keys(e.state.presets||{})}),getPatch:(t=e.state.current)=>t?m(e.state.presets?.[t]):null,setParam:(t,n,a=e.state.current)=>{const s=e.state;if(!a||!s.presets?.[a])return;((e,t,n)=>{const a=t.split(".");let s=e;for(let e=0;e<a.length-1;e++){const t=a[e];"object"==typeof s[t]&&s[t]||(s[t]={}),s=s[t]}s[a.at(-1)]=n})(s.presets[a],t,n);const o=s.chains?.[a],i=s.Tone;if(o&&i){if("osc1.type"===t&&o.osc1&&(o.osc1.type=n),"osc2.enabled"===t){if(!n&&o.osc2){try{o.osc2.stop(),o.osc2.disconnect()}catch{}o.osc2=null}if(n&&!o.osc2){const e=s.presets[a];try{o.osc2=new i.Oscillator(e.osc2.note,e.osc2.type).start(),o.osc2.connect(o.volume);try{o.lfo?.connect(o.osc2.detune)}catch{}}catch{}}}if("osc2.type"===t&&o.osc2&&(o.osc2.type=n),"filter.freq"===t&&o.filter?.frequency&&(o.filter.frequency.value=n),"filter.Q"===t&&o.filter?.Q&&(o.filter.Q.value=n),"lfo.rate"===t&&o.lfo?.frequency&&(o.lfo.frequency.value=n),"lfo.min"===t||"lfo.max"===t){const e=s.presets[a];o.filter?.frequency&&(o.filter.frequency.value=e.filter.freq)}}a===s.current&&k(a),_(a,s.presets[a])},onPatchChange:e=>(g.add(e),()=>g.delete(e))}}(g),S=document.getElementById("startBtn"),b=document.getElementById("status"),w=document.getElementById("bank"),k=null,C=e=>document.getElementById(e),A=(e,t,n,a)=>(e.addEventListener("input",(e=>a(parseFloat(e.target.value)))),t.addEventListener("change",(e=>a(parseFloat(e.target.value)))),{set:a=>(n=>{e.value=n,t.value=n})(n(a))});function P(e){e&&(C("osc1_type").value=e.osc1.type,C("osc2_enabled").checked=!!e.osc2.enabled,C("osc2_type").value=e.osc2.type,C("osc2_type").disabled=!C("osc2_enabled").checked,C("filter_freq").value=C("filter_freq_num").value=e.filter.freq,C("filter_q").value=C("filter_q_num").value=e.filter.Q,C("env_a").value=C("env_a_num").value=e.envelope.attack,C("env_d").value=C("env_d_num").value=e.envelope.decay,C("env_s").value=C("env_s_num").value=e.envelope.sustain,C("env_r").value=C("env_r_num").value=e.envelope.release,C("lfo_rate").value=C("lfo_rate_num").value=e.lfo.rate,C("lfo_min").value=C("lfo_min_num").value=e.lfo.min,C("lfo_max").value=C("lfo_max_num").value=e.lfo.max)}async function E(){g.state=g.defaultState(v),_.loadPresets(v),k=Object.keys(g.state.presets)[0]||null,w.innerHTML="",Object.keys(g.state.presets||{}).forEach((e=>{const t=document.createElement("button");t.type="button",t.textContent=e,t.dataset.key=e,e===k&&t.classList.add("active"),t.addEventListener("click",(()=>{k=e,_.setInstrumentSilent(e),[...w.children].forEach((t=>t.classList.toggle("active",t.dataset.key===e))),P(_.getPatch(e))})),w.appendChild(t)})),S.disabled=!0,S.textContent="Starting...";try{await _.unlockAudioAndBufferInitial(k||g.humKey),b.textContent="Ready. Select a sound, then play.",S.textContent="Audio Active",k&&_.setInstrumentSilent(k),P(_.getPatch(k))}catch(e){console.error(e),b.textContent="Unable to start audio. See console.",S.disabled=!1,S.textContent="Click to Start Audio"}}_.onPatchChange(((e,t)=>{e===k&&P(t)})),S.addEventListener("click",(()=>{window.Tone&&E()}),{once:!0}),document.getElementById("toneLoader").addEventListener("tone-ready",(()=>{b.textContent='Audio engine ready. Click "Start" to begin.',S.disabled=!1,S.textContent="Click to Start Audio"})),new class{constructor(e,t){this.container=document.getElementById(e),this.engine=t,this.downKeys=new Set,this.buildKeyboard(),this.bindKeyboardEvents()}buildKeyboard(){const e=document.createElement("div");e.className="kb-row",this.container.appendChild(e);const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];let n=1,a=0;for(let s=0;s<88;s++){const s=t[a],o=`${s}${n}`,i=document.createElement("div");i.dataset.note=o,i.className=s.includes("#")?"key black":"key white",e.appendChild(i),a++,a>=t.length&&(a=0,n++)}}play(e){e&&!e.classList.contains("active")&&(this.engine.playNote(e.dataset.note),e.classList.add("active"))}stop(e){e&&(this.engine.stopNote(e.dataset.note),e.classList.remove("active"))}bindKeyboardEvents(){this.container.querySelectorAll(".key").forEach((e=>{e.addEventListener("mousedown",(()=>this.play(e))),e.addEventListener("mouseup",(()=>this.stop(e))),e.addEventListener("mouseleave",(()=>this.stop(e))),e.addEventListener("touchstart",(t=>{t.preventDefault(),this.play(e)})),e.addEventListener("touchend",(t=>{t.preventDefault(),this.stop(e)}))}));const e={a:"C4",w:"C#4",s:"D4",e:"D#4",d:"E4",f:"F4",t:"F#4",g:"G4",y:"G#4",h:"A4",u:"A#4",j:"B4",k:"C5",o:"C#5",l:"D5",p:"D#5",";":"E5"};window.addEventListener("keydown",(t=>{if(this.downKeys.has(t.key))return;const n=e[t.key];if(!n)return;const a=this.container.querySelector(`[data-note="${n}"]`);a&&(this.downKeys.add(t.key),this.play(a))})),window.addEventListener("keyup",(t=>{const n=e[t.key];if(!n)return;this.downKeys.delete(t.key);const a=this.container.querySelector(`[data-note="${n}"]`);a&&this.stop(a)}))}}("keyboard-container",_),C("osc1_type").addEventListener("change",(e=>_.setParam("osc1.type",e.target.value))),C("osc2_enabled").addEventListener("change",(e=>{C("osc2_type").disabled=!e.target.checked,_.setParam("osc2.enabled",e.target.checked)})),C("osc2_type").addEventListener("change",(e=>_.setParam("osc2.type",e.target.value))),A(C("filter_freq"),C("filter_freq_num"),(e=>e),(e=>_.setParam("filter.freq",e))),A(C("filter_q"),C("filter_q_num"),(e=>e),(e=>_.setParam("filter.Q",e))),A(C("env_a"),C("env_a_num"),(e=>e),(e=>_.setParam("envelope.attack",e))),A(C("env_d"),C("env_d_num"),(e=>e),(e=>_.setParam("envelope.decay",e))),A(C("env_s"),C("env_s_num"),(e=>e),(e=>_.setParam("envelope.sustain",e))),A(C("env_r"),C("env_r_num"),(e=>e),(e=>_.setParam("envelope.release",e))),A(C("lfo_rate"),C("lfo_rate_num"),(e=>e),(e=>_.setParam("lfo.rate",e))),A(C("lfo_min"),C("lfo_min_num"),(e=>e),(e=>_.setParam("lfo.min",e))),A(C("lfo_max"),C("lfo_max_num"),(e=>e),(e=>_.setParam("lfo.max",e)))})();