(()=>{!function(){const e=document.createElement("style");e.textContent="\n    :root { color-scheme: dark; }\n\n    html, body {\n      margin: 0; padding: 0;\n      height: 100%; width: 100%;\n      background: #000; color: #fff;\n      font-family: 'Courier New', monospace;\n      overflow: hidden; /* no page scroll during performance */\n    }\n\n    /* Desktop-friendly floor, but don't block phones from fitting */\n    body { min-width: 480px; min-height: 400px; }\n\n    /* On small screens, let the app fill the dynamic viewport\n       (prevents iOS URL bar shrinking issues) */\n    @media (max-width: 480px) {\n      body {\n        min-width: 0;\n        min-height: 100dvh; /* dynamic viewport height on mobile */\n      }\n    }\n\n    /* Respect reduced motion preferences (small global nudge) */\n    @media (prefers-reduced-motion: reduce) {\n      * { scroll-behavior: auto !important; }\n    }\n  ",document.head.appendChild(e)}(),function(){const e=navigator.userAgent||navigator.vendor||"",t=/iPad|iPhone|iPod/.test(e)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1,s=/^((?!chrome|android).)*safari/i.test(e);if(t&&s){const e=document.createElement("meta");e.name="apple-mobile-web-app-capable",e.content="yes",document.head.appendChild(e);const t=document.createElement("meta");t.name="apple-mobile-web-app-status-bar-style",t.content="black-translucent",document.head.appendChild(t)}}(),document.addEventListener("DOMContentLoaded",()=>{document.body.dataset.seed=document.documentElement.dataset.seed||"default",new MutationObserver(()=>{document.body.dataset.seed=document.documentElement.dataset.seed||"default"}).observe(document.documentElement,{attributes:!0,attributeFilter:["data-seed"]})});var e=class extends HTMLElement{static get observedAttributes(){return["disabled"]}constructor(){super(),this.attachShadow({mode:"open"}).innerHTML="<style>:host{display:none}</style>"
,this._enabled=!0,this._config={humKey:"hum",shapes:[]},this._downKeys=new Set,this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._onBlur=this._onBlur.bind(this),this._onVisibility=this._onVisibility.bind(this),this._onPageHide=this._onPageHide.bind(this),this._listeners=[]}connectedCallback(){this._enabled&&this._attach()}disconnectedCallback(){this._detach()}attributeChangedCallback(e){if("disabled"!==e)return;const t=!this.hasAttribute("disabled");t&&!this._enabled?(this._enabled=!0,this._attach()):!t&&this._enabled&&(this._enabled=!1,this._detach())}setConfig({humKey:e,shapes:t}={}){e&&(this._config.humKey=e),Array.isArray(t)&&(this._config.shapes=t)}simulatePressKey(e){this._handlePress(e)}simulateReleaseKey(e){this._handleRelease(e)}_addL(e,t,s,n){e.addEventListener(t,s,n),this._listeners.push({target:e,type:t,fn:s,opts:n})}_attach(){const e={capture:!1,passive:!1},t={capture:!1,passive:!0};this._addL(window,"keydown",this._onKeyDown,e),this._addL(window,"keyup",this._onKeyUp,e),this._addL(window,"blur",this._onBlur,t),this._addL(document,"visibilitychange",this._onVisibility,t),this._addL(window,"pagehide",this._onPageHide,t)}_detach(){for(const{target:e,type:t,fn:s,opts:n}of this._listeners)e.removeEventListener(t,s,n?.capture??!1);this._listeners.length=0,this._downKeys.size&&this._releaseAll()}_onKeyDown(e){const t=(e.composedPath?.()[0]||e.target).tagName||"";if(/^(INPUT|TEXTAREA|SELECT)$/.test(t))return;const s=e.key,n=s?.toUpperCase?.()||"",i=(t,s)=>{this._emit(t,s),e.preventDefault()},o={M:"hk-toggle-mute",C:"hk-toggle-controls",Q:"hk-toggle-sequencer",P:"hk-toggle-seq-play",H:"hk-toggle-latch"};if(o[n])return i(o[n]);if("Enter"===s)return i("hk-toggle-power");if("S"===n&&e.shiftKey&&!e.ctrlKey&&!e.altKey&&!e.metaKey)return i("save-state");if("L"===n&&e.shiftKey&&!e.ctrlKey&&!e.altKey&&!e.metaKey)return i("load-state");if("l"===s&&!e.shiftKey)return i("hk-toggle-loop");if(!e.shiftKey&&"S"===n)return i("hk-toggle-signature");if("i"===s&&!e.shiftKey)return i("hk-audio-signature");if("O"===n&&!e.shiftKey&&!e.ctrlKey&&!e.altKey&&!e.metaKey)return i("fr-play");if("F"===n&&!e.shiftKey&&!e.ctrlKey&&!e.altKey&&!e.metaKey)return i("fr-toggle");if("ArrowUp"===s||"ArrowDown"===s)return i("hk-shape-step",{direction:"ArrowDown"===s?1:-1});if(this._downKeys.has(s))return e.preventDefault();this._downKeys.add(s);const a=this._mapKey(s);a&&i("hk-press",a)}_onKeyUp(e){const t=e.key;if(!this._downKeys.has(t))return;this._downKeys.delete(t);const s=this._mapKey(t);s&&this._emit("hk-release",s)}_onBlur(){this._releaseAll()}_onVisibility(){"hidden"===document.visibilityState&&this._releaseAll()}_onPageHide(){this._releaseAll()}_releaseAll(){for(const e of this._downKeys){const t=this._mapKey(e);t&&this._emit("hk-release",t)}this._downKeys.clear()}_handlePress(e){if(!this._downKeys.has(e)){this._downKeys.add(e);const t=this._mapKey(e);t&&this._emit("hk-press",t)}}_handleRelease(e){if(this._downKeys.delete(e)){const t=this._mapKey(e);t&&this._emit("hk-release",t)}}_mapKey(e){if("0"===e)return{key:e,idx:-1,shapeKey:this._config.humKey};const t=(e?.charCodeAt?.(0)??0)-49;return t>=0&&t<this._config.shapes.length?{key:e,idx:t,shapeKey:this._config.shapes[t]}:null}_emit(e,t){this.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0,composed:!0}))}};customElements.define("osc-hotkeys",e);var t=async e=>{if(!e.audioWorklet)throw new Error("AudioWorklet not supported");return t._added||(t._added=e.audioWorklet.addModule("./js/worklet/dsp-processor.js")),t._added},s=(e,t)=>{if("number"==typeof t)return t;try{return e.Frequency(t).toFrequency()}catch{return 440}},n=class{constructor(e=440,n="sine"){const i=window.Tone,o=i?.getContext?.()?.rawContext||i?.context?._context||i?.context?._nativeAudioContext||i?.context?.rawContext||i?.context||new(window.AudioContext||window.webkitAudioContext);this._ctx=o,this._type=n||"sine",this._frequency=s(i,e),this._node=null,this._started=!1,this._ready=t(o).then(()=>{this._node=new AudioWorkletNode(o,"dsp-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2],parameterData:{frequency:this._frequency}}),this._node.port.postMessage({type:this._type,detune:0,gain:1,seed:123456})}),this.frequency={get value(){return this._owner._frequency},set value(e){const t="number"==typeof e?e:s(window.Tone,e);if(this._owner._frequency=t,this._owner._node){const e=this._owner._node.parameters.get("frequency");e&&e.setValueAtTime(t,this._owner._ctx.currentTime)}}},this.frequency._owner=this,this.type=this._type}start(){return this._started=!0,this}stop(){return this}set(e){return e&&this._node&&(this._type=e,this._node.port.postMessage({type:e})),this}connect(e){return this._ready.then(()=>{const t=this._node,s=e;return t.connect(s),e})}disconnect(){if(this._node)try{this._node.disconnect()}catch{}return this}get context(){return this._ctx}},i=()=>{const e=window,t=e.Tone;if(!t||!("Oscillator"in t))return!1;const s=t?.getContext?.()?.rawContext||t?.context?._context||t?.context?._nativeAudioContext||t?.context?.rawContext||t?.context||null;if(!s?.audioWorklet)return console.info("[AW Bridge] AudioWorklet not supported; keeping original Tone.Oscillator."),!1;try{return e.Tone=new Proxy(t,{get:(e,t,s)=>"Oscillator"===t?n:Reflect.get(e,t,s)}),e.Tone.__OrigOscillator=t.Oscillator,console.info("[AW Bridge] Patched Tone via Proxy -> Oscillator routed to AudioWorklet"),!0}catch(s){console.warn("[AW Bridge] Failed to install Proxy; falling back to shadow object",s);try{const s=Object.create(t);return Object.defineProperty(s,"Oscillator",{configurable:!0,enumerable:!0,get:()=>n}),s.__OrigOscillator=t.Oscillator,e.Tone=s,console.info("[AW Bridge] Patched Tone via shadow object -> Oscillator routed to AudioWorklet"),!0}catch(e){return console.warn("[AW Bridge] Failed to patch Tone.",e),!1}}};function o(e){return Number.isFinite(e)?e<0?0:e>1?1:e:0}window.Tone?i():window.addEventListener("tone-ready",()=>i(),{once:!0});var a=2*Math.PI;function r(e,t,s,n){e?.addEventListener?.(t,s,n)}function l(e,t,s,n){e?.removeEventListener?.(t,s,n)}function c(e,t){for(let s=0;s<(t?.length||0);s++)r(e,t[s][0],t[s][1],t[s][2])}function h(e,t){for(let s=0;s<(t?.length||0);s++)l(e,t[s][0],t[s][1],t[s][2])}function d(e,t){e&&e.textContent!==t&&(e.textContent=t)}function u(e,t){const s=String(!!t);e?.getAttribute?.("aria-pressed")!==s&&e?.setAttribute?.("aria-pressed",s)}function p(e,t,s){e?.classList?.toggle?.(t,!!s)}function g(e,t){return e?.getElementById?.(t)??null}function _(e,t){const s=!!t;for(const t of e||[])t&&t.disabled!==s&&(t.disabled=s)}Math.PI;var y=e=>"boolean"==typeof e,m=(Array.isArray,globalThis),{sin:f,cos:S,abs:b,PI:v,pow:x,sqrt:w,imul:C,min:k,max:q,floor:T,ceil:P,round:R}=(m.requestAnimationFrame||m.webkitRequestAnimationFrame||m.mozRequestAnimationFrame,m.cancelAnimationFrame||m.webkitCancelAnimationFrame||m.mozCancelAnimationFrame||clearTimeout,Math),M=Math.SQRT2,A=(e,t)=>Object.assign(document.createElement(e),t),E=e=>"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e);function L(e,t=6e3){return new Promise(s=>{const n=performance.now(),i=()=>{e()?s(!0):performance.now()-n>t?s(!1):requestAnimationFrame(i)};i()})}var B=(e,t,s=0)=>e/t*a+s,I=e=>e?.humKey||"hum",O=e=>{const t=e?._canvas?.listShapes?.();return(Array.isArray(t)&&t.length?t:Array.isArray(e?.shapes)?e.shapes:[]).filter(t=>t!==I(e))},F=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML="",this._loaded=!1}connectedCallback(){this._loaded||(this._loaded=!0,import("https://ordinals.com/content/04813d7748d918bd8a3069cb1823ebc9586f0ce16cd6a97a784581ec38d13062i0").then(e=>{window.Tone||!e?.default&&!e?.Tone||(window.Tone=e.default??e.Tone),this.dispatchEvent(new CustomEvent("tone-ready",{bubbles:!0,composed:!0}))}).catch(e=>console.error("Failed to load Tone.js:",e)))}};customElements.define("tone-loader",F),(()=>{const e={PROB:{"mono-prob":.02,"half-dominant-prob":.05,"group-strobe-prob":.01,"dark-palette-prob":.01,"neutral-palette-prob":.05},HALF_DOMINANT_RATIO:.5,CYCLER_SPEEDS:{slow:.03,medium:.06,fast:.12,lightning:.6},EFFECT_WEIGHTS:{none:60,glow:25,strobe:10,neon:5},CYC_SPEED_WEIGHTS:{slow:25,medium:40,fast:25,lightning:10},COLOR_WEIGHTS:{bitcoin_orange:3,stacks_purple:2,deep_purple:2,light_magenta:3,shocking_pink:4,royal_blue:10,dark_green:3,bright_pink:6,bright_red:12,dark_red:6,bright_yellow:1,gold:1,white:3,dark_gray:2,cycler:3},DARK_COLOR_WEIGHTS:{extra_dark_purple:2,very_dark_blue:2,very_dark_green:3,dark_red:5,extra_dark_gray:3,charcoal:2,near_black:1,gold:1},NEUTRAL_COLOR_WEIGHTS:{near_black:4,extra_dark_gray:5,charcoal:5,dark_gray:5,slate_gray:4,dim_gray:4,silver:3,gainsboro:3,off_white:4,white:3},NAMED_COLORS:{bitcoin_orange:"#F7931A",stacks_purple:"#5546FF",deep_purple:"#4B1EFF",light_magenta:"#FF4FD8",shocking_pink:"#FF00A8",bright_pink:"#FF1493",bright_red:"#FF1A1A",dark_red:"#6A0000",royal_blue:"#0726a2ff",dark_green:"#017210ff",bright_yellow:"#FFD400",gold:"#FFD700",white:"#FFFFFF",dark_gray:"rgba(16,16,24,0.40)",stacks_purple_dark:"#241E72",extra_dark_purple:"#1C0033",very_dark_blue:"#0B1E3A",very_dark_green:"#012B1B",extra_dark_gray:"#0F1014",charcoal:"#14161C",slate_gray:"#2A2F3A",dim_gray:"#6E6E73",silver:"#C0C0C8",gainsboro:"#DDDEE3"}},t=(Object.keys(e.DARK_COLOR_WEIGHTS),Object.keys(e.NEUTRAL_COLOR_WEIGHTS)),s=e=>{let t=(e=>{let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s);return 0|t})(e);return()=>{t=t+1831565813|0;let e=C(t^t>>>15,1|t);return e=e+C(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}},n=(e,t)=>{const s=Object.keys(t);if(!s.length)return null;const n=s.map(e=>q(0,+t[e]||0)),i=n.reduce((e,t)=>e+t,0);if(i<=0)return s[0];let o=e()*i;for(let e=0;e<s.length;e++)if(o-=n[e],o<=0)return s[e];return s.at(-1)},i=(e,t)=>Object.fromEntries(t.filter(t=>t in e).map(t=>[t,e[t]])),o=(e,t,s)=>{const n=t.slice();for(let t=n.length-1;t>0;t--){const s=e()*(t+1)|0;[n[t],n[s]]=[n[s],n[t]]}return n.slice(0,s)},r={circle:{freq:1,harmonics:[1,.5,.25],complexity:.3},square:{freq:1.5,harmonics:[1,.3,.7,.2],complexity:.6},butterfly:{freq:2.2,harmonics:[1,.4,.6,.3,.2],complexity:.8},Bowditch:{freq:1.8,harmonics:[1,.6,.4],complexity:.5},spiro:{freq:3.1,harmonics:[1,.3,.5,.2,.4],complexity:.9},harmonograph:{freq:2.5,harmonics:[1,.7,.5,.3,.2,.1],complexity:1},rose:{freq:1.7,harmonics:[1,.4,.3,.2],complexity:.4},hypocycloid:{freq:2.8,harmonics:[1,.5,.3,.4],complexity:.7},epicycloid:{freq:2.9,harmonics:[1,.4,.5,.3],complexity:.7},spiral:{freq:1.3,harmonics:[1,.3,.2],complexity:.4},star:{freq:2.1,harmonics:[1,.6,.4,.2],complexity:.6},flower:{freq:1.9,harmonics:[1,.5,.3,.4],complexity:.5},wave:{freq:1.1,harmonics:[1,.4,.2],complexity:.3},mandala:{freq:3.5,harmonics:[1,.3,.4,.2,.3,.1],complexity:1.2},infinity:{freq:1.6,harmonics:[1,.5,.3],complexity:.4},dna:{freq:2.7,harmonics:[1,.4,.3,.5,.2],complexity:.8},tornado:{freq:3.2,harmonics:[1,.3,.6,.2,.4],complexity:1.1},hum:{freq:.8,harmonics:[1,.2,.1],complexity:.2}};class l extends HTMLElement{constructor(){super();const e=this.attachShadow({mode:"open"}),t=document.createElement("style");t.textContent=":host{display:block;width:100%;height:100%}canvas{display:block;width:100%;height:100%}",e.append(t),this._canvas=document.createElement("canvas"),e.append(this._canvas),this._ctx=this._canvas.getContext("2d"),this.analyser=null,this.preset=null,this.shapeKey="circle",this.mode="seed",this.isAudioStarted=!1,this.isPlaying=!1,this.onIndicatorUpdate=null,this._plan=null,this._dummyData=null,this._liveBuffer=null,this._animId=null,this._cssW=0,this._cssH=0,this._dpr=1,this._animate=this._animate.bind(this),this._resizeCanvas=this._resizeCanvas.bind(this),this._samp=(e,t)=>e?e[t%e.length]??0:0,this._ampAt=(e,t)=>.5*(this._samp(e,t)+1),this._avgAbs=e=>e.reduce?.((e,t)=>e+b(t),0)/e.length,this._withCtx=e=>{const t=this._cssW||this._canvas.clientWidth||this._canvas.width,s=this._canvas.width/2|0,n=this._canvas.height/2|0,i=k(s,n)/(this._dpr||1);return e(this._ctx,t,i)},this._traceParam=(e,t,{close:s=!1}={})=>this._withCtx((n,i,o)=>{n.beginPath();for(let s=0,a=e.length;s<a;s++){const[e,r]=t(s,a,i,o);s?n.lineTo(e,r):n.moveTo(e,r)}s&&n.closePath(),n.stroke()}),this._tracePolar=(e,t,{phase:s=0,close:n=!1}={})=>this._traceParam(e,(e,n,i,o)=>{const a=B(e,n,s),r=t(e,n,a,i,o);return[o+S(a)*r,o+f(a)*r]},{close:n}),this._prepareStroke=(e,{effect:t="none",now:s=0}={})=>{const n=this._ctx;if(n.clearRect(0,0,this._cssW,this._cssH),n.globalCompositeOperation="source-over",n.shadowBlur=0,n.shadowColor="transparent",n.globalAlpha=1,n.lineWidth=2,n.lineJoin=n.lineCap="round","glow"===t)n.shadowBlur=16,n.shadowColor=e;else if("neon"===t)n.shadowBlur=28,n.shadowColor=e,n.globalCompositeOperation="lighter",n.lineWidth=2.6;else if("strobe"===t){const e=s*(10+s%1e3*.002)/1e3%1<.5;n.globalAlpha=e?1:.22}n.strokeStyle=e};const s=e=>(t,s)=>this._withCtx((n,i,o)=>{const a="epi"===e?1:-1,r=("epi"===e?.36:.39)*i,l=1/("epi"===e?4+Math.round(3*b(f(21e-5*s+.5))):3+Math.round(3*b(S(23e-5*s)))),c=(1+a*l)/l,h="epi"===e?38e-5*s:4e-4*s;this._traceParam(t,(e,s)=>{const n=B(e,s,h),i=.7+.3*this._ampAt(t,e),d=r*((1+a*l)*S(n)-a*l*S(c*n))*i,u=r*((1+a*l)*f(n)-l*f(c*n))*i;return[o+d,o+u]},{close:!0})});this.drawFuncs={hum:(e,t)=>this._withCtx((s,n,i)=>{const o=.33*n+5*f(2e-4*t);s.save(),s.globalAlpha=.23+.14*b(f(4e-4*t)),s.beginPath(),s.arc(i,i,o,0,a),s.stroke();const r=!!this._plan?.isMono;s.strokeStyle=r?this._getColorFor("hum",t).css:"hsl(195, 80%, 62%)",s.globalAlpha=.36,s.beginPath();for(let n=0,r=128;n<r;n++){const l=n/r*a,c=o+(12*f(3*l+45e-5*t)+6*f(6*l-32e-5*t))+7*this._samp(e,n),h=i+S(l)*c,d=i+f(l)*c;n?s.lineTo(h,d):s.moveTo(h,d)}s.closePath(),s.stroke(),s.restore()}),circle:(e,t)=>this._withCtx((s,n,i)=>this._traceParam(e,(s,o)=>{const a=B(s,o,.001*t),r=.4*n*this._ampAt(e,s);return[i+S(a)*r,i+f(a)*r]},{close:!0})),square:(e,t)=>this._withCtx((s,n,i)=>{const o=.8*n/M,a=(n-o)/2,r=10*f(5e-4*t),l=10*S(6e-4*t);this._traceParam(e,(t,s)=>{const n=t/s,[c,h]=(e=>e<.25?[a+o*(e/.25),a]:e<.5?[a+o,a+o*((e-.25)/.25)]:e<.75?[a+o-o*((e-.5)/.25),a+o]:[a,a+o-o*((e-.75)/.25)])(n);if(!t)return[c,h];const d=.8+.2*this._ampAt(e,t);return[i+(c-i)*d+r,i+(h-i)*d+l]},{close:!0})}),butterfly:(e,t)=>this._withCtx(()=>this._traceParam(e,(s,n,i,o)=>{const a=s/n*v*28+35e-5*t,r=x(this._ampAt(e,s),1.25),l=.22*(Math.exp(.85*S(a))-1.6*S(5*a)+x(f(a/10),7))*i*(.5+.5*r);return[o+f(a)*l,o+S(a)*l]},{close:!0})),Bowditch:(e,t)=>this._withCtx((s,n,i)=>{const o=.8*n/3,a=this._avgAbs(e),r=3+1.5*f(3e-4*t),l=2+1.5*S(4e-4*t),c=5e-4*t;this._traceParam(e,(t,s)=>{const n=B(t,s),h=a*(.5+.5*this._samp(e,t));return[i+f(r*n+c)*o*h,i+f(l*n)*o*h]})}),spiro:(e,t)=>this._withCtx((s,n,i)=>{const o=.6*n/3,a=.3+.2*f(2e-4*t),r=.21+.02*f(1e-4*t),l=(.7-a)/a;this._traceParam(e,(s,n)=>{const c=B(s,n),h=.8+.2*this._ampAt(e,s),d=(o*(.7-a)*S(c)+o*a*S(l*c+t*r))*h,u=(o*(.7-a)*f(c)-o*a*f(l*c+t*r))*h;return[i+d,i+u]})}),harmonograph:(e,t)=>this._withCtx((s,n,i)=>{const o=.7*n/4;this._traceParam(e,(s,n)=>{const a=B(s,n),r=.7*f(3*a+3e-4*t)+.3*f(5*a+4e-4*t),l=.6*f(4*a+35e-5*t)+.4*f(6*a+25e-5*t),c=.5+.5*this._samp(e,s);return[i+o*r*c,i+o*l*c]})}),rose:(e,t)=>this._withCtx((s,n,i)=>{const o=.42*n,a=3+Math.round(4*b(f(25e-5*t)));this._tracePolar(e,(t,s,n)=>o*S(a*n)*(.65+.35*this._ampAt(e,t)),{phase:35e-5*t,close:!0})}),hypocycloid:s("hypo"),epicycloid:s("epi"),spiral:(e,t)=>this._withCtx((s,n,i)=>{const o=.4*n;this._traceParam(e,(s,n)=>{const r=s/n*a*8+3e-4*t,l=o*(s/n)*(1+this._ampAt(e,s));return[i+S(r)*l,i+f(r)*l]})}),star:(e,t)=>this._withCtx((s,n,i)=>{const o=.45*n,a=5+Math.round(3*b(f(2e-4*t)));this._tracePolar(e,(t,s,n)=>o*(.5*f(a*n)+.5)*(.7+.3*this._ampAt(e,t)),{phase:4e-4*t,close:!0})}),flower:(e,t)=>this._withCtx((s,n,i)=>{const o=.4*n,a=6+Math.round(2*b(S(15e-5*t)));this._tracePolar(e,(t,s,n)=>o*(.3*S(a*n)+.7)*(.6+.4*this._ampAt(e,t)),{phase:3e-4*t,close:!0})}),wave:(e,t)=>this._withCtx((s,n,i)=>{const o=.6*n,a=e.length,r=3+2*f(2e-4*t);this._traceParam(e,s=>{const n=s/a*o-o/2,l=f(n*r/50+.001*t)*o*.3*this._ampAt(e,s);return[i+n,i+l]})}),mandala:(e,t)=>this._withCtx((s,n,i)=>{const o=.35*n;this._tracePolar(e,(t,s,n)=>o*(.8+.3*S(6*n)+.2*f(12*n)+.1*S(18*n))*(.7+.3*this._ampAt(e,t)),{phase:2e-4*t,close:!0})}),infinity:(e,t)=>this._withCtx((s,n,i)=>{const o=.4*n;this._traceParam(e,(s,n)=>{const a=B(s,n,3e-4*t),r=.7+.3*this._ampAt(e,s),l=1+f(a)*f(a);return[i+o*S(a)/l*r,i+o*f(a)*S(a)/l*r]})}),dna:(e,t)=>this._withCtx((s,n,i)=>{const o=.3*n,a=e.length,r=.8*n,l=n=>{s.beginPath();for(let l=0;l<a;l++){const c=l/a*4*v+n+.001*t,h=.7+.3*this._ampAt(e,l),d=i+S(c)*o*h,u=i+(l/a-.5)*r;l?s.lineTo(d,u):s.moveTo(d,u)}s.stroke()};l(0),l(v)}),tornado:(e,t)=>this._withCtx((s,n,i)=>{const o=.4*n;this._traceParam(e,(s,r)=>{const l=s/r,c=l*a*6+5e-4*t,h=o*(1-l)*(.6+.4*this._ampAt(e,s));return[i+S(c)*h,i+(l-.5)*n*.7]})})}}listShapes(){return Object.keys(this.drawFuncs).filter(e=>"hum"!==e)}connectedCallback(){this._animId||(this._animId=requestAnimationFrame(this._animate));try{this._ro=new ResizeObserver(this._resizeCanvas),this._ro.observe(this)}catch{this._resizeCanvas()}this._resizeCanvas()}disconnectedCallback(){if(this._animId&&(cancelAnimationFrame(this._animId),this._animId=null),this._ro){try{this._ro.disconnect()}catch{}this._ro=null}}_resizeCanvas(){const{width:e,height:t}=this.getBoundingClientRect?.()??{width:this._cssW,height:this._cssH},s=q(1,0|e),n=q(1,0|t),i=k(4,q(1,window.devicePixelRatio||1));if(s===this._cssW&&n===this._cssH&&i===this._dpr)return;this._cssW=s,this._cssH=n,this._dpr=i;const o=q(1,Math.round(s*i)),a=q(1,Math.round(n*i)),r=this._canvas;r.width!==o&&(r.width=o),r.height!==a&&(r.height=a);const l=this._ctx;l.setTransform(1,0,0,1,0,0),l.clearRect(0,0,o,a),l.setTransform(i,0,0,i,0,0)}_getSeed(){return this.preset?.seed??this.closest?.("osc-app")?.getAttribute?.("seed")??document.documentElement?.dataset?.seed??"default"}_makeSeedBuffer(e,t,s=2048){const n=`${t}_${e}`;let i=0;for(let e=0;e<n.length;e++)i=(i<<5)-i+n.charCodeAt(e);let o=0|i;const l=()=>{o=o+1831565813|0;let e=C(o^o>>>15,1|o);return e=e+C(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296},c=new Float32Array(s),h=r[e]||r.circle;for(let e=0;e<s;e++){const t=e/s;let n=0;for(let e=0;e<h.harmonics.length;e++){const s=h.freq*(e+1);n+=h.harmonics[e]*f(a*s*t+l()*a)}const i=h.complexity*(l()-.5)*.3,o=.5+.5*f(a*t*.1+l()*a);c[e]=(n+i)*o*.7}return c}_selectData(){if(this.isAudioStarted&&this.isPlaying&&this.analyser){const e=this.analyser.fftSize;return this._liveBuffer&&this._liveBuffer.length===e||(this._liveBuffer=new Float32Array(e)),this.analyser.getFloatTimeDomainData(this._liveBuffer),this._liveBuffer}if(this.preset&&"seed"===this.mode){const e=this.preset?.seed??this._getSeed(),t=this.shapeKey||"circle";return this.preset._seedBuffers||={},this.preset._seedBuffers[t]||=this._makeSeedBuffer(t,e)}if(!this._dummyData){const e=2048,t=new Float32Array(e);for(let s=0;s<e;s++){const n=s/e;t[s]=.5*f(a*n)+.3*f(2*a*n+v/3)}this._dummyData=t}return this._dummyData}_prob(t){const s=parseFloat(this.getAttribute?.(t)||""),n=Number.isFinite(s)?s:e.PROB[t];return k(1,q(0,n))}_weights(e,t){const s=((e,t,s)=>{try{const n=e?.getAttribute?.(t);if(!n)return s;const i=JSON.parse(n);return i&&"object"==typeof i?i:s}catch{return s}})(this,t,e);return{...e,...s}}_getColorWeights(){return this._weights(e.COLOR_WEIGHTS,"color-weights")}_getDarkColorWeights(){return this._weights(e.DARK_COLOR_WEIGHTS,"dark-color-weights")}_getNeutralColorWeights(){return this._weights(e.NEUTRAL_COLOR_WEIGHTS,"neutral-color-weights")}_getEffectWeights(){return this._weights(e.EFFECT_WEIGHTS,"effect-weights")}_getSpeedWeights(){return this._weights(e.CYC_SPEED_WEIGHTS,"cycle-speed-weights")}_ensurePlan(){const a=this.preset?.seed??this._getSeed(),r=this._prob("mono-prob"),l=this._prob("half-dominant-prob"),c=this._prob("group-strobe-prob"),h=this._prob("dark-palette-prob"),d=this._prob("neutral-palette-prob"),u=this._getColorWeights(),p=this._getEffectWeights(),g=this._getSpeedWeights(),_=this._getDarkColorWeights(),y=this._getNeutralColorWeights(),m=this._plan;if(m&&m.seed===a&&JSON.stringify(m.colorWeights)===JSON.stringify(u)&&JSON.stringify(m.effectWeights)===JSON.stringify(p)&&JSON.stringify(m.speedWeights)===JSON.stringify(g)&&JSON.stringify(m.darkWeights)===JSON.stringify(_)&&JSON.stringify(m.neutralWeights)===JSON.stringify(y)&&m.monoProb===r&&m.halfDomProb===l&&m.groupStrobeProb===c&&m.darkProb===h&&m.neutralProb===d)return;const f=s(`${a}::mode::mono`)()<r,S=s(`${a}::mode::neutral`),b=!f&&S()<d,v=s(`${a}::mode::dark`),x=!f&&!b&&v()<h,w=s(`${a}::mode::half`),C=!f&&w()<l,k=s(`${a}::mode::gStrobe`)()<c,T=k&&s(`${a}::mode::gStrobeType`)()<.5;let P=b?i(y,t):x?i(_,Object.keys(_)):{...u};Object.keys(P).length||(P={...u});const R=f?n(s(`${a}::monoColorPick`),P):null;let M=null,A=new Set;if(C){M=n(s(`${a}::halfColorPick`),P);const t=Object.keys(this.drawFuncs),i=q(1,Math.round(t.length*e.HALF_DOMINANT_RATIO));A=new Set(o(s(`${a}::halfSubset`),t,i))}const E={},L={},B={},I=Object.keys(this.drawFuncs);for(const t of I){const i=f?R:C&&A.has(t)?M:n(s(`${a}::color::${t}`),P);E[t]=i,"cycler"===i&&(L[t]=n(s(`${a}::speed::${t}`),g));const o=s(`${a}::effect::${t}`);B[t]=n(o,e.EFFECT_WEIGHTS)??"none";const r=n(o,p);r&&(B[t]=r)}let O=new Set;if(k){if(T)O=new Set(I);else{const e=.5+.5*s(`${a}::gStrobe::size`)(),t=q(1,Math.round(I.length*e));O=new Set(o(s(`${a}::gStrobe::subset`),I,t))}for(const e of O)B[e]="strobe"}this._plan={seed:a,monoProb:r,halfDomProb:l,groupStrobeProb:c,darkProb:h,neutralProb:d,isMono:f,isHalf:C,isDarkPalette:x,isNeutralPalette:b,colorUniformKey:R,halfDominantKey:M,halfDominantSet:A,colorWeights:u,effectWeights:p,speedWeights:g,darkWeights:_,neutralWeights:y,perShapeColorKey:E,perShapeCyclerSpeedKey:L,perShapeEffectKey:B,isGroupStrobe:k,groupStrobeAll:T,groupStrobeSet:O}}_getColorFor(t,s){this._ensurePlan();const n=this._plan.perShapeColorKey[t]||"bitcoin_orange";if("cycler"===n){const i=this._plan.perShapeCyclerSpeedKey[t]||"medium";return{css:`hsl(${s*(e.CYCLER_SPEEDS[i]??e.CYCLER_SPEEDS.medium)%360},85%,60%)`,key:n,speedKey:i}}return{css:e.NAMED_COLORS[n]||"#FFFFFF",key:n,speedKey:null}}_getEffectFor(e){return this._ensurePlan(),this._plan.perShapeEffectKey[e]||"none"}_animate(){const e=performance.now();this._resizeCanvas();const t=this._selectData(),{css:s}=this._getColorFor(this.shapeKey,e),n=this._getEffectFor(this.shapeKey);this._prepareStroke(s,{effect:n,now:e}),(this.drawFuncs[this.shapeKey]||this.drawFuncs.circle)(t,e,this.preset??{}),"function"==typeof this.onIndicatorUpdate&&this.isAudioStarted&&this.isPlaying,this._animId=requestAnimationFrame(this._animate)}}customElements.define("scope-canvas",l)})();var K=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}).innerHTML="<style>:host{display:none}</style>",this._armed=this._isRecording=this._isPlaying=!1,this._loop=!1,this._showOverlay=!0,this._recording=null,this._points=[],this._t0=this._lastSampleT=this._playIdx=this._playT0=this._raf=0;for(const e of["arm","disarm","clear","play","stop","getRecording","inputPointer","renderOverlay","setLoop"])this[e]=this[e].bind(this)}arm(){this._armed||(this._armed=!0,this._showOverlay=!0,this._dispatch("fr-armed"))}disarm(){this._armed&&(this._isRecording&&this._endRecording(performance.now()),this._armed=!1,this._showOverlay=!1,this._dispatch("fr-disarmed"))}clear(){this.stop(),this._recording=null,this._points=[],this._dispatch("fr-cleared")}getRecording(){return this._recording?{points:this._recording.points.slice(),duration:this._recording.duration}:null}play(e,t={}){if(this._loop=!!t.loop,this._isPlaying)return;const s=e||this._recording;if(!s?.points?.length)return;e&&(this._recording=e),this._isPlaying=!0,this._playIdx=0,this._playT0=performance.now(),this._dispatch("fr-play-started");const n=s.points[0];n&&this._emitPlayInput({x:n.x,y:n.y,t:0,type:n.type||"down"});const i=()=>{if(!this._isPlaying)return;const e=performance.now()-this._playT0,t=s.points;for(;this._playIdx<t.length&&t[this._playIdx].t<=e;)this._emitPlayInput(t[this._playIdx++]);const n=this._interpAtTime(s,e);if(n&&this._emitPlayInput({x:n.x,y:n.y,t:e,type:"move",_interp:!0}),e>=s.duration){const e=t[t.length-1];if("up"!==e.type&&this._emitPlayInput({x:e.x,y:e.y,t:s.duration,type:"up"}),this._loop){this._dispatch("fr-play-loop"),this._playIdx=0,this._playT0=performance.now();const e=t[0];e&&this._emitPlayInput({x:e.x,y:e.y,t:0,type:e.type||"down"}),this._raf=requestAnimationFrame(i)}else this.stop()}else this._raf=requestAnimationFrame(i)};this._raf=requestAnimationFrame(i)}stop(){this._isPlaying&&(cancelAnimationFrame(this._raf),this._isPlaying=!1,this._dispatch("fr-play-stopped"))}setLoop(e){this._loop=!!e}inputPointer(e,t,s,n){if(!this._armed)return;t=o(t),s=o(s);const i=n??performance.now();if("down"!==e||this._isRecording||this._beginRecording(i),!this._isRecording)return;const a=i-this._t0;this._points.push({x:t,y:s,t:a,type:e}),this._lastSampleT=a,"up"===e&&this._endRecording(i)}renderOverlay(e,t=performance.now()){if(!(this._showOverlay||this._isPlaying&&this._recording))return;const s=this._isRecording?{points:this._points}:this._recording,n=s?.points?.length>0,{canvas:i}=e;if(e.save(),this._showOverlay&&n&&(e.lineWidth=3,e.lineJoin="round",e.lineCap="round",e.shadowBlur=15,e.shadowColor="#00ffff80",e.strokeStyle="#00ffff",e.beginPath(),this._drawPath(e,s.points,i),e.stroke(),e.shadowBlur=5,e.shadowColor="#00ffff",e.lineWidth=2,e.stroke()),this._isPlaying&&this._recording){const s=t-this._playT0,n=this._interpAtTime(this._recording,s);if(n){const s=n.x*i.width,o=n.y*i.height,a=.8+.2*Math.sin(t/100),r=.7+.3*Math.sin(t/150);e.beginPath(),e.arc(s,o,10*a,0,2*Math.PI),e.fillStyle=`hsl(300,100%,${70+10*r}%)`,e.fill(),e.shadowBlur=15*r,e.shadowColor="#ff00ff",e.strokeStyle="#ff00ff",e.lineWidth=2,e.stroke()}}e.restore()}_beginRecording(e){this.stop(),this._isRecording=!0,this._points=[],this._t0=e,this._lastSampleT=0,this._dispatch("fr-record-started")}_endRecording(e){if(!this._isRecording)return;const t=Math.max(1,Math.round(e-this._t0));0===this._points.length&&this._points.push({x:.5,y:.5,t:0,type:"down"});const s=this._points[this._points.length-1];"up"!==s.type&&this._points.push({x:s.x,y:s.y,t:t,type:"up"}),this._recording={points:this._points.slice(),duration:t},this._isRecording=!1,this._dispatch("fr-record-stopped",{duration:t}),this._armed&&(this._armed=!1,this._showOverlay=!1,this._dispatch("fr-disarmed")),this.play(this._recording,{loop:this._loop})}_drawPath(e,t,s){for(let n=0;n<t.length;n++){const i=t[n],o=i.x*s.width,a=i.y*s.height;0===n?e.moveTo(o,a):e.lineTo(o,a)}}_interpAtTime(e,t){const s=e.points;if(!s.length)return null;if(t<=s[0].t)return{x:s[0].x,y:s[0].y};if(t>=e.duration){const e=s[s.length-1];return{x:e.x,y:e.y}}for(let e=1;e<s.length;e++){const n=s[e-1],i=s[e];if(t<=i.t){const e=(t-n.t)/(i.t-n.t||1);return{x:n.x+(i.x-n.x)*e,y:n.y+(i.y-n.y)*e}}}const n=s[s.length-1];return{x:n.x,y:n.y}}_emitPlayInput(e){this._dispatch("fr-play-input",{x:e.x,y:e.y,t:e.t,type:e.type})}_dispatch(e,t){this.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0,composed:!0}))}};customElements.define("path-rec-app",K);var D=class extends HTMLElement{constructor(){super();const e=this.attachShadow({mode:"open"}),t=(e,t)=>this.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0,composed:!0}));e.innerHTML='\n      <style>\n        :host{display:block}\n        #controls{display:flex;gap:1.1rem;align-items:center;flex-wrap:wrap;justify-content:center;padding:.7rem 1.2rem;background:rgba(255,255,255,.07);border-radius:9px;width:95%;max-width:980px;margin:.9rem auto 0;box-sizing:border-box}\n        .seed{display:flex;align-items:center;gap:.55rem;padding:.3rem .55rem;background:#23252b;border:1px solid #4e5668;border-radius:8px}\n        .seed label{font-size:.95rem;color:#ffe7b3;letter-spacing:.02em}\n        .seed input{font-family:inherit;font-size:.98rem;color:#ffecb3;background:#1c1d22;border:1px solid #3c3f48;border-radius:6px;padding:.38rem .55rem;width:15ch;letter-spacing:.04em}\n        .seed button{padding:.42rem .8rem;border-radius:6px;border:1px solid #665;background:#221;color:#ffe0a3;cursor:pointer;font-family:inherit;font-size:.95rem;transition:background .18s}\n        .seed button:hover{background:#2c1f1f}\n        .vol{display:flex;align-items:center;gap:.55rem;min-width:190px;padding:.3rem .55rem;background:#23252b;border:1px solid #4e5668;border-radius:8px}\n        .vol label{font-size:.95rem;color:#cfe3ff;letter-spacing:.02em}\n        .vol input[type="range"]{-webkit-appearance:none;appearance:none;width:140px;height:4px;background:#3a3f4a;border-radius:999px;outline:none}\n        .vol input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;background:#46ad6d;border:1px solid #2b6b44;box-shadow:0 0 6px #46ad6d55;cursor:pointer}\n        .vol input[type="range"]::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:#46ad6d;border:1px solid #2b6b44;cursor:pointer}\n        .vol #volVal{font-size:.92rem;color:#9df5c2;min-width:3.5ch;text-align:right}\n        button,select{padding:.53em 1.17em;border-radius:6px;border:1px solid #555;background:#242;color:#fff;font-size:1rem;cursor:pointer;font-family:inherit;font-weight:500;transition:background .19s,color .19s,box-shadow .19s,transform .06s ease;box-shadow:0 0 0 #0000;will-change:transform}\n        button:active{transform:translateY(1px)}\n        button:focus{outline:2px solid #7af6ff;outline-offset:1px}\n        button:hover{background:#454}\n        #startBtn.power-off{background:#451015;color:#e97c90;border-color:#89232a;box-shadow:0 0 4px #ff505011,0 0 0 #0000;text-shadow:none;filter:brightness(.95)}\n        #startBtn.power-on{background:#ff2a39;color:#fff;border-color:#ff4e6a;box-shadow:0 0 18px 5px #ff2a3999,0 0 4px #ff748499;text-shadow:0 1px 3px #8d2025cc,0 0 10px #fff7;filter:brightness(1.1) saturate(1.2)}\n        #startBtn:not(.ready){opacity:.7}\n        #muteBtn.muted{background:#a51427;color:#fff;border-color:#ff506e;box-shadow:0 0 12px #ff506e66;text-shadow:0 1px 2px #320a0b}\n        #audioSigBtn{background:#2a4d3a;color:#7af6ff;border-color:#4a7c59;box-shadow:0 0 8px #7af6ff33}\n        #audioSigBtn:hover{background:#3a5d4a;box-shadow:0 0 12px #7af6ff55}\n        #audioSigBtn:disabled{background:#1a2d2a;color:#4a6c59;box-shadow:none}\n        .toggle{position:relative;background:#23252b;border-color:#4e5668;color:#cfe3ff;box-shadow:inset 0 -1px 0 #0004,0 0 0 #0000}\n        .toggle:hover{background:#2b2f38}\n        .toggle[aria-pressed="true"]{background:#1f3a26;color:#9df5c2;border-color:#46ad6d;box-shadow:0 0 10px #46ad6d55,inset 0 0 0 1px #46ad6d33;text-shadow:0 1px 2px #0b1a10aa}\n        #loopBtn.toggle[aria-pressed="true"]{background:#173a2a;border-color:#35d08e;box-shadow:0 0 12px #35d08e55,inset 0 0 0 1px #35d08e33}\n        #sigModeBtn.toggle[aria-pressed="true"]{background:#1f2a3f;border-color:#7aa2ff;color:#cfe0ff;box-shadow:0 0 12px #7aa2ff55,inset 0 0 0 1px #7aa2ff33}\n        #latchBtn.toggle[aria-pressed="true"]{background:#1f3a26;border-color:#46ad6d;color:#9df5c2;box-shadow:0 0 10px #46ad6d55,inset 0 0 0 1px #46ad6d33}\n        /* Auditioning Controls Styles */\n        #auditionControls{display:flex;gap:.5rem;border-left:2px solid #555;padding-left:1rem;margin-left:.5rem}\n        #approveBtn{background:#141;color:#8f8;border-color:#383}\n        #approveBtn:hover{background:#252}\n        #rejectBtn{background:#411;color:#f88;border-color:#833}\n        #rejectBtn:hover{background:#522}\n        #approvedSeedsWrapper{width:100%;margin-top:.8rem;display:none}\n        #approvedSeedsWrapper label{color:#ffe7b3;font-size:.9rem;display:block;margin-bottom:.3rem}\n        #approvedSeedsList{width:100%;box-sizing:border-box;height:80px;background:#1c1d22;border:1px solid #3c3f48;color:#9f8;font-family:monospace;resize:vertical;padding:.4rem .6rem;border-radius:6px}\n        @media (max-width:768px){\n          #auditionControls {\n            flex-basis: 100%;\n            justify-content: center;\n            border-left: none;\n            margin-left: 0;\n            padding-left: 0;\n            margin-top: .5rem;\n          }\n        }\n        @media (max-width:430px){#controls{gap:.5rem;padding:.55rem .8rem}button,select{padding:.42em .8em;font-size:.93rem}.vol{min-width:160px}.vol input[type="range"]{width:120px}.seed input{width:11ch}}\n        @media (max-width:380px){#controls{gap:.45rem;padding:.5rem .7rem}button,select{padding:.4em .72em;font-size:.9rem}.vol{min-width:150px}.vol input[type="range"]{width:110px}.seed label{display:none}}\n        button:disabled,select:disabled{opacity:.5;pointer-events:none}\n        .vol:has(input:disabled){opacity:.5;pointer-events:none}\n      </style>\n      <div id="controls">\n        <button id="startBtn" title="Click to initialize audio">POWER ON</button>\n        <button id="muteBtn">Mute</button>\n        <select id="shapeSelect"></select>\n        <button id="seqBtn">Create Sequence</button>\n        <button id="audioSigBtn">Audio Signature</button>\n        <button id="latchBtn" class="toggle" aria-pressed="false">(H) Latch: Off</button>\n        <button id="loopBtn" class="toggle" aria-pressed="false">Loop: Off</button>\n        <button id="sigModeBtn" class="toggle" aria-pressed="false">Signature Mode: Off</button>\n        <div id="volWrap" class="vol" title="Master Volume">\n          <label for="vol">Vol</label>\n          <input id="vol" type="range" min="0" max="100" step="1" value="10"/>\n          <span id="volVal">10%</span>\n        </div>\n        <form id="seedForm" class="seed" autocomplete="off">\n          <label for="seedInput">Seed</label>\n          <input id="seedInput" name="seedInput" maxlength="32" spellcheck="false"/>\n          <button id="seedSetBtn" type="submit">Set Seed</button>\n        </form>\n        \x3c!-- MODIFIED START: Seed Auditioning Controls --\x3e\n        <div id="auditionControls">\n            <button id="nextSeedBtn" title="Load the next seed from the CSV list">Next Seed</button>\n            <button id="approveBtn" title="Save this seed to the list and play the next one">✅</button>\n            <button id="rejectBtn" title="Discard this seed and play the next one">❌</button>\n        </div>\n        \x3c!-- MODIFIED END --\x3e\n        \x3c!-- Freestyle Path Recorder Buttons --\x3e\n        <button id="frReadyBtn" class="toggle" aria-pressed="false" title="Freestyle Record-Ready (F)">FR Ready</button>\n        <button id="frPlayBtn" disabled title="Play Freestyle Recording (O)">FR Play</button>\n        \x3c!-- Save/Load Buttons --\x3e\n        <button id="saveBtn" title="Save entire sequencer state to clipboard as JSON">Save State</button>\n        <button id="loadBtn" title="Load sequencer state from JSON data">Load State</button>\n      </div>\n      \x3c!-- MODIFIED START: Approved Seeds List Display --\x3e\n      <div id="approvedSeedsWrapper">\n        <label for="approvedSeedsList">Approved Seeds:</label>\n        <textarea id="approvedSeedsList" readonly spellcheck="false"></textarea>\n      </div>\n      \x3c!-- MODIFIED END --\x3e',this._startBtn=g(e,"startBtn"),this._muteBtn=g(e,"muteBtn"),this._shapeSelect=g(e,"shapeSelect"),this._seqBtn=g(e,"seqBtn"),this._audioSigBtn=g(e,"audioSigBtn"),this._latchBtn=g(e,"latchBtn"),this._loopBtn=g(e,"loopBtn"),this._sigModeBtn=g(e,"sigModeBtn"),this._vol=g(e,"vol"),this._volVal=g(e,"volVal"),this._seedForm=g(e,"seedForm"),this._seedInput=g(e,"seedInput"),this._nextSeedBtn=g(e,"nextSeedBtn"),this._approveBtn=g(e,"approveBtn"),this._rejectBtn=g(e,"rejectBtn"),this._approvedSeedsWrapper=g(e,"approvedSeedsWrapper"),this._approvedSeedsList=g(e,"approvedSeedsList"),this._allControls=[this._startBtn,this._muteBtn,this._shapeSelect,this._seqBtn,this._audioSigBtn,this._latchBtn,this._loopBtn,this._sigModeBtn,this._vol],this._frReadyBtn=g(e,"frReadyBtn"),this._frPlayBtn=g(e,"frPlayBtn"),this._saveBtn=g(e,"saveBtn"),this._loadBtn=g(e,"loadBtn"),this._allControls.push(this._frReadyBtn,this._frPlayBtn,this._saveBtn,this._loadBtn),this._allControls.push(this._nextSeedBtn,this._approveBtn,this._rejectBtn),c(this._frReadyBtn,[["click",()=>t("fr-toggle")]]),c(this._frPlayBtn,[["click",()=>t("fr-play")]]),c(this._saveBtn,[["click",()=>t("save-state")]]),c(this._loadBtn,[["click",()=>t("load-state")]]),c(this._startBtn,[["click",()=>t("start-request")]]),c(this._muteBtn,[["click",()=>t("mute-toggle")]]),c(this._shapeSelect,[["change",()=>t("shape-change",{shapeKey:this._shapeSelect.value})]]),c(this._seqBtn,[["click",()=>t("toggle-sequencer")]]),c(this._audioSigBtn,[["click",()=>t("audio-signature")]]),c(this._latchBtn,[["click",()=>t("latch-toggle")]]),c(this._loopBtn,[["click",()=>t("loop-toggle")]]),c(this._sigModeBtn,[["click",()=>t("signature-mode-toggle")]]),c(this._vol,[["input",()=>t("volume-change",{value:Number(this._vol.value)})]]),c(this._seedForm,[["submit",e=>(e.preventDefault(),t("seed-set",{value:(this._seedInput?.value||"").trim()}))]]),c(this._nextSeedBtn,[["click",()=>t("next-seed")]]),c(this._approveBtn,[["click",()=>t("approve-seed")]]),c(this._rejectBtn,[["click",()=>t("reject-seed")]]),this._helpers={setPressed:u,setText:d}}setShapes(e){const t=document.createDocumentFragment();for(const{value:s,label:n}of e??[])t.appendChild(Object.assign(document.createElement("option"),{value:s,textContent:n}));this._shapeSelect.replaceChildren(t)}setSeed(e){this._seedInput&&(this._seedInput.value=e??"")}disableAll(e){_(this._allControls,e)}updateApprovedSeeds(e=[]){if(this._approvedSeedsWrapper&&this._approvedSeedsList){const t=e.length>0;this._approvedSeedsWrapper.style.display=t?"block":"none",this._approvedSeedsList.value=t?e.join("\n"):"",t&&(this._approvedSeedsList.scrollTop=this._approvedSeedsList.scrollHeight),this.dispatchEvent(new Event("controls-resize"))}}updateState(e={}){const{setPressed:t,setText:s}=this._helpers,n=(e,n,i,o)=>(t(e,n),s(e,n?i:o));if(y(e.isAudioSignaturePlaying)&&n(this._audioSigBtn,e.isAudioSignaturePlaying,"Stop Signature","Audio Signature"),y(e.isPlaying)&&(s(this._startBtn,e.isPlaying?"POWER OFF":"POWER ON"),p(this._startBtn,"power-on",e.isPlaying),p(this._startBtn,"power-off",!e.isPlaying)),y(e.isAudioStarted)&&(p(this._startBtn,"ready",e.isAudioStarted),_([this._muteBtn,this._audioSigBtn,this._latchBtn,this._loopBtn,this._sigModeBtn,this._vol],!e.isAudioStarted)),y(e.isMuted)&&(s(this._muteBtn,e.isMuted?"Unmute":"Mute"),p(this._muteBtn,"muted",e.isMuted)),e.shapeKey&&(this._shapeSelect.value=e.shapeKey),y(e.sequencerVisible)&&s(this._seqBtn,e.sequencerVisible?"Hide Sequencer":"Create Sequence"),y(e.isLoopEnabled)&&n(this._loopBtn,e.isLoopEnabled,"Loop: On","Loop: Off"),y(e.isSequenceSignatureMode)&&n(this._sigModeBtn,e.isSequenceSignatureMode,"Signature Mode: On","Signature Mode: Off"),y(e.isLatchOn)&&n(this._latchBtn,!!e.isLatchOn,"(H) Latch: On","(H) Latch: Off"),"number"==typeof(a=e.volume)&&!Number.isNaN(a)){const t=(i=e.volume,Math.round(100*o(i)));this._vol&&(this._vol.value=String(t)),this._volVal&&(this._volVal.textContent=`${t}%`)}var i,a;y(e.sequencerVisible)&&this.dispatchEvent(new Event("controls-resize"))}};customElements.define("osc-controls",D);var H=class extends HTMLElement{static get observedAttributes(){return["seed"]}constructor(){super(),this.attachShadow({mode:"open"}),this._heldKeys=new Set,this.humKey="hum",this.humLabel="Power Hum",this.shapes=["circle","square","butterfly","Bowditch","spiro","harmonograph","rose","hypocycloid","epicycloid","spiral","star","flower","wave","mandala","infinity","dna","tornado"],this.shapeLabels=Object.fromEntries(this.shapes.map(e=>[e,e[0].toUpperCase()+e.slice(1)])),Object.assign(this,function(e){Object.assign;const t=t=>{const s=e.state.chains;for(const e in s)t(s[e],e)},s=e=>new Promise(t=>setTimeout(t,e)),n=e=>e?.now?.()??0,i=t=>{e._canvas&&"object"==typeof e._canvas&&Object.assign(e._canvas,t)},o=e=>{let t=1831565813^e.length;for(let s=0;s<e.length;s++)t=Math.imul(t^e.charCodeAt(s),2654435761);return()=>(t=Math.imul(t^t>>>15,1|t),(t>>>16&65535)/65536)},a=e=>{const t=e?.context?.createAnalyser?.();if(t){t.fftSize=2048;try{t.smoothingTimeConstant=.06}catch{}}return t||null},r=e=>e<=0?-60:Math.max(-60,Math.min(0,20*Math.log10(Math.min(1,Math.max(1e-4,e))))),l=e=>{try{e?.()}catch{}},c=async e=>{try{await(e?.())}catch{}},h=/iPad|iPhone|iPod/.test(navigator.userAgent),d=h?.028:.012,u=h?.028:.008,p=e=>JSON.parse(JSON.stringify(e||{})),g=(e={})=>{const t=e.envelope||{},s=!!e.osc2;return{osc1:{type:e.osc1?.[0]||"sine",note:e.osc1?.[1]||"C3"},osc2:{enabled:s,type:e.osc2?.[0]||"sine",note:e.osc2?.[1]||"E3"},filter:{freq:e.filter??800,Q:e.filterQ??.8,type:"lowpass"},envelope:{attack:t.attack??.03,decay:t.decay??.2,sustain:t.sustain??.3,release:t.release??.2},lfo:{rate:e.lfo?.[0]??2,min:e.lfo?.[1]??100,max:e.lfo?.[2]??1200},meta:{seed:e.seed,colorSpeed:e.colorSpeed,shapeDrift:e.shapeDrift}}},_=new Set,y=(e,t)=>{_.forEach(s=>{try{s(e,p(t))}catch{}})},m=(e,t,s=d,i)=>{if(!e||!i)return;const o=n(i);l(()=>e.cancelScheduledValues?.(o));const a=e.value??0;l(()=>e.setValueAtTime?.(a,o)),l(()=>e.linearRampToValueAtTime?.(t,o+Math.max(.001,s)))},f=e=>{l(()=>e.stop?.()),l(()=>e.dispose?.()),l(()=>e.disconnect?.())},S=async t=>{const s=e.state?.Tone;s&&t?.out?.gain&&(m(t.out.gain,0,d,s),await e._sleep(Math.ceil(1e3*(d+.002))));for(const e of Object.values(t||{}))f(e)},b=t=>{const{Tone:s,presets:n,keyboardSynth:i}=e.state;if(!s||!i)return;const o=n[t];if(!o)return void i.set({voice0:{oscillator:{type:"sine"},envelope:{attack:.01,decay:.2,sustain:.1,release:.1}},voice1:{oscillator:{type:"sine"},envelope:{attack:.01,decay:.2,sustain:.1,release:.1}}});const a={oscillator:{type:o.osc1.type},envelope:{...o.envelope}},r=o.osc2.enabled?{oscillator:{type:o.osc2.type},envelope:{...o.envelope}}:{volume:-1/0},l=o.lfo.rate>6?.1:o.lfo.rate>2?.05:0;i.set({voice0:a,voice1:r,vibratoRate:o.lfo.rate,vibratoAmount:l})},v=(e,t)=>{const s=o(`${e}_${t}`),n=["sine","triangle","square","sawtooth"],i=["C1","C2","E2","G2","A2","C3","E3","G3","B3","D4","F#4","A4","C5"],a=s(),r=a<.18?0:a<.56?1:a<.85?2:3,l=3===r?2+(s()>.7?1:0):1+(s()>.6?1:0),c=e=>e[s()*e.length|0],h=Array.from({length:l},()=>[c(n),c(i)]);let d,u,p,g,_;return 0===r?(u=.07+.3*s(),p=400+400*s(),g=900+600*s(),_=700+500*s(),d={attack:.005+.03*s(),decay:.04+.08*s(),sustain:.1+.2*s(),release:.03+.1*s()}):1===r?(u=.25+8*s(),p=120+700*s(),g=1200+1400*s(),_=300+2400*s(),d={attack:.03+.4*s(),decay:.1+.7*s(),sustain:.2+.5*s(),release:.2+3*s()}):2===r?(u=6+20*s(),p=80+250*s(),g=1500+3500*s(),_=300+2400*s(),d={attack:.03+.4*s(),decay:.1+.7*s(),sustain:.2+.5*s(),release:.2+3*s()}):(u=24+36*s(),p=80+250*s(),g=1500+3500*s(),_=300+2400*s(),d={attack:2+8*s(),decay:4+20*s(),sustain:.7+.2*s(),release:8+24*s()}),{osc1:h[0],osc2:h[1]||null,filter:_,filterQ:.6+.7*s(),lfo:[u,p,g],envelope:d,colorSpeed:.06+.22*s(),shapeDrift:6e-4+.0032*s(),seed:e}},x=t=>{e.state.presets=Object.fromEntries(O(e).map(e=>{const s=v(t,e);return[e,g(s)]}))},w=async()=>{const{Tone:t,chains:s}=e.state;if(!t)return;const n=I(e);s[n]&&(await S(s[n]),delete s[n]);try{const e=new t.Oscillator("A0","sine").start(),i=new t.Filter(150,"lowpass");i.Q.value=.5;const o=new t.Volume(-25),r=a(t),l=new t.Gain(0).toDestination();e.connect(o),o.connect(i),i.connect(l),r&&i.connect(r),s[n]={osc:e,volume:o,filter:i,out:l,analyser:r}}catch(t){console.error("Error buffering hum chain",t),delete e.state.chains[n]}},C=async t=>{if(t===I(e))return w();const{Tone:s,presets:n,chains:i}=e.state,o=n[t];if(o&&s){i[t]&&(await S(i[t]),delete i[t]);try{const e=new s.Oscillator(o.osc1.note,o.osc1.type).start(),n=o.osc2?.enabled?new s.Oscillator(o.osc2.note,o.osc2.type).start():null,r=new s.Volume(5),l=new s.Filter(o.filter.freq,o.filter.type||"lowpass");l.Q&&(l.Q.value=o.filter.Q??.8);const c=new s.LFO(o.lfo.rate,o.lfo.min,o.lfo.max).start(),h=a(s),d=new s.Gain(0).toDestination();c.connect(l.frequency),n&&c.connect(n.detune),e.connect(r),n?.connect(r),r.connect(l),l.connect(d),h&&l.connect(h),i[t]={osc1:e,osc2:n,volume:r,filter:l,lfo:c,out:d,analyser:h}}catch(s){console.error("Error buffering chain for shape",t,s),delete e.state.chains[t]}}},k=(t,{updateCanvasShape:s=!0,setStateCurrent:n=s,syncCanvasPlayState:o=!0}={})=>{const{Tone:a,chains:r,current:l}=e.state,c=r[l],h=r[t];c&&c!==h&&m(c.out.gain,0,u,a),h&&m(h.out.gain,1,u,a);const d={isAudioStarted:!0};h?.analyser&&(d.analyser=h.analyser),o&&(d.isPlaying=e.state.isPlaying),i(d),s&&(t===I(e)?i({shapeKey:I(e),preset:null}):i({shapeKey:t,preset:e.state.presets[t]})),n&&(e.state.current=t),b(t)},q=()=>{t(S),e.state.chains={},e.state.current=null,l(()=>e.state.keyboardSynth?.dispose()),e.state.keyboardSynth=null},T=()=>{e.sig?.updateSequencerState?.()},P=()=>{e.sig?.stopSequence?.()},R=()=>{e.sig?.stopAudioSignature?.()},M=()=>{q(),e.state.sequencePlaying&&P(),e.state.audioSignaturePlaying&&R?.();const{seed:t,Tone:s,approvedSeeds:n}=e.state;e.state=e.defaultState(t),e.state.Tone=s,e.state.approvedSeeds=n||[],e.state.keyboardSynth=null,x(t),w();const a=O(e),r=o(t),l=a.length?a[r()*a.length|0]:I(e);i({preset:e.state.presets[l]??null,shapeKey:l,mode:"seed",isAudioStarted:!1,isPlaying:!1}),e.state.current=I(e),e._updateControls({isAudioStarted:!0,isPlaying:!1,isMuted:!1,shapeKey:I(e)}),e.state.isSequencerMode=!1,e._sequencerComponent.style.display="none",e._main.style.overflow="hidden",e.state.sequence=Array(8).fill(null),T?.()},E=async()=>{const t=e.state;if(!t.initialBufferingStarted||t.initialShapeBuffered){if(t.isPlaying)return L();if(t.contextUnlocked)return t.initialShapeBuffered?(k(I(e)),t.isPlaying=!0,e._canvas&&(e._canvas.isPlaying=!0),e._updateControls({isAudioStarted:!0,isPlaying:!0}),t._startupSigDone||(await c(()=>e._sleep(200)),l(()=>e._triggerSignatureFor?.(I(e),{loop:t.isLoopEnabled})),setTimeout(()=>l(()=>{e.cleanupHotkeyTour?.(),e.runHotkeyTour?.({stepMs:260,holdMs:1e3})}),60),t._startupSigDone=!0),void(e._loader.textContent="Audio resumed (hum).")):void(e._loader.textContent="Audio context unlocked, but synth not ready. Click again.");try{const n=t.Tone;if(!n)throw new Error("Tone.js not available");const i=n.getContext?.()||n.context;let o=!1;if(i?.resume?(await i.resume(),o=!0):n.start&&(await n.start(),o=!0),!o)throw new Error("Could not resume AudioContext");if(t.contextUnlocked=!0,t.initialBufferingStarted=!0,!t.keyboardSynth){t.keyboardSynth=new n.PolySynth(n.DuoSynth).toDestination();const e=r(t.volume);t.keyboardSynth.volume&&(t.keyboardSynth.volume.value=e)}await w(),k(I(e));for(const n of O(e)){if(!t.contextUnlocked)break;await c(()=>C(n)),await s(0)}t.initialShapeBuffered=!0,t.isPlaying=!0,e._canvas&&(e._canvas.isPlaying=!0),e._updateControls({isAudioStarted:!0,isPlaying:!0}),t._startupSigDone||(await c(()=>e._sleep(200)),l(()=>e._triggerSignatureFor?.(I(e),{loop:t.isLoopEnabled})),setTimeout(()=>l(()=>{e.cleanupHotkeyTour?.(),e.runHotkeyTour?.({stepMs:260,holdMs:1e3})}),60),t._startupSigDone=!0)}catch(e){console.error("Failed to unlock AudioContext:",e),t.contextUnlocked=!1,t.initialBufferingStarted=!1,t.initialShapeBuffered=!1}}else e._loader.textContent="Still preparing initial synth, please wait..."},L=()=>{const t=e.state;(t.isPlaying||t.initialBufferingStarted)&&(l(()=>e.cleanupHotkeyTour?.()),t.audioSignatureTimer&&(l(()=>clearTimeout(t.audioSignatureTimer)),t.audioSignatureTimer=null),t.isPlaying=t.initialBufferingStarted=t.initialShapeBuffered=!1,q(),t.sequencePlaying&&P?.(),t.audioSignaturePlaying&&R?.(),e._canvas&&(e._canvas.isPlaying=!1,e._canvas.isAudioStarted=!1),M())},B=t=>{const s=t?.detail?.shapeKey;if(!s)return;const n=e.state,o=I(e);if(n.audioSignaturePlaying||n.signatureSequencerRunning||(n._uiReturnShapeKey=s!==o?s:n._uiReturnShapeKey),!n.contextUnlocked||!n.initialShapeBuffered)return i(s===o?{shapeKey:o,preset:null,mode:"seed"}:{shapeKey:s,preset:n.presets[s],mode:"seed"}),void e._updateControls({shapeKey:s});k(s),s!==o&&i({shapeKey:s,preset:n.presets[s],mode:"live"}),e._canvas.isPlaying=!e.state.Tone?.Destination?.mute,e._updateControls({shapeKey:s}),n.current=s};return{createElement:A,_eachChain:t,_disposeChain:S,_rng:o,_setCanvas:i,_createAnalyser:a,_sleep:s,_timeNow:n,_rampLinear:m,_silenceAllChains:async(s=d)=>{const n=e.state?.Tone;n&&(t(e=>e?.out?.gain&&m(e.out.gain,0,s,n)),await e._sleep(Math.ceil(1e3*(s+.002))))},_linToDb:r,deterministicPreset:v,loadPresets:x,bufferHumChain:w,bufferShapeChain:C,setActiveChain:k,disposeAllChains:q,resetState:M,unlockAudioAndBufferInitial:E,stopAudioAndDraw:L,_onStartRequest:()=>E(),_onMuteToggle:()=>{const t=e.state,s=t.Tone;if(!s?.Destination)return;const n=!t.isMuted;s.Destination.mute=n,t.isMuted=n,e._updateControls(),i({isPlaying:t.isPlaying&&!t.isMuted}),e._loader.textContent=t.isMuted?"Muted.":"Unmuted."},_onShapeChange:B,_onVolumeChange:t=>{const s=t?.detail?.value;if("number"!=typeof s)return;const n=e.state;n.volume=Math.min(1,Math.max(0,s/100));const i=n.Tone,o=r(n.volume);i?.Destination?.volume&&(i.Destination.volume.value=o),n.keyboardSynth?.volume&&(n.keyboardSynth.volume.value=o),e._updateControls({volume:n.volume})},updateSequencerState:T,stopSequence:P,stopAudioSignature:R,playNote:(t,s=1)=>{const{Tone:n,keyboardSynth:i,isMuted:o}=e.state;i&&n&&!o&&i.triggerAttack(t,n.now(),s)},stopNote:t=>{const{Tone:s,keyboardSynth:n}=e.state;n&&s&&n.triggerRelease(t,s.now())},setInstrument:t=>{t&&e.state.presets[t]&&B({detail:{shapeKey:t}})},setInstrumentSilent:t=>{if(!t)return;const s=e.state;s.presets&&s.presets[t]&&(s.current=t,b(t),y(t,s.presets[t]))},getSynthState:()=>({currentShape:e.state.current,isMuted:e.state.isMuted,volume:e.state.volume,isPlaying:e.state.isPlaying,isReady:e.state.contextUnlocked&&e.state.initialShapeBuffered,presets:Object.keys(e.state.presets||{})}),getPatch:(t=e.state.current)=>t?p(e.state.presets?.[t]):null,setParam:(t,s,n=e.state.current)=>{const i=e.state;if(!n||!i.presets?.[n])return;((e,t,s)=>{const n=t.split(".");let i=e;for(let e=0;e<n.length-1;e++){const t=n[e];"object"==typeof i[t]&&i[t]||(i[t]={}),i=i[t]}i[n.at(-1)]=s})(i.presets[n],t,s);const o=i.chains?.[n],a=i.Tone;if(o&&a){if("osc1.type"===t&&o.osc1&&(o.osc1.type=s),"osc2.enabled"===t){if(!s&&o.osc2){try{o.osc2.stop(),o.osc2.disconnect()}catch{}o.osc2=null}if(s&&!o.osc2){const e=i.presets[n];try{o.osc2=new a.Oscillator(e.osc2.note,e.osc2.type).start(),o.osc2.connect(o.volume);try{o.lfo?.connect(o.osc2.detune)}catch{}}catch{}}}if("osc2.type"===t&&o.osc2&&(o.osc2.type=s),"filter.freq"===t&&o.filter?.frequency&&(o.filter.frequency.value=s),"filter.Q"===t&&o.filter?.Q&&(o.filter.Q.value=s),"lfo.rate"===t&&o.lfo?.frequency&&(o.lfo.frequency.value=s),"lfo.min"===t||"lfo.max"===t){const e=i.presets[n];o.filter?.frequency&&(o.filter.frequency.value=e.filter.freq)}}n===i.current&&b(n),y(n,i.presets[n])},onPatchChange:e=>(_.add(e),()=>_.delete(e))}}(this),function(e){const t=()=>I(e),s=()=>O(e),n=()=>(e=>O(e).length)(e),i=(e,t,s)=>t+Math.floor(e()*(s-t+1)),o=e=>i(e,0,n()),a=e=>{const t=n();return t>0?i(e,1,t):0},r=t=>{const s=e._rng(`${t}_unique_algo_mapping`),n=(e=>[I(e),...O(e)])(e),i=n.length,o=[1,2,3,4,5,6,7,8,9,10],a=[];for(;a.length<i;)a.push(...o);a.length=i;for(let e=a.length-1;e>0;e--){const t=s()*(e+1)|0;[a[e],a[t]]=[a[t],a[e]]}const r={};return n.forEach((e,t)=>r[e]=a[t]),r},l=(t,{steps:s=32,paletteSize:o=6,pRepeat:a=.35,pHum:r=.15,pSilence:l=.2,avoidBackAndForth:c=!0}={})=>{const h=e._rng(`${t}_audio_signature_constrained`),d=n(),u=Math.max(1,Math.min(d,o)),p=[];let g=null,_=null;for(let e=0;e<s;e++){if(h()<l){p.push(null);continue}const e=h();let t;if(e<r)t=0;else if(e<r+a&&null!==_)t=_;else do{t=i(h,1,u),c&&null!==g&&g>=1&&t>=1&&p.length>=2&&p.at(-2)===t&&(t=null)}while(null===t);p.push(t),null!==t&&(t>=1&&(_=t),g=t)}return p},c=(t,s=1)=>{const i=e._rng(`${t}_audio_signature_v${s}`),r=32,c=n();switch(s){case 1:{const e=[];for(let t=0;t<r;t++)e.push(o(i));return e}case 2:return l(t,{steps:r,paletteSize:Math.min(6,Math.max(1,c)),pRepeat:.35,pHum:.15,pSilence:.2,avoidBackAndForth:!0});case 3:{const e=8,t=Array.from({length:e},()=>o(i));return Array.from({length:r},(s,n)=>t[n%e])}case 4:{const e=[0];let t=0;for(let s=1;s<r;s++){const s=i()>.5?1:-1,n=1+(3*i()|0);t=Math.max(0,Math.min(c,t+s*n)),e.push(t)}return e}case 5:{const e=[];let t=o(i);for(let s=0;s<r;){const n=Math.min(2+(6*i()|0),r-s);for(let i=0;i<n;i++,s++)e.push(t);t=o(i)}return e}case 6:{const e=[];for(let t=0;t<r;t++)e.push(i()>.7?a(i):0);return e}case 7:{const e=new Array(r).fill(0);let t=0,s=1,n=1;for(;t<r;){e[t]=a(i);const o=s+n;s=n,n=o,t+=o}return e}case 8:{const e=o(i),t=o(i);return Array.from({length:r},(s,n)=>n%2==0?e:t)}case 9:{let e=a(i);const t=[];for(let s=0;s<r;s++)(i()<.2||0===e)&&(e=o(i)),t.push(e),i()>.7&&(e=Math.max(0,e-1));return t}case 10:{let e=o(i);const t=[];for(let s=0;s<r;s++)(s%8==0||i()>.6)&&(e=o(i)),t.push(e);return t}default:return l(t)}},h=(s,{loop:n=e.state.isLoopEnabled}={})=>{const i=e.state;if(!i.contextUnlocked||!i.initialShapeBuffered)return;i.sequencePlaying&&y(),i.audioSignaturePlaying&&u(),i._uiReturnShapeKey=s||i._uiReturnShapeKey||t(),i._sigStartShapeKey=i._uiReturnShapeKey;const o=r(i.seed)[s]||1,a=c(i.seed,o);d(a,o),e._loader.textContent=i.isLoopEnabled?`Playing ${s} Audio Signature (Loop).`:`Playing AudioGNARL ${s} Signature ID...`},d=(n,i=1,{onComplete:o=null}={})=>{const a=e.state;a.audioSignaturePlaying&&u();const r="string"==typeof a.current&&a.current?a.current:null;a._uiReturnShapeKey=r||a._uiReturnShapeKey||t(),a._sigStartShapeKey=a._uiReturnShapeKey,a.audioSignaturePlaying=!0,a.audioSignatureStepIndex=0,a.audioSignatureOnComplete=o,e._updateControls({isAudioSignaturePlaying:!0});const l=3===i||7===i?100:5===i?150:10===i?200:125,c=()=>{const i=e.state;if(!i.audioSignaturePlaying)return;const o=i.audioSignatureStepIndex,a=n[o];if(null!==a){const n=0===a?t():s()[a-1];n&&e._onShapeChange({detail:{shapeKey:n}})}if(i.audioSignatureStepIndex++,i.audioSignatureStepIndex>=n.length){const s=()=>{i.audioSignaturePlaying=!1,i.audioSignatureTimer=null,e._updateControls({isAudioSignaturePlaying:!1});const t=i.audioSignatureOnComplete;i.audioSignatureOnComplete=null,"function"==typeof t?t():e._loader.textContent="Signature complete."};i.isLoopEnabled?(i.audioSignatureStepIndex=0,i.audioSignatureTimer=setTimeout(c,l)):((()=>{const s=e.state;try{e.cleanupHotkeyTour?.()}catch{}if(s.isLatchOn){s.isLatchOn=!1;try{e._pathRec?.setLatch?.(!1)}catch{}e._updateControls()}const n=t(),i=s._sigStartShapeKey||s._uiReturnShapeKey||n;try{e.setActiveChain(n,{updateCanvasShape:!1,setStateCurrent:!0,syncCanvasPlayState:!1})}catch{}try{e._canvas&&(e._canvas.isPlaying=!1)}catch{}try{const t=i===n?null:s.presets?.[i]||null;e._canvas&&Object.assign(e._canvas,{shapeKey:i,preset:t,mode:"live"}),e._updateControls({shapeKey:i})}catch{}s._uiReturnShapeKey=i,s._sigStartShapeKey=null})(),i.audioSignatureTimer=setTimeout(s,l))}else i.audioSignatureTimer=setTimeout(c,l)};c()},u=()=>{const s=e.state;s.audioSignatureTimer&&(clearTimeout(s.audioSignatureTimer),s.audioSignatureTimer=null);try{e.cleanupHotkeyTour?.()}catch{}if(s.audioSignaturePlaying=!1,s.audioSignatureStepIndex=0,e._updateControls({isAudioSignaturePlaying:!1}),s.isLatchOn){s.isLatchOn=!1;try{e._pathRec?.setLatch?.(!1)}catch{}e._updateControls()}const n=t(),i=s._sigStartShapeKey||s._uiReturnShapeKey||n;try{e.setActiveChain(n,{updateCanvasShape:!1,setStateCurrent:!0,syncCanvasPlayState:!1})}catch{}try{e._canvas&&(e._canvas.isPlaying=!1)}catch{}try{const t=i===n?null:s.presets?.[i]||null;e._canvas&&Object.assign(e._canvas,{shapeKey:i,preset:t,mode:"live"}),e._updateControls({shapeKey:i})}catch{}s._uiReturnShapeKey=i,s._sigStartShapeKey=null,s.audioSignatureOnComplete=null},p=async()=>{const i=e.state;if(i.signatureSequencerRunning)return;i.signatureSequencerRunning=!0,u();const o=r(i.seed),a=async()=>{if(i.signatureSequencerRunning)for(let a=0;a<i.sequence.length;a++){if(!i.signatureSequencerRunning)return;i.sequenceStepIndex=a,_();const r=i.sequence[a];if(null===r||"number"!=typeof r||r<0){await e._sleep(Math.max(50,i.stepTime));continue}let l=null;if(0===r?l=t():r>=1&&r<=n()&&(l=s()[r-1]),!l){await e._sleep(Math.max(50,i.stepTime));continue}const h=o[l]||1,u=c(i.seed,h);if(await new Promise(e=>{i.signatureSequencerRunning?d(u,h,{onComplete:()=>e()}):e()}),!i.signatureSequencerRunning)return;await e._sleep(Math.max(30,i.stepTime))}};if(await a(),i.signatureSequencerRunning){if(i.isLoopEnabled&&i.sequencePlaying)for(;i.signatureSequencerRunning&&i.sequencePlaying&&i.isLoopEnabled;)await a();g(),e._sequencerComponent?.stopSequence?.()}},g=()=>{const t=e.state;t.signatureSequencerRunning=!1,u(),t.sequencePlaying=!1,t.sequenceStepIndex=0,t._seqFirstCycleStarted=!1,_(),t._uiReturnShapeKey?e._updateControls({shapeKey:t._uiReturnShapeKey}):e._updateControls()},_=()=>{e._sequencerComponent&&e._sequencerComponent.updateState?.({isRecording:e.state.isRecording,currentRecordSlot:e.state.currentRecordSlot,sequence:[...e.state.sequence],velocities:[...e.state.velocities],sequencePlaying:e.state.sequencePlaying,sequenceStepIndex:e.state.sequenceStepIndex,stepTime:e.state.stepTime,isLoopEnabled:e.state.isLoopEnabled,isSequenceSignatureMode:e.state.isSequenceSignatureMode,steps:e.state.sequenceSteps})},y=()=>{e._sequencerComponent?.stopSequence();const t=e.state;t.signatureSequencerRunning&&g(),t.audioSignaturePlaying&&u(),t.sequencePlaying=!1,t.sequenceStepIndex=0,t._seqFirstCycleStarted=!1,_(),e._updateControls()};return{_onToggleSequencer:()=>{const t=e.state;t.isSequencerMode=!t.isSequencerMode,e._sequencerComponent&&(e._sequencerComponent.style.display=t.isSequencerMode?"block":"none"),t.isSequencerMode?_():(t.isRecording=!1,t.currentRecordSlot=-1,t.sequencePlaying&&y(),t.signatureSequencerRunning&&g()),e._updateControls({sequencerVisible:t.isSequencerMode}),"function"==typeof e._fitLayout&&e._fitLayout()},_onLoopToggle:()=>{const t=e.state;t.isLoopEnabled=!t.isLoopEnabled,e._updateControls();try{e._pathRec?.setLoop?.(t.isLoopEnabled)}catch{}},_onSignatureModeToggle:()=>{const t=e.state;t.isSequenceSignatureMode=!t.isSequenceSignatureMode,e._updateControls(),t.sequencePlaying&&y(),t.audioSignaturePlaying&&u()},_getUniqueAlgorithmMapping:r,generateAudioSignature:c,_generateSignatureWithConstraints:l,_onAudioSignature:()=>{const s=e.state;if(s.audioSignaturePlaying)return u(),void e._updateControls({isAudioSignaturePlaying:!1});if(!s.contextUnlocked||!s.initialShapeBuffered)return;const n=s._uiReturnShapeKey||s.current||t();h(n,{loop:s.isLoopEnabled}),e._updateControls({isAudioSignaturePlaying:!0})},_triggerSignatureFor:h,playAudioSignature:d,stopAudioSignature:u,_onSeqRecordStart:t=>{const s=t?.detail?.slotIndex??-1;e.state.isRecording=!0,e.state.currentRecordSlot=s,e._updateControls()},_onSeqStepCleared:t=>{const s=t?.detail?.slotIndex;if("number"!=typeof s)return;const n=e.state;n.sequence[s]=null,n.isRecording&&n.currentRecordSlot===s&&(n.currentRecordSlot=(s+1)%8,0===n.currentRecordSlot&&(n.isRecording=!1))},_onSeqStepRecorded:t=>{const s=t?.detail??{};"number"==typeof s.slotIndex&&(e.state.sequence[s.slotIndex]=s.value),"number"==typeof s.nextSlot&&(e.state.currentRecordSlot=s.nextSlot),"boolean"==typeof s.isRecording&&(e.state.isRecording=s.isRecording)},_onSeqPlayStarted:t=>{const s=t?.detail?.stepTime,n=e.state;n.sequencePlaying=!0,n.sequenceStepIndex=0,n._seqFirstCycleStarted=!1,n.isSequencerMode=!0,"number"==typeof s&&(n.stepTime=s),e._updateControls(),n.isSequenceSignatureMode&&(e._sequencerComponent?.stopSequence(),p())},_onSeqPlayStopped:()=>{const s=e.state;if(s.sequencePlaying=!1,s.sequenceStepIndex=0,s._seqFirstCycleStarted=!1,s.isSequencerMode=!1,s.signatureSequencerRunning&&g(),!s.isLatchOn)try{const s=t();e._updateControls({shapeKey:s}),e._onShapeChange({detail:{shapeKey:s}})}catch{}e._updateControls()},_onSeqStepAdvance:i=>{if(e.state.isSequenceSignatureMode)return;const o=i?.detail||{},a=e.state,r="number"==typeof o.stepIndex?o.stepIndex:"number"==typeof o.index?o.index:a.sequenceStepIndex,l=o.value;if(a.sequencePlaying&&0===r)if(a._seqFirstCycleStarted){if(!a.isLoopEnabled)return void y()}else a._seqFirstCycleStarted=!0;if(a.sequenceStepIndex=r,null!=l&&0!==l){if(l>=1&&l<=n()){const t=s()[l-1];e._updateControls({shapeKey:t}),e._onShapeChange({detail:{shapeKey:t}})}}else if(!a.isLatchOn){const s=t();e._updateControls({shapeKey:s}),e._onShapeChange({detail:{shapeKey:s}})}},_onSeqStepTimeChanged:t=>{const s=t?.detail?.stepTime;"number"==typeof s&&(e.state.stepTime=s)},_onSeqStepsChanged:t=>{const s=t?.detail?.steps;if("number"==typeof s&&s>0){const t=e.state;if(t.sequenceSteps=s,s!==t.sequence.length){const e=[...t.sequence],n=[...t.velocities||[]];t.sequence=Array.from({length:s},(t,s)=>e[s]??null),t.velocities=Array.from({length:s},(e,t)=>n[t]??1)}_()}},_startSignatureSequencer:p,_stopSignatureSequencer:g,updateSequencerState:_,recordStep:t=>{e._sequencerComponent?.recordStep(t)},playSequence:()=>{e._sequencerComponent?.playSequence()},stopSequence:y}}(this));const e=(this.getAttribute("seed")||"").trim(),t=(document.documentElement?.dataset?.seed||"").trim(),s=e||t||"default";this.state=this.defaultState(s),["_onToneReady","_onStartRequest","_onMuteToggle","_onShapeChange","_onToggleSequencer","_onAudioSignature","_handleSeedSubmit","_onSeqRecordStart","_onSeqStepCleared","_onSeqStepRecorded","_onSeqPlayStarted","_onSeqPlayStopped","_onSeqStepAdvance","_onSeqStepTimeChanged","_onSeqStepsChanged","_onLoopToggle","_onSignatureModeToggle","_onVolumeChange","_onHotkeyPress","_onHotkeyRelease","_onHotkeyLoopToggle","_onHotkeySignatureToggle","_onLatchToggle","_fitLayout","_onWindowResize","_onShapeStep","_onHotkeyToggleSeqPlay","_onHotkeyTogglePower","_onToggleControls","_initControlsVisibility","_onFreestyleReadyToggle","_onFreestylePlay","_onSaveState","_onLoadState","_onNextSeed","_onApproveSeed","_onRejectSeed"].forEach(e=>this[e]=this[e].bind(this))}_onToneReady(){const e=this.state;e.Tone=window.Tone,this.loadPresets(e.seed),this.bufferHumChain();const t=this.shapes[this._rng(e.seed)()*this.shapes.length|0];e.uiHomeShapeKey=t,this._setCanvas({preset:e.presets[t],shapeKey:t,mode:"seed"}),e.current=this.humKey,this._controls.disableAll?.(!1);const s=e.Tone?.Destination?.volume;s&&(s.value=this._linToDb(e.volume)),this._updateControls(),this._fitLayout()}attributeChangedCallback(e,t,s){if("seed"!==e)return;const n=(s||"").trim();!n||n===this.state.seed||this.resetToSeed(n)}defaultState(e="default"){return{isPlaying:!1,contextUnlocked:!1,initialBufferingStarted:!1,initialShapeBuffered:!1,Tone:null,chains:{},current:null,isMuted:!1,isLoopEnabled:!1,volume:.2,isSequencerMode:!1,isRecording:!1,currentRecordSlot:-1,sequence:Array(8).fill(null),velocities:Array(8).fill(1),sequencePlaying:!1,sequenceIntervalId:null,sequenceStepIndex:0,stepTime:200,_seqFirstCycleStarted:!1,sequenceSteps:8,isSequenceSignatureMode:!1,signatureSequencerRunning:!1,audioSignaturePlaying:!1,audioSignatureTimer:null,audioSignatureStepIndex:0,audioSignatureOnComplete:null,isLatchOn:!1,seed:e,presets:{},uiHomeShapeKey:null,_transientOverride:!1,isFreestyleMode:!1,isFreestyleRecording:!1,freestyleRecording:null,freestylePlayback:!1,approvedSeeds:[],seedList:[],seedListIndex:0,seedListLoaded:!1}}connectedCallback(){const e=this.createElement?.bind(this)??((e,t={})=>{const s=document.createElement(e);for(const e in t)"textContent"===e?s.textContent=t[e]:s.setAttribute(e,t[e]);return s}),t=e("div",{id:"appWrapper"}),s=this._main=e("div",{id:"main"}),n=this._canvasContainer=e("div",{id:"canvasContainer"});this._canvas=e("scope-canvas"),n.appendChild(this._canvas),this._setupCanvasClickGrid(),this._renderPowerOverlay(),this._controls=e("osc-controls");const i=[{value:this.humKey,label:this.humLabel},...this.shapes.map(e=>({value:e,label:this.shapeLabels[e]||e}))];this._controls.setShapes(i),this._hotkeys=e("osc-hotkeys"),this._hotkeys.setConfig({humKey:this.humKey,shapes:this.shapes}),s.appendChild(this._hotkeys),c(this._hotkeys,[["hk-press",this._onHotkeyPress],["hk-release",this._onHotkeyRelease],["hk-toggle-loop",this._onHotkeyLoopToggle],["hk-toggle-signature",this._onHotkeySignatureToggle],["hk-shape-step",this._onShapeStep],["hk-toggle-mute",this._onMuteToggle],["hk-toggle-sequencer",this._onToggleSequencer],["hk-audio-signature",this._onAudioSignature],["hk-toggle-latch",this._onLatchToggle],["hk-toggle-seq-play",this._onHotkeyToggleSeqPlay],["hk-toggle-power",this._onHotkeyTogglePower],["fr-toggle",this._onFreestyleReadyToggle],["fr-play",this._onFreestylePlay],["save-state",this._onSaveState],["load-state",this._onLoadState]]),this._buildGridMap=()=>{const e=(e,t)=>`${e},${t}`,t=[[0,0],[0,4],[4,0],[4,4]],s=new Set(t.map(([t,s])=>e(t,s))),n=[];for(let e=0;e<5;e++)n.push([0,e]);for(let e=1;e<5;e++)n.push([e,4]);for(let e=3;e>=0;e--)n.push([4,e]);for(let e=3;e>=1;e--)n.push([e,0]);const i=[];for(let e=1;e<=3;e++)for(let t=1;t<=3;t++)i.push([e,t]);const o=new Set,a=[].concat(n,i).filter(([t,n])=>{const i=e(t,n);return!s.has(i)&&!o.has(i)&&(o.add(i),!0)}),r=this.shapes.slice(0,18),l=new Map;for(let t=0;t<a.length;t++){const[s,n]=a[t];l.set(e(s,n),{type:"shape",shapeKey:r[t%r.length]})}t.forEach(([t,s])=>l.set(e(t,s),{type:"hum",shapeKey:this.humKey})),this._grid25={map:l,cellInfo:(t,s)=>l.get(e(t,s))||null}},this._buildGridMap(),this._pathRec=document.createElement("path-rec-app"),this.shadowRoot.appendChild(this._pathRec),this._frLastCell=null,this._frCanvas=document.createElement("canvas"),Object.assign(this._frCanvas.style,{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none"}),n.appendChild(this._frCanvas),this._frCtx=this._frCanvas.getContext("2d"),this._drawFrOverlay=()=>{const e=this._frCtx;if(e){e.clearRect(0,0,this._frCanvas.width,this._frCanvas.height);try{(this.state?.isFreestyleMode||this.state?.freestylePlayback||this.state?.isFreestyleRecording)&&this._pathRec?.renderOverlay(e)}catch{}}requestAnimationFrame(this._drawFrOverlay)},this._resizeFrCanvas(),requestAnimationFrame(this._drawFrOverlay),this._pathRec.addEventListener("fr-armed",()=>{this.state.isFreestyleMode=!0,this._updateControls()}),this._pathRec.addEventListener("fr-disarmed",()=>{this.state.isFreestyleMode=!1,this._updateControls()}),this._pathRec.addEventListener("fr-record-started",()=>{this.state.isFreestyleRecording=!0,this._updateControls()}),this._pathRec.addEventListener("fr-record-stopped",()=>{this.state.isFreestyleRecording=!1,this.state.freestyleRecording=this._pathRec.getRecording(),this._updateControls()}),this._pathRec.addEventListener("fr-cleared",()=>{this.state.freestyleRecording=null,this._updateControls()}),this._pathRec.addEventListener("fr-play-started",()=>{this.state.freestylePlayback=!0,this._updateControls()}),this._pathRec.addEventListener("fr-play-stopped",()=>{this.state.freestylePlayback=!1,this._updateControls(),this._frLastCell&&(this._releaseCell(this._frLastCell),this._frLastCell=null)}),this._pathRec.addEventListener("fr-play-input",e=>{const{x:t,y:s,type:n}=e.detail||{},i=this._cellFromNorm(t,s);this._handleFreestyleInput(i,n)}),this._sequencerComponent=e("seq-app"),this._sequencerComponent.style.display="none",this._loader=e("div",{id:"loader",textContent:"..."}),s.append(n,this._controls,this._sequencerComponent,this._loader),t.append(s),this.shadowRoot.append(e("style",{textContent:this._style()}),e("tone-loader"),t),this._main.style.overflow="hidden",this._controls.setSeed?.(this.state.seed),this.shadowRoot.querySelector("tone-loader").addEventListener("tone-ready",this._onToneReady),c(this._controls,[["start-request",this._onStartRequest],["mute-toggle",this._onMuteToggle],["shape-change",this._onShapeChange],["toggle-sequencer",this._onToggleSequencer],["audio-signature",this._onAudioSignature],["latch-toggle",this._onLatchToggle],["loop-toggle",this._onLoopToggle],["signature-mode-toggle",this._onSignatureModeToggle],["volume-change",this._onVolumeChange],["seed-set",this._handleSeedSubmit],["controls-resize",this._fitLayout],["fr-toggle",this._onFreestyleReadyToggle],["fr-play",this._onFreestylePlay],["save-state",this._onSaveState],["load-state",this._onLoadState],["next-seed",this._onNextSeed],["approve-seed",this._onApproveSeed],["reject-seed",this._onRejectSeed]]),this._canvas.onIndicatorUpdate=e=>{this._loader.textContent=this.state.isPlaying||this.state.contextUnlocked?e:"Initializing...",this._fitLayout()},this._seqPairs=[["seq-record-start",this._onSeqRecordStart],["seq-step-cleared",this._onSeqStepCleared],["seq-step-recorded",this._onSeqStepRecorded],["seq-play-started",this._onSeqPlayStarted],["seq-play-stopped",this._onSeqPlayStopped],["seq-step-advance",this._onSeqStepAdvance],["seq-step-time-changed",this._onSeqStepTimeChanged],["seq-steps-changed",this._onSeqStepsChanged]],c(this._sequencerComponent,this._seqPairs),this._fitLayout(),setTimeout(this._fitLayout,50),setTimeout(this._fitLayout,250),r(window,"resize",this._onWindowResize,{passive:!0}),r(window,"orientationchange",this._onWindowResize,{passive:!0});try{this._resizeObserver=new ResizeObserver(this._fitLayout),this._controls&&this._resizeObserver.observe(this._controls),this._sequencerComponent&&this._resizeObserver.observe(this._sequencerComponent);const e=this.shadowRoot.getElementById("loader");e&&this._resizeObserver.observe(e)}catch{}}_onToggleControls(){const e=this._controls;if(!e)return;const t="none"===e.style.display;e.style.display=t?"flex":"none";try{this._fitLayout()}catch{}try{e.dispatchEvent(new Event("controls-resize"))}catch{}}_initControlsVisibility(){this._controls&&(this._controls.style.display="none"),this._hotkeys&&this._hotkeys.addEventListener("hk-toggle-controls",this._onToggleControls)}disconnectedCallback(){if(h(this._hotkeys,[["hk-press",this._onHotkeyPress],["hk-release",this._onHotkeyRelease],["hk-toggle-loop",this._onHotkeyLoopToggle],["hk-toggle-signature",this._onHotkeySignatureToggle],["hk-shape-step",this._onShapeStep],["hk-toggle-mute",this._onMuteToggle],["hk-toggle-sequencer",this._onToggleSequencer],["hk-audio-signature",this._onAudioSignature],["hk-toggle-latch",this._onLatchToggle],["hk-toggle-seq-play",this._onHotkeyToggleSeqPlay],["hk-toggle-power",this._onHotkeyTogglePower],["fr-toggle",this._onFreestyleReadyToggle],["fr-play",this._onFreestylePlay],["save-state",this._onSaveState],["load-state",this._onLoadState]]),this._sequencerComponent&&h(this._sequencerComponent,this._seqPairs||[]),this._resizeObserver){try{this._resizeObserver.disconnect()}catch{}this._resizeObserver=null}l(window,"resize",this._onWindowResize),l(window,"orientationchange",this._onWindowResize)}_updateControls(e={}){const t=this._controls;if(!t)return;const s={...this.state,...e};s.contextUnlocked&&this._removePowerOverlay(),"function"==typeof t.updateState&&t.updateState(s),this.updateHkIcons?.(s),Object.prototype.hasOwnProperty.call(e,"sequencerVisible")&&this._fitLayout();try{const{isFreestyleMode:e,freestyleRecording:n,freestylePlayback:i}=s;t._frReadyBtn&&u(t._frReadyBtn,!!e),t._frPlayBtn&&(t._frPlayBtn.disabled=!n,d(t._frPlayBtn,i?"Stop":"FR Play"))}catch{}}_style(){return"\n      :host{display:block;width:100%;height:100%}\n      #appWrapper{display:flex;flex-direction:column;height:100dvh;padding-bottom:env(safe-area-inset-bottom,0)}\n      #main{width:100%;height:100%;display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;overflow:hidden;background:#000;gap:8px;padding-inline:env(safe-area-inset-left,0) env(safe-area-inset-right,0)}\n      #canvasContainer{flex:0 0 auto;max-width:100%;position:relative;display:flex;flex-direction:column;justify-content:center;align-items:center;transform:none;margin-left:auto;margin-right:auto;aspect-ratio:1/1;box-sizing:border-box}\n      #loader{font-size:.95rem;color:#aaa;min-height:1.3em;text-align:center;font-style:italic;margin:2px 0 8px}\n      @media (max-width:430px){:host{font-size:15px}}\n      @media (max-width:380px){:host{font-size:14px}}\n    "}_safeInsetBottom(){try{const e=document.createElement("div");e.style.cssText="position:fixed;bottom:0;height:0;padding-bottom:env(safe-area-inset-bottom,0px);visibility:hidden;pointer-events:none;",document.documentElement.appendChild(e);const t=parseFloat(getComputedStyle(e).paddingBottom)||0;return e.remove(),t}catch{return 0}}_measureChromeHeights(){const e=this.shadowRoot;if(!e)return{controlsH:0,loaderH:0,seqH:0};const t=e.querySelector("osc-controls"),s=e.getElementById("loader"),n=this._sequencerComponent,i=e=>e?e.getBoundingClientRect().height:0;return{controlsH:i(t),loaderH:i(s),seqH:n&&"none"!==n.style.display?i(n):0}}_fitLayout(){try{const e=this._canvasContainer,t=this._canvas,s=this._main;if(!e||!t||!s)return;const n=Math.max(1,window.innerWidth||document.documentElement.clientWidth),i=Math.max(1,window.innerHeight||document.documentElement.clientHeight),{controlsH:o,loaderH:a,seqH:r}=this._measureChromeHeights(),l=Math.max(1,i-o-a-r-this._safeInsetBottom()-10),c=Math.round(Math.max(1,Math.min(n,l)));Object.assign(e.style,{width:`${c}px`,height:`${c}px`,maxWidth:"100%",maxHeight:`calc(100dvh - ${o+a+r+this._safeInsetBottom()+10}px)`,aspectRatio:"1 / 1",boxSizing:"border-box",left:"",transform:""}),Object.assign(t.style,{width:"100%",height:"100%",aspectRatio:"1 / 1",display:"block",touchAction:"none"}),this._resizeFrCanvas?.()}catch(e){console.warn("fitLayout failed",e)}}_onWindowResize(){this._fitLayout()}_onHotkeyToggleSeqPlay(){this.state.sequencePlaying?this.stopSequence?.():this.playSequence?.()}_onSeqPlayStarted(e){const t=e?.detail?.stepTime,s=this.state;s.sequencePlaying=!0,s.sequenceStepIndex=0,s._seqFirstCycleStarted=!1,"number"==typeof t&&(s.stepTime=t),this._updateControls(),s.isSequenceSignatureMode&&(this._sequencerComponent?.stopSequence(),this._startSignatureSequencer())}_onSeqPlayStopped(){const e=this.state;if(e.sequencePlaying=!1,e.sequenceStepIndex=0,e._seqFirstCycleStarted=!1,e.signatureSequencerRunning&&this._stopSignatureSequencer(),!e.isLatchOn)try{const e=this.humKey;this._updateControls({shapeKey:e}),this._onShapeChange({detail:{shapeKey:e}})}catch{}this._updateControls()}_onHotkeyTogglePower(){(this.state||{}).isPlaying?this.stopAudioAndDraw?.():this._onStartRequest?.()}_handleSeedSubmit(e){const t=e?.detail?.value&&String(e.detail.value).trim()||(this.getAttribute("seed")||"").trim()||(document.documentElement?.dataset?.seed||"").trim()||"default";!t||t===this.state.seed||(this.resetToSeed(t),this._controls.setSeed?.(t))}resetToSeed(e){const{seedList:t,seedListIndex:s,seedListLoaded:n,approvedSeeds:i}=this.state;this.stopAudioAndDraw(),this.state.seed=e,this.setAttribute("seed",e),document?.documentElement&&(document.documentElement.dataset.seed=e),this.loadPresets(e),this.resetState?this.resetState():this.state=this.defaultState(e),this.state.seedList=t,this.state.seedListIndex=s,this.state.seedListLoaded=n,this.state.approvedSeeds=i,this._controls.setSeed?.(e),this._loader.textContent="Seed updated. Click POWER ON.",this._fitLayout()}_generateRandomSeed(){return Math.random().toString(36).substring(2,10)}_onNextSeed(){const e=this._generateRandomSeed();this._loader.textContent=`Loading new random seed: ${e}...`,this.resetToSeed(e),setTimeout(()=>{this._onStartRequest()},150)}_onApproveSeed(){const{seed:e,approvedSeeds:t}=this.state;e&&!t.includes(e)&&(this.state.approvedSeeds.push(e),this._controls.updateApprovedSeeds(this.state.approvedSeeds),console.log("Approved seeds:",this.state.approvedSeeds)),this._onNextSeed()}_onRejectSeed(){this._onNextSeed()}_renderPowerOverlay(){try{const e=this.state,t=this._canvasContainer||this._main||this.shadowRoot?.host||document.body;if(!t)return;if(e?.contextUnlocked)return void this._removePowerOverlay();if(this._powerOverlay)return;const s=Object.assign(document.createElement("div"),{id:"powerOverlay"});Object.assign(s.style,{position:"absolute",inset:"0",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"20",pointerEvents:"auto",background:"rgba(0,0,0,.55)",userSelect:"none",cursor:"pointer",fontFamily:"'Courier New', monospace"});const i=this._canvasContainer||this._main;i&&"static"===getComputedStyle(i).position&&(i.style.position="relative"),(this._canvasContainer||this._main||t).appendChild(s),this._powerOverlay=s,s.addEventListener("click",()=>this._onStartRequest?.())}catch(e){console.error("overlay error",e)}}_removePowerOverlay(){this._powerOverlay?.parentNode?.removeChild(this._powerOverlay),this._powerOverlay=null}_setupCanvasClickGrid(){const e=this._canvas;if(!e||this._canvasClickGridSetup)return;this._canvasClickGridSetup=!0;const t=t=>{const s=e.getBoundingClientRect(),n=Math.max(0,Math.min(s.width,(t.clientX??0)-s.left)),i=Math.max(0,Math.min(s.height,(t.clientY??0)-s.top)),o=Math.min(4,Math.max(0,Math.floor(n/(s.width/5)))),a=Math.min(4,Math.max(0,Math.floor(i/(s.height/5)))),r=this._grid25?.cellInfo(a,o);return{row:a,col:o,info:r,xNorm:s.width>0?n/s.width:0,yNorm:s.height>0?i/s.height:0}},s=(e,t,s)=>{const n=`r${e}c${t}`,i=s?.shapeKey||this.humKey,o=i===this.humKey?-1:this.shapes.indexOf(i);this._heldKeys.add(n);const a={key:n,idx:o,shapeKey:i,variant:s?.variant||null};this._onHotkeyPress({detail:a})},n=e=>{this._onHotkeyRelease({detail:{key:e}})};this._onCanvasPointerDown=e=>{if(this.state?.contextUnlocked)try{this._isCanvasPointerDown=!0;try{e.target?.setPointerCapture?.(e.pointerId)}catch{}const{row:n,col:i,info:o,xNorm:a,yNorm:r}=t(e);if(this.state?.isFreestyleMode&&!this.state?.isSequencerMode)try{this._pathRec?.arm?.(),this._pathRec?.inputPointer?.("down",a,r,performance.now())}catch{}this._lastPointerKey=`r${n}c${i}`,this._lastPointerInfo=o||null,s(n,i,o)}catch(e){console.error("canvas grid down error",e)}else{try{this.unlockAudioAndBufferInitial?.()}catch{}e?.preventDefault?.()}},this._onCanvasPointerMove=e=>{if(this._isCanvasPointerDown&&this.state?.contextUnlocked)try{const{row:i,col:o,info:a,xNorm:r,yNorm:l}=t(e);if(this.state?.isFreestyleMode&&!this.state?.isSequencerMode)try{this._pathRec?.inputPointer?.("move",r,l,performance.now())}catch{}const c=`r${i}c${o}`;if(c!==this._lastPointerKey){const e=this._lastPointerKey;this._lastPointerKey=c,this._lastPointerInfo=a||null,e&&n(e),s(i,o,a)}}catch(e){console.error("canvas grid move error",e)}},this._onCanvasPointerUp=t=>{try{this._isCanvasPointerDown=!1,t?.target?.releasePointerCapture?.(t.pointerId)}catch{}if(this.state?.isFreestyleMode&&!this.state?.isSequencerMode)try{const s=e.getBoundingClientRect(),n=Math.max(0,Math.min(s.width,(t?.clientX??0)-s.left)),i=Math.max(0,Math.min(s.height,(t?.clientY??0)-s.top)),o=s.width>0?n/s.width:0,a=s.height>0?i/s.height:0;this._pathRec?.inputPointer?.("up",o,a,performance.now())}catch{}if(!this._lastPointerKey)return;const s=this._lastPointerKey;this._lastPointerKey=null,this._lastPointerInfo=null,n(s)},this._onCanvasPointerCancel=()=>{if(this._isCanvasPointerDown=!1,this.state?.isFreestyleMode&&!this.state?.isSequencerMode)try{this._pathRec?.inputPointer?.("up",0,0,performance.now())}catch{}if(this._lastPointerKey){const e=this._lastPointerKey;this._lastPointerKey=null,this._lastPointerInfo=null,n(e)}},c(e,[["pointerdown",this._onCanvasPointerDown],["pointermove",this._onCanvasPointerMove],["pointercancel",this._onCanvasPointerCancel],["pointerleave",this._onCanvasPointerUp]]),r(window,"pointerup",this._onCanvasPointerUp)}_onHotkeyLoopToggle(){this._onLoopToggle()}_onHotkeySignatureToggle(){this._onSignatureModeToggle()}_onHotkeyPress({detail:e}){const t=this.state,{key:s,idx:n,shapeKey:i,variant:o}=e||{};i&&(t._transientOverride=o||null,t.isSequenceSignatureMode?this._triggerSignatureFor(i,{loop:t.isLoopEnabled}):(this._heldKeys.add(s),t.isSequencerMode,t.contextUnlocked&&t.initialShapeBuffered&&(()=>{this.setActiveChain(i),t._transientOverride&&this.applyVariant?.(i,t._transientOverride),n>=0&&this._setCanvas({shapeKey:i,preset:t.presets[i],mode:"live"}),this._canvas.isPlaying=!0,this._updateControls({shapeKey:i}),t.current=i,i!==this.humKey&&(t._uiReturnShapeKey=i)})()))}_onHotkeyRelease({detail:e}){const t=this.state,{key:s}=e||{};this._heldKeys?.has(s)&&(this._heldKeys.delete(s),this._recordedThisHold?.delete?.(s),t._transientOverride&&t.current&&t.current!==this.humKey&&this.applyVariant?.(t.current,null),t._transientOverride=null,!t.isLatchOn&&t.contextUnlocked&&t.initialShapeBuffered&&(this.setActiveChain(this.humKey,{updateCanvasShape:!1,setStateCurrent:!1}),this._canvas.isPlaying=!1,t._uiReturnShapeKey?this._updateControls({shapeKey:t._uiReturnShapeKey}):this._updateControls()))}_onShapeStep({detail:e}){const t=e?.direction;if(!t||!this.shapes.length)return;const s=this.state,n=this.shapes,i=s._uiReturnShapeKey||s.current;let o=n.indexOf(i);-1===o&&(o=1===t?-1:0);const a=n[(o+t+n.length)%n.length];s.contextUnlocked&&s.initialShapeBuffered&&(this.setActiveChain(a),this._setCanvas({shapeKey:a,preset:s.presets[a],mode:"live"}),this._canvas.isPlaying=!0,this._updateControls({shapeKey:a}),s.current=s._uiReturnShapeKey=a)}_onFreestyleReadyToggle(){const e=this.state||{},t=!e.isFreestyleMode;e.isFreestyleMode=t;try{t?this._pathRec?.arm?.():this._pathRec?.disarm?.()}catch{}this._updateControls()}_onFreestylePlay(){const e=this.state||{};try{e.freestylePlayback?this._pathRec?.stop?.():e.freestyleRecording&&this._pathRec?.play?.(e.freestyleRecording,{loop:!!e.isLoopEnabled})}catch{}}_cellFromNorm(e,t){const s=Math.min(4,Math.max(0,Math.floor(5*t))),n=Math.min(4,Math.max(0,Math.floor(5*e)));return{row:s,col:n,info:this._grid25?.cellInfo(s,n)||null}}_resizeFrCanvas(){const e=this._frCanvas;if(!e)return;const t=(this._canvasContainer||this._canvas||e.parentElement).getBoundingClientRect(),s=Math.max(1,Math.round(window.devicePixelRatio||1)),n=Math.max(1,Math.round(t.width*s)),i=Math.max(1,Math.round(t.height*s));e.width===n&&e.height===i||(e.width=n,e.height=i,e.style.width="100%",e.style.height="100%")}_pressCell(e){if(!e)return;const{row:t,col:s,info:n}=e,i=`r${t}c${s}`,o=n?.shapeKey||this.humKey,a=o===this.humKey?-1:this.shapes.indexOf(o);this._heldKeys.add(i);const r={key:i,idx:a,shapeKey:o,variant:n?.variant||null};this._onHotkeyPress({detail:r})}_releaseCell(e){if(!e)return;const t="string"==typeof e?e:`r${e.row}c${e.col}`;this._onHotkeyRelease({detail:{key:t}})}_handleFreestyleInput(e,t){e&&("down"===t?(!this._frLastCell||this._frLastCell.row===e.row&&this._frLastCell.col===e.col||this._releaseCell(this._frLastCell),this._pressCell(e),this._frLastCell=e):"move"===t?this._frLastCell&&this._frLastCell.row===e.row&&this._frLastCell.col===e.col||(this._frLastCell&&this._releaseCell(this._frLastCell),this._pressCell(e),this._frLastCell=e):"up"===t&&this._frLastCell&&(this._releaseCell(this._frLastCell),this._frLastCell=null))}_onLatchToggle(){this.state.isLatchOn=!this.state.isLatchOn,this._updateControls();const e=this.state;e.isLatchOn||e.isSequencerMode||this._heldKeys?.size||!e.contextUnlocked||!e.initialShapeBuffered||(this.setActiveChain(this.humKey,{updateCanvasShape:!1,setStateCurrent:!1}),this._canvas.isPlaying=!1)}async _onSaveState(){try{const e={...this.state,Tone:void 0,chains:void 0,audioSignatureTimer:void 0,sequenceIntervalId:void 0,keyboardSynth:void 0,sequencerState:this._sequencerComponent?{steps:this._sequencerComponent.steps,state:this._sequencerComponent.state}:null,pathRecorderState:this._pathRec?{recording:this._pathRec.getRecording(),isArmed:this._pathRec._armed,loop:this._pathRec._loop}:null,uiState:{sequencerVisible:"none"!==this._sequencerComponent?.style.display,currentShapeKey:this.state.current,volume:this.state.volume,seed:this.state.seed},saveTimestamp:(new Date).toISOString(),version:"v19.3"},t=JSON.stringify(e,null,2);if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(t),this._showNotification("State saved to clipboard successfully!","success");else{const e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),this._showNotification("State saved to clipboard (fallback method)","success")}console.log("Saved state:",e)}catch(e){console.error("Error saving state:",e),this._showNotification("Error saving state: "+e.message,"error")}}async _onLoadState(){try{const e=prompt("Paste the JSON state data to load:");if(!e||""===e.trim())return;const t=JSON.parse(e);if(!t||"object"!=typeof t)throw new Error("Invalid state data format");const s=!!this.state?.isPlaying,n=!!this.state?.sequencePlaying;this.state.sequencePlaying&&this._sequencerComponent?.stopSequence(),this.state.freestylePlayback&&this._pathRec?.stop();const i="string"==typeof t.seed?t.seed.trim():"",o="string"==typeof t.uiState?.seed?t.uiState.seed.trim():"",a=i||o||null;a&&this.resetToSeed(a);const r={...this.state};if(["isMuted","isLoopEnabled","volume","isSequencerMode","isRecording","currentRecordSlot","sequence","velocities","sequenceStepIndex","stepTime","sequenceSteps","isSequenceSignatureMode","isLatchOn","uiHomeShapeKey","isFreestyleMode","isFreestyleRecording","freestyleRecording","freestylePlayback","approvedSeeds","seedList","seedListIndex","seedListLoaded","sequencePlaying"].forEach(e=>{t.hasOwnProperty(e)&&(r[e]=t[e])}),Object.assign(this.state,r),a&&(this.state.seed=a),t.sequencerState&&this._sequencerComponent){const e=t.sequencerState;e.steps&&this._sequencerComponent.changeStepCount(e.steps),e.state&&(Object.assign(this._sequencerComponent.state,e.state),this._sequencerComponent.updateSequenceUI(),this._sequencerComponent.updateStepControls())}if(t.pathRecorderState&&this._pathRec){const e=t.pathRecorderState;e.recording&&(this.state.freestyleRecording=e.recording),void 0!==e.loop&&this._pathRec.setLoop(e.loop)}if(t.uiState){const e=t.uiState;void 0!==e.sequencerVisible&&this._sequencerComponent&&(this._sequencerComponent.style.display=e.sequencerVisible?"block":"none",this.state.isSequencerMode=e.sequencerVisible),void 0!==e.volume&&(this.state.volume=e.volume)}a&&this._controls.setSeed?.(a),this._controls.updateApprovedSeeds(this.state.approvedSeeds),this._updateControls(),this._fitLayout();const l=t.hasOwnProperty("sequencePlaying")?!!t.sequencePlaying:n;s&&Promise.resolve(this._onStartRequest?.()).then(()=>{l&&this.playSequence?.()}).catch(e=>console.error("Error restarting audio after load:",e)),this._showNotification("State loaded successfully!","success"),console.log("Loaded state:",t)}catch(e){console.error("Error loading state:",e),this._showNotification("Error loading state: "+e.message,"error")}}_showNotification(e,t="info"){const s=document.createElement("div");s.textContent=e,Object.assign(s.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"6px",color:"#fff",fontFamily:"inherit",fontSize:"14px",zIndex:"10000",maxWidth:"300px",wordWrap:"break-word",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",background:"success"===t?"#4CAF50":"error"===t?"#f44336":"#2196F3"}),document.body.appendChild(s),setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},3e3)}};customElements.define("osc-app",H);var N=class e extends HTMLElement{static VALID_SIZES=[8,16,32,64];static DEFAULT_STEPS=8;static MIN_MS=50;static MAX_MS=2e3;#e=(e,t={})=>this.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0,composed:!0}));#t=()=>this.state.sequence.length;#s=e=>(e+1)%this.#t();#n=()=>this._stepSlotsDiv?.querySelectorAll(".step-slot")??[];#i=e=>this.state.velocities?.[e]??1;#o=(e,t)=>this.state.sequence[e]=t;#a=(e,t)=>this.state.velocities[e]=t;#r=e=>this.state.isRecording&&this.state.currentRecordSlot===e;#l=e=>this.state.sequencePlaying&&this.state.sequenceStepIndex===e;#c=(e,t,s="Alt-drag to edit")=>e.title=`Velocity: ${Math.round(100*t)}% (${s})`;#h=t=>e.VALID_SIZES[e.VALID_SIZES.indexOf(this.steps)+t]??null;#d(e){this.steps=e,Object.assign(this.state,{sequence:Array(e).fill(null),velocities:Array(e).fill(1),sequenceStepIndex:0})}#u(){const e=e=>this.shadowRoot.getElementById(e);this._stepSlotsDiv=e("stepSlots"),this._playBtn=e("playBtn"),this._stepTimeInput=e("stepTimeInput"),this._addBlockBtn=e("addBlockBtn"),this._removeBlockBtn=e("removeBlockBtn"),this._stepInfo=e("stepInfo")}#p(){this._eventListeners||=[];const e=(e,t,s)=>e&&(e.addEventListener(t,s),this._eventListeners.push([e,t,s]));e(this._playBtn,"click",this.handlePlayClick),e(this._stepTimeInput,"change",this.handleStepTimeChange),e(this._stepTimeInput,"input",this.handleStepTimeChange),e(this._stepTimeInput,"focus",()=>this._isEditingStepTime=!0),e(this._stepTimeInput,"blur",()=>{this._isEditingStepTime=!1,this.handleStepTimeChange()}),e(this._addBlockBtn,"click",this.handleAddBlock),e(this._removeBlockBtn,"click",this.handleRemoveBlock)}_applyPendingEdits(){const e=this._pendingEdits||[];if(e.length){for(const t of e)"paint"===t.type?(this.#o(t.i,t.value),this.#e("seq-step-recorded",{slotIndex:t.i,value:t.value,nextSlot:this.#s(t.i),isRecording:!1})):(this.#o(t.i,null),this.#e("seq-step-cleared",{slotIndex:t.i}));this._pendingEdits.length=0,this.updateSequenceUI()}}#g(e,t){if(!this.state.isRecording||e<0||e>=this.#t())return;this._pendingEdits&&(this._pendingEdits=this._pendingEdits.filter(t=>t.i!==e)),this.#o(e,t);const s=this.#s(e);this.state.currentRecordSlot=s,0===s&&(this.state.isRecording=!1),this.updateSequenceUI(),this.#e("seq-step-recorded",{slotIndex:e,value:t,nextSlot:s,isRecording:this.state.isRecording})}#_(e){this.#o(e,null),this.updateSequenceUI(),this.#e("seq-step-cleared",{slotIndex:e})}#y(e,t){this._pendingEdits||=[],this._pendingEdits.push(null==t?{type:"clear",i:e}:{type:"paint",i:e,value:0}),this.#o(e,null==t?null:0),this.updateSequenceUI()}#m(e){const t=null==this.state.sequence[e]?1:null;Object.assign(this._dragState,{painting:!0,mode:"paint",setTo:t,lastIndex:-1}),this.#y(e,t)}#f(e,t){Object.assign(this._dragState,{painting:!0,mode:"velocity",baseVel:this.#i(e),startY:t.clientY,lastIndex:e})}#S(e){const t=this._dragState;t.painting&&"paint"===t.mode&&t.lastIndex!==e&&(t.lastIndex=e,this.#y(e,t.setTo))}#b(e,t,s,n){const i=this._dragState;if(!i.painting||"velocity"!==i.mode)return;this._velocityUpdateThrottle||={};const a=Date.now(),r=this._velocityUpdateThrottle[e];if(r&&a-r<16)return;this._velocityUpdateThrottle[e]=a;const l=o(i.baseVel+(i.startY-t.clientY)/150*(t.shiftKey?.25:1));this.#a(e,l),this.#c(s,l,"Alt-drag"+(t.shiftKey?" + Shift":"")),n.style.height=`${Math.round(100*l)}%`}#v(e){const t=Object.assign(document.createElement("div"),{className:"step-slot"});t.dataset.index=`${e}`;const s=Object.assign(document.createElement("div"),{className:"vel-bar"}),n=Object.assign(document.createElement("div"),{className:"digit"});t.append(s,n),this._slotListeners||=[];const i=(e,s)=>(t.addEventListener(e,s),this._slotListeners.push([t,e,s]));return i("click",()=>this.handleStepClick(e)),i("contextmenu",t=>this.handleStepRightClick(t,e)),i("pointerdown",s=>(s.altKey?this.#f(e,s):this.#m(e),t.setPointerCapture(s.pointerId))),i("pointerenter",()=>this.#S(e)),i("pointermove",n=>this.#b(e,n,t,s)),t}#x(){this.render(),this.#p(),this.updateSequenceUI()}constructor(){super(),this.attachShadow({mode:"open"}),this.state={isRecording:!1,currentRecordSlot:-1,sequence:[],velocities:[],sequencePlaying:!1,sequenceStepIndex:0,stepTime:400},["updateState","updateSequenceUI","recordStep","playSequence","stopSequence","handleStepClick","handleStepRightClick","handlePlayClick","handleStepTimeChange","handleAddBlock","handleRemoveBlock","updateStepControls","_onWindowKeyDown","_onPointerUpGlobal","createSequenceUI","render","changeStepCount"].forEach(e=>this[e]=this[e].bind(this)),this._eventListeners=[],this._slotListeners=[],this._isEditingStepTime=!1,this._audioCtx=null,this._sequenceTargetTime=null,this._sequenceTimeSource=null,this._lastStepDuration=0,this._runSequenceTick=null,this._scheduleSequenceTick=null}_getAudioContext(){if(this._audioCtx&&"currentTime"in this._audioCtx)return this._audioCtx;const e=window.Tone,t=e?.getContext?.()?.rawContext||e?.context?._context||e?.context?._nativeAudioContext||e?.context?.rawContext||e?.context;return t&&"currentTime"in t?this._audioCtx=t:this._audioCtx||null}connectedCallback(){const t=Number(this.getAttribute("steps"))||e.DEFAULT_STEPS;this.#d(e.VALID_SIZES.includes(t)?t:e.DEFAULT_STEPS),this.render(),this.updateSequenceUI(),this.#p(),window.addEventListener("keydown",this._onWindowKeyDown),window.addEventListener("pointerup",this._onPointerUpGlobal),this._globalListeners=[["keydown",this._onWindowKeyDown],["pointerup",this._onPointerUpGlobal]]}disconnectedCallback(){(this._globalListeners||[]).forEach(([e,t])=>window.removeEventListener(e,t)),(this._eventListeners||[]).forEach(([e,t,s])=>e.removeEventListener(t,s)),(this._slotListeners||[]).forEach(([e,t,s])=>e.removeEventListener(t,s)),this._globalListeners=this._eventListeners=this._slotListeners=[],this._seqTimer&&clearTimeout(this._seqTimer),this._tailTimer&&clearTimeout(this._tailTimer),this._velocityUpdateThrottle=null}render(){const t=Math.min(8,this.steps),s=Math.min(320,40*this.steps),{MIN_MS:n,MAX_MS:i}=e;this.shadowRoot.innerHTML=`\n      <style>\n        :host{display:block;text-align:center;width:95%;margin:.8em auto 0;font-family:sans-serif}\n        #stepSlots{display:grid;grid-template-columns:repeat(${t},1fr);gap:.4em;margin:.6em auto .7em;max-width:${s}px;width:100%;justify-content:center;align-content:center;padding:0;border-radius:6px;background:#fff0;box-shadow:0 0 12px #0003}\n        #stepControls{display:flex;align-items:center;justify-content:center;gap:1rem;margin:.5em 0;font-size:.9em}\n        #stepControls button{padding:.3em .8em;border-radius:4px;border:1px solid #666;background:#212;color:#ffe0a3;cursor:pointer;font:inherit;font-size:.9em;transition:background .18s}\n        #stepControls button:hover{background:#323}\n        #stepControls button:disabled{opacity:.5;cursor:not-allowed}\n        #stepInfo{color:#aaa;font-size:.85em}\n        .step-slot{position:relative;width:37px;height:37px;border:1px solid #555;border-radius:6px;background:#232325;display:grid;place-items:center;cursor:pointer;font-weight:700;font-size:1.12rem;user-select:none;transition:background .15s,box-shadow .16s,border-color .16s}\n        .step-slot.record-mode{background:#343;box-shadow:0 0 7px #f7c46988}\n        .step-slot.active{border-color:#7af6ff;box-shadow:0 0 8px #7af6ff88}\n        .step-slot.record-mode.active{background:#575;box-shadow:0 0 12px #f7c469d6}\n        .digit{position:relative;z-index:2;color:#eee}\n        .vel-bar{position:absolute;bottom:0;left:0;width:100%;height:0%;background:#7af6ff55;border-bottom-left-radius:6px;border-bottom-right-radius:6px;pointer-events:none;transition:height .05s linear;z-index:1}\n        #sequenceControls{display:flex;align-items:center;justify-content:center;gap:1.1rem;margin:1.1em 0 0;width:100%}\n        #playBtn{min-width:150px;font-size:1.09rem;padding:.44em 1.4em;border-radius:7px;margin:0;background:#181818;color:#fff;border:2px solid #7af6ff;transition:background .19s,color .19s;box-shadow:0 2px 10px #7af6ff22}\n        #playBtn:hover{background:#212d3d;color:#fff;border-color:#fff}\n        #playBtn:disabled{opacity:.5;cursor:not-allowed;background:#181818;border-color:#555;color:#888}\n        #stepTimeInput{width:60px;margin-left:.7em}\n      </style>\n      <div id="sequencer">\n        <div id="stepControls">\n          <button id="removeBlockBtn">Remove Block (-8)</button>\n          <span id="stepInfo">${this.steps} steps (${this.steps/8} blocks)</span>\n          <button id="addBlockBtn">Add Block (+8)</button>\n        </div>\n        <div id="stepSlots"></div>\n        <div id="sequenceControls">\n          <button id="playBtn">Play Sequence</button>\n          <label for="stepTimeInput" style="margin-left:1.2em;">Step Time (ms):</label>\n          <input type="number" id="stepTimeInput" min="${n}" max="${i}" step="10" value="${this.state.stepTime}"/>\n        </div>\n      </div>`,this.#u(),this.createSequenceUI(),this.updateStepControls()}createSequenceUI(){if(!this._stepSlotsDiv)return;(this._slotListeners||[]).forEach(([e,t,s])=>e.removeEventListener(t,s)),this._slotListeners=[],this._stepSlotsDiv.innerHTML="",this._dragState={painting:!1,mode:null,setTo:null,baseVel:1,startY:0,lastIndex:-1};const e=document.createDocumentFragment();for(let t=0;t<this.steps;t++)e.appendChild(this.#v(t));this._stepSlotsDiv.appendChild(e)}updateState(t={}){if("steps"in t){const s=e.VALID_SIZES.includes(t.steps)?t.steps:this.steps;if(s!==this.steps)return this.#d(s),this.#x()}Object.assign(this.state,t),this.updateSequenceUI()}updateSequenceUI(){if(!this._stepSlotsDiv)return;const{sequence:e,velocities:t,sequencePlaying:s,stepTime:n}=this.state;for(const s of this.#n()){const n=+s.dataset.index,i=e[n],o=s.querySelector(".digit"),a=s.querySelector(".vel-bar"),r=t?.[n]??1;o&&(o.textContent=0===i?"0":i??""),s.classList.toggle("record-mode",this.#r(n)),s.classList.toggle("active",this.#l(n)),a&&(a.style.height=`${Math.round(100*r)}%`),s.title?.startsWith("Velocity:")||this.#c(s,r)}this._playBtn&&(this._playBtn.textContent=s?"Stop Sequence":"Play Sequence",this._playBtn.disabled=!s&&!this.hasPopulatedSteps()),this._stepTimeInput&&!s&&!this._isEditingStepTime&&(this._stepTimeInput.value=n),this.updateStepControls()}handleStepClick(e){this.state.isRecording=!0,this.state.currentRecordSlot=e,this.updateSequenceUI(),this.#e("seq-record-start",{slotIndex:e})}handleStepRightClick(e,t){e.preventDefault(),this._pendingEdits||=[],this._pendingEdits.push({type:"clear",i:t}),this.#o(t,null),this.updateSequenceUI()}handlePlayClick(){this.state.sequencePlaying?this.stopSequence():this.playSequence()}handleStepTimeChange(t){const s=this._stepTimeInput;if(!s)return;const n=s.value.trim();if(!n)return void(!t||"blur"!==t.type&&"change"!==t.type||(s.value=String(this.state.stepTime)));let i=parseInt(n,10);if(Number.isFinite(i)){if(i<e.MIN_MS){if(!t||"blur"!==t.type&&"change"!==t.type)return;i=e.MIN_MS}if(i>e.MAX_MS&&(i=e.MAX_MS),i!==this.state.stepTime){if(this.state.stepTime=i,s.value=String(i),this.#e("seq-step-time-changed",{stepTime:i}),this.state.sequencePlaying&&null!=this._sequenceTargetTime){const t=Math.max(e.MIN_MS,Math.min(e.MAX_MS,i))/1e3,s=this._lastStepDuration||0;s>0&&(this._sequenceTargetTime=this._sequenceTargetTime-s+t),this._lastStepDuration=t,this._seqTimer&&(clearTimeout(this._seqTimer),this._seqTimer=null),this._scheduleSequenceTick?.()}}else s.value=String(i)}}handleAddBlock(){if(!this.state.sequencePlaying){const e=this.#h(1);e&&this.changeStepCount(e)}}handleRemoveBlock(){if(!this.state.sequencePlaying){const e=this.#h(-1);e&&this.changeStepCount(e)}}changeStepCount(t){if(!e.VALID_SIZES.includes(t))return;this.state.isRecording=!1,this.state.currentRecordSlot=-1;const s=[...this.state.sequence],n=[...this.state.velocities];this.steps=t,this.state.sequence=Array(t).fill(null),this.state.velocities=Array(t).fill(1);for(let e=0,i=Math.min(s.length,t);e<i;e++)this.state.sequence[e]=s[e],this.state.velocities[e]=n[e];this.state.sequenceStepIndex>=t&&(this.state.sequenceStepIndex=0),this.#x(),this.#e("seq-steps-changed",{steps:t})}updateStepControls(){this._addBlockBtn&&(this._addBlockBtn.disabled=this.steps>=64||this.state.sequencePlaying),this._removeBlockBtn&&(this._removeBlockBtn.disabled=this.steps<=8||this.state.sequencePlaying),this._stepInfo&&(this._stepInfo.textContent=`${this.steps} steps (${this.steps/8} blocks)`)}_onWindowKeyDown(e){this.state.isRecording&&/^[0-9]$/.test(e.key)&&this.#g(this.state.currentRecordSlot,parseInt(e.key,10))}_onPointerUpGlobal(){this._dragState&&Object.assign(this._dragState,{painting:!1,mode:null,lastIndex:-1})}recordStep(e){this.#g(this.state.currentRecordSlot,e)}hasPopulatedSteps(){return this.state.sequence.some(e=>null!==e)}playSequence(){if(this.state.sequencePlaying||!this.hasPopulatedSteps())return;const e=this._getAudioContext(),t=e?()=>e.currentTime:()=>performance.now()/1e3;this.state.sequencePlaying=!0,this.state.sequenceStepIndex=0,this._sequenceTimeSource=t,this._sequenceTargetTime=t(),this._lastStepDuration=0,this._seqTimer&&(clearTimeout(this._seqTimer),this._seqTimer=null),this.#e("seq-play-started",{stepTime:this.state.stepTime}),this._runSequenceTick=()=>{if(!this.state.sequencePlaying)return;this._seqTimer=null,this._applyPendingEdits();const e=this.state.sequenceStepIndex,t=this.state.sequence[e],s=this.#i(e),n=0===this.#s(e);this.updateSequenceUI(),this.#e("seq-step-advance",{stepIndex:e,index:e,value:t,velocity:s,isLastStep:n}),this.state.sequenceStepIndex=this.#s(e);const i=Math.max(this.constructor.MIN_MS,Math.min(this.constructor.MAX_MS,this.state.stepTime))/1e3;this._lastStepDuration=i,this._sequenceTargetTime+=i,this._scheduleSequenceTick?.()},this._scheduleSequenceTick=()=>{if(!this.state.sequencePlaying)return;const e=this._sequenceTimeSource?this._sequenceTimeSource():performance.now()/1e3,t=this._sequenceTargetTime??e,s=Math.max(0,1e3*(t-e));s<=1?this._runSequenceTick():this._seqTimer=setTimeout(this._runSequenceTick,s)},this._scheduleSequenceTick()}stopSequence(){this.state.sequencePlaying=!1,this._seqTimer&&(clearTimeout(this._seqTimer),this._seqTimer=null),this._tailTimer&&(clearTimeout(this._tailTimer),this._tailTimer=null),this._scheduleSequenceTick=null,this._runSequenceTick=null,this._sequenceTargetTime=null,this._sequenceTimeSource=null,this._lastStepDuration=0,this._applyPendingEdits(),this.state.sequenceStepIndex=0,this.updateSequenceUI(),this.#e("seq-play-stopped",{});const e=Math.max(20,Math.min(this.state.stepTime,200));this._tailTimer=setTimeout(()=>{this.#e("seq-step-advance",{stepIndex:-1,index:-1,value:0,velocity:1,isLastStep:!0}),this._tailTimer=null},e)}};customElements.get("seq-app")||customElements.define("seq-app",N),(()=>{const e=[["m","M","hk-toggle-mute",null,-45,"Mute","mute"],["c","C","hk-toggle-controls",null,-18.75,"Control Buttons","controls"],["q","Q","hk-toggle-sequencer",null,7.5,"Show/Hide Sequencer","sequencer"],["p","P","hk-toggle-seq-play",null,33.75,"Play/Pause Sequence","seq-play"],["f","FR","fr-toggle",null,60,"Freestyle Recording","fr-ready"],["o","PF","fr-play",null,85,"Play Freestyle Recording","fr-playback"],["i","ID","hk-audio-signature",null,0,"AudioGnarl ID","signature"],["s","S","hk-toggle-signature",null,150,"Signature Mode","sig-mode"],["l","L","hk-toggle-loop",null,180,"Looped Playback","loop"],["h","H","hk-toggle-latch",null,-135,"Latch Notes","latch"]],t=(e,t)=>e.querySelector(t),s=(e,t,s)=>{const n=t.getBoundingClientRect(),i=s.getBoundingClientRect(),o=t.dataset.id,a=t.textContent?.trim(),r=n.top-i.top-12+"px",l=`${n.top-i.top+n.height+8}px`;e.style.left=n.left-i.left+n.width/2+"px";const c=["signature","fr-ready","fr-playback"].includes(o)?r:"O"===a?l:n.top-i.top-8+"px",h="O"===a?"translate(-50%,0)":"translate(-50%,-100%)";e.style.top=c,e.style.setProperty("--tooltip-transform",h)};E(async()=>{const n=document.querySelector("osc-app");if(!n)return;if(!await L(()=>n.shadowRoot?.querySelector("#canvasContainer")&&n.shadowRoot?.querySelector("osc-hotkeys")))return;const i=n.shadowRoot,o=t(i,"#canvasContainer"),a=t(i,"osc-hotkeys");"static"===getComputedStyle(o).position&&(o.style.position="relative");const l=document.createElement("div");l.className="hk-ring",l.appendChild(Object.assign(document.createElement("style"),{textContent:'.hk-ring{position:absolute;inset:0;pointer-events:none;z-index:40;--scale:1;--badge:calc(60px*var(--scale));--badge-font:calc(28px*var(--scale));--gap:calc(10px*var(--scale));--ring-outset:calc(28px*var(--scale));--cluster-left:calc(-208px*var(--scale));--cluster-right:calc(208px*var(--scale));--cluster-left-sm:calc(-172px*var(--scale));--cluster-right-sm:calc(172px*var(--scale));transition:opacity .35s ease}\n.hk-ring.is-dormant{opacity:0;pointer-events:none}\n.hk-badge{position:absolute;left:50%;top:50%;width:var(--badge);height:var(--badge);display:flex;align-items:center;justify-content:center;font:700 var(--badge-font)/1 "Courier New",monospace;--hk-bg:rgba(18,22,27,.62);--hk-border:rgba(120,140,170,.45);--hk-color:#b7c6d6;--hk-glow:rgba(120,160,255,.25);--hk-active-bg:#1f3a28;--hk-active-border:#46ad6d;--hk-active-color:#c1f1d7;--hk-active-glow:rgba(70,173,109,.45);background:var(--hk-bg);border:1px solid var(--hk-border);border-radius:999px;box-shadow:0 0 0 1px #000,0 0 0 var(--hk-glow);backdrop-filter:blur(5px);user-select:none;cursor:pointer;letter-spacing:.02em;transition:transform .16s ease-out,box-shadow .2s ease-out,background .2s ease-out,border-color .2s ease-out,opacity .3s ease-out,color .2s ease-out,filter .18s ease-out,visibility .3s ease-out;transform:translate(-50%,-50%) scale(1);touch-action:manipulation;opacity:0;visibility:hidden;pointer-events:none;color:var(--hk-color)}\n.hk-badge.is-visible{opacity:.76;visibility:visible;pointer-events:auto;filter:none}\n.hk-ring:not(.is-controls-hidden) .hk-badge.is-visible{opacity:1;filter:none}\n.hk-badge.is-visible:hover{opacity:1;transform:translate(-50%,-50%) scale(1.1);filter:brightness(1.12) saturate(1.12);box-shadow:0 0 18px var(--hk-glow),0 0 6px rgba(255,255,255,.08)}\n.hk-badge.is-visible:active{transform:translate(-50%,-50%) scale(1.05);filter:brightness(1.05) saturate(1.05)}\n.hk-ring.is-controls-hidden .hk-badge.is-visible{opacity:.23;filter:saturate(.58) brightness(.94)}\n.hk-ring.is-controls-hidden .hk-badge.is-visible[data-active="true"]{opacity:.51;filter:saturate(.82) brightness(.99)}\n.hk-ring.is-controls-hidden .hk-badge.is-visible:hover{opacity:.92;filter:saturate(1.08) brightness(1.15)}\n.hk-ring.is-controls-hidden .hk-badge.is-power{opacity:.68;filter:saturate(.9) brightness(1.03)}\n.hk-badge[data-shift="1"]{border-color:#6b7fad}\n.hk-badge span{display:inline-block}\n.hk-badge[data-disabled="1"]{opacity:.2!important;pointer-events:none!important;filter:grayscale(.45)}\n.hk-badge[data-active="true"]{opacity:1;background:var(--hk-active-bg);border-color:var(--hk-active-border);color:var(--hk-active-color);box-shadow:0 0 18px var(--hk-active-glow),0 0 3px rgba(255,255,255,.12);filter:saturate(1.05);text-shadow:0 1px 2px rgba(0,0,0,.4)}\n.hk-badge.is-power{--hk-bg:rgba(122,22,33,.58);--hk-border:#d34e5a;--hk-color:#ffd5dd;--hk-glow:rgba(255,90,110,.4);--hk-active-bg:#ff3749;--hk-active-border:#ff7484;--hk-active-color:#fff8fa;--hk-active-glow:rgba(255,116,132,.6)}\n.hk-badge[data-id="power"]{--hk-bg:rgba(26,32,30,.42);--hk-border:#4b7a67;--hk-color:#8ddfb5;--hk-glow:rgba(75,122,103,.28);--hk-active-bg:#123621;--hk-active-border:#3ff58b;--hk-active-color:#baffdc;--hk-active-glow:rgba(63,245,139,.6)}\n.hk-badge[data-id="mute"]{--hk-bg:rgba(88,32,62,.55);--hk-border:#b04c87;--hk-color:#ffd1e6;--hk-glow:rgba(224,96,160,.3);--hk-active-bg:#d04587;--hk-active-border:#ff73b0;--hk-active-color:#fff9fd;--hk-active-glow:rgba(255,122,182,.55)}\n.hk-badge[data-id="controls"]{--hk-bg:rgba(26,44,63,.52);--hk-border:#4e7ca8;--hk-color:#c3d9f4;--hk-glow:rgba(96,170,255,.32);--hk-active-bg:#1d5c92;--hk-active-border:#53aef1;--hk-active-color:#e5f5ff;--hk-active-glow:rgba(83,174,241,.55)}\n.hk-badge[data-id="sequencer"]{--hk-bg:rgba(70,44,18,.5);--hk-border:#b58136;--hk-color:#ffe2b5;--hk-glow:rgba(255,176,58,.32);--hk-active-bg:#e68b22;--hk-active-border:#ffbb58;--hk-active-color:#fff4df;--hk-active-glow:rgba(255,187,88,.55)}\n.hk-badge[data-id="seq-play"]{--hk-bg:rgba(32,66,50,.5);--hk-border:#3fa072;--hk-color:#bdf3d9;--hk-glow:rgba(76,242,159,.36);--hk-active-bg:#28c978;--hk-active-border:#6af7ae;--hk-active-color:#f0fff8;--hk-active-glow:rgba(76,242,159,.6)}\n.hk-badge[data-id="fr-ready"]{--hk-bg:rgba(57,40,92,.52);--hk-border:#8a6ad1;--hk-color:#dbc8ff;--hk-glow:rgba(181,140,255,.34);--hk-active-bg:#7856d9;--hk-active-border:#b296ff;--hk-active-color:#f3edff;--hk-active-glow:rgba(178,150,255,.55)}\n.hk-badge[data-id="fr-playback"]{--hk-bg:rgba(88,46,28,.52);--hk-border:#d17d46;--hk-color:#ffd3b5;--hk-glow:rgba(255,156,102,.34);--hk-active-bg:#ff924d;--hk-active-border:#ffba85;--hk-active-color:#fff4eb;--hk-active-glow:rgba(255,156,102,.55)}\n.hk-badge[data-id="signature"]{--hk-bg:rgba(26,20,38,.45);--hk-border:#8357ff;--hk-color:#e0d8ff;--hk-glow:rgba(178,130,255,.38);--hk-active-bg:rgba(60,32,120,.7);--hk-active-border:#c9a6ff;--hk-active-color:#fff6ff;--hk-active-glow:rgba(180,130,255,.6)}\n.hk-badge[data-id="sig-mode"]{--hk-bg:rgba(30,38,74,.5);--hk-border:#6a82cc;--hk-color:#cbd8ff;--hk-glow:rgba(122,162,255,.35);--hk-active-bg:#2b3e73;--hk-active-border:#8dacff;--hk-active-color:#eef3ff;--hk-active-glow:rgba(122,162,255,.55)}\n.hk-badge[data-id="loop"]{--hk-bg:rgba(24,54,66,.5);--hk-border:#3ea3c6;--hk-color:#c5f1ff;--hk-glow:rgba(54,209,255,.38);--hk-active-bg:#27a4d9;--hk-active-border:#68d9ff;--hk-active-color:#effbff;--hk-active-glow:rgba(104,217,255,.55)}\n.hk-badge[data-id="latch"]{--hk-bg:rgba(74,32,56,.52);--hk-border:#c0618a;--hk-color:#ffd0e3;--hk-glow:rgba(255,109,156,.34);--hk-active-bg:#ff6d9c;--hk-active-border:#ff9dc0;--hk-active-color:#fff3f7;--hk-active-glow:rgba(255,109,156,.58)}\n.hk-badge[data-id="signature"] span{display:inline-block}\n.hk-tooltip{position:absolute;top:0;left:0;color:#ccc;background:rgba(20,20,20,.6);border:1px solid rgba(255,255,255,.15);padding:6px 12px;border-radius:6px;font-size:13px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;z-index:50;opacity:0;white-space:nowrap;pointer-events:none;box-shadow:0 5px 15px rgba(0,0,0,.6);backdrop-filter:blur(12px);transform-origin:center;transform:var(--tooltip-transform,translate(-50%,-100%)) scale(.9);transition:opacity .2s cubic-bezier(.4,0,.2,1),transform .2s cubic-bezier(.4,0,.2,1)}\n.hk-tooltip.is-visible{opacity:1;transform:var(--tooltip-transform,translate(-50%,-100%)) scale(1)}\n@keyframes shimmer-text{0%{background-position:-200% center}100%{background-position:200% center}}\n.hk-badge.is-visible[data-id="signature"]{width:calc(160px*var(--scale));height:calc(72px*var(--scale));margin:0;padding:0;border-radius:calc(18px*var(--scale));background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.3);color:transparent;font-size:calc(40px*var(--scale));font-weight:700;letter-spacing:.05em;box-shadow:0 0 6px rgba(255,255,255,.1);backdrop-filter:blur(6px);overflow:hidden;opacity:.7;z-index:41;position:absolute;left:50%;top:100%;transform:translate(-50%,calc(-100% - var(--gap)));transition:all .2s ease}\n.hk-badge.is-visible[data-id="signature"] span{background:linear-gradient(90deg,#ff00de 0%,#00f7ff 25%,#ff00de 50%,#00f7ff 75%,#ff00de 100%);background-size:200% auto;background-clip:text;-webkit-background-clip:text;color:transparent;animation:shimmer-text 4s linear infinite;display:inline-block;width:100%;text-align:center;text-shadow:none}\n.hk-badge.is-visible[data-id="signature"][data-active="true"]{opacity:1;border-color:#fff;box-shadow:0 0 12px rgba(255,255,255,.4),0 0 20px rgba(150,100,255,.5)}\n.hk-badge.is-visible[data-id="signature"][data-active="true"] span{animation-duration:1.5s;background:linear-gradient(90deg,#ff00de 0%,#00f7ff 30%,#f0f 50%,#00f7ff 70%,#ff00de 100%);background-size:150% auto}\n.hk-badge.is-visible[data-id="fr-ready"],.hk-badge.is-visible[data-id="fr-playback"]{left:50%;top:100%;margin:0;transform:translate(calc(-50% + var(--x,0px)),calc(-100% - calc(var(--gap) + 4px)))}\n.hk-badge.is-visible[data-id="fr-ready"]{--x:var(--cluster-left)}.hk-badge.is-visible[data-id="fr-playback"]{--x:var(--cluster-right)}\n@media (max-width:520px){.hk-badge.is-visible[data-id="fr-ready"]{--x:var(--cluster-left-sm)}.hk-badge.is-visible[data-id="fr-playback"]{--x:var(--cluster-right-sm)}}\n@media (max-width:420px){.hk-badge.is-visible[data-id="signature"]{width:calc(120px * var(--scale));height:calc(60px * var(--scale));border-radius:calc(14px * var(--scale));font-size:calc(32px * var(--scale));}.hk-badge.is-visible[data-id="fr-ready"]{--x: calc(-100px * var(--scale));}.hk-badge.is-visible[data-id="fr-playback"]{--x: calc(100px * var(--scale));}}\n.hk-badge.is-tour{opacity:1!important;color:#ddd;border-color:#aaa;box-shadow:0 0 0 1px #000,0 0 12px rgba(255,255,255,.35);transform:translate(-50%,-50%) scale(1.1)}\n.hk-badge.is-tour.is-power[data-active="true"]{box-shadow:0 0 12px 2px #d32a3988,0 0 3px #ff7484cc,0 0 12px rgba(255,255,255,.25)}\n.hk-badge.is-tour[data-id="signature"]{opacity:1;border-color:#fff;box-shadow:0 0 12px rgba(255,255,255,.4),0 0 20px rgba(150,100,255,.5)}\n.hk-tooltip.hk-tour{opacity:1;pointer-events:none;transition:none}\n'}));const c=document.createElement("div");c.className="hk-tooltip";const h=([,e,t,n,i,o,h])=>{const d=document.createElement("div");return d.className="hk-badge",d.dataset.id=h,d.dataset.angle=i,"power"===h&&d.classList.add("is-power"),"mute"===h&&d.classList.add("is-mute"),("S"===e||"H"===e||"fr-playback"===h&&"R"===e)&&(d.dataset.shift="1"),d.appendChild(Object.assign(document.createElement("span"),{textContent:e})),r(d,"mouseenter",()=>{c.textContent=o,s(c,d,l),c.classList.add("is-visible")}),r(d,"mouseleave",()=>c.classList.remove("is-visible")),r(d,"click",e=>{e.preventDefault(),e.stopPropagation(),a.dispatchEvent(new CustomEvent(t,{detail:n,bubbles:!0,composed:!0}))},{passive:!1}),d},d=document.createDocumentFragment();for(const t of e)d.appendChild(h(t));l.append(c),o.appendChild(l.appendChild(d)&&l);const u=new Set;let p=!1;const g=()=>{p=u.size>0;try{n.updateHkIcons?.(n.state)}catch{}};r(a,"seq-step-recorded",e=>{const t=e.detail?.slotIndex;Number.isInteger(t)&&u.add(t),g()}),r(a,"seq-step-cleared",e=>{const t=e.detail?.slotIndex;Number.isInteger(t)&&u.delete(t),g()}),r(a,"seq-steps-changed",()=>{u.clear(),g()});const _=()=>{try{c.classList.remove("is-visible")}catch{}l.querySelectorAll(".hk-badge.is-tour").forEach(e=>e.classList.remove("is-tour")),l.querySelectorAll(".hk-tooltip.hk-tour").forEach(e=>e.remove()),n._hkTourTips=[],n._hkTourRunning=!1};n.cleanupHotkeyTour=_;const y=e.map(([,,,,,e,t])=>({id:t,title:e})).filter(e=>e.id);n.runHotkeyTour=async(e={})=>{if(n._hkTourRunning)return;_(),n._hkTourRunning=!0;const t=Math.max(120,Math.min(900,e.stepMs??260)),i=Math.max(500,e.holdMs??1e3),o=e=>new Promise(t=>setTimeout(t,e)),a=y.map(({id:e,title:t})=>{const s=l.querySelector(`.hk-badge[data-id="${e}"]`);return s?.classList.contains("is-visible")?{el:s,title:t}:null}).filter(Boolean),r=(e,t)=>{const i=document.createElement("div");return i.className="hk-tooltip hk-tour is-visible",i.textContent=t,s(i,e,l),l.appendChild(i),(n._hkTourTips??=[]).push(i),i};try{for(const{el:e,title:s}of a)e.classList.add("is-tour"),r(e,s),await o(t);await o(i)}finally{_()}};const m=(e,t,s)=>{const n=l.querySelector(`[data-id="${e}"]`);n&&(n.dataset[t]="disabled"===t?s?"1":"":(!!s).toString())},f=(e={})=>{const t=!!e.isPlaying;if(!t)try{n.cleanupHotkeyTour?.()}catch{}const o=!!e.contextUnlocked,r=!!e.controlsVisible,a=o||r;l.classList.toggle("is-dormant",!a),l.classList.toggle("is-controls-hidden",a&&!r),l.querySelectorAll(".hk-badge").forEach(e=>e.classList.toggle("is-visible",a));const c=l.querySelector("[data-id=\"power\"] span");c&&(c.textContent=t?"":""),m("power","active",t),m("mute","active",e.isMuted),m("controls","active",r),m("sequencer","active",e.sequencerVisible),m("seq-play","active",e.sequencePlaying),m("sig-mode","active",e.isSequenceSignatureMode),m("loop","active",e.isLoopEnabled),m("latch","active",e.isLatchOn);const s=e.isSignaturePlaying||e.signatureActive||!1;m("signature","active",s),m("fr-ready","active",!!e.isFreestyleMode),m("fr-playback","active",!!e.freestylePlayback),m("fr-playback","disabled",!e.freestyleRecording)};n.updateHkIcons=f,n.state&&f(n.state);const S=()=>{try{n.cleanupHotkeyTour?.()}catch{}const e=o.getBoundingClientRect();if(!e||e.width<100)return;const t=e.left+e.width/2,s=e.top+e.height/2,a=innerWidth,r=innerHeight,c=(()=>{const e=document.createElement("div");e.style.cssText="position:fixed;inset:auto 0 0 0;height:0;padding:env(safe-area-inset-top,0) env(safe-area-inset-right,0) env(safe-area-inset-bottom,0) env(safe-area-inset-left,0);visibility:hidden",document.body.appendChild(e);const t=getComputedStyle(e),s={top:+t.paddingTop.replace("px","")||0,right:+t.paddingRight.replace("px","")||0,bottom:+t.paddingBottom.replace("px","")||0,left:+t.paddingLeft.replace("px","")||0};return e.remove(),s})(),h=Math.min(e.width,e.height)/2+28,d=i.querySelector("osc-controls"),u=d&&null!==d.offsetParent?d.getBoundingClientRect():null;l.querySelectorAll(".hk-badge").forEach(e=>{const{id:n}=e.dataset;if(["signature","fr-ready","fr-playback"].includes(n))return;const i=(+e.dataset.angle||0)*Math.PI/180,o=Math.cos(i),l=Math.sin(i),d=c.left+10+15,p=a-c.right-10-15,g=c.top+10+15,_=u?Math.max(g,u.top-10-15):r-c.bottom-10-15;let y=h,m=1/0;o>0&&(m=Math.min(m,(p-t)/o)),o<0&&(m=Math.min(m,(t-d)/-o)),l>0&&(m=Math.min(m,(_-s)/l)),l<0&&(m=Math.min(m,(s-g)/-l)),y=Math.max(19,Math.floor(Math.min(y,m)));const f=Math.cos(i)*y,S=Math.sin(i)*y;e.style.transform=`translate(${f}px,${S}px) translate(-50%,-50%) scale(1)`})};S(),r(window,"resize",S,{passive:!0});const b=i.querySelector("osc-controls");if(b)try{new ResizeObserver(S).observe(b)}catch{}})})(),E(async()=>{const e=document.querySelector("osc-app");if(!e)return;if(!await L(()=>e.shadowRoot&&e.shadowRoot.querySelector("osc-controls")&&e.shadowRoot.querySelector("osc-hotkeys")))return;const t=e.shadowRoot,s=t.querySelector("osc-controls"),n=t.querySelector("osc-hotkeys");s.style.display="none",n.addEventListener("hk-toggle-controls",()=>{const t="none"===s.style.display;s.style.display=t?"block":"none";try{e._fitLayout?.()}catch{}try{s.dispatchEvent(new Event("controls-resize"))}catch{}})})})();