(()=>{const e=(...e)=>console.log("[AudioGnarls parsepatch v2]",...e),t=(...e)=>console.warn("[AudioGnarls parsepatch v2]",...e),r=e=>"number"==typeof e&&Number.isFinite(e),o=e=>e&&r(e.t)&&r(e.x)&&r(e.y);function n(e){if(!e||"object"!=typeof e)return{points:[],duration:0};let t=Array.isArray(e.points)?e.points.filter(o):[];const n=e.points?.length??0;t.length&&(t.sort(((e,t)=>e.t-t.t)),t=((e,t)=>{const r=new Set,o=[];for(const n of e){const e=t(n);r.has(e)||(r.add(e),o.push(n))}return o})(t,(e=>e.t)));return{points:t,duration:r(e.duration)?e.duration:t.length?t[t.length-1].t:0,__stats:{before:n,after:t.length}}}const a=JSON.parse;Object.defineProperty(JSON,"parse",{configurable:!0,writable:!0,value:function(r,o){let i=a(r,o);try{if(!((s=i)&&"object"==typeof s&&Object.keys(s).includes("presets")&&"uiState"in s&&("freestyleRecording"in s||"pathRecorderState"in s||"sequence"in s&&"sequenceSteps"in s)))return i;const r=n(i.freestyleRecording);let o=null;i.pathRecorderState?.recording&&(o=n(i.pathRecorderState.recording));let a=r.points.length?r:o&&o.points.length?o:r;i.freestyleRecording={points:a.points,duration:a.duration},i.pathRecorderState&&"object"==typeof i.pathRecorderState?(i.pathRecorderState.recording=i.freestyleRecording,i.pathRecorderState.isArmed=!!i.pathRecorderState.isArmed,i.pathRecorderState.loop=!!i.pathRecorderState.loop):i.pathRecorderState={recording:i.freestyleRecording,isArmed:!1,loop:!1},e("intercepted state: freestyle points",{mainBefore:r.__stats.before,mainAfter:r.__stats.after,pathBefore:o?.__stats.before??0,pathAfter:o?.__stats.after??0,chosen:a===r?"main":o?"path":"main"}),queueMicrotask((()=>function(r){const o=document.querySelector("osc-app");if(o){o.state=o.state||{},o.state.freestyleRecording=r.freestyleRecording,o.pathRecorderState=o.pathRecorderState||{},o.pathRecorderState.recording=r.freestyleRecording;try{o._pathRec?.loadRecording&&r.freestyleRecording&&(o._pathRec.loadRecording(r.freestyleRecording),e("rehydrated path recorder with",r.freestyleRecording.points.length,"points"))}catch(e){t("optional _pathRec.loadRecording failed:",e)}try{"_seqFirstCycleStarted"in o&&(o._seqFirstCycleStarted=!1),"sequenceStepIndex"in o&&(o.sequenceStepIndex=0)}catch{}window.playRehydrated=()=>{try{o._onFreestylePlay?.()}catch(e){t("playRehydrated failed:",e)}}}else t("osc-app not found during rehydrate")}({freestyleRecording:i.freestyleRecording})))}catch(e){t("parse sanitizer error (continuing with original data)",e)}var s;return i}}),e("JSON.parse patched (v2)")})();
