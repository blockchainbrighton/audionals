(()=>{const e=(...e)=>console.log("[AudioGnarls seedpatch]",...e),t=(...e)=>console.warn("[AudioGnarls seedpatch]",...e),r=["isMuted","isLoopEnabled","volume","isSequencerMode","isRecording","currentRecordSlot","sequence","velocities","sequenceStepIndex","stepTime","sequenceSteps","isSequenceSignatureMode","isLatchOn","seed","uiHomeShapeKey","isFreestyleMode","freestyleRecording","approvedSeeds"],o=e=>{if(!e||"object"!=typeof e)return e;try{return structuredClone(e)}catch(n){try{return JSON.parse(JSON.stringify(e))}catch(e){return t("clone fallback failed",n,e),e}}},n=()=>{const n=customElements.get("osc-app");if(!n||n.prototype.__seedPatchApplied)return!!n&&n.prototype.__seedPatchApplied;const a=n.prototype,s=a._onSaveState;a._onSaveState=async function(...n){let i="",c="default";try{if(this?.state){i="string"==typeof this.state.seed?this.state.seed.trim():"",c=i||this.getAttribute?.("seed")||document?.documentElement?.dataset?.seed||"default",this.state.seed=c,i!==c&&t("seed fallback during save",{from:i,to:c}),e("captured seed before save",c)}}catch(e){t("pre-save seed capture failed",e)}const d=await s?.apply(this,n);try{this?.state?.seed&&e("state saved with seed",this.state.seed)}catch(e){t("post-save logging failed",e)}return d};a._onLoadState=function(...n){try{const a=prompt("Paste the JSON state data to load:");if(!a||""===a.trim()){e("load cancelled â€“ empty input");return}let s;try{s=JSON.parse(a)}catch(e){throw t("JSON parse failed",e),new Error("Invalid JSON: "+e.message)}if(!s||"object"!=typeof s)throw new Error("Invalid state data format");const n="string"==typeof s.seed?s.seed.trim():"",i=n||this.state?.seed||document?.documentElement?.dataset?.seed||"default";e("loading state payload",{incomingSeed:n,resolvedSeed:i});this.state.sequencePlaying&&this._sequencerComponent?.stopSequence?.(),this.state.freestylePlayback&&this._pathRec?.stop?.();const c={};r.forEach((e=>{Object.prototype.hasOwnProperty.call(s,e)&&(c[e]=o(s[e]))})),c.seed=i;const d=s.sequencerState?o(s.sequencerState):null,h=s.pathRecorderState?o(s.pathRecorderState):null,u=s.uiState?o(s.uiState):null;try{this.resetToSeed(i),e("resetToSeed invoked",i)}catch(e){throw t("resetToSeed failed",e),e}r.forEach((e=>{if("seed"===e)return void(this.state.seed=i);Object.prototype.hasOwnProperty.call(c,e)&&(this.state[e]=o(c[e]))})),Array.isArray(this.state.approvedSeeds)||(this.state.approvedSeeds=[]),d&&this._sequencerComponent&&(()=>{const n=this._sequencerComponent;try{d.steps&&"function"==typeof n.changeStepCount&&n.changeStepCount(d.steps),d.state&&"object"==typeof d.state&&(Object.assign(n.state,d.state),n.updateSequenceUI?.(),n.updateStepControls?.(),e("sequencer state restored"))}catch(o){t("sequencer rehydrate failed",o)}})(),h&&this._pathRec&&(()=>{const n=this._pathRec;try{h.recording&&(this.state.freestyleRecording=o(h.recording),n.loadRecording?.(this.state.freestyleRecording)),void 0!==h.loop&&n.setLoop?.(!!h.loop),e("path recorder state restored");}catch(o){t("path recorder rehydrate failed",o)}})(),u&&(()=>{try{void 0!==u.sequencerVisible&&this._sequencerComponent&&(this._sequencerComponent.style.display=u.sequencerVisible?"block":"none",this.state.isSequencerMode=!!u.sequencerVisible),void 0!==u.volume&&(this.state.volume=u.volume),e("ui state fields applied");}catch(o){t("ui state apply failed",o)}})(),document?.documentElement&&(document.documentElement.dataset.seed=i),document?.body&&(document.body.dataset.seed=i),this._loader&&(this._loader.textContent=`Loaded saved seed ${i}. Preparing playback...`),this._controls?.updateApprovedSeeds?.(this.state.approvedSeeds),this._updateControls?.(),this._fitLayout?.(),this._showNotification?.("State loaded successfully!","success"),console.log("Loaded state:",s);const l=()=>{if(this.state?.contextUnlocked)return e("audio context already unlocked; skipping auto power"),!0;if("function"==typeof this._onStartRequest)try{return e("attempting auto power-on"),this._onStartRequest(),!0}catch(o){t("auto power-on failed",o)}return!1},p=(n=0)=>{if(!this.state)return;if(!this.state.contextUnlocked||!this.state.initialShapeBuffered){n<20&&setTimeout((()=>p(n+1)),200);return}if("function"==typeof this._onAudioSignature)try{e("playing signature for seed",this.state.seed),this._onAudioSignature()}catch(o){t("signature playback failed",o)}};setTimeout((()=>{l(),setTimeout((()=>p(0)),250)}),150)}catch(o){console.error("Error loading state:",o),this._showNotification?.("Error loading state: "+o.message,"error")}};return a.__seedPatchApplied=!0,e("osc-app save/load patched"),!0};const a=()=>{n()||setTimeout(a,100)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",a,{once:!0}):a()})();
