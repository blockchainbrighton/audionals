import{clamp01,pct,on,off,setText,setPressed,toggleClass,byId,isBool,isNum,setDisabledAll,addEvents,removeEvents}from"./utils.js";import"./path-rec-app.js";class OscControls extends HTMLElement{constructor(){super();const e=this.attachShadow({mode:"open"}),t=(e,t)=>this.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0,composed:!0}));e.innerHTML='\n      <style>\n        :host{display:block}\n        #controls{display:flex;gap:1.1rem;align-items:center;flex-wrap:wrap;justify-content:center;padding:.7rem 1.2rem;background:rgba(255,255,255,.07);border-radius:9px;width:95%;max-width:980px;margin:.9rem auto 0;box-sizing:border-box}\n        .seed{display:flex;align-items:center;gap:.55rem;padding:.3rem .55rem;background:#23252b;border:1px solid #4e5668;border-radius:8px}\n        .seed label{font-size:.95rem;color:#ffe7b3;letter-spacing:.02em}\n        .seed input{font-family:inherit;font-size:.98rem;color:#ffecb3;background:#1c1d22;border:1px solid #3c3f48;border-radius:6px;padding:.38rem .55rem;width:15ch;letter-spacing:.04em}\n        .seed button{padding:.42rem .8rem;border-radius:6px;border:1px solid #665;background:#221;color:#ffe0a3;cursor:pointer;font-family:inherit;font-size:.95rem;transition:background .18s}\n        .seed button:hover{background:#2c1f1f}\n        .vol{display:flex;align-items:center;gap:.55rem;min-width:190px;padding:.3rem .55rem;background:#23252b;border:1px solid #4e5668;border-radius:8px}\n        .vol label{font-size:.95rem;color:#cfe3ff;letter-spacing:.02em}\n        .vol input[type="range"]{-webkit-appearance:none;appearance:none;width:140px;height:4px;background:#3a3f4a;border-radius:999px;outline:none}\n        .vol input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;background:#46ad6d;border:1px solid #2b6b44;box-shadow:0 0 6px #46ad6d55;cursor:pointer}\n        .vol input[type="range"]::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:#46ad6d;border:1px solid #2b6b44;cursor:pointer}\n        .vol #volVal{font-size:.92rem;color:#9df5c2;min-width:3.5ch;text-align:right}\n        button,select{padding:.53em 1.17em;border-radius:6px;border:1px solid #555;background:#242;color:#fff;font-size:1rem;cursor:pointer;font-family:inherit;font-weight:500;transition:background .19s,color .19s,box-shadow .19s,transform .06s ease;box-shadow:0 0 0 #0000;will-change:transform}\n        button:active{transform:translateY(1px)}\n        button:focus{outline:2px solid #7af6ff;outline-offset:1px}\n        button:hover{background:#454}\n        #startBtn.power-off{background:#451015;color:#e97c90;border-color:#89232a;box-shadow:0 0 4px #ff505011,0 0 0 #0000;text-shadow:none;filter:brightness(.95)}\n        #startBtn.power-on{background:#ff2a39;color:#fff;border-color:#ff4e6a;box-shadow:0 0 18px 5px #ff2a3999,0 0 4px #ff748499;text-shadow:0 1px 3px #8d2025cc,0 0 10px #fff7;filter:brightness(1.1) saturate(1.2)}\n        #startBtn:not(.ready){opacity:.7}\n        #muteBtn.muted{background:#a51427;color:#fff;border-color:#ff506e;box-shadow:0 0 12px #ff506e66;text-shadow:0 1px 2px #320a0b}\n        #audioSigBtn{background:#2a4d3a;color:#7af6ff;border-color:#4a7c59;box-shadow:0 0 8px #7af6ff33}\n        #audioSigBtn:hover{background:#3a5d4a;box-shadow:0 0 12px #7af6ff55}\n        #audioSigBtn:disabled{background:#1a2d2a;color:#4a6c59;box-shadow:none}\n        .toggle{position:relative;background:#23252b;border-color:#4e5668;color:#cfe3ff;box-shadow:inset 0 -1px 0 #0004,0 0 0 #0000}\n        .toggle:hover{background:#2b2f38}\n        .toggle[aria-pressed="true"]{background:#1f3a26;color:#9df5c2;border-color:#46ad6d;box-shadow:0 0 10px #46ad6d55,inset 0 0 0 1px #46ad6d33;text-shadow:0 1px 2px #0b1a10aa}\n        #loopBtn.toggle[aria-pressed="true"]{background:#173a2a;border-color:#35d08e;box-shadow:0 0 12px #35d08e55,inset 0 0 0 1px #35d08e33}\n        #sigModeBtn.toggle[aria-pressed="true"]{background:#1f2a3f;border-color:#7aa2ff;color:#cfe0ff;box-shadow:0 0 12px #7aa2ff55,inset 0 0 0 1px #7aa2ff33}\n        #latchBtn.toggle[aria-pressed="true"]{background:#1f3a26;border-color:#46ad6d;color:#9df5c2;box-shadow:0 0 10px #46ad6d55,inset 0 0 0 1px #46ad6d33}\n        /* Auditioning Controls Styles */\n        #auditionControls{display:flex;gap:.5rem;border-left:2px solid #555;padding-left:1rem;margin-left:.5rem}\n        #approveBtn{background:#141;color:#8f8;border-color:#383}\n        #approveBtn:hover{background:#252}\n        #rejectBtn{background:#411;color:#f88;border-color:#833}\n        #rejectBtn:hover{background:#522}\n        #approvedSeedsWrapper{width:100%;margin-top:.8rem;display:none}\n        #approvedSeedsWrapper label{color:#ffe7b3;font-size:.9rem;display:block;margin-bottom:.3rem}\n        #approvedSeedsList{width:100%;box-sizing:border-box;height:80px;background:#1c1d22;border:1px solid #3c3f48;color:#9f8;font-family:monospace;resize:vertical;padding:.4rem .6rem;border-radius:6px}\n        @media (max-width:430px){#controls{gap:.5rem;padding:.55rem .8rem}button,select{padding:.42em .8em;font-size:.93rem}.vol{min-width:160px}.vol input[type="range"]{width:120px}.seed input{width:11ch}}\n        @media (max-width:380px){#controls{gap:.45rem;padding:.5rem .7rem}button,select{padding:.4em .72em;font-size:.9rem}.vol{min-width:150px}.vol input[type="range"]{width:110px}.seed label{display:none}}\n        button:disabled,select:disabled{opacity:.5;pointer-events:none}\n        .vol:has(input:disabled){opacity:.5;pointer-events:none}\n      </style>\n      <div id="controls">\n        <button id="startBtn" title="Click to initialize audio">POWER ON</button>\n        <button id="muteBtn">Mute</button>\n        <select id="shapeSelect"></select>\n        <button id="seqBtn">Create Sequence</button>\n        <button id="audioSigBtn">Audio Signature</button>\n        <button id="latchBtn" class="toggle" aria-pressed="false">Latch: Off</button>\n        <button id="loopBtn" class="toggle" aria-pressed="false">Loop: Off</button>\n        <button id="sigModeBtn" class="toggle" aria-pressed="false">Signature Mode: Off</button>\n        <div id="volWrap" class="vol" title="Master Volume">\n          <label for="vol">Vol</label>\n          <input id="vol" type="range" min="0" max="100" step="1" value="10"/>\n          <span id="volVal">10%</span>\n        </div>\n        <form id="seedForm" class="seed" autocomplete="off">\n          <label for="seedInput">Seed</label>\n          <input id="seedInput" name="seedInput" maxlength="32" spellcheck="false"/>\n          <button id="seedSetBtn" type="submit">Set Seed</button>\n        </form>\n        \x3c!-- MODIFIED START: Seed Auditioning Controls --\x3e\n        <div id="auditionControls">\n            <button id="nextSeedBtn" title="Load the next seed from the CSV list">Next Seed</button>\n            <button id="approveBtn" title="Save this seed to the list and play the next one">✅</button>\n            <button id="rejectBtn" title="Discard this seed and play the next one">❌</button>\n        </div>\n        \x3c!-- MODIFIED END --\x3e\n        \x3c!-- Freestyle Path Recorder Buttons --\x3e\n        <button id="frReadyBtn" class="toggle" aria-pressed="false" title="Freestyle Record-Ready (R)">FR Ready</button>\n        <button id="frPlayBtn" disabled title="Play Freestyle Recording (Shift+R)">FR Play</button>\n        \x3c!-- Save/Load Buttons --\x3e\n        <button id="saveBtn" title="Save entire sequencer state to clipboard as JSON">Save State</button>\n        <button id="loadBtn" title="Load sequencer state from JSON data">Load State</button>\n      </div>\n      \x3c!-- MODIFIED START: Approved Seeds List Display --\x3e\n      <div id="approvedSeedsWrapper">\n        <label for="approvedSeedsList">Approved Seeds:</label>\n        <textarea id="approvedSeedsList" readonly spellcheck="false"></textarea>\n      </div>\n      \x3c!-- MODIFIED END --\x3e',this._startBtn=byId(e,"startBtn"),this._muteBtn=byId(e,"muteBtn"),this._shapeSelect=byId(e,"shapeSelect"),this._seqBtn=byId(e,"seqBtn"),this._audioSigBtn=byId(e,"audioSigBtn"),this._latchBtn=byId(e,"latchBtn"),this._loopBtn=byId(e,"loopBtn"),this._sigModeBtn=byId(e,"sigModeBtn"),this._vol=byId(e,"vol"),this._volVal=byId(e,"volVal"),this._seedForm=byId(e,"seedForm"),this._seedInput=byId(e,"seedInput"),this._nextSeedBtn=byId(e,"nextSeedBtn"),this._approveBtn=byId(e,"approveBtn"),this._rejectBtn=byId(e,"rejectBtn"),this._approvedSeedsWrapper=byId(e,"approvedSeedsWrapper"),this._approvedSeedsList=byId(e,"approvedSeedsList"),this._allControls=[this._startBtn,this._muteBtn,this._shapeSelect,this._seqBtn,this._audioSigBtn,this._latchBtn,this._loopBtn,this._sigModeBtn,this._vol],this._frReadyBtn=byId(e,"frReadyBtn"),this._frPlayBtn=byId(e,"frPlayBtn"),this._saveBtn=byId(e,"saveBtn"),this._loadBtn=byId(e,"loadBtn"),this._allControls.push(this._frReadyBtn,this._frPlayBtn,this._saveBtn,this._loadBtn),this._allControls.push(this._nextSeedBtn,this._approveBtn,this._rejectBtn),addEvents(this._frReadyBtn,[["click",()=>t("fr-toggle")]]),addEvents(this._frPlayBtn,[["click",()=>t("fr-play")]]),addEvents(this._saveBtn,[["click",()=>t("save-state")]]),addEvents(this._loadBtn,[["click",()=>t("load-state")]]),addEvents(this._startBtn,[["click",()=>t("start-request")]]),addEvents(this._muteBtn,[["click",()=>t("mute-toggle")]]),addEvents(this._shapeSelect,[["change",()=>t("shape-change",{shapeKey:this._shapeSelect.value})]]),addEvents(this._seqBtn,[["click",()=>t("toggle-sequencer")]]),addEvents(this._audioSigBtn,[["click",()=>t("audio-signature")]]),addEvents(this._latchBtn,[["click",()=>t("latch-toggle")]]),addEvents(this._loopBtn,[["click",()=>t("loop-toggle")]]),addEvents(this._sigModeBtn,[["click",()=>t("signature-mode-toggle")]]),addEvents(this._vol,[["input",()=>t("volume-change",{value:Number(this._vol.value)})]]),addEvents(this._seedForm,[["submit",e=>(e.preventDefault(),t("seed-set",{value:(this._seedInput?.value||"").trim()}))]]),addEvents(this._nextSeedBtn,[["click",()=>t("next-seed")]]),addEvents(this._approveBtn,[["click",()=>t("approve-seed")]]),addEvents(this._rejectBtn,[["click",()=>t("reject-seed")]]),this._helpers={setPressed:setPressed,setText:setText}}setShapes(e){const t=document.createDocumentFragment();for(const{value:s,label:o}of e??[])t.appendChild(Object.assign(document.createElement("option"),{value:s,textContent:o}));this._shapeSelect.replaceChildren(t)}setSeed(e){this._seedInput&&(this._seedInput.value=e??"")}disableAll(e){setDisabledAll(this._allControls,e)}updateApprovedSeeds(e=[]){if(this._approvedSeedsWrapper&&this._approvedSeedsList){const t=e.length>0;this._approvedSeedsWrapper.style.display=t?"block":"none",this._approvedSeedsList.value=t?e.join("\n"):"",t&&(this._approvedSeedsList.scrollTop=this._approvedSeedsList.scrollHeight),this.dispatchEvent(new Event("controls-resize"))}}updateState(e={}){const{setPressed:t,setText:s}=this._helpers,o=(e,o,n,i)=>(t(e,o),s(e,o?n:i));if(isBool(e.isAudioSignaturePlaying)&&o(this._audioSigBtn,e.isAudioSignaturePlaying,"Stop Signature","Audio Signature"),isBool(e.isPlaying)&&(s(this._startBtn,e.isPlaying?"POWER OFF":"POWER ON"),toggleClass(this._startBtn,"power-on",e.isPlaying),toggleClass(this._startBtn,"power-off",!e.isPlaying)),isBool(e.isAudioStarted)&&(toggleClass(this._startBtn,"ready",e.isAudioStarted),setDisabledAll([this._muteBtn,this._audioSigBtn,this._latchBtn,this._loopBtn,this._sigModeBtn,this._vol],!e.isAudioStarted)),isBool(e.isMuted)&&(s(this._muteBtn,e.isMuted?"Unmute":"Mute"),toggleClass(this._muteBtn,"muted",e.isMuted)),e.shapeKey&&(this._shapeSelect.value=e.shapeKey),isBool(e.sequencerVisible)&&s(this._seqBtn,e.sequencerVisible?"Hide Sequencer":"Create Sequence"),isBool(e.isLoopEnabled)&&o(this._loopBtn,e.isLoopEnabled,"Loop: On","Loop: Off"),isBool(e.isSequenceSignatureMode)&&o(this._sigModeBtn,e.isSequenceSignatureMode,"Signature Mode: On","Signature Mode: Off"),isBool(e.isLatchOn)&&o(this._latchBtn,!!e.isLatchOn,"Latch: On","Latch: Off"),isNum(e.volume)){const t=pct(e.volume);this._vol&&(this._vol.value=String(t)),this._volVal&&(this._volVal.textContent=`${t}%`)}isBool(e.sequencerVisible)&&this.dispatchEvent(new Event("controls-resize"))}}customElements.define("osc-controls",OscControls);import{Engine,Signatures}from"./engine.js";class OscApp extends HTMLElement{static get observedAttributes(){return["seed"]}constructor(){super(),this.attachShadow({mode:"open"}),this._heldKeys=new Set,this.humKey="hum",this.humLabel="Power Hum",this.shapes=["circle","square","butterfly","Bowditch","spiro","harmonograph","rose","hypocycloid","epicycloid","spiral","star","flower","wave","mandala","infinity","dna","tornado"],this.shapeLabels=Object.fromEntries(this.shapes.map((e=>[e,e[0].toUpperCase()+e.slice(1)]))),Object.assign(this,Engine(this),Signatures(this));const e=(this.getAttribute("seed")||"").trim(),t=(document.documentElement?.dataset?.seed||"").trim(),s=e||t||"default";this.state=this.defaultState(s),["_onToneReady","_onStartRequest","_onMuteToggle","_onShapeChange","_onToggleSequencer","_onAudioSignature","_handleSeedSubmit","_onSeqRecordStart","_onSeqStepCleared","_onSeqStepRecorded","_onSeqPlayStarted","_onSeqPlayStopped","_onSeqStepAdvance","_onSeqStepTimeChanged","_onSeqStepsChanged","_onLoopToggle","_onSignatureModeToggle","_onVolumeChange","_onHotkeyPress","_onHotkeyRelease","_onHotkeyLoopToggle","_onHotkeySignatureToggle","_onLatchToggle","_fitLayout","_onWindowResize","_onShapeStep","_onHotkeyToggleSeqPlay","_onHotkeyTogglePower","_onToggleControls","_initControlsVisibility","_onFreestyleReadyToggle","_onFreestylePlay","_onSaveState","_onLoadState","_onNextSeed","_onApproveSeed","_onRejectSeed"].forEach((e=>this[e]=this[e].bind(this)))}_onToneReady(){const e=this.state;e.Tone=window.Tone,this.loadPresets(e.seed),this.bufferHumChain();const t=this.shapes[this._rng(e.seed)()*this.shapes.length|0];e.uiHomeShapeKey=t,this._setCanvas({preset:e.presets[t],shapeKey:t,mode:"seed"}),e.current=this.humKey,this._controls.disableAll?.(!1);const s=e.Tone?.Destination?.volume;s&&(s.value=this._linToDb(e.volume)),this._updateControls(),this._fitLayout()}attributeChangedCallback(e,t,s){if("seed"!==e)return;const o=(s||"").trim();!o||o===this.state.seed||this.resetToSeed(o)}defaultState(e="default"){return{isPlaying:!1,contextUnlocked:!1,initialBufferingStarted:!1,initialShapeBuffered:!1,Tone:null,chains:{},current:null,isMuted:!1,isLoopEnabled:!1,volume:.2,isSequencerMode:!1,isRecording:!1,currentRecordSlot:-1,sequence:Array(8).fill(null),velocities:Array(8).fill(1),sequencePlaying:!1,sequenceIntervalId:null,sequenceStepIndex:0,stepTime:200,_seqFirstCycleStarted:!1,sequenceSteps:8,isSequenceSignatureMode:!1,signatureSequencerRunning:!1,audioSignaturePlaying:!1,audioSignatureTimer:null,audioSignatureStepIndex:0,audioSignatureOnComplete:null,isLatchOn:!1,seed:e,presets:{},uiHomeShapeKey:null,_transientOverride:!1,isFreestyleMode:!1,isFreestyleRecording:!1,freestyleRecording:null,freestylePlayback:!1,approvedSeeds:[],seedList:[],seedListIndex:0,seedListLoaded:!1}}connectedCallback(){const e=this.createElement?.bind(this)??((e,t={})=>{const s=document.createElement(e);for(const e in t)"textContent"===e?s.textContent=t[e]:s.setAttribute(e,t[e]);return s}),t=e("div",{id:"appWrapper"}),s=this._main=e("div",{id:"main"}),o=this._canvasContainer=e("div",{id:"canvasContainer"});this._canvas=e("scope-canvas"),o.appendChild(this._canvas),this._setupCanvasClickGrid(),this._renderPowerOverlay(),this._controls=e("osc-controls");const n=[{value:this.humKey,label:this.humLabel},...this.shapes.map((e=>({value:e,label:this.shapeLabels[e]||e})))];this._controls.setShapes(n),this._hotkeys=e("osc-hotkeys"),this._hotkeys.setConfig({humKey:this.humKey,shapes:this.shapes}),s.appendChild(this._hotkeys),addEvents(this._hotkeys,[["hk-press",this._onHotkeyPress],["hk-release",this._onHotkeyRelease],["hk-toggle-loop",this._onHotkeyLoopToggle],["hk-toggle-signature",this._onHotkeySignatureToggle],["hk-shape-step",this._onShapeStep],["hk-toggle-mute",this._onMuteToggle],["hk-toggle-sequencer",this._onToggleSequencer],["hk-audio-signature",this._onAudioSignature],["hk-toggle-latch",this._onLatchToggle],["hk-toggle-seq-play",this._onHotkeyToggleSeqPlay],["hk-toggle-power",this._onHotkeyTogglePower],["fr-toggle",this._onFreestyleReadyToggle],["fr-play",this._onFreestylePlay]]),this._buildGridMap=()=>{const e=(e,t)=>`${e},${t}`,t=[[0,0],[0,4],[4,0],[4,4]],s=new Set(t.map((([t,s])=>e(t,s)))),o=[];for(let e=0;e<5;e++)o.push([0,e]);for(let e=1;e<5;e++)o.push([e,4]);for(let e=3;e>=0;e--)o.push([4,e]);for(let e=3;e>=1;e--)o.push([e,0]);const n=[];for(let e=1;e<=3;e++)for(let t=1;t<=3;t++)n.push([e,t]);const i=new Set,a=[].concat(o,n).filter((([t,o])=>{const n=e(t,o);return!s.has(n)&&!i.has(n)&&(i.add(n),!0)})),r=this.shapes.slice(0,18),d=new Map;for(let t=0;t<a.length;t++){const[s,o]=a[t];d.set(e(s,o),{type:"shape",shapeKey:r[t%r.length]})}t.forEach((([t,s])=>d.set(e(t,s),{type:"hum",shapeKey:this.humKey}))),this._grid25={map:d,cellInfo:(t,s)=>d.get(e(t,s))||null}},this._buildGridMap(),this._pathRec=document.createElement("path-rec-app"),this.shadowRoot.appendChild(this._pathRec),this._frLastCell=null,this._frCanvas=document.createElement("canvas"),Object.assign(this._frCanvas.style,{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none"}),o.appendChild(this._frCanvas),this._frCtx=this._frCanvas.getContext("2d"),this._drawFrOverlay=()=>{const e=this._frCtx;if(e){e.clearRect(0,0,this._frCanvas.width,this._frCanvas.height);try{(this.state?.isFreestyleMode||this.state?.freestylePlayback||this.state?.isFreestyleRecording)&&this._pathRec?.renderOverlay(e)}catch{}}requestAnimationFrame(this._drawFrOverlay)},this._resizeFrCanvas(),requestAnimationFrame(this._drawFrOverlay),this._pathRec.addEventListener("fr-armed",(()=>{this.state.isFreestyleMode=!0,this._updateControls()})),this._pathRec.addEventListener("fr-disarmed",(()=>{this.state.isFreestyleMode=!1,this._updateControls()})),this._pathRec.addEventListener("fr-record-started",(()=>{this.state.isFreestyleRecording=!0,this._updateControls()})),this._pathRec.addEventListener("fr-record-stopped",(()=>{this.state.isFreestyleRecording=!1,this.state.freestyleRecording=this._pathRec.getRecording(),this._updateControls()})),this._pathRec.addEventListener("fr-cleared",(()=>{this.state.freestyleRecording=null,this._updateControls()})),this._pathRec.addEventListener("fr-play-started",(()=>{this.state.freestylePlayback=!0,this._updateControls()})),this._pathRec.addEventListener("fr-play-stopped",(()=>{this.state.freestylePlayback=!1,this._updateControls(),this._frLastCell&&(this._releaseCell(this._frLastCell),this._frLastCell=null)})),this._pathRec.addEventListener("fr-play-input",(e=>{const{x:t,y:s,type:o}=e.detail||{},n=this._cellFromNorm(t,s);this._handleFreestyleInput(n,o)})),this._sequencerComponent=e("seq-app"),this._sequencerComponent.style.display="none",this._loader=e("div",{id:"loader",textContent:"..."}),s.append(o,this._controls,this._sequencerComponent,this._loader),t.append(s),this.shadowRoot.append(e("style",{textContent:this._style()}),e("tone-loader"),t),this._main.style.overflow="hidden",this._controls.setSeed?.(this.state.seed),this.shadowRoot.querySelector("tone-loader").addEventListener("tone-ready",this._onToneReady),addEvents(this._controls,[["start-request",this._onStartRequest],["mute-toggle",this._onMuteToggle],["shape-change",this._onShapeChange],["toggle-sequencer",this._onToggleSequencer],["audio-signature",this._onAudioSignature],["latch-toggle",this._onLatchToggle],["loop-toggle",this._onLoopToggle],["signature-mode-toggle",this._onSignatureModeToggle],["volume-change",this._onVolumeChange],["seed-set",this._handleSeedSubmit],["controls-resize",this._fitLayout],["fr-toggle",this._onFreestyleReadyToggle],["fr-play",this._onFreestylePlay],["save-state",this._onSaveState],["load-state",this._onLoadState],["next-seed",this._onNextSeed],["approve-seed",this._onApproveSeed],["reject-seed",this._onRejectSeed]]),this._canvas.onIndicatorUpdate=e=>{this._loader.textContent=this.state.isPlaying||this.state.contextUnlocked?e:"Initializing...",this._fitLayout()},this._seqPairs=[["seq-record-start",this._onSeqRecordStart],["seq-step-cleared",this._onSeqStepCleared],["seq-step-recorded",this._onSeqStepRecorded],["seq-play-started",this._onSeqPlayStarted],["seq-play-stopped",this._onSeqPlayStopped],["seq-step-advance",this._onSeqStepAdvance],["seq-step-time-changed",this._onSeqStepTimeChanged],["seq-steps-changed",this._onSeqStepsChanged]],addEvents(this._sequencerComponent,this._seqPairs),this._fitLayout(),setTimeout(this._fitLayout,50),setTimeout(this._fitLayout,250),on(window,"resize",this._onWindowResize,{passive:!0}),on(window,"orientationchange",this._onWindowResize,{passive:!0});try{this._resizeObserver=new ResizeObserver(this._fitLayout),this._controls&&this._resizeObserver.observe(this._controls),this._sequencerComponent&&this._resizeObserver.observe(this._sequencerComponent);const e=this.shadowRoot.getElementById("loader");e&&this._resizeObserver.observe(e)}catch{}}_onToggleControls(){const e=this._controls;if(!e)return;const t="none"===e.style.display;e.style.display=t?"flex":"none";try{this._fitLayout()}catch{}try{e.dispatchEvent(new Event("controls-resize"))}catch{}}_initControlsVisibility(){this._controls&&(this._controls.style.display="none"),this._hotkeys&&this._hotkeys.addEventListener("hk-toggle-controls",this._onToggleControls)}disconnectedCallback(){if(removeEvents(this._hotkeys,[["hk-press",this._onHotkeyPress],["hk-release",this._onHotkeyRelease],["hk-toggle-loop",this._onHotkeyLoopToggle],["hk-toggle-signature",this._onHotkeySignatureToggle],["hk-shape-step",this._onShapeStep]]),this._sequencerComponent&&removeEvents(this._sequencerComponent,this._seqPairs||[]),this._resizeObserver){try{this._resizeObserver.disconnect()}catch{}this._resizeObserver=null}off(window,"resize",this._onWindowResize),off(window,"orientationchange",this._onWindowResize)}_updateControls(e={}){const t=this._controls;if(!t)return;const s={...this.state,...e};s.contextUnlocked&&this._removePowerOverlay(),"function"==typeof t.updateState&&t.updateState(s),this.updateHkIcons?.(s),Object.prototype.hasOwnProperty.call(e,"sequencerVisible")&&this._fitLayout();try{const{isFreestyleMode:e,freestyleRecording:o,freestylePlayback:n}=s;t._frReadyBtn&&setPressed(t._frReadyBtn,!!e),t._frPlayBtn&&(t._frPlayBtn.disabled=!o,setText(t._frPlayBtn,n?"Stop":"FR Play"))}catch{}}_style(){return"\n      :host{display:block;width:100%;height:100%}\n      #appWrapper{display:flex;flex-direction:column;height:100dvh;padding-bottom:env(safe-area-inset-bottom,0)}\n      #main{width:100%;height:100%;display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;overflow:hidden;background:#000;gap:8px;padding-inline:env(safe-area-inset-left,0) env(safe-area-inset-right,0)}\n      #canvasContainer{flex:0 0 auto;max-width:100%;position:relative;display:flex;flex-direction:column;justify-content:center;align-items:center;transform:none;margin-left:auto;margin-right:auto;aspect-ratio:1/1;box-sizing:border-box}\n      #loader{font-size:.95rem;color:#aaa;min-height:1.3em;text-align:center;font-style:italic;margin:2px 0 8px}\n      @media (max-width:430px){:host{font-size:15px}}\n      @media (max-width:380px){:host{font-size:14px}}\n    "}_safeInsetBottom(){try{const e=document.createElement("div");e.style.cssText="position:fixed;bottom:0;height:0;padding-bottom:env(safe-area-inset-bottom,0px);visibility:hidden;pointer-events:none;",document.documentElement.appendChild(e);const t=parseFloat(getComputedStyle(e).paddingBottom)||0;return e.remove(),t}catch{return 0}}_measureChromeHeights(){const e=this.shadowRoot;if(!e)return{controlsH:0,loaderH:0,seqH:0};const t=e.querySelector("osc-controls"),s=e.getElementById("loader"),o=this._sequencerComponent,n=e=>e?e.getBoundingClientRect().height:0;return{controlsH:n(t),loaderH:n(s),seqH:o&&"none"!==o.style.display?n(o):0}}_fitLayout(){try{const e=this._canvasContainer,t=this._canvas,s=this._main;if(!e||!t||!s)return;const o=Math.max(1,window.innerWidth||document.documentElement.clientWidth),n=Math.max(1,window.innerHeight||document.documentElement.clientHeight),{controlsH:i,loaderH:a,seqH:r}=this._measureChromeHeights(),d=Math.max(1,n-i-a-r-this._safeInsetBottom()-10),l=Math.round(Math.max(1,Math.min(o,d)));Object.assign(e.style,{width:`${l}px`,height:`${l}px`,maxWidth:"100%",maxHeight:`calc(100dvh - ${i+a+r+this._safeInsetBottom()+10}px)`,aspectRatio:"1 / 1",boxSizing:"border-box",left:"",transform:""}),Object.assign(t.style,{width:"100%",height:"100%",aspectRatio:"1 / 1",display:"block",touchAction:"none"}),this._resizeFrCanvas?.()}catch(e){console.warn("fitLayout failed",e)}}_onWindowResize(){this._fitLayout()}_onHotkeyToggleSeqPlay(){this.state.sequencePlaying?this.stopSequence?.():this.playSequence?.()}_onSeqPlayStarted(e){const t=e?.detail?.stepTime,s=this.state;s.sequencePlaying=!0,s.sequenceStepIndex=0,s._seqFirstCycleStarted=!1,"number"==typeof t&&(s.stepTime=t),this._updateControls(),s.isSequenceSignatureMode&&(this._sequencerComponent?.stopSequence(),this._startSignatureSequencer())}_onSeqPlayStopped(){const e=this.state;if(e.sequencePlaying=!1,e.sequenceStepIndex=0,e._seqFirstCycleStarted=!1,e.signatureSequencerRunning&&this._stopSignatureSequencer(),!e.isLatchOn)try{const e=this.humKey;this._updateControls({shapeKey:e}),this._onShapeChange({detail:{shapeKey:e}})}catch{}this._updateControls()}_onHotkeyTogglePower(){(this.state||{}).isPlaying?this.stopAudioAndDraw?.():this._onStartRequest?.()}_handleSeedSubmit(e){const t=e?.detail?.value&&String(e.detail.value).trim()||(this.getAttribute("seed")||"").trim()||(document.documentElement?.dataset?.seed||"").trim()||"default";!t||t===this.state.seed||(this.resetToSeed(t),this._controls.setSeed?.(t))}resetToSeed(e){const{seedList:t,seedListIndex:s,seedListLoaded:o,approvedSeeds:n}=this.state;this.stopAudioAndDraw(),this.state.seed=e,this.setAttribute("seed",e),document?.documentElement&&(document.documentElement.dataset.seed=e),this.loadPresets(e),this.resetState?this.resetState():this.state=this.defaultState(e),this.state.seedList=t,this.state.seedListIndex=s,this.state.seedListLoaded=o,this.state.approvedSeeds=n,this._controls.setSeed?.(e),this._loader.textContent="Seed updated. Click POWER ON.",this._fitLayout()}_generateRandomSeed(){return Math.random().toString(36).substring(2,10)}_onNextSeed(){const e=this._generateRandomSeed();this._loader.textContent=`Loading new random seed: ${e}...`,this.resetToSeed(e),setTimeout((()=>{this._onStartRequest()}),150)}_onApproveSeed(){const{seed:e,approvedSeeds:t}=this.state;e&&!t.includes(e)&&(this.state.approvedSeeds.push(e),this._controls.updateApprovedSeeds(this.state.approvedSeeds),console.log("Approved seeds:",this.state.approvedSeeds)),this._onNextSeed()}_onRejectSeed(){this._onNextSeed()}_renderPowerOverlay(){try{const e=this.state,t=this._canvasContainer||this._main||this.shadowRoot?.host||document.body;if(!t)return;if(e?.contextUnlocked)return void this._removePowerOverlay();if(this._powerOverlay)return;const s=Object.assign(document.createElement("div"),{id:"powerOverlay"});Object.assign(s.style,{position:"absolute",inset:"0",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"20",pointerEvents:"auto",background:"rgba(0,0,0,.55)",userSelect:"none",cursor:"pointer",fontFamily:"'Courier New', monospace"});const o=Object.assign(document.createElement("div"),{textContent:"Click to power on"});Object.assign(o.style,{padding:"14px 18px",border:"1px dashed rgba(255,255,255,.65)",borderRadius:"8px",fontSize:"18px",letterSpacing:".06em",color:"#fff",background:"rgba(0,0,0,.25)",textShadow:"0 1px 2px rgba(0,0,0,.5)"}),s.appendChild(o);const n=this._canvasContainer||this._main;n&&"static"===getComputedStyle(n).position&&(n.style.position="relative"),(this._canvasContainer||this._main||t).appendChild(s),this._powerOverlay=s,s.addEventListener("click",(()=>this._onStartRequest?.()))}catch(e){console.error("overlay error",e)}}_removePowerOverlay(){this._powerOverlay?.parentNode?.removeChild(this._powerOverlay),this._powerOverlay=null}_setupCanvasClickGrid(){const e=this._canvas;if(!e||this._canvasClickGridSetup)return;this._canvasClickGridSetup=!0;const t=t=>{const s=e.getBoundingClientRect(),o=Math.max(0,Math.min(s.width,(t.clientX??0)-s.left)),n=Math.max(0,Math.min(s.height,(t.clientY??0)-s.top)),i=Math.min(4,Math.max(0,Math.floor(o/(s.width/5)))),a=Math.min(4,Math.max(0,Math.floor(n/(s.height/5)))),r=this._grid25?.cellInfo(a,i);return{row:a,col:i,info:r,xNorm:s.width>0?o/s.width:0,yNorm:s.height>0?n/s.height:0}},s=(e,t,s)=>{const o=`r${e}c${t}`,n=s?.shapeKey||this.humKey,i=n===this.humKey?-1:this.shapes.indexOf(n);this._heldKeys.add(o);const a={key:o,idx:i,shapeKey:n,variant:s?.variant||null};this._onHotkeyPress({detail:a})},o=e=>{this._onHotkeyRelease({detail:{key:e}})};this._onCanvasPointerDown=e=>{if(this.state?.contextUnlocked)try{this._isCanvasPointerDown=!0;try{e.target?.setPointerCapture?.(e.pointerId)}catch{}const{row:o,col:n,info:i,xNorm:a,yNorm:r}=t(e);if(this.state?.isFreestyleMode&&!this.state?.isSequencerMode)try{this._pathRec?.arm?.(),this._pathRec?.inputPointer?.("down",a,r,performance.now())}catch{}this._lastPointerKey=`r${o}c${n}`,this._lastPointerInfo=i||null,s(o,n,i)}catch(e){console.error("canvas grid down error",e)}else{try{this.unlockAudioAndBufferInitial?.()}catch{}e?.preventDefault?.()}},this._onCanvasPointerMove=e=>{if(this._isCanvasPointerDown&&this.state?.contextUnlocked)try{const{row:n,col:i,info:a,xNorm:r,yNorm:d}=t(e);if(this.state?.isFreestyleMode&&!this.state?.isSequencerMode)try{this._pathRec?.inputPointer?.("move",r,d,performance.now())}catch{}const l=`r${n}c${i}`;if(l!==this._lastPointerKey){const e=this._lastPointerKey;this._lastPointerKey=l,this._lastPointerInfo=a||null,e&&o(e),s(n,i,a)}}catch(e){console.error("canvas grid move error",e)}},this._onCanvasPointerUp=t=>{try{this._isCanvasPointerDown=!1,t?.target?.releasePointerCapture?.(t.pointerId)}catch{}if(this.state?.isFreestyleMode&&!this.state?.isSequencerMode)try{const s=e.getBoundingClientRect(),o=Math.max(0,Math.min(s.width,(t?.clientX??0)-s.left)),n=Math.max(0,Math.min(s.height,(t?.clientY??0)-s.top)),i=s.width>0?o/s.width:0,a=s.height>0?n/s.height:0;this._pathRec?.inputPointer?.("up",i,a,performance.now())}catch{}if(!this._lastPointerKey)return;const s=this._lastPointerKey;this._lastPointerKey=null,this._lastPointerInfo=null,o(s)},this._onCanvasPointerCancel=()=>{if(this._isCanvasPointerDown=!1,this.state?.isFreestyleMode&&!this.state?.isSequencerMode)try{this._pathRec?.inputPointer?.("up",0,0,performance.now())}catch{}if(this._lastPointerKey){const e=this._lastPointerKey;this._lastPointerKey=null,this._lastPointerInfo=null,o(e)}},addEvents(e,[["pointerdown",this._onCanvasPointerDown],["pointermove",this._onCanvasPointerMove],["pointercancel",this._onCanvasPointerCancel],["pointerleave",this._onCanvasPointerUp]]),on(window,"pointerup",this._onCanvasPointerUp)}_onHotkeyLoopToggle(){this._onLoopToggle()}_onHotkeySignatureToggle(){this._onSignatureModeToggle()}_onHotkeyPress({detail:e}){const t=this.state,{key:s,idx:o,shapeKey:n,variant:i}=e||{};if(!n)return;if(t._transientOverride=i||null,t.isSequenceSignatureMode)return void this._triggerSignatureFor(n,{loop:t.isLoopEnabled});this._heldKeys.add(s);const a=()=>{this.setActiveChain(n),t._transientOverride&&this.applyVariant?.(n,t._transientOverride),o>=0&&this._setCanvas({shapeKey:n,preset:t.presets[n],mode:"live"}),this._canvas.isPlaying=!0,this._updateControls({shapeKey:n}),t.current=n,n!==this.humKey&&(t._uiReturnShapeKey=n)};t.isSequencerMode,t.contextUnlocked&&t.initialShapeBuffered&&a()}_onHotkeyRelease({detail:e}){const t=this.state,{key:s}=e||{};this._heldKeys?.has(s)&&(this._heldKeys.delete(s),this._recordedThisHold?.delete?.(s),t._transientOverride&&t.current&&t.current!==this.humKey&&this.applyVariant?.(t.current,null),t._transientOverride=null,!t.isLatchOn&&t.contextUnlocked&&t.initialShapeBuffered&&(this.setActiveChain(this.humKey,{updateCanvasShape:!1,setStateCurrent:!1}),this._canvas.isPlaying=!1,t._uiReturnShapeKey?this._updateControls({shapeKey:t._uiReturnShapeKey}):this._updateControls()))}_onShapeStep({detail:e}){const t=e?.direction;if(!t||!this.shapes.length)return;const s=this.state,o=this.shapes,n=s._uiReturnShapeKey||s.current;let i=o.indexOf(n);-1===i&&(i=1===t?-1:0);const a=o[(i+t+o.length)%o.length];s.contextUnlocked&&s.initialShapeBuffered&&(this.setActiveChain(a),this._setCanvas({shapeKey:a,preset:s.presets[a],mode:"live"}),this._canvas.isPlaying=!0,this._updateControls({shapeKey:a}),s.current=s._uiReturnShapeKey=a)}_onFreestyleReadyToggle(){const e=this.state||{},t=!e.isFreestyleMode;e.isFreestyleMode=t;try{t?this._pathRec?.arm?.():this._pathRec?.disarm?.()}catch{}this._updateControls()}_onFreestylePlay(){const e=this.state||{};try{e.freestylePlayback?this._pathRec?.stop?.():e.freestyleRecording&&this._pathRec?.play?.(e.freestyleRecording,{loop:!!e.isLoopEnabled})}catch{}}_cellFromNorm(e,t){const s=Math.min(4,Math.max(0,Math.floor(5*t))),o=Math.min(4,Math.max(0,Math.floor(5*e)));return{row:s,col:o,info:this._grid25?.cellInfo(s,o)||null}}_resizeFrCanvas(){const e=this._frCanvas;if(!e)return;const t=(this._canvasContainer||this._canvas||e.parentElement).getBoundingClientRect(),s=Math.max(1,Math.round(window.devicePixelRatio||1)),o=Math.max(1,Math.round(t.width*s)),n=Math.max(1,Math.round(t.height*s));e.width===o&&e.height===n||(e.width=o,e.height=n,e.style.width="100%",e.style.height="100%")}_pressCell(e){if(!e)return;const{row:t,col:s,info:o}=e,n=`r${t}c${s}`,i=o?.shapeKey||this.humKey,a=i===this.humKey?-1:this.shapes.indexOf(i);this._heldKeys.add(n);const r={key:n,idx:a,shapeKey:i,variant:o?.variant||null};this._onHotkeyPress({detail:r})}_releaseCell(e){if(!e)return;const t="string"==typeof e?e:`r${e.row}c${e.col}`;this._onHotkeyRelease({detail:{key:t}})}_handleFreestyleInput(e,t){e&&("down"===t?(!this._frLastCell||this._frLastCell.row===e.row&&this._frLastCell.col===e.col||this._releaseCell(this._frLastCell),this._pressCell(e),this._frLastCell=e):"move"===t?this._frLastCell&&this._frLastCell.row===e.row&&this._frLastCell.col===e.col||(this._frLastCell&&this._releaseCell(this._frLastCell),this._pressCell(e),this._frLastCell=e):"up"===t&&this._frLastCell&&(this._releaseCell(this._frLastCell),this._frLastCell=null))}_onLatchToggle(){this.state.isLatchOn=!this.state.isLatchOn,this._updateControls();const e=this.state;e.isLatchOn||e.isSequencerMode||this._heldKeys?.size||!e.contextUnlocked||!e.initialShapeBuffered||(this.setActiveChain(this.humKey,{updateCanvasShape:!1,setStateCurrent:!1}),this._canvas.isPlaying=!1)}async _onSaveState(){try{const e={...this.state,Tone:void 0,chains:void 0,audioSignatureTimer:void 0,sequenceIntervalId:void 0,sequencerState:this._sequencerComponent?{steps:this._sequencerComponent.steps,state:this._sequencerComponent.state}:null,pathRecorderState:this._pathRec?{recording:this._pathRec.getRecording(),isArmed:this._pathRec._armed,loop:this._pathRec._loop}:null,uiState:{sequencerVisible:"none"!==this._sequencerComponent?.style.display,currentShapeKey:this.state.current,volume:this.state.volume},saveTimestamp:(new Date).toISOString(),version:"v19.3"},t=JSON.stringify(e,null,2);if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(t),this._showNotification("State saved to clipboard successfully!","success");else{const e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),this._showNotification("State saved to clipboard (fallback method)","success")}console.log("Saved state:",e)}catch(e){console.error("Error saving state:",e),this._showNotification("Error saving state: "+e.message,"error")}}async _onLoadState(){try{const e=prompt("Paste the JSON state data to load:");if(!e||""===e.trim())return;const t=JSON.parse(e);if(!t||"object"!=typeof t)throw new Error("Invalid state data format");this.state.sequencePlaying&&this._sequencerComponent?.stopSequence(),this.state.freestylePlayback&&this._pathRec?.stop();const s={...this.state};if(["isMuted","isLoopEnabled","volume","isSequencerMode","isRecording","currentRecordSlot","sequence","velocities","sequenceStepIndex","stepTime","sequenceSteps","isSequenceSignatureMode","isLatchOn","seed","uiHomeShapeKey","isFreestyleMode","freestyleRecording","approvedSeeds"].forEach((e=>{t.hasOwnProperty(e)&&(s[e]=t[e])})),Object.assign(this.state,s),t.sequencerState&&this._sequencerComponent){const e=t.sequencerState;e.steps&&this._sequencerComponent.changeStepCount(e.steps),e.state&&(Object.assign(this._sequencerComponent.state,e.state),this._sequencerComponent.updateSequenceUI(),this._sequencerComponent.updateStepControls())}if(t.pathRecorderState&&this._pathRec){const e=t.pathRecorderState;e.recording&&(this.state.freestyleRecording=e.recording),void 0!==e.loop&&this._pathRec.setLoop(e.loop)}if(t.uiState){const e=t.uiState;void 0!==e.sequencerVisible&&this._sequencerComponent&&(this._sequencerComponent.style.display=e.sequencerVisible?"block":"none",this.state.isSequencerMode=e.sequencerVisible),void 0!==e.volume&&(this.state.volume=e.volume)}t.seed&&t.seed!==this.state.seed&&this.resetToSeed(t.seed),this._controls.updateApprovedSeeds(this.state.approvedSeeds),this._updateControls(),this._fitLayout(),this._showNotification("State loaded successfully!","success"),console.log("Loaded state:",t)}catch(e){console.error("Error loading state:",e),this._showNotification("Error loading state: "+e.message,"error")}}_showNotification(e,t="info"){const s=document.createElement("div");s.textContent=e,Object.assign(s.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"6px",color:"#fff",fontFamily:"inherit",fontSize:"14px",zIndex:"10000",maxWidth:"300px",wordWrap:"break-word",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",background:"success"===t?"#4CAF50":"error"===t?"#f44336":"#2196F3"}),document.body.appendChild(s),setTimeout((()=>{s.parentNode&&s.parentNode.removeChild(s)}),3e3)}}customElements.define("osc-app",OscApp);export{OscApp};