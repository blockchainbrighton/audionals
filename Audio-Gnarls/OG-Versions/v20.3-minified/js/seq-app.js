import{clamp01}from"./utils.js";class SeqApp extends HTMLElement{static VALID_SIZES=[8,16,32,64];static DEFAULT_STEPS=8;static MIN_MS=50;static MAX_MS=2e3;#t=(t,e={})=>this.dispatchEvent(new CustomEvent(t,{detail:e,bubbles:!0,composed:!0}));#e=()=>this.state.sequence.length;#s=t=>(t+1)%this.#e();#i=()=>this._stepSlotsDiv?.querySelectorAll(".step-slot")??[];#n=t=>this.state.velocities?.[t]??1;#a=(t,e)=>this.state.sequence[t]=e;#o=(t,e)=>this.state.velocities[t]=e;#l=t=>this.state.isRecording&&this.state.currentRecordSlot===t;#r=t=>this.state.sequencePlaying&&this.state.sequenceStepIndex===t;#h=(t,e,s="Alt-drag to edit")=>t.title=`Velocity: ${Math.round(100*e)}% (${s})`;#d=t=>SeqApp.VALID_SIZES[SeqApp.VALID_SIZES.indexOf(this.steps)+t]??null;#c(t){this.steps=t,Object.assign(this.state,{sequence:Array(t).fill(null),velocities:Array(t).fill(1),sequenceStepIndex:0})}#p(){const t=t=>this.shadowRoot.getElementById(t);this._stepSlotsDiv=t("stepSlots"),this._playBtn=t("playBtn"),this._stepTimeInput=t("stepTimeInput"),this._addBlockBtn=t("addBlockBtn"),this._removeBlockBtn=t("removeBlockBtn"),this._stepInfo=t("stepInfo")}#u(){this._eventListeners||=[];const t=(t,e,s)=>t&&(t.addEventListener(e,s),this._eventListeners.push([t,e,s]));t(this._playBtn,"click",this.handlePlayClick),t(this._stepTimeInput,"change",this.handleStepTimeChange),t(this._addBlockBtn,"click",this.handleAddBlock),t(this._removeBlockBtn,"click",this.handleRemoveBlock)}_applyPendingEdits(){const t=this._pendingEdits||[];if(t.length){for(const e of t)"paint"===e.type?(this.#a(e.i,e.value),this.#t("seq-step-recorded",{slotIndex:e.i,value:e.value,nextSlot:this.#s(e.i),isRecording:!1})):(this.#a(e.i,null),this.#t("seq-step-cleared",{slotIndex:e.i}));this._pendingEdits.length=0,this.updateSequenceUI()}}#S(t,e){if(!this.state.isRecording||t<0||t>=this.#e())return;this._pendingEdits&&(this._pendingEdits=this._pendingEdits.filter((e=>e.i!==t))),this.#a(t,e);const s=this.#s(t);this.state.currentRecordSlot=s,0===s&&(this.state.isRecording=!1),this.updateSequenceUI(),this.#t("seq-step-recorded",{slotIndex:t,value:e,nextSlot:s,isRecording:this.state.isRecording})}#g(t){this.#a(t,null),this.updateSequenceUI(),this.#t("seq-step-cleared",{slotIndex:t})}#m(t,e){this._pendingEdits||=[],this._pendingEdits.push(null==e?{type:"clear",i:t}:{type:"paint",i:t,value:0}),this.#a(t,null==e?null:0),this.updateSequenceUI()}#q(t){const e=null==this.state.sequence[t]?1:null;Object.assign(this._dragState,{painting:!0,mode:"paint",setTo:e,lastIndex:-1}),this.#m(t,e)}#_(t,e){Object.assign(this._dragState,{painting:!0,mode:"velocity",baseVel:this.#n(t),startY:e.clientY,lastIndex:t})}#f(t){const e=this._dragState;e.painting&&"paint"===e.mode&&e.lastIndex!==t&&(e.lastIndex=t,this.#m(t,e.setTo))}#v(t,e,s,i){const n=this._dragState;if(!n.painting||"velocity"!==n.mode)return;this._velocityUpdateThrottle||={};const a=Date.now(),o=this._velocityUpdateThrottle[t];if(o&&a-o<16)return;this._velocityUpdateThrottle[t]=a;const l=clamp01(n.baseVel+(n.startY-e.clientY)/150*(e.shiftKey?.25:1));this.#o(t,l),this.#h(s,l,"Alt-drag"+(e.shiftKey?" + Shift":"")),i.style.height=`${Math.round(100*l)}%`}#b(t){const e=Object.assign(document.createElement("div"),{className:"step-slot"});e.dataset.index=`${t}`;const s=Object.assign(document.createElement("div"),{className:"vel-bar"}),i=Object.assign(document.createElement("div"),{className:"digit"});e.append(s,i),this._slotListeners||=[];const n=(t,s)=>(e.addEventListener(t,s),this._slotListeners.push([e,t,s]));return n("click",(()=>this.handleStepClick(t))),n("contextmenu",(e=>this.handleStepRightClick(e,t))),n("pointerdown",(s=>(s.altKey?this.#_(t,s):this.#q(t),e.setPointerCapture(s.pointerId)))),n("pointerenter",(()=>this.#f(t))),n("pointermove",(i=>this.#v(t,i,e,s))),e}#y(){this.render(),this.#u(),this.updateSequenceUI()}constructor(){super(),this.attachShadow({mode:"open"}),this.state={isRecording:!1,currentRecordSlot:-1,sequence:[],velocities:[],sequencePlaying:!1,sequenceStepIndex:0,stepTime:400},["updateState","updateSequenceUI","recordStep","playSequence","stopSequence","handleStepClick","handleStepRightClick","handlePlayClick","handleStepTimeChange","handleAddBlock","handleRemoveBlock","updateStepControls","_onWindowKeyDown","_onPointerUpGlobal","createSequenceUI","render","changeStepCount"].forEach((t=>this[t]=this[t].bind(this))),this._eventListeners=[],this._slotListeners=[]}connectedCallback(){const t=Number(this.getAttribute("steps"))||SeqApp.DEFAULT_STEPS;this.#c(SeqApp.VALID_SIZES.includes(t)?t:SeqApp.DEFAULT_STEPS),this.render(),this.updateSequenceUI(),this.#u(),window.addEventListener("keydown",this._onWindowKeyDown),window.addEventListener("pointerup",this._onPointerUpGlobal),this._globalListeners=[["keydown",this._onWindowKeyDown],["pointerup",this._onPointerUpGlobal]]}disconnectedCallback(){(this._globalListeners||[]).forEach((([t,e])=>window.removeEventListener(t,e))),(this._eventListeners||[]).forEach((([t,e,s])=>t.removeEventListener(e,s))),(this._slotListeners||[]).forEach((([t,e,s])=>t.removeEventListener(e,s))),this._globalListeners=this._eventListeners=this._slotListeners=[],this._seqTimer&&clearTimeout(this._seqTimer),this._tailTimer&&clearTimeout(this._tailTimer),this._velocityUpdateThrottle=null}render(){const t=Math.min(8,this.steps),e=Math.min(320,40*this.steps),{MIN_MS:s,MAX_MS:i}=SeqApp;this.shadowRoot.innerHTML=`\n      <style>\n        :host{display:block;text-align:center;width:95%;margin:.8em auto 0;font-family:sans-serif}\n        #stepSlots{display:grid;grid-template-columns:repeat(${t},1fr);gap:.4em;margin:.6em auto .7em;max-width:${e}px;width:100%;justify-content:center;align-content:center;padding:0;border-radius:6px;background:#fff0;box-shadow:0 0 12px #0003}\n        #stepControls{display:flex;align-items:center;justify-content:center;gap:1rem;margin:.5em 0;font-size:.9em}\n        #stepControls button{padding:.3em .8em;border-radius:4px;border:1px solid #666;background:#212;color:#ffe0a3;cursor:pointer;font:inherit;font-size:.9em;transition:background .18s}\n        #stepControls button:hover{background:#323}\n        #stepControls button:disabled{opacity:.5;cursor:not-allowed}\n        #stepInfo{color:#aaa;font-size:.85em}\n        .step-slot{position:relative;width:37px;height:37px;border:1px solid #555;border-radius:6px;background:#232325;display:grid;place-items:center;cursor:pointer;font-weight:700;font-size:1.12rem;user-select:none;transition:background .15s,box-shadow .16s,border-color .16s}\n        .step-slot.record-mode{background:#343;box-shadow:0 0 7px #f7c46988}\n        .step-slot.active{border-color:#7af6ff;box-shadow:0 0 8px #7af6ff88}\n        .step-slot.record-mode.active{background:#575;box-shadow:0 0 12px #f7c469d6}\n        .digit{position:relative;z-index:2;color:#eee}\n        .vel-bar{position:absolute;bottom:0;left:0;width:100%;height:0%;background:#7af6ff55;border-bottom-left-radius:6px;border-bottom-right-radius:6px;pointer-events:none;transition:height .05s linear;z-index:1}\n        #sequenceControls{display:flex;align-items:center;justify-content:center;gap:1.1rem;margin:1.1em 0 0;width:100%}\n        #playBtn{min-width:150px;font-size:1.09rem;padding:.44em 1.4em;border-radius:7px;margin:0;background:#181818;color:#fff;border:2px solid #7af6ff;transition:background .19s,color .19s;box-shadow:0 2px 10px #7af6ff22}\n        #playBtn:hover{background:#212d3d;color:#fff;border-color:#fff}\n        #playBtn:disabled{opacity:.5;cursor:not-allowed;background:#181818;border-color:#555;color:#888}\n        #stepTimeInput{width:60px;margin-left:.7em}\n      </style>\n      <div id="sequencer">\n        <div id="stepControls">\n          <button id="removeBlockBtn">Remove Block (-8)</button>\n          <span id="stepInfo">${this.steps} steps (${this.steps/8} blocks)</span>\n          <button id="addBlockBtn">Add Block (+8)</button>\n        </div>\n        <div id="stepSlots"></div>\n        <div id="sequenceControls">\n          <button id="playBtn">Play Sequence</button>\n          <label for="stepTimeInput" style="margin-left:1.2em;">Step Time (ms):</label>\n          <input type="number" id="stepTimeInput" min="${s}" max="${i}" value="${this.state.stepTime}"/>\n        </div>\n      </div>`,this.#p(),this.createSequenceUI(),this.updateStepControls()}createSequenceUI(){if(!this._stepSlotsDiv)return;(this._slotListeners||[]).forEach((([t,e,s])=>t.removeEventListener(e,s))),this._slotListeners=[],this._stepSlotsDiv.innerHTML="",this._dragState={painting:!1,mode:null,setTo:null,baseVel:1,startY:0,lastIndex:-1};const t=document.createDocumentFragment();for(let e=0;e<this.steps;e++)t.appendChild(this.#b(e));this._stepSlotsDiv.appendChild(t)}updateState(t={}){if("steps"in t){const e=SeqApp.VALID_SIZES.includes(t.steps)?t.steps:this.steps;if(e!==this.steps)return this.#c(e),this.#y()}Object.assign(this.state,t),this.updateSequenceUI()}updateSequenceUI(){if(!this._stepSlotsDiv)return;const{sequence:t,velocities:e,sequencePlaying:s,stepTime:i}=this.state;for(const s of this.#i()){const i=+s.dataset.index,n=t[i],a=s.querySelector(".digit"),o=s.querySelector(".vel-bar"),l=e?.[i]??1;a&&(a.textContent=0===n?"0":n??""),s.classList.toggle("record-mode",this.#l(i)),s.classList.toggle("active",this.#r(i)),o&&(o.style.height=`${Math.round(100*l)}%`),s.title?.startsWith("Velocity:")||this.#h(s,l)}this._playBtn&&(this._playBtn.textContent=s?"Stop Sequence":"Play Sequence",this._playBtn.disabled=!s&&!this.hasPopulatedSteps()),this._stepTimeInput&&!s&&(this._stepTimeInput.value=i),this.updateStepControls()}handleStepClick(t){this.state.isRecording=!0,this.state.currentRecordSlot=t,this.updateSequenceUI(),this.#t("seq-record-start",{slotIndex:t})}handleStepRightClick(t,e){t.preventDefault(),this._pendingEdits||=[],this._pendingEdits.push({type:"clear",i:e}),this.#a(e,null),this.updateSequenceUI()}handlePlayClick(){this.state.sequencePlaying?this.stopSequence():this.playSequence()}handleStepTimeChange(){const t=this._stepTimeInput;if(!t)return;const e=parseInt(t.value,10);!Number.isFinite(e)||e<SeqApp.MIN_MS||e>SeqApp.MAX_MS||(this.state.stepTime=e,this.#t("seq-step-time-changed",{stepTime:e}))}handleAddBlock(){if(!this.state.sequencePlaying){const t=this.#d(1);t&&this.changeStepCount(t)}}handleRemoveBlock(){if(!this.state.sequencePlaying){const t=this.#d(-1);t&&this.changeStepCount(t)}}changeStepCount(t){if(!SeqApp.VALID_SIZES.includes(t))return;this.state.isRecording=!1,this.state.currentRecordSlot=-1;const e=[...this.state.sequence],s=[...this.state.velocities];this.steps=t,this.state.sequence=Array(t).fill(null),this.state.velocities=Array(t).fill(1);for(let i=0,n=Math.min(e.length,t);i<n;i++)this.state.sequence[i]=e[i],this.state.velocities[i]=s[i];this.state.sequenceStepIndex>=t&&(this.state.sequenceStepIndex=0),this.#y(),this.#t("seq-steps-changed",{steps:t})}updateStepControls(){this._addBlockBtn&&(this._addBlockBtn.disabled=this.steps>=64||this.state.sequencePlaying),this._removeBlockBtn&&(this._removeBlockBtn.disabled=this.steps<=8||this.state.sequencePlaying),this._stepInfo&&(this._stepInfo.textContent=`${this.steps} steps (${this.steps/8} blocks)`)}_onWindowKeyDown(t){this.state.isRecording&&/^[0-9]$/.test(t.key)&&this.#S(this.state.currentRecordSlot,parseInt(t.key,10))}_onPointerUpGlobal(){this._dragState&&Object.assign(this._dragState,{painting:!1,mode:null,lastIndex:-1})}recordStep(t){this.#S(this.state.currentRecordSlot,t)}hasPopulatedSteps(){return this.state.sequence.some((t=>null!==t))}playSequence(){if(this.state.sequencePlaying||!this.hasPopulatedSteps())return;this.state.sequencePlaying=!0,this.state.sequenceStepIndex=0,this.#t("seq-play-started",{stepTime:this.state.stepTime});const t=()=>{if(!this.state.sequencePlaying)return;this._applyPendingEdits();const e=this.state.sequenceStepIndex;this.updateSequenceUI();const s=this.state.sequence[e],i=this.#n(e),n=0===this.#s(e);this.#t("seq-step-advance",{stepIndex:e,index:e,value:s,velocity:i,isLastStep:n}),this.state.sequenceStepIndex=this.#s(e),this._seqTimer=this.state.sequencePlaying?setTimeout(t,this.state.stepTime):null};t()}stopSequence(){this.state.sequencePlaying=!1,this._seqTimer&&(clearTimeout(this._seqTimer),this._seqTimer=null),this._tailTimer&&(clearTimeout(this._tailTimer),this._tailTimer=null),this._applyPendingEdits(),this.state.sequenceStepIndex=0,this.updateSequenceUI(),this.#t("seq-play-stopped",{});const t=Math.max(20,Math.min(this.state.stepTime,200));this._tailTimer=setTimeout((()=>{this.#t("seq-step-advance",{stepIndex:-1,index:-1,value:0,velocity:1,isLastStep:!0}),this._tailTimer=null}),t)}}customElements.get("seq-app")||customElements.define("seq-app",SeqApp);