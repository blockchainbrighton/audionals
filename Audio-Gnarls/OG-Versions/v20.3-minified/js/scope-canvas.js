import{sin,cos,abs,PI,pow,SQRT2,imul,min,max,TAU,theta,norm}from"./utils.js";(()=>{const t={PROB:{"mono-prob":.02,"half-dominant-prob":.05,"group-strobe-prob":.01,"dark-palette-prob":.01,"neutral-palette-prob":.05},HALF_DOMINANT_RATIO:.5,CYCLER_SPEEDS:{slow:.03,medium:.06,fast:.12,lightning:.6},EFFECT_WEIGHTS:{none:60,glow:25,strobe:10,neon:5},CYC_SPEED_WEIGHTS:{slow:25,medium:40,fast:25,lightning:10},COLOR_WEIGHTS:{bitcoin_orange:3,stacks_purple:2,deep_purple:2,light_magenta:3,shocking_pink:4,royal_blue:10,dark_green:3,bright_pink:6,bright_red:12,dark_red:6,bright_yellow:1,gold:1,white:3,dark_gray:2,cycler:3},DARK_COLOR_WEIGHTS:{extra_dark_purple:2,very_dark_blue:2,very_dark_green:3,dark_red:5,extra_dark_gray:3,charcoal:2,near_black:1,gold:1},NEUTRAL_COLOR_WEIGHTS:{near_black:4,extra_dark_gray:5,charcoal:5,dark_gray:5,slate_gray:4,dim_gray:4,silver:3,gainsboro:3,off_white:4,white:3},NAMED_COLORS:{bitcoin_orange:"#F7931A",stacks_purple:"#5546FF",deep_purple:"#4B1EFF",light_magenta:"#FF4FD8",shocking_pink:"#FF00A8",bright_pink:"#FF1493",bright_red:"#FF1A1A",dark_red:"#6A0000",royal_blue:"#0726a2ff",dark_green:"#017210ff",bright_yellow:"#FFD400",gold:"#FFD700",white:"#FFFFFF",dark_gray:"rgba(16,16,24,0.40)",stacks_purple_dark:"#241E72",extra_dark_purple:"#1C0033",very_dark_blue:"#0B1E3A",very_dark_green:"#012B1B",extra_dark_gray:"#0F1014",charcoal:"#14161C",slate_gray:"#2A2F3A",dim_gray:"#6E6E73",silver:"#C0C0C8",gainsboro:"#DDDEE3"}},e=(Object.keys(t.DARK_COLOR_WEIGHTS),Object.keys(t.NEUTRAL_COLOR_WEIGHTS)),s=t=>{let e=(t=>{let e=0;for(let s=0;s<t.length;s++)e=(e<<5)-e+t.charCodeAt(s);return 0|e})(t);return()=>{e=e+1831565813|0;let t=imul(e^e>>>15,1|e);return t=t+imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296}},i=(t,e)=>{const s=Object.keys(e);if(!s.length)return null;const i=s.map((t=>max(0,+e[t]||0))),r=i.reduce(((t,e)=>t+e),0);if(r<=0)return s[0];let o=t()*r;for(let t=0;t<s.length;t++)if(o-=i[t],o<=0)return s[t];return s.at(-1)},r=(t,e)=>Object.fromEntries(e.filter((e=>e in t)).map((e=>[e,t[e]]))),o=(t,e,s)=>{const i=e.slice();for(let e=i.length-1;e>0;e--){const s=t()*(e+1)|0;[i[e],i[s]]=[i[s],i[e]]}return i.slice(0,s)},a={circle:{freq:1,harmonics:[1,.5,.25],complexity:.3},square:{freq:1.5,harmonics:[1,.3,.7,.2],complexity:.6},butterfly:{freq:2.2,harmonics:[1,.4,.6,.3,.2],complexity:.8},Bowditch:{freq:1.8,harmonics:[1,.6,.4],complexity:.5},spiro:{freq:3.1,harmonics:[1,.3,.5,.2,.4],complexity:.9},harmonograph:{freq:2.5,harmonics:[1,.7,.5,.3,.2,.1],complexity:1},rose:{freq:1.7,harmonics:[1,.4,.3,.2],complexity:.4},hypocycloid:{freq:2.8,harmonics:[1,.5,.3,.4],complexity:.7},epicycloid:{freq:2.9,harmonics:[1,.4,.5,.3],complexity:.7},spiral:{freq:1.3,harmonics:[1,.3,.2],complexity:.4},star:{freq:2.1,harmonics:[1,.6,.4,.2],complexity:.6},flower:{freq:1.9,harmonics:[1,.5,.3,.4],complexity:.5},wave:{freq:1.1,harmonics:[1,.4,.2],complexity:.3},mandala:{freq:3.5,harmonics:[1,.3,.4,.2,.3,.1],complexity:1.2},infinity:{freq:1.6,harmonics:[1,.5,.3],complexity:.4},dna:{freq:2.7,harmonics:[1,.4,.3,.5,.2],complexity:.8},tornado:{freq:3.2,harmonics:[1,.3,.6,.2,.4],complexity:1.1},hum:{freq:.8,harmonics:[1,.2,.1],complexity:.2}};class n extends HTMLElement{constructor(){super();const t=this.attachShadow({mode:"open"}),e=document.createElement("style");e.textContent=":host{display:block;width:100%;height:100%}canvas{display:block;width:100%;height:100%}",t.append(e),this._canvas=document.createElement("canvas"),t.append(this._canvas),this._ctx=this._canvas.getContext("2d"),this.analyser=null,this.preset=null,this.shapeKey="circle",this.mode="seed",this.isAudioStarted=!1,this.isPlaying=!1,this.onIndicatorUpdate=null,this._plan=null,this._dummyData=null,this._liveBuffer=null,this._animId=null,this._cssW=0,this._cssH=0,this._dpr=1,this._animate=this._animate.bind(this),this._resizeCanvas=this._resizeCanvas.bind(this),this._samp=(t,e)=>t?t[e%t.length]??0:0,this._ampAt=(t,e)=>norm(this._samp(t,e)),this._avgAbs=t=>t.reduce?.(((t,e)=>t+abs(e)),0)/t.length??0,this._withCtx=t=>{const e=this._cssW||this._canvas.clientWidth||this._canvas.width,s=this._canvas.width/2|0,i=this._canvas.height/2|0,r=min(s,i)/(this._dpr||1);return t(this._ctx,e,r)},this._traceParam=(t,e,{close:s=!1}={})=>this._withCtx(((i,r,o)=>{i.beginPath();for(let s=0,a=t.length;s<a;s++){const[t,n]=e(s,a,r,o);s?i.lineTo(t,n):i.moveTo(t,n)}s&&i.closePath(),i.stroke()})),this._tracePolar=(t,e,{phase:s=0,close:i=!1}={})=>this._traceParam(t,((t,i,r,o)=>{const a=theta(t,i,s),n=e(t,i,a,r,o);return[o+cos(a)*n,o+sin(a)*n]}),{close:i}),this._prepareStroke=(t,{effect:e="none",now:s=0}={})=>{const i=this._ctx;if(i.clearRect(0,0,this._cssW,this._cssH),i.globalCompositeOperation="source-over",i.shadowBlur=0,i.shadowColor="transparent",i.globalAlpha=1,i.lineWidth=2,i.lineJoin=i.lineCap="round","glow"===e)i.shadowBlur=16,i.shadowColor=t;else if("neon"===e)i.shadowBlur=28,i.shadowColor=t,i.globalCompositeOperation="lighter",i.lineWidth=2.6;else if("strobe"===e){const t=s*(10+s%1e3*.002)/1e3%1<.5;i.globalAlpha=t?1:.22}i.strokeStyle=t};const s=t=>(e,s)=>this._withCtx(((i,r,o)=>{const a="epi"===t?1:-1,n=("epi"===t?.36:.39)*r,h="epi"===t?4+Math.round(3*abs(sin(21e-5*s+.5))):3+Math.round(3*abs(cos(23e-5*s))),c=1/h,l=(1+a*c)/c,_="epi"===t?38e-5*s:4e-4*s;this._traceParam(e,((t,s)=>{const i=theta(t,s,_),r=.7+.3*this._ampAt(e,t),h=n*((1+a*c)*cos(i)-a*c*cos(l*i))*r,p=n*((1+a*c)*sin(i)-c*sin(l*i))*r;return[o+h,o+p]}),{close:!0})}));this.drawFuncs={hum:(t,e)=>this._withCtx(((s,i,r)=>{const o=.33*i+5*sin(2e-4*e);s.save(),s.globalAlpha=.23+.14*abs(sin(4e-4*e)),s.beginPath(),s.arc(r,r,o,0,TAU),s.stroke();const a=!!this._plan?.isMono;s.strokeStyle=a?this._getColorFor("hum",e).css:"hsl(195, 80%, 62%)",s.globalAlpha=.36,s.beginPath();for(let i=0,a=128;i<a;i++){const n=i/a*TAU,h=o+(12*sin(3*n+45e-5*e)+6*sin(6*n-32e-5*e))+7*this._samp(t,i),c=r+cos(n)*h,l=r+sin(n)*h;i?s.lineTo(c,l):s.moveTo(c,l)}s.closePath(),s.stroke(),s.restore()})),circle:(t,e)=>this._withCtx(((s,i,r)=>this._traceParam(t,((s,o)=>{const a=theta(s,o,.001*e),n=.4*i*this._ampAt(t,s);return[r+cos(a)*n,r+sin(a)*n]}),{close:!0}))),square:(t,e)=>this._withCtx(((s,i,r)=>{const o=.8*i/SQRT2,a=(i-o)/2,n=10*sin(5e-4*e),h=10*cos(6e-4*e);this._traceParam(t,((e,s)=>{const i=e/s,[c,l]=(t=>t<.25?[a+o*(t/.25),a]:t<.5?[a+o,a+o*((t-.25)/.25)]:t<.75?[a+o-o*((t-.5)/.25),a+o]:[a,a+o-o*((t-.75)/.25)])(i);if(!e)return[c,l];const _=.8+.2*this._ampAt(t,e);return[r+(c-r)*_+n,r+(l-r)*_+h]}),{close:!0})})),butterfly:(t,e)=>this._withCtx((()=>this._traceParam(t,((s,i,r,o)=>{const a=s/i*PI*28+35e-5*e,n=pow(this._ampAt(t,s),1.25),h=.22*(Math.exp(.85*cos(a))-1.6*cos(5*a)+pow(sin(a/10),7))*r*(.5+.5*n);return[o+sin(a)*h,o+cos(a)*h]}),{close:!0}))),Bowditch:(t,e)=>this._withCtx(((s,i,r)=>{const o=.8*i/3,a=this._avgAbs(t),n=3+1.5*sin(3e-4*e),h=2+1.5*cos(4e-4*e),c=5e-4*e;this._traceParam(t,((e,s)=>{const i=theta(e,s),l=a*(.5+.5*this._samp(t,e));return[r+sin(n*i+c)*o*l,r+sin(h*i)*o*l]}))})),spiro:(t,e)=>this._withCtx(((s,i,r)=>{const o=.6*i/3,a=.3+.2*sin(2e-4*e),n=.21+.02*sin(1e-4*e),h=(.7-a)/a;this._traceParam(t,((s,i)=>{const c=theta(s,i),l=.8+.2*this._ampAt(t,s),_=(o*(.7-a)*cos(c)+o*a*cos(h*c+e*n))*l,p=(o*(.7-a)*sin(c)-o*a*sin(h*c+e*n))*l;return[r+_,r+p]}))})),harmonograph:(t,e)=>this._withCtx(((s,i,r)=>{const o=.7*i/4;this._traceParam(t,((s,i)=>{const a=theta(s,i),n=.7*sin(3*a+3e-4*e)+.3*sin(5*a+4e-4*e),h=.6*sin(4*a+35e-5*e)+.4*sin(6*a+25e-5*e),c=.5+.5*this._samp(t,s);return[r+o*n*c,r+o*h*c]}))})),rose:(t,e)=>this._withCtx(((s,i,r)=>{const o=.42*i,a=3+Math.round(4*abs(sin(25e-5*e)));this._tracePolar(t,((e,s,i)=>o*cos(a*i)*(.65+.35*this._ampAt(t,e))),{phase:35e-5*e,close:!0})})),hypocycloid:s("hypo"),epicycloid:s("epi"),spiral:(t,e)=>this._withCtx(((s,i,r)=>{const o=.4*i;this._traceParam(t,((s,i)=>{const a=s/i*TAU*8+3e-4*e,n=o*(s/i)*(1+this._ampAt(t,s));return[r+cos(a)*n,r+sin(a)*n]}))})),star:(t,e)=>this._withCtx(((s,i,r)=>{const o=.45*i,a=5+Math.round(3*abs(sin(2e-4*e)));this._tracePolar(t,((e,s,i)=>o*(.5*sin(a*i)+.5)*(.7+.3*this._ampAt(t,e))),{phase:4e-4*e,close:!0})})),flower:(t,e)=>this._withCtx(((s,i,r)=>{const o=.4*i,a=6+Math.round(2*abs(cos(15e-5*e)));this._tracePolar(t,((e,s,i)=>o*(.3*cos(a*i)+.7)*(.6+.4*this._ampAt(t,e))),{phase:3e-4*e,close:!0})})),wave:(t,e)=>this._withCtx(((s,i,r)=>{const o=.6*i,a=t.length,n=3+2*sin(2e-4*e);this._traceParam(t,(s=>{const i=s/a*o-o/2,h=sin(i*n/50+.001*e)*o*.3*this._ampAt(t,s);return[r+i,r+h]}))})),mandala:(t,e)=>this._withCtx(((s,i,r)=>{const o=.35*i;this._tracePolar(t,((e,s,i)=>o*(.8+.3*cos(6*i)+.2*sin(12*i)+.1*cos(18*i))*(.7+.3*this._ampAt(t,e))),{phase:2e-4*e,close:!0})})),infinity:(t,e)=>this._withCtx(((s,i,r)=>{const o=.4*i;this._traceParam(t,((s,i)=>{const a=theta(s,i,3e-4*e),n=.7+.3*this._ampAt(t,s),h=1+sin(a)*sin(a);return[r+o*cos(a)/h*n,r+o*sin(a)*cos(a)/h*n]}))})),dna:(t,e)=>this._withCtx(((s,i,r)=>{const o=.3*i,a=t.length,n=.8*i,h=i=>{s.beginPath();for(let h=0;h<a;h++){const c=h/a*4*PI+i+.001*e,l=.7+.3*this._ampAt(t,h),_=r+cos(c)*o*l,p=r+(h/a-.5)*n;h?s.lineTo(_,p):s.moveTo(_,p)}s.stroke()};h(0),h(PI)})),tornado:(t,e)=>this._withCtx(((s,i,r)=>{const o=.4*i;this._traceParam(t,((s,a)=>{const n=s/a,h=n*TAU*6+5e-4*e,c=o*(1-n)*(.6+.4*this._ampAt(t,s));return[r+cos(h)*c,r+(n-.5)*i*.7]}))}))}}listShapes(){return Object.keys(this.drawFuncs).filter((t=>"hum"!==t))}connectedCallback(){this._animId||(this._animId=requestAnimationFrame(this._animate));try{this._ro=new ResizeObserver(this._resizeCanvas),this._ro.observe(this)}catch{this._resizeCanvas()}this._resizeCanvas()}disconnectedCallback(){if(this._animId&&(cancelAnimationFrame(this._animId),this._animId=null),this._ro){try{this._ro.disconnect()}catch{}this._ro=null}}_resizeCanvas(){const{width:t,height:e}=this.getBoundingClientRect?.()??{width:this._cssW,height:this._cssH},s=max(1,0|t),i=max(1,0|e),r=min(4,max(1,window.devicePixelRatio||1));if(s===this._cssW&&i===this._cssH&&r===this._dpr)return;this._cssW=s,this._cssH=i,this._dpr=r;const o=max(1,Math.round(s*r)),a=max(1,Math.round(i*r)),n=this._canvas;n.width!==o&&(n.width=o),n.height!==a&&(n.height=a);const h=this._ctx;h.setTransform(1,0,0,1,0,0),h.clearRect(0,0,o,a),h.setTransform(r,0,0,r,0,0)}_getSeed(){return this.preset?.seed??this.closest?.("osc-app")?.getAttribute?.("seed")??document.documentElement?.dataset?.seed??"default"}_makeSeedBuffer(t,e,s=2048){const i=`${e}_${t}`;let r=0;for(let t=0;t<i.length;t++)r=(r<<5)-r+i.charCodeAt(t);let o=0|r;const n=()=>{o=o+1831565813|0;let t=imul(o^o>>>15,1|o);return t=t+imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296},h=new Float32Array(s),c=a[t]||a.circle;for(let t=0;t<s;t++){const e=t/s;let i=0;for(let t=0;t<c.harmonics.length;t++){const s=c.freq*(t+1);i+=c.harmonics[t]*sin(TAU*s*e+n()*TAU)}const r=c.complexity*(n()-.5)*.3,o=.5+.5*sin(TAU*e*.1+n()*TAU);h[t]=(i+r)*o*.7}return h}_selectData(){if(this.isAudioStarted&&this.isPlaying&&this.analyser){const t=this.analyser.fftSize;return this._liveBuffer&&this._liveBuffer.length===t||(this._liveBuffer=new Float32Array(t)),this.analyser.getFloatTimeDomainData(this._liveBuffer),this._liveBuffer}if(this.preset&&"seed"===this.mode){const t=this.preset?.seed??this._getSeed(),e=this.shapeKey||"circle";return this.preset._seedBuffers||={},this.preset._seedBuffers[e]||=this._makeSeedBuffer(e,t)}if(!this._dummyData){const t=2048,e=new Float32Array(t);for(let s=0;s<t;s++){const i=s/t;e[s]=.5*sin(TAU*i)+.3*sin(2*TAU*i+PI/3)}this._dummyData=e}return this._dummyData}_prob(e){const s=parseFloat(this.getAttribute?.(e)||""),i=Number.isFinite(s)?s:t.PROB[e];return min(1,max(0,i))}_weights(t,e){const s=((t,e,s)=>{try{const i=t?.getAttribute?.(e);if(!i)return s;const r=JSON.parse(i);return r&&"object"==typeof r?r:s}catch{return s}})(this,e,t);return{...t,...s}}_getColorWeights(){return this._weights(t.COLOR_WEIGHTS,"color-weights")}_getDarkColorWeights(){return this._weights(t.DARK_COLOR_WEIGHTS,"dark-color-weights")}_getNeutralColorWeights(){return this._weights(t.NEUTRAL_COLOR_WEIGHTS,"neutral-color-weights")}_getEffectWeights(){return this._weights(t.EFFECT_WEIGHTS,"effect-weights")}_getSpeedWeights(){return this._weights(t.CYC_SPEED_WEIGHTS,"cycle-speed-weights")}_ensurePlan(){const a=this.preset?.seed??this._getSeed(),n=this._prob("mono-prob"),h=this._prob("half-dominant-prob"),c=this._prob("group-strobe-prob"),l=this._prob("dark-palette-prob"),_=this._prob("neutral-palette-prob"),p=this._getColorWeights(),m=this._getEffectWeights(),d=this._getSpeedWeights(),u=this._getDarkColorWeights(),g=this._getNeutralColorWeights(),f=this._plan;if(!(!f||f.seed!==a||JSON.stringify(f.colorWeights)!==JSON.stringify(p)||JSON.stringify(f.effectWeights)!==JSON.stringify(m)||JSON.stringify(f.speedWeights)!==JSON.stringify(d)||JSON.stringify(f.darkWeights)!==JSON.stringify(u)||JSON.stringify(f.neutralWeights)!==JSON.stringify(g)||f.monoProb!==n||f.halfDomProb!==h||f.groupStrobeProb!==c||f.darkProb!==l||f.neutralProb!==_))return;const y=s(`${a}::mode::mono`)()<n,b=s(`${a}::mode::neutral`),w=!y&&b()<_,C=s(`${a}::mode::dark`),S=!y&&!w&&C()<l,A=s(`${a}::mode::half`),k=!y&&A()<h,x=s(`${a}::mode::gStrobe`)()<c,F=x&&s(`${a}::mode::gStrobeType`)()<.5;let P=w?r(g,e):S?r(u,Object.keys(u)):{...p};Object.keys(P).length||(P={...p});const E=y?i(s(`${a}::monoColorPick`),P):null;let O=null,T=new Set;if(k){O=i(s(`${a}::halfColorPick`),P);const e=Object.keys(this.drawFuncs),r=max(1,Math.round(e.length*t.HALF_DOMINANT_RATIO));T=new Set(o(s(`${a}::halfSubset`),e,r))}const v={},W={},D={},I=Object.keys(this.drawFuncs);for(const e of I){const r=y?E:k&&T.has(e)?O:i(s(`${a}::color::${e}`),P);v[e]=r,"cycler"===r&&(W[e]=i(s(`${a}::speed::${e}`),d));const o=s(`${a}::effect::${e}`);D[e]=i(o,t.EFFECT_WEIGHTS)??"none";const n=i(o,m);n&&(D[e]=n)}let R=new Set;if(x){if(F)R=new Set(I);else{const t=.5+.5*s(`${a}::gStrobe::size`)(),e=max(1,Math.round(I.length*t));R=new Set(o(s(`${a}::gStrobe::subset`),I,e))}for(const t of R)D[t]="strobe"}this._plan={seed:a,monoProb:n,halfDomProb:h,groupStrobeProb:c,darkProb:l,neutralProb:_,isMono:y,isHalf:k,isDarkPalette:S,isNeutralPalette:w,colorUniformKey:E,halfDominantKey:O,halfDominantSet:T,colorWeights:p,effectWeights:m,speedWeights:d,darkWeights:u,neutralWeights:g,perShapeColorKey:v,perShapeCyclerSpeedKey:W,perShapeEffectKey:D,isGroupStrobe:x,groupStrobeAll:F,groupStrobeSet:R}}_getColorFor(e,s){this._ensurePlan();const i=this._plan.perShapeColorKey[e]||"bitcoin_orange";if("cycler"===i){const r=this._plan.perShapeCyclerSpeedKey[e]||"medium";return{css:`hsl(${s*(t.CYCLER_SPEEDS[r]??t.CYCLER_SPEEDS.medium)%360},85%,60%)`,key:i,speedKey:r}}return{css:t.NAMED_COLORS[i]||"#FFFFFF",key:i,speedKey:null}}_getEffectFor(t){return this._ensurePlan(),this._plan.perShapeEffectKey[t]||"none"}_animate(){const t=performance.now();this._resizeCanvas();const e=this._selectData(),{css:s}=this._getColorFor(this.shapeKey,t),i=this._getEffectFor(this.shapeKey);if(this._prepareStroke(s,{effect:i,now:t}),(this.drawFuncs[this.shapeKey]||this.drawFuncs.circle)(e,t,this.preset??{}),"function"==typeof this.onIndicatorUpdate){this.isAudioStarted&&this.isPlaying}this._animId=requestAnimationFrame(this._animate)}}customElements.define("scope-canvas",n)})();