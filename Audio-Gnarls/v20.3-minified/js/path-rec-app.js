import{clamp01}from"./utils.js";class PathRecApp extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}).innerHTML="<style>:host{display:none}</style>",this._armed=this._isRecording=this._isPlaying=!1,this._loop=!1,this._showOverlay=!0,this._recording=null,this._points=[],this._t0=this._lastSampleT=this._playIdx=this._playT0=this._raf=0;for(const t of["arm","disarm","clear","play","stop","getRecording","inputPointer","renderOverlay","setLoop"])this[t]=this[t].bind(this)}arm(){this._armed||(this._armed=!0,this._showOverlay=!0,this._dispatch("fr-armed"))}disarm(){this._armed&&(this._isRecording&&this._endRecording(performance.now()),this._armed=!1,this._showOverlay=!1,this._dispatch("fr-disarmed"))}clear(){this.stop(),this._recording=null,this._points=[],this._dispatch("fr-cleared")}getRecording(){return this._recording?{points:this._recording.points.slice(),duration:this._recording.duration}:null}play(t,i={}){if(this._loop=!!i.loop,this._isPlaying)return;const s=t||this._recording;if(!s?.points?.length)return;t&&(this._recording=t),this._isPlaying=!0,this._playIdx=0,this._playT0=performance.now(),this._dispatch("fr-play-started");const e=s.points[0];e&&this._emitPlayInput({x:e.x,y:e.y,t:0,type:e.type||"down"});const n=()=>{if(!this._isPlaying)return;const t=performance.now()-this._playT0,i=s.points;for(;this._playIdx<i.length&&i[this._playIdx].t<=t;)this._emitPlayInput(i[this._playIdx++]);const e=this._interpAtTime(s,t);if(e&&this._emitPlayInput({x:e.x,y:e.y,t:t,type:"move",_interp:!0}),t>=s.duration){const t=i[i.length-1];if("up"!==t.type&&this._emitPlayInput({x:t.x,y:t.y,t:s.duration,type:"up"}),this._loop){this._dispatch("fr-play-loop"),this._playIdx=0,this._playT0=performance.now();const t=i[0];t&&this._emitPlayInput({x:t.x,y:t.y,t:0,type:t.type||"down"}),this._raf=requestAnimationFrame(n)}else this.stop()}else this._raf=requestAnimationFrame(n)};this._raf=requestAnimationFrame(n)}stop(){this._isPlaying&&(cancelAnimationFrame(this._raf),this._isPlaying=!1,this._dispatch("fr-play-stopped"))}setLoop(t){this._loop=!!t}inputPointer(t,i,s,e){if(!this._armed)return;i=clamp01(i),s=clamp01(s);const n=e??performance.now();if("down"!==t||this._isRecording||this._beginRecording(n),!this._isRecording)return;const r=n-this._t0;this._points.push({x:i,y:s,t:r,type:t}),this._lastSampleT=r,"up"===t&&this._endRecording(n)}renderOverlay(t,i=performance.now()){if(!(this._showOverlay||this._isPlaying&&this._recording))return;const s=this._isRecording?{points:this._points}:this._recording,e=s?.points?.length>0,{canvas:n}=t;if(t.save(),this._showOverlay&&e&&(t.lineWidth=3,t.lineJoin="round",t.lineCap="round",t.shadowBlur=15,t.shadowColor="#00ffff80",t.strokeStyle="#00ffff",t.beginPath(),this._drawPath(t,s.points,n),t.stroke(),t.shadowBlur=5,t.shadowColor="#00ffff",t.lineWidth=2,t.stroke()),this._isPlaying&&this._recording){const s=i-this._playT0,e=this._interpAtTime(this._recording,s);if(e){const s=e.x*n.width,r=e.y*n.height,o=.8+.2*Math.sin(i/100),h=.7+.3*Math.sin(i/150);t.beginPath(),t.arc(s,r,10*o,0,2*Math.PI),t.fillStyle=`hsl(300,100%,${70+10*h}%)`,t.fill(),t.shadowBlur=15*h,t.shadowColor="#ff00ff",t.strokeStyle="#ff00ff",t.lineWidth=2,t.stroke()}}t.restore()}_beginRecording(t){this.stop(),this._isRecording=!0,this._points=[],this._t0=t,this._lastSampleT=0,this._dispatch("fr-record-started")}_endRecording(t){if(!this._isRecording)return;const i=Math.max(1,Math.round(t-this._t0));0===this._points.length&&this._points.push({x:.5,y:.5,t:0,type:"down"});const s=this._points[this._points.length-1];"up"!==s.type&&this._points.push({x:s.x,y:s.y,t:i,type:"up"}),this._recording={points:this._points.slice(),duration:i},this._isRecording=!1,this._dispatch("fr-record-stopped",{duration:i}),this._armed&&(this._armed=!1,this._showOverlay=!1,this._dispatch("fr-disarmed")),this.play(this._recording,{loop:this._loop})}_drawPath(t,i,s){for(let e=0;e<i.length;e++){const n=i[e],r=n.x*s.width,o=n.y*s.height;0===e?t.moveTo(r,o):t.lineTo(r,o)}}_interpAtTime(t,i){const s=t.points;if(!s.length)return null;if(i<=s[0].t)return{x:s[0].x,y:s[0].y};if(i>=t.duration){const t=s[s.length-1];return{x:t.x,y:t.y}}for(let t=1;t<s.length;t++){const e=s[t-1],n=s[t];if(i<=n.t){const t=(i-e.t)/(n.t-e.t||1);return{x:e.x+(n.x-e.x)*t,y:e.y+(n.y-e.y)*t}}}const e=s[s.length-1];return{x:e.x,y:e.y}}_emitPlayInput(t){this._dispatch("fr-play-input",{x:t.x,y:t.y,t:t.t,type:t.type})}_dispatch(t,i){this.dispatchEvent(new CustomEvent(t,{detail:i,bubbles:!0,composed:!0}))}}customElements.define("path-rec-app",PathRecApp);export{PathRecApp};