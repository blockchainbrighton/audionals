import{humKey,shapeList,shapeCount,allKeys}from"./shapes.js";import{createElement}from"./utils.js";export function Engine(e){const t=Object.assign,n=t=>{const n=e.state.chains;for(const e in n)t(n[e],e)},a=e=>new Promise((t=>setTimeout(t,e))),s=e=>e?.now?.()??0,o=n=>t(e._canvas,n),i=e=>{let t=1831565813^e.length;for(let n=0;n<e.length;n++)t=Math.imul(t^e.charCodeAt(n),2654435761);return()=>(t=Math.imul(t^t>>>15,1|t),(t>>>16&65535)/65536)},r=e=>{const t=e?.context?.createAnalyser?.();if(t){t.fftSize=2048;try{t.smoothingTimeConstant=.06}catch{}}return t||null},u=e=>e<=0?-60:Math.max(-60,Math.min(0,20*Math.log10(Math.min(1,Math.max(1e-4,e))))),c=e=>{try{e?.()}catch{}},l=async e=>{try{await(e?.())}catch{}},d=/iPad|iPhone|iPod/.test(navigator.userAgent),p=d?.028:.012,g=d?.028:.008,S=(e,t,n=p,a)=>{if(!e||!a)return;const o=s(a);c((()=>e.cancelScheduledValues?.(o)));const i=e.value??0;c((()=>e.setValueAtTime?.(i,o))),c((()=>e.linearRampToValueAtTime?.(t,o+Math.max(.001,n))))},h=e=>{c((()=>e.stop?.())),c((()=>e.dispose?.())),c((()=>e.disconnect?.()))},y=async t=>{const n=e.state?.Tone;n&&t?.out?.gain&&(S(t.out.gain,0,p,n),await e._sleep(Math.ceil(1e3*(p+.002))));for(const e of Object.values(t||{}))h(e)},_=(e,t)=>{const n=i(`${e}_${t}`),a=["sine","triangle","square","sawtooth"],s=["C1","C2","E2","G2","A2","C3","E3","G3","B3","D4","F#4","A4","C5"],o=n(),r=o<.18?0:o<.56?1:o<.85?2:3,u=3===r?2+(n()>.7?1:0):1+(n()>.6?1:0),c=e=>e[n()*e.length|0],l=Array.from({length:u},(()=>[c(a),c(s)]));let d,p,g,S,h;return 0===r?(p=.07+.3*n(),g=400+400*n(),S=900+600*n(),h=700+500*n(),d={attack:.005+.03*n(),decay:.04+.08*n(),sustain:.1+.2*n(),release:.03+.1*n()}):1===r?(p=.25+8*n(),g=120+700*n(),S=1200+1400*n(),h=300+2400*n(),d={attack:.03+.4*n(),decay:.1+.7*n(),sustain:.2+.5*n(),release:.2+3*n()}):2===r?(p=6+20*n(),g=80+250*n(),S=1500+3500*n(),h=300+2400*n(),d={attack:.03+.4*n(),decay:.1+.7*n(),sustain:.2+.5*n(),release:.2+3*n()}):(p=24+36*n(),g=80+250*n(),S=1500+3500*n(),h=300+2400*n(),d={attack:2+8*n(),decay:4+20*n(),sustain:.7+.2*n(),release:8+24*n()}),{osc1:l[0],osc2:l[1]||null,filter:h,filterQ:.6+.7*n(),lfo:[p,g,S],envelope:d,colorSpeed:.06+.22*n(),shapeDrift:6e-4+.0032*n(),seed:e}},f=t=>{e.state.presets=Object.fromEntries(shapeList(e).map((e=>[e,_(t,e)])))},m=async()=>{const{Tone:t,chains:n}=e.state;if(!t)return;const a=humKey(e);n[a]&&(await y(n[a]),delete n[a]);try{const e=new t.Oscillator("A0","sine").start(),s=new t.Filter(150,"lowpass");s.Q.value=.5;const o=new t.Volume(-25),i=r(t),u=new t.Gain(0).toDestination();e.connect(o),o.connect(s),s.connect(u),i&&s.connect(i),n[a]={osc:e,volume:o,filter:s,out:u,analyser:i}}catch(t){console.error("Error buffering hum chain",t),delete e.state.chains[a]}},q=async t=>{if(t===humKey(e))return m();const{Tone:n,presets:a,chains:s}=e.state,o=a[t];if(o&&n){s[t]&&(await y(s[t]),delete s[t]);try{const e=new n.Oscillator(o.osc1[1],o.osc1[0]).start(),a=o.osc2?new n.Oscillator(o.osc2[1],o.osc2[0]).start():null,i=new n.Volume(5),u=new n.Filter(o.filter,"lowpass");u.Q.value=o.filterQ;const c=new n.LFO(...o.lfo).start(),l=r(n),d=new n.Gain(0).toDestination();c.connect(u.frequency),a&&c.connect(a.detune),e.connect(i),a?.connect(i),i.connect(u),u.connect(d),l&&u.connect(l),s[t]={osc1:e,osc2:a,volume:i,filter:u,lfo:c,out:d,analyser:l}}catch(n){console.error("Error buffering chain for shape",t,n),delete e.state.chains[t]}}},C=(t,{updateCanvasShape:n=!0,setStateCurrent:a=n,syncCanvasPlayState:s=!0}={})=>{const{Tone:i,chains:r,current:u}=e.state,c=r[u],l=r[t];c&&c!==l&&S(c.out.gain,0,g,i),l&&S(l.out.gain,1,g,i);const d={isAudioStarted:!0};l?.analyser&&(d.analyser=l.analyser),s&&(d.isPlaying=e.state.isPlaying),o(d),n&&(t===humKey(e)?o({shapeKey:humKey(e),preset:null}):o({shapeKey:t,preset:e.state.presets[t]})),a&&(e.state.current=t)},v=()=>{n(y),e.state.chains={},e.state.current=null},T=()=>{e.sig?.updateSequencerState?.()},P=()=>{e.sig?.stopSequence?.()},K=()=>{e.sig?.stopAudioSignature?.()},x=()=>{v(),e.state.sequencePlaying&&P(),e.state.audioSignaturePlaying&&K?.();const{seed:t,Tone:n,approvedSeeds:a}=e.state;e.state=e.defaultState(t),e.state.Tone=n,e.state.approvedSeeds=a||[],f(t),m();const s=shapeList(e),r=i(t),u=s.length?s[r()*s.length|0]:humKey(e);o({preset:e.state.presets[u]??null,shapeKey:u,mode:"seed",isAudioStarted:!1,isPlaying:!1}),e.state.current=humKey(e),e._updateControls({isAudioStarted:!0,isPlaying:!1,isMuted:!1,shapeKey:humKey(e)}),e.state.isSequencerMode=!1,e._sequencerComponent.style.display="none",e._main.style.overflow="hidden",e.state.sequence=Array(8).fill(null),T?.()},R=async()=>{const t=e.state;if(!t.initialBufferingStarted||t.initialShapeBuffered){if(t.isPlaying)return A();if(t.contextUnlocked)return t.initialShapeBuffered?(C(humKey(e)),t.isPlaying=!0,e._canvas.isPlaying=!0,e._updateControls({isAudioStarted:!0,isPlaying:!0}),t._startupSigDone||(await l((()=>e._sleep(200))),c((()=>e._triggerSignatureFor?.(humKey(e),{loop:t.isLoopEnabled}))),setTimeout((()=>c((()=>{e.cleanupHotkeyTour?.(),e.runHotkeyTour?.({stepMs:260,holdMs:1e3})}))),60),t._startupSigDone=!0),void(e._loader.textContent="Audio resumed (hum).")):void(e._loader.textContent="Audio context unlocked, but synth not ready. Click again.");try{const n=t.Tone;if(!n)throw new Error("Tone.js not available");const s=n.getContext?.()||n.context;let o=!1;if(s?.resume?(await s.resume(),o=!0):n.start&&(await n.start(),o=!0),!o)throw new Error("Could not resume AudioContext");t.contextUnlocked=!0,t.initialBufferingStarted=!0,await m(),C(humKey(e));for(const n of shapeList(e)){if(!t.contextUnlocked)break;await l((()=>q(n))),await a(0)}t.initialShapeBuffered=!0,t.isPlaying=!0,e._canvas.isPlaying=!0,e._updateControls({isAudioStarted:!0,isPlaying:!0}),t._startupSigDone||(await l((()=>e._sleep(200))),c((()=>e._triggerSignatureFor?.(humKey(e),{loop:t.isLoopEnabled}))),setTimeout((()=>c((()=>{e.cleanupHotkeyTour?.(),e.runHotkeyTour?.({stepMs:260,holdMs:1e3})}))),60),t._startupSigDone=!0)}catch(e){console.error("Failed to unlock AudioContext:",e),t.contextUnlocked=!1,t.initialBufferingStarted=!1,t.initialShapeBuffered=!1}}else e._loader.textContent="Still preparing initial synth, please wait..."},A=()=>{const t=e.state;(t.isPlaying||t.initialBufferingStarted)&&(c((()=>e.cleanupHotkeyTour?.())),t.audioSignatureTimer&&(c((()=>clearTimeout(t.audioSignatureTimer))),t.audioSignatureTimer=null),t.isPlaying=t.initialBufferingStarted=t.initialShapeBuffered=!1,v(),t.sequencePlaying&&P?.(),t.audioSignaturePlaying&&K?.(),e._canvas&&(e._canvas.isPlaying=!1,e._canvas.isAudioStarted=!1),x())};return{createElement:createElement,_eachChain:n,_disposeChain:y,_rng:i,_setCanvas:o,_createAnalyser:r,_sleep:a,_timeNow:s,_rampLinear:S,_silenceAllChains:async(t=p)=>{const a=e.state?.Tone;a&&(n((e=>e?.out?.gain&&S(e.out.gain,0,t,a))),await e._sleep(Math.ceil(1e3*(t+.002))))},_linToDb:u,deterministicPreset:_,loadPresets:f,bufferHumChain:m,bufferShapeChain:q,setActiveChain:C,disposeAllChains:v,resetState:x,unlockAudioAndBufferInitial:R,stopAudioAndDraw:A,_onStartRequest:()=>R(),_onMuteToggle:()=>{const t=e.state,n=t.Tone;if(!n?.Destination)return;const a=!t.isMuted;n.Destination.mute=a,t.isMuted=a,e._updateControls(),o({isPlaying:t.isPlaying&&!t.isMuted}),e._loader.textContent=t.isMuted?"Muted.":"Unmuted."},_onShapeChange:t=>{const n=t?.detail?.shapeKey;if(!n)return;const a=e.state,s=humKey(e);if(a.audioSignaturePlaying||a.signatureSequencerRunning||(a._uiReturnShapeKey=n!==s?n:a._uiReturnShapeKey),!a.contextUnlocked||!a.initialShapeBuffered)return o(n===s?{shapeKey:s,preset:null,mode:"seed"}:{shapeKey:n,preset:a.presets[n],mode:"seed"}),void e._updateControls({shapeKey:n});C(n),n!==s&&o({shapeKey:n,preset:a.presets[n],mode:"live"}),e._canvas.isPlaying=!e.state.Tone?.Destination?.mute,e._updateControls({shapeKey:n}),a.current=n},_onVolumeChange:t=>{const n=t?.detail?.value;if("number"!=typeof n)return;const a=e.state;a.volume=Math.min(1,Math.max(0,n));const s=a.Tone;s?.Destination?.volume&&(s.Destination.volume.value=u(a.volume)),e._updateControls({volume:a.volume})},updateSequencerState:T,stopSequence:P,stopAudioSignature:K}}export function Signatures(e){const t=()=>humKey(e),n=()=>shapeList(e),a=()=>shapeCount(e),s=(e,t,n)=>t+Math.floor(e()*(n-t+1)),o=e=>s(e,0,a()),i=e=>{const t=a();return t>0?s(e,1,t):0},r=t=>{const n=e._rng(`${t}_unique_algo_mapping`),a=allKeys(e),s=a.length,o=[1,2,3,4,5,6,7,8,9,10],i=[];for(;i.length<s;)i.push(...o);i.length=s;for(let e=i.length-1;e>0;e--){const t=n()*(e+1)|0;[i[e],i[t]]=[i[t],i[e]]}const r={};return a.forEach(((e,t)=>r[e]=i[t])),r},u=(t,{steps:n=32,paletteSize:o=6,pRepeat:i=.35,pHum:r=.15,pSilence:u=.2,avoidBackAndForth:c=!0}={})=>{const l=e._rng(`${t}_audio_signature_constrained`),d=a(),p=Math.max(1,Math.min(d,o)),g=[];let S=null,h=null;for(let e=0;e<n;e++){if(l()<u){g.push(null);continue}const e=l();let t;if(e<r)t=0;else if(e<r+i&&null!==h)t=h;else do{t=s(l,1,p),c&&null!==S&&S>=1&&t>=1&&g.length>=2&&g.at(-2)===t&&(t=null)}while(null===t);g.push(t),null!==t&&(t>=1&&(h=t),S=t)}return g},c=(t,n=1)=>{const s=e._rng(`${t}_audio_signature_v${n}`),r=32,c=a();switch(n){case 1:{const e=[];for(let t=0;t<r;t++)e.push(o(s));return e}case 2:return u(t,{steps:r,paletteSize:Math.min(6,Math.max(1,c)),pRepeat:.35,pHum:.15,pSilence:.2,avoidBackAndForth:!0});case 3:{const e=8,t=Array.from({length:e},(()=>o(s)));return Array.from({length:r},((n,a)=>t[a%e]))}case 4:{const e=[0];let t=0;for(let n=1;n<r;n++){const n=s()>.5?1:-1,a=1+(3*s()|0);t=Math.max(0,Math.min(c,t+n*a)),e.push(t)}return e}case 5:{const e=[];let t=o(s);for(let n=0;n<r;){const a=Math.min(2+(6*s()|0),r-n);for(let s=0;s<a;s++,n++)e.push(t);t=o(s)}return e}case 6:{const e=[];for(let t=0;t<r;t++)e.push(s()>.7?i(s):0);return e}case 7:{const e=new Array(r).fill(0);let t=0,n=1,a=1;for(;t<r;){e[t]=i(s);const o=n+a;n=a,a=o,t+=o}return e}case 8:{const e=o(s),t=o(s);return Array.from({length:r},((n,a)=>a%2==0?e:t))}case 9:{let e=i(s);const t=[];for(let n=0;n<r;n++)(s()<.2||0===e)&&(e=o(s)),t.push(e),s()>.7&&(e=Math.max(0,e-1));return t}case 10:{let e=o(s);const t=[];for(let n=0;n<r;n++)(n%8==0||s()>.6)&&(e=o(s)),t.push(e);return t}default:return u(t)}},l=(n,{loop:a=e.state.isLoopEnabled}={})=>{const s=e.state;if(!s.contextUnlocked||!s.initialShapeBuffered)return;s.sequencePlaying&&y(),s.audioSignaturePlaying&&p(),s._uiReturnShapeKey=n||s._uiReturnShapeKey||t(),s._sigStartShapeKey=s._uiReturnShapeKey;const o=r(s.seed)[n]||1,i=c(s.seed,o);d(i,o),e._loader.textContent=s.isLoopEnabled?`Playing ${n} Audio Signature (Loop).`:`Playing ${n} Audio Signature...`},d=(a,s=1,{onComplete:o=null}={})=>{const i=e.state;i.audioSignaturePlaying&&p();const r="string"==typeof i.current&&i.current?i.current:null;i._uiReturnShapeKey=r||i._uiReturnShapeKey||t(),i._sigStartShapeKey=i._uiReturnShapeKey,i.audioSignaturePlaying=!0,i.audioSignatureStepIndex=0,i.audioSignatureOnComplete=o,e._updateControls({isAudioSignaturePlaying:!0});const u=3===s||7===s?100:5===s?150:10===s?200:125,c=()=>{const s=e.state;if(!s.audioSignaturePlaying)return;const o=s.audioSignatureStepIndex,i=a[o];if(null!==i){const a=0===i?t():n()[i-1];a&&e._onShapeChange({detail:{shapeKey:a}})}if(s.audioSignatureStepIndex++,s.audioSignatureStepIndex>=a.length){const n=()=>{s.audioSignaturePlaying=!1,s.audioSignatureTimer=null,e._updateControls({isAudioSignaturePlaying:!1});const t=s.audioSignatureOnComplete;s.audioSignatureOnComplete=null,"function"==typeof t?t():e._loader.textContent="Audio Signature complete."};s.isLoopEnabled?(s.audioSignatureStepIndex=0,s.audioSignatureTimer=setTimeout(c,u)):((()=>{const n=e.state;try{e.cleanupHotkeyTour?.()}catch{}if(n.isLatchOn){n.isLatchOn=!1;try{e._pathRec?.setLatch?.(!1)}catch{}e._updateControls()}const a=t(),s=n._sigStartShapeKey||n._uiReturnShapeKey||a;try{e.setActiveChain(a,{updateCanvasShape:!1,setStateCurrent:!0,syncCanvasPlayState:!1})}catch{}try{e._canvas&&(e._canvas.isPlaying=!1)}catch{}try{const t=s===a?null:n.presets?.[s]||null;e._canvas&&Object.assign(e._canvas,{shapeKey:s,preset:t,mode:"live"}),e._updateControls({shapeKey:s})}catch{}n._uiReturnShapeKey=s,n._sigStartShapeKey=null})(),s.audioSignatureTimer=setTimeout(n,u))}else s.audioSignatureTimer=setTimeout(c,u)};c()},p=()=>{const n=e.state;n.audioSignatureTimer&&(clearTimeout(n.audioSignatureTimer),n.audioSignatureTimer=null);try{e.cleanupHotkeyTour?.()}catch{}if(n.audioSignaturePlaying=!1,n.audioSignatureStepIndex=0,e._updateControls({isAudioSignaturePlaying:!1}),n.isLatchOn){n.isLatchOn=!1;try{e._pathRec?.setLatch?.(!1)}catch{}e._updateControls()}const a=t(),s=n._sigStartShapeKey||n._uiReturnShapeKey||a;try{e.setActiveChain(a,{updateCanvasShape:!1,setStateCurrent:!0,syncCanvasPlayState:!1})}catch{}try{e._canvas&&(e._canvas.isPlaying=!1)}catch{}try{const t=s===a?null:n.presets?.[s]||null;e._canvas&&Object.assign(e._canvas,{shapeKey:s,preset:t,mode:"live"}),e._updateControls({shapeKey:s})}catch{}n._uiReturnShapeKey=s,n._sigStartShapeKey=null,n.audioSignatureOnComplete=null},g=async()=>{const s=e.state;if(s.signatureSequencerRunning)return;s.signatureSequencerRunning=!0,p();const o=r(s.seed),i=async()=>{if(s.signatureSequencerRunning)for(let i=0;i<s.sequence.length;i++){if(!s.signatureSequencerRunning)return;s.sequenceStepIndex=i,h();const r=s.sequence[i];if(null===r||"number"!=typeof r||r<0){await e._sleep(Math.max(50,s.stepTime));continue}let u=null;if(0===r?u=t():r>=1&&r<=a()&&(u=n()[r-1]),!u){await e._sleep(Math.max(50,s.stepTime));continue}const l=o[u]||1,p=c(s.seed,l);if(await new Promise((e=>{s.signatureSequencerRunning?d(p,l,{onComplete:()=>e()}):e()})),!s.signatureSequencerRunning)return;await e._sleep(Math.max(30,s.stepTime))}};if(await i(),s.signatureSequencerRunning){if(s.isLoopEnabled&&s.sequencePlaying)for(;s.signatureSequencerRunning&&s.sequencePlaying&&s.isLoopEnabled;)await i();S(),e._sequencerComponent?.stopSequence?.()}},S=()=>{const t=e.state;t.signatureSequencerRunning=!1,p(),t.sequencePlaying=!1,t.sequenceStepIndex=0,t._seqFirstCycleStarted=!1,h(),t._uiReturnShapeKey?e._updateControls({shapeKey:t._uiReturnShapeKey}):e._updateControls()},h=()=>{e._sequencerComponent&&e._sequencerComponent.updateState?.({isRecording:e.state.isRecording,currentRecordSlot:e.state.currentRecordSlot,sequence:[...e.state.sequence],velocities:[...e.state.velocities],sequencePlaying:e.state.sequencePlaying,sequenceStepIndex:e.state.sequenceStepIndex,stepTime:e.state.stepTime,isLoopEnabled:e.state.isLoopEnabled,isSequenceSignatureMode:e.state.isSequenceSignatureMode,steps:e.state.sequenceSteps})},y=()=>{e._sequencerComponent?.stopSequence();const t=e.state;t.signatureSequencerRunning&&S(),t.audioSignaturePlaying&&p(),t.sequencePlaying=!1,t.sequenceStepIndex=0,t._seqFirstCycleStarted=!1,h(),e._updateControls()};return{_onToggleSequencer:()=>{const t=e.state;t.isSequencerMode=!t.isSequencerMode,e._sequencerComponent&&(e._sequencerComponent.style.display=t.isSequencerMode?"block":"none"),t.isSequencerMode?h():(t.isRecording=!1,t.currentRecordSlot=-1,t.sequencePlaying&&y(),t.signatureSequencerRunning&&S()),e._updateControls({sequencerVisible:t.isSequencerMode}),"function"==typeof e._fitLayout&&e._fitLayout()},_onLoopToggle:()=>{const t=e.state;t.isLoopEnabled=!t.isLoopEnabled,e._updateControls();try{e._pathRec?.setLoop?.(t.isLoopEnabled)}catch{}},_onSignatureModeToggle:()=>{const t=e.state;t.isSequenceSignatureMode=!t.isSequenceSignatureMode,e._updateControls(),t.sequencePlaying&&y(),t.audioSignaturePlaying&&p()},_getUniqueAlgorithmMapping:r,generateAudioSignature:c,_generateSignatureWithConstraints:u,_onAudioSignature:()=>{const n=e.state;if(n.audioSignaturePlaying)return p(),void e._updateControls({isAudioSignaturePlaying:!1});if(!n.contextUnlocked||!n.initialShapeBuffered)return;const a=n._uiReturnShapeKey||n.current||t();l(a,{loop:n.isLoopEnabled}),e._updateControls({isAudioSignaturePlaying:!0})},_triggerSignatureFor:l,playAudioSignature:d,stopAudioSignature:p,_onSeqRecordStart:t=>{const n=t?.detail?.slotIndex??-1;e.state.isRecording=!0,e.state.currentRecordSlot=n,e._updateControls()},_onSeqStepCleared:t=>{const n=t?.detail?.slotIndex;if("number"!=typeof n)return;const a=e.state;a.sequence[n]=null,a.isRecording&&a.currentRecordSlot===n&&(a.currentRecordSlot=(n+1)%8,0===a.currentRecordSlot&&(a.isRecording=!1))},_onSeqStepRecorded:t=>{const n=t?.detail??{};"number"==typeof n.slotIndex&&(e.state.sequence[n.slotIndex]=n.value),"number"==typeof n.nextSlot&&(e.state.currentRecordSlot=n.nextSlot),"boolean"==typeof n.isRecording&&(e.state.isRecording=n.isRecording)},_onSeqPlayStarted:t=>{const n=t?.detail?.stepTime,a=e.state;a.sequencePlaying=!0,a.sequenceStepIndex=0,a._seqFirstCycleStarted=!1,a.isSequencerMode=!0,"number"==typeof n&&(a.stepTime=n),e._updateControls(),a.isSequenceSignatureMode&&(e._sequencerComponent?.stopSequence(),g())},_onSeqPlayStopped:()=>{const n=e.state;if(n.sequencePlaying=!1,n.sequenceStepIndex=0,n._seqFirstCycleStarted=!1,n.isSequencerMode=!1,n.signatureSequencerRunning&&S(),!n.isLatchOn)try{const n=t();e._updateControls({shapeKey:n}),e._onShapeChange({detail:{shapeKey:n}})}catch{}e._updateControls()},_onSeqStepAdvance:s=>{if(e.state.isSequenceSignatureMode)return;const o=s?.detail||{},i=e.state,r="number"==typeof o.stepIndex?o.stepIndex:"number"==typeof o.index?o.index:i.sequenceStepIndex,u=o.value;if(i.sequencePlaying&&0===r)if(i._seqFirstCycleStarted){if(!i.isLoopEnabled)return void y()}else i._seqFirstCycleStarted=!0;if(i.sequenceStepIndex=r,null!=u&&0!==u){if(u>=1&&u<=a()){const t=n()[u-1];e._updateControls({shapeKey:t}),e._onShapeChange({detail:{shapeKey:t}})}}else if(!i.isLatchOn){const n=t();e._updateControls({shapeKey:n}),e._onShapeChange({detail:{shapeKey:n}})}},_onSeqStepTimeChanged:t=>{const n=t?.detail?.stepTime;"number"==typeof n&&(e.state.stepTime=n)},_onSeqStepsChanged:t=>{const n=t?.detail?.steps;if("number"==typeof n&&n>0){const t=e.state;if(t.sequenceSteps=n,n!==t.sequence.length){const e=[...t.sequence],a=[...t.velocities||[]];t.sequence=Array.from({length:n},((t,n)=>e[n]??null)),t.velocities=Array.from({length:n},((e,t)=>a[t]??1))}h()}},_startSignatureSequencer:g,_stopSignatureSequencer:S,updateSequencerState:h,recordStep:t=>{e._sequencerComponent?.recordStep(t)},playSequence:()=>{e._sequencerComponent?.playSequence()},stopSequence:y}}class ToneLoader extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML="",this._loaded=!1}connectedCallback(){if(this._loaded)return;this._loaded=!0;import("https://ordinals.com/content/04813d7748d918bd8a3069cb1823ebc9586f0ce16cd6a97a784581ec38d13062i0").then((e=>{window.Tone||!e?.default&&!e?.Tone||(window.Tone=e.default??e.Tone),this.dispatchEvent(new CustomEvent("tone-ready",{bubbles:!0,composed:!0}))})).catch((e=>console.error("Failed to load Tone.js:",e)))}}customElements.define("tone-loader",ToneLoader);