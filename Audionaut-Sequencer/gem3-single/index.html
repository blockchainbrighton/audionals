<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audionaut Sequencer V3 [Decentralized]</title>
    <style>
        :root {
            --bg-dark: #121214;
            --bg-panel: #1e1e24;
            --primary: #00ff9d;
            --secondary: #7000ff;
            --accent: #ff0055;
            --text: #e0e0e0;
            --grid-line: #333;
            --step-inactive: #2a2a35;
            --step-active: #00ff9d;
            --font-main: 'Courier New', Courier, monospace; /* Tech/Code aesthetic */
        }

        * { box-sizing: border-box; user-select: none; }
        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header / Transport --- */
        header {
            background: var(--bg-panel);
            padding: 15px;
            border-bottom: 1px solid var(--grid-line);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 2px; color: var(--primary); font-family: var(--font-main); }
        
        .controls { display: flex; gap: 15px; align-items: center; }
        
        button {
            background: #333;
            border: 1px solid #444;
            color: white;
            padding: 5px 15px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        button:hover { background: #444; border-color: var(--primary); }
        button.active { background: var(--primary); color: black; border-color: var(--primary); }
        button.record { color: var(--accent); }
        button.record.active { background: var(--accent); color: white; }

        .bpm-control { display: flex; align-items: center; gap: 5px; }
        input[type="number"] { background: #222; border: 1px solid #444; color: white; width: 60px; padding: 5px; border-radius: 4px; }

        /* --- Main Sequencer Grid --- */
        #sequencer-view {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .channel-row {
            display: flex;
            height: 50px;
            background: var(--bg-panel);
            border-radius: 4px;
            overflow: hidden;
        }

        .channel-controls {
            width: 200px;
            background: #25252e;
            padding: 0 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-right: 1px solid #333;
            font-size: 0.85rem;
        }
        .channel-name { font-weight: bold; color: var(--text); width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chan-btn { width: 24px; height: 24px; padding: 0; font-size: 0.7rem; margin-left: 4px;}
        
        .step-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(16, 1fr); /* MVP: 16 steps visualized */
            gap: 2px;
            padding: 5px;
            position: relative;
        }

        .step {
            background: var(--step-inactive);
            border-radius: 2px;
            cursor: pointer;
            transition: background 0.1s;
        }
        .step:hover { background: #3a3a45; }
        .step.active { background: var(--step-active); box-shadow: 0 0 5px var(--primary); }
        
        /* Different color for Synth channels */
        .channel-row[data-type="synth"] .step.active { background: var(--secondary); box-shadow: 0 0 5px var(--secondary); }

        /* Playhead Overlay */
        .playhead-overlay {
            position: absolute;
            top: 0; bottom: 0; left: 0;
            width: 2px;
            background: rgba(255, 255, 255, 0.5);
            pointer-events: none;
            transform: translateX(0);
            z-index: 10;
            display: none; /* Controlled via JS transformation */
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-overlay.open { display: flex; }
        
        .modal {
            background: var(--bg-panel);
            width: 500px;
            padding: 20px;
            border: 1px solid var(--primary);
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.2);
        }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;}

        /* --- Startup Overlay --- */
        #startup {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-dark);
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #start-btn {
            font-size: 1.5rem;
            padding: 20px 40px;
            background: var(--primary);
            color: #000;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }

        /* --- Helper Classes --- */
        .knob-container { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; }
        .led { width: 8px; height: 8px; border-radius: 50%; background: #444; margin-right: 5px; display: inline-block; }
        .led.on { background: var(--accent); box-shadow: 0 0 5px var(--accent); }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
</head>
<body>

    <div id="startup">
        <h1 style="font-size: 3rem; margin-bottom: 20px;">AUDIONAUT V3</h1>
        <p style="color: #888; margin-bottom: 30px;">Decentralized Web Audio Workstation</p>
        <button id="start-btn">INITIALIZE AUDIO ENGINE</button>
    </div>

    <header>
        <div class="brand">
            <h1>AUDIONAUT <span style="font-size:0.7em; color:#666;">V3</span></h1>
        </div>
        
        <div class="controls">
            <div class="bpm-control">
                <label>BPM</label>
                <input type="number" id="bpm-input" value="120" min="60" max="180">
            </div>
            <div style="width: 1px; height: 30px; background: #333;"></div>
            <button id="btn-stop">■ STOP</button>
            <button id="btn-play">▶ PLAY</button>
            <div style="width: 1px; height: 30px; background: #333;"></div>
            <button id="btn-save">SAVE PROJECT</button>
            <button id="btn-add-track">+ ADD TRACK</button>
        </div>
    </header>

    <div id="sequencer-view">
        </div>

    <div class="modal-overlay" id="synth-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Synth Parameters</h3>
                <button class="close-modal">X</button>
            </div>
            <div id="synth-controls-content">
                </div>
        </div>
    </div>

    <script type="module">
        /**
         * AUDIONAUT ARCHITECTURE
         * 1. STATE: The Single Source of Truth (Observer Pattern)
         * 2. AUDIO: Tone.js Wrapper (The Engine)
         * 3. UI: DOM Rendering (The View)
         */

        /* ==========================================
           1. STATE MANAGEMENT (state.js)
           ========================================== */
        const DEFAULT_STATE = {
            bpm: 120,
            isPlaying: false,
            stepCount: 16, // Simplified to 16 for viewport fitting in this demo
            currentStep: 0,
            channels: [
                { 
                    id: 0, type: 'sampler', name: 'Kick', 
                    url: 'https://tonejs.github.io/audio/drum-samples/Techno/kick.mp3', // Real on-chain URL would go here
                    mute: false, solo: false, vol: 0, 
                    steps: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0] 
                },
                { 
                    id: 1, type: 'sampler', name: 'HiHat', 
                    url: 'https://tonejs.github.io/audio/drum-samples/Techno/hihat.mp3',
                    mute: false, solo: false, vol: -5, 
                    steps: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0] 
                },
                { 
                    id: 2, type: 'synth', subtype: 'fm', name: 'Bass', 
                    mute: false, solo: false, vol: -8, 
                    // Simple pitch array for monophonic step sequencer: null = rest, string = note
                    steps: ["C2", null, "C2", null, "F2", null, null, null, "G2", null, "C2", null, null, null, "Bb1", null] 
                }
            ]
        };

        class ProjectState {
            constructor() {
                // Load from local storage or default
                const saved = localStorage.getItem('audionaut_v3_project');
                this.data = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULT_STATE));
                this.listeners = [];
            }

            subscribe(callback) {
                this.listeners.push(callback);
            }

            notify(action, payload) {
                this.listeners.forEach(cb => cb(action, payload));
                this.saveLocally();
            }

            saveLocally() {
                localStorage.setItem('audionaut_v3_project', JSON.stringify(this.data));
            }

            // --- Actions ---
            setBpm(bpm) {
                this.data.bpm = bpm;
                this.notify('BPM_CHANGED', bpm);
            }

            togglePlay(isPlaying) {
                this.data.isPlaying = isPlaying;
                this.notify('PLAYBACK_CHANGED', isPlaying);
            }

            updateStep(channelId, stepIndex, value) {
                const channel = this.data.channels.find(c => c.id === channelId);
                if (channel) {
                    channel.steps[stepIndex] = value;
                    this.notify('STEP_UPDATED', { channelId, stepIndex, value });
                }
            }

            toggleMute(channelId) {
                const channel = this.data.channels.find(c => c.id === channelId);
                channel.mute = !channel.mute;
                this.notify('CHANNEL_MUTE', { channelId, val: channel.mute });
            }
        }

        const store = new ProjectState();

        /* ==========================================
           2. AUDIO ENGINE (audio.js)
           ========================================== */
        class AudioEngine {
            constructor(store) {
                this.store = store;
                this.channels = {}; // Map of Tone.js instruments
                this.isInitialized = false;
            }

            async init() {
                await Tone.start();
                console.log("Audio Context Started");
                
                Tone.Transport.bpm.value = this.store.data.bpm;
                
                // Initialize Channels
                for (const channel of this.store.data.channels) {
                    this.createChannelAudio(channel);
                }

                // Main Sequencer Loop
                // We use scheduleRepeat for precise timing
                Tone.Transport.scheduleRepeat((time) => {
                    this.step(time);
                }, "16n");

                this.isInitialized = true;
            }

            createChannelAudio(channelData) {
                let instrument;

                if (channelData.type === 'sampler') {
                    // For decentralized app, these URLs would be blobs fetched from chain
                    instrument = new Tone.Player(channelData.url).toDestination();
                    instrument.volume.value = channelData.vol;
                } else if (channelData.type === 'synth') {
                    instrument = new Tone.PolySynth(Tone.FMSynth).toDestination();
                    instrument.volume.value = channelData.vol;
                }

                this.channels[channelData.id] = instrument;
            }

            step(time) {
                // Calculate current step (0-15)
                const step = (Tone.Transport.position.split(':')[1] * 4) + parseFloat(Tone.Transport.position.split(':')[2]);
                const current16th = Math.floor(step) % 16;

                // Defer UI update to Draw for synchronization
                Tone.Draw.schedule(() => {
                    updatePlayheadUI(current16th);
                }, time);

                // Trigger Audio
                this.store.data.channels.forEach(ch => {
                    if (ch.mute) return;
                    
                    const stepValue = ch.steps[current16th];
                    const instrument = this.channels[ch.id];

                    if (stepValue) {
                        if (ch.type === 'sampler') {
                            if (instrument.loaded) instrument.start(time, 0, "16n");
                        } else if (ch.type === 'synth') {
                            // stepValue contains the Note name (e.g., "C2")
                            instrument.triggerAttackRelease(stepValue, "16n", time);
                        }
                    }
                });
            }

            togglePlayback(play) {
                if (!this.isInitialized) return;
                if (play) {
                    Tone.Transport.start();
                } else {
                    Tone.Transport.stop();
                    // Reset visual playhead
                    updatePlayheadUI(0); 
                }
            }

            updateBpm(bpm) {
                Tone.Transport.bpm.rampTo(bpm, 0.1);
            }
        }

        const audio = new AudioEngine(store);

        /* ==========================================
           3. UI RENDERING (ui.js)
           ========================================== */
        // DOM Elements
        const sequencerView = document.getElementById('sequencer-view');
        const bpmInput = document.getElementById('bpm-input');
        const btnPlay = document.getElementById('btn-play');
        const btnStop = document.getElementById('btn-stop');
        const startupOverlay = document.getElementById('startup');
        
        // --- Initialization ---
        document.getElementById('start-btn').addEventListener('click', async () => {
            await audio.init();
            startupOverlay.style.display = 'none';
            renderSequencer();
        });

        // --- Rendering Logic ---

        function renderSequencer() {
            sequencerView.innerHTML = ''; // Clear
            store.data.channels.forEach(channel => {
                const row = document.createElement('div');
                row.className = 'channel-row';
                row.dataset.id = channel.id;
                row.dataset.type = channel.type;

                // 1. Controls (Left Side)
                const controls = document.createElement('div');
                controls.className = 'channel-controls';
                controls.innerHTML = `
                    <span class="channel-name">${channel.name}</span>
                    <div>
                        <button class="chan-btn ${channel.mute ? 'active' : ''}" onclick="toggleMute(${channel.id})">M</button>
                        <button class="chan-btn">S</button>
                    </div>
                `;

                // 2. Step Grid (Right Side)
                const grid = document.createElement('div');
                grid.className = 'step-grid';
                
                channel.steps.forEach((val, index) => {
                    const step = document.createElement('div');
                    step.className = `step ${val ? 'active' : ''}`;
                    step.dataset.index = index;
                    
                    // Interaction
                    step.addEventListener('mousedown', () => {
                        // Toggle logic
                        let newVal;
                        if (channel.type === 'sampler') {
                            newVal = val ? 0 : 1;
                        } else {
                            // For synth, simplified: toggle between C2 and null
                            // In full version, this opens a mini-piano roll modal
                            newVal = val ? null : "C2";
                        }
                        store.updateStep(channel.id, index, newVal);
                    });
                    grid.appendChild(step);
                });

                row.appendChild(controls);
                row.appendChild(grid);
                sequencerView.appendChild(row);
            });
        }

        // --- Granular Updates (Performance Optimization) ---
        // Instead of re-rendering the whole grid, we update specific classes
        function updateStepVisual(channelId, stepIndex, value) {
            const row = document.querySelector(`.channel-row[data-id="${channelId}"]`);
            const step = row.querySelector(`.step[data-index="${stepIndex}"]`);
            if (value) {
                step.classList.add('active');
            } else {
                step.classList.remove('active');
            }
        }

        // Global Playhead Visualizer
        let lastActiveStep = -1;
        function updatePlayheadUI(stepIndex) {
            // Remove 'playing' class from previous column
            const allSteps = document.querySelectorAll('.step');
            
            // Simple visualization: add a border to the current column
            // In a full implementation, we would move a CSS transform div for smoother animation
            
            // Reset all borders (naive approach, optimized approach would track last index)
            // For 64 steps this is fast enough.
            document.querySelectorAll(`.step[data-index="${lastActiveStep}"]`).forEach(el => {
                el.style.borderColor = 'transparent';
                el.style.borderStyle = 'none';
            });

            document.querySelectorAll(`.step[data-index="${stepIndex}"]`).forEach(el => {
                el.style.border = '1px solid white';
            });

            lastActiveStep = stepIndex;
        }

        // --- Global Interaction Handlers ---
        
        window.toggleMute = (id) => {
            store.toggleMute(id);
        };

        btnPlay.addEventListener('click', () => {
            const isPlaying = !store.data.isPlaying;
            store.togglePlay(isPlaying);
            
            if (isPlaying) {
                btnPlay.textContent = "|| PAUSE";
                btnPlay.classList.add('active');
                audio.togglePlayback(true);
            } else {
                btnPlay.textContent = "▶ PLAY";
                btnPlay.classList.remove('active');
                audio.togglePlayback(false);
            }
        });

        btnStop.addEventListener('click', () => {
            store.togglePlay(false);
            btnPlay.textContent = "▶ PLAY";
            btnPlay.classList.remove('active');
            audio.togglePlayback(false);
            updatePlayheadUI(-1); // Clear visual
        });

        bpmInput.addEventListener('change', (e) => {
            const val = parseInt(e.target.value);
            store.setBpm(val);
            audio.updateBpm(val);
        });

        document.getElementById('btn-save').addEventListener('click', () => {
            const json = JSON.stringify(store.data);
            navigator.clipboard.writeText(json).then(() => {
                alert('Project JSON copied to clipboard!');
            });
        });

        /* ==========================================
           4. SUBSCRIPTIONS
           ========================================== */
        store.subscribe((action, payload) => {
            // React to state changes
            if (action === 'STEP_UPDATED') {
                updateStepVisual(payload.channelId, payload.stepIndex, payload.value);
            }
            if (action === 'CHANNEL_MUTE') {
                // Update Mute button UI
                const btn = document.querySelector(`.channel-row[data-id="${payload.channelId}"] .chan-btn`);
                if (payload.val) btn.classList.add('active');
                else btn.classList.remove('active');
            }
        });

    </script>
</body>
</html>