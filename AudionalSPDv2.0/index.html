<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Iframe Grid Loader</title>
<style>
  body {
    background-color: black;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }
  .grid-container {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 10px;
    width: calc(100vh - 20px);
    height: calc(100vh - 20px);
    max-width: 100vw;
    max-height: 100vh;
  }
  .iframe-wrapper {
    position: relative;
    width: 100%;
    padding-top: 16.66%;
  }
  .bpm-display {
    position: absolute;
    top: 20px;
    left: 20px;
    color: red;
    font-size: 48px; /* Large font size for visibility */
    z-index: 10; /* Ensures it's on top of other elements */
  }
  iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 2px solid rgb(69, 69, 69);
    cursor: pointer;
  }
</style>
</head>
<body>
<div class="bpm-display">
  <input type="number" id="globalBPM" value="78" min="60" max="240">
  <button id="setBPM">Set BPM</button>
</div>
<div>  
  <button id="saveSettingsButton">Save Settings</button>
</div>
<div class="grid-container"></div>

<script>
  const numberOfIframes = 36; // Define the total number of iframes
  
  let expectedResponses = document.querySelectorAll('iframe').length;
  let receivedResponses = 0;
  const iframeSettings = [];

  window.addEventListener('message', function(event) {
      if (event.data.type === 'currentSettings') {
          console.log(`Settings received from ${event.source.frameElement.id}: `, event.data.settings);
          iframeSettings.push({
              iframeId: event.source.frameElement.id,
              settings: event.data.settings
          });
          receivedResponses++;

          // Check if all responses have been received
          if (receivedResponses === expectedResponses) {
              // Compile and download settings
              console.log('All iframe settings received:', iframeSettings);
              compileAndDownloadSettings(iframeSettings);
          }
      }
  });

  
  function createIframes() {
    console.log('Starting to create iframes...');
    const container = document.querySelector('.grid-container');
    console.log('Creating iframes...');
    for (let i = 0; i < numberOfIframes; i++) {
      const wrapper = document.createElement('div');
      wrapper.className = 'iframe-wrapper';
  
      const iframe = document.createElement('iframe');
      iframe.id = `iframe-${i}`;
      console.log(`Iframe ${iframe.id} created`);
  
      // Attach event listener for loading HTML files into iframes
      attachIframeClickListener(iframe);
  
      wrapper.appendChild(iframe);
      container.appendChild(wrapper);
    }
  }
  
  function attachIframeClickListener(iframe) {
    console.log(`Attaching click listener to ${iframe.id}`);
    iframe.addEventListener('click', () => {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'text/html';
      fileInput.style.display = 'none';
  
      fileInput.onchange = (e) => loadFileIntoIframe(e, iframe);
      document.body.appendChild(fileInput);
      fileInput.click();
      document.body.removeChild(fileInput);
    });
  }
  
  function loadFileIntoIframe(e, iframe) {
      const file = e.target.files[0];
      console.log(`Loading file into ${iframe.id}`);
      if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
              const blob = new Blob([e.target.result], { type: 'text/html' });
              const url = URL.createObjectURL(blob);
              iframe.src = url;
  
              console.log(`File loaded into ${iframe.id}, URL: ${url}`);
  
              // Wait for the iframe to load the new content
              iframe.onload = () => {
                  console.log(`Iframe ${iframe.id} loaded with content`);
                  const currentGlobalBPM = parseInt(document.getElementById('globalBPM').value, 10);
                  console.log(`Sending BPM update to ${iframe.id}: BPM = ${currentGlobalBPM}`);
                  iframe.contentWindow.postMessage({
                      type: 'updateBPM',
                      data: { bpm: currentGlobalBPM }
                  }, '*'); // Remember to replace '*' with the actual origin for better security
              };
          };
          reader.readAsText(file);
      }
  }
  
  function setGlobalBPM() {
    console.log('Setting global BPM...');
    const bpm = parseInt(document.getElementById('globalBPM').value, 10);
    const iframes = document.querySelectorAll('iframe');
  
    iframes.forEach(iframe => {
      console.log(`Updating BPM for ${iframe.id} to ${bpm}`);
      iframe.contentWindow.postMessage({
        type: 'updateBPM',
        data: { bpm: bpm }
      }, '*'); // Adjust to use the actual origin for better security
    });
  }
  
  createIframes();
  
  document.getElementById('setBPM').addEventListener('click', () => {
    console.log('Set BPM button clicked');
    setGlobalBPM();
  });
  
  // Toggle selection and mute control
  document.querySelectorAll('iframe').forEach(iframe => {
    iframe.addEventListener('click', () => {
      console.log(`${iframe.id} clicked for toggle selection/mute`);
      iframe.classList.toggle('selected');
    });
  });
  
  document.addEventListener('keydown', event => {
    if (event.key.toLowerCase() === 'm') {
      console.log('Mute key pressed, toggling mute for selected iframes');
      document.querySelectorAll('iframe.selected').forEach(iframe => {
        const isMuted = iframe.classList.contains('muted');
        console.log(`Toggling mute for ${iframe.id}: ${!isMuted}`);
        iframe.contentWindow.postMessage({
          type: 'muteControl',
          data: { mute: !isMuted }
        }, '*'); // Adjust to use the actual origin for better security
        iframe.classList.toggle('muted', !isMuted);
      });
    }
  });
  
  let isEventListenerAdded = false; // Flag to check if the event listener has been added
  
  function saveSettings() {
    console.log('saveSettings function triggered');
    const settings = [];
  
    // Add the event listener only once
    if (!isEventListenerAdded) {
      console.log('Adding message event listener for receiving settings from iframes...');
      window.addEventListener('message', (event) => {
        console.log('Message received from iframe:', event.data);
        if (event.data && event.data.type === 'currentSettings') {
          // Process the settings received from the iframe
          settings.push({
            iframeId: event.source.frameElement.id, // Assuming each iframe has a unique ID
            ...event.data.settings // Spreads the settings including URL and volume
          });
          console.log('Settings received and processed:', event.data.settings);
        }
      });
      isEventListenerAdded = true; // Set the flag to true after adding the listener
    }
  
    document.querySelectorAll('iframe').forEach(iframe => {
      console.log(`Requesting settings from ${iframe.id}`);
      // Wait for the iframe to load before requesting settings
      iframe.contentWindow.postMessage({ type: 'requestSettings' }, '*');
    });
  
    // Compile settings into a single JSON text file
    setTimeout(() => { // Delay to ensure all settings are received before creating the blob
      console.log('Compiled settings:', JSON.stringify(settings, null, 2));
      const settingsBlob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
      const settingsUrl = URL.createObjectURL(settingsBlob);
  
      // Trigger download
      const downloadLink = document.createElement('a');
      downloadLink.href = settingsUrl;
      downloadLink.download = 'audioSettings.json';
      downloadLink.click();
      console.log('Settings file created and download triggered');
    }, 1000); // Adjust delay as needed
  }
  
  document.getElementById('saveSettingsButton').addEventListener('click', () => {
    console.log('Save Settings button clicked');
    saveSettings();
  });
  </script>
  

</body>
</html>
