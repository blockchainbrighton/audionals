<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Audio GNARLS — Multi-Line Title Engine (All Effects, In→Hold→Out)</title>
<style>
  :root{
    --pink:#ff0064;--cyan:#00ffff;--yellow:#ffff00;--orange:#ff5500;--green:#00ff00;--blue:#00aaff;
    --glow-strong:0 0 10px var(--pink);--blur-bg:rgba(255,255,255,.15)
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
    color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative
  }
  .container{z-index:1;text-align:center;padding:2rem;max-width:1200px}
  h1{font-size:clamp(2rem,6vw,4.5rem);font-weight:800;margin:0 0 1.25rem;letter-spacing:3px;text-transform:uppercase;
      background:linear-gradient(45deg,#ff0064,#00ffff,#ffff00);-webkit-background-clip:text;background-clip:text;color:transparent;
      text-shadow:0 0 10px rgba(255,0,100,.7);animation:hueShift 10s linear infinite}
  .subtitle{font-size:1.05rem;max-width:900px;margin-inline:auto;color:#e0e0ff;line-height:1.6;margin-bottom:1.25rem}
  .title-wrap{position:relative;width:100%;min-height:clamp(180px,35vw,360px);display:grid;place-items:center;perspective:1000px;margin:1.25rem 0}
  .audio-title{font-size:clamp(2.25rem,10vw,6rem);font-weight:900;text-transform:uppercase;letter-spacing:4px;white-space:nowrap;
               color:var(--pink);text-shadow:0 0 10px var(--pink);transform-style:preserve-3d;display:flex;flex-direction:column;gap:.4em}
  .line{display:block;white-space:nowrap}
  .char{display:inline-block;transform-origin:center}
  .effect-name{position:absolute;inset:auto 0 10px; text-align:center;font-size:.95rem;color:#a0a0ff;letter-spacing:2px;text-transform:uppercase;
               text-shadow:0 0 10px rgba(160,160,255,.7);animation:pulse 2s infinite}
  .controls{display:flex;flex-direction:column;gap:.8rem;justify-content:center;margin-top:.5rem}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.6rem;align-items:stretch;margin-top:.6rem}
  button,input,select,label{font:inherit}
  button{background:var(--blur-bg);border:1px solid rgba(255,255,255,.3);color:#fff;font-weight:600;font-size:1rem;padding:.6rem 1rem;border-radius:30px;cursor:pointer;
         transition:transform .25s ease,box-shadow .25s ease,background .25s ease;backdrop-filter:blur(6px);position:relative;overflow:hidden}
  button:hover{background:rgba(255,255,255,.25);transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.3)}
  button::before{content:"";position:absolute;inset:0;left:-100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.22),transparent);transition:left .5s}
  button:hover::before{left:100%}
  .field{display:flex;align-items:center;gap:.35rem;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);padding:.4rem .6rem;border-radius:12px}
  .field input{width:9.2rem;background:transparent;border:none;outline:none;color:#fff}
  .field select{flex:1;background:transparent;border:none;outline:none;color:#fff}
  .stack{display:flex;flex-direction:column;gap:.35rem}
  .row{display:flex;flex-wrap:wrap;gap:.6rem;justify-content:center;align-items:center}
  .muted{opacity:.8}
  .particles{position:absolute;inset:0;pointer-events:none}
  .particle{position:absolute;width:4px;height:4px;border-radius:50%;box-shadow:0 0 10px currentColor}
  .footer{margin-top:1rem;color:rgba(255,255,255,.65);font-size:.9rem}

  /* --- Core keyframes (used by effects) --- */
  @keyframes float{0%,100%{transform:translate(0) rotate(0)}25%{transform:translate(15px,15px) rotate(90deg)}50%{transform:translate(20px,-20px) rotate(180deg)}75%{transform:translate(-15px,15px) rotate(270deg)}}
  @keyframes hueShift{to{filter:hue-rotate(360deg)}}
  @keyframes pulse{0%{opacity:.7;transform:scale(1)}50%{opacity:1;transform:scale(1.05)}100%{opacity:.7;transform:scale(1)}}
  @keyframes glitchChar{0%{transform:translate(0)}20%{transform:translate(-5px,2px) scale(1.02);filter:blur(.5px)}40%{transform:translate(5px,-2px)}60%{transform:translate(-2px,5px)}80%{transform:translate(2px,-5px);filter:blur(.3px)}100%{transform:translate(0)}}
  @keyframes glitch{0%{transform:translate(0)}20%{transform:translate(-3px,3px)}40%{transform:translate(-3px,-3px)}60%{transform:translate(3px,3px)}80%{transform:translate(3px,-3px)}100%{transform:translate(0)}}
  @keyframes rainbow{0%{color:#f00}16%{color:#f80}33%{color:#ff0}50%{color:#0f0}66%{color:#08f}83%{color:#80f}100%{color:#f00}}
  @keyframes neon{0%,100%{text-shadow:0 0 5px #fff,0 0 10px #fff,0 0 15px #fff,0 0 20px #ff00de,0 0 35px #ff00de,0 0 40px #ff00de}50%{text-shadow:0 0 2px #fff,0 0 5px #fff,0 0 7px #fff,0 0 10px #ff00de,0 0 17px #ff00de,0 0 20px #ff00de}}
  @keyframes hologram{0%,100%{text-shadow:0 0 5px #0ff,0 0 10px #0ff,0 0 15px #0ff,0 0 20px #0ff;color:#0ff}25%{text-shadow:0 0 5px #f0f,0 0 10px #f0f,0 0 15px #f0f,0 0 20px #f0f;color:#f0f}50%{text-shadow:0 0 5px #ff0,0 0 10px #ff0,0 0 15px #ff0,0 0 20px #ff0;color:#ff0}75%{text-shadow:0 0 5px #0f0,0 0 10px #0f0,0 0 15px #0f0,0 0 20px #0f0;color:#0f0}}
  @keyframes fire{0%,100%{text-shadow:0 0 5px #f00,0 0 10px #f50,0 0 15px #fa0,0 0 20px #fa0;color:#f50}25%{text-shadow:0 0 5px #f50,0 0 10px #fa0,0 0 15px #ff0,0 0 20px #ff0;color:#fa0}50%{text-shadow:0 0 5px #fa0,0 0 10px #ff0,0 0 15px #ff5,0 0 20px #ff5;color:#ff0}}
  @keyframes matrix{0%{text-shadow:0 0 5px #0f0,0 0 10px #0f0,0 0 15px #0f0,0 0 20px #0f0;color:#0f0}50%{text-shadow:0 0 2px #0a0,0 0 5px #0a0,0 0 7px #0a0,0 0 10px #0a0;color:#0a0}100%{text-shadow:0 0 5px #0f0,0 0 10px #0f0,0 0 15px #0f0,0 0 20px #0f0;color:#0f0}}
  @keyframes levitate{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-30px)}}
  @keyframes stretch{0%,100%{transform:scaleX(1)}50%{transform:scaleX(1.2)}}
  @keyframes swing{0%,100%{transform:rotate(0)}25%{transform:rotate(5deg)}75%{transform:rotate(-5deg)}}
  @keyframes twirl{0%{transform:rotate(0) scale(1)}50%{transform:rotate(180deg) scale(1.2)}100%{transform:rotate(360deg) scale(1)}}
  @keyframes implode{0%{transform:scale(0);opacity:0}70%{transform:scale(1.1);opacity:1}100%{transform:scale(1);opacity:1}}
  @keyframes explode{0%{transform:scale(1);opacity:1}30%{transform:scale(1.5);opacity:.7}100%{transform:scale(0);opacity:0}}
  @keyframes morph{0%{font-family:"Arial Black",sans-serif;letter-spacing:4px}25%{font-family:"Courier New",monospace;letter-spacing:2px}50%{font-family:Impact,sans-serif;letter-spacing:6px}75%{font-family:Georgia,serif;letter-spacing:1px}100%{font-family:"Arial Black",sans-serif;letter-spacing:4px}}
  @keyframes dissolve{from{opacity:1}to{opacity:0}} @keyframes appear{from{opacity:0;transform:scale(.5)}to{opacity:1;transform:scale(1)}}
  @keyframes slideIn{from{transform:translateX(-100%);opacity:0}to{transform:translateX(0);opacity:1}}
  @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}
  @keyframes flipIn{from{transform:rotateY(90deg);opacity:0}to{transform:rotateY(0);opacity:1}} @keyframes flipOut{from{opacity:1}to{transform:rotateY(-90deg);opacity:0}}
  @keyframes rollIn{from{opacity:0;transform:rotate(-360deg) scale(0)}to{opacity:1;transform:rotate(0) scale(1)}}
  @keyframes rollOut{from{opacity:1}to{opacity:0;transform:rotate(360deg) scale(0)}}
  @keyframes blurIn{from{filter:blur(10px);opacity:0}to{filter:blur(0);opacity:1}} @keyframes blurOut{from{filter:blur(0);opacity:1}to{filter:blur(10px);opacity:0}}
  @keyframes flash{50%{opacity:.1}} @keyframes wobble{0%,100%{transform:translateX(0)}15%{transform:translateX(-25px) rotate(-5deg)}30%{transform:translateX(20px) rotate(3deg)}45%{transform:translateX(-15px) rotate(-3deg)}60%{transform:translateX(10px) rotate(2deg)}75%{transform:translateX(-5px) rotate(-1deg)}}
  @keyframes tada{0%{transform:scale(1)}10%,20%{transform:scale(.9) rotate(-3deg)}30%,50%,70%,90%{transform:scale(1.1) rotate(3deg)}40%,60%,80%{transform:scale(1.1) rotate(-3deg)}100%{transform:scale(1) rotate(0)}}
  @keyframes jello{0%,100%{transform:scale(1,1)}30%{transform:scale(1.25,.75)}40%{transform:scale(.75,1.25)}50%{transform:scale(1.15,.85)}65%{transform:scale(.95,1.05)}75%{transform:scale(1.05,.95)}}
  @keyframes heartBeat{0%{transform:scale(1)}14%{transform:scale(1.3)}28%{transform:scale(1)}42%{transform:scale(1.3)}70%{transform:scale(1)}}
  @keyframes hinge{0%{transform-origin:top left}20%,60%{transform:rotate(80deg)}40%,80%{transform:rotate(60deg);opacity:1}100%{transform:translateY(700px);opacity:0}}
  @keyframes jackInTheBox{0%{opacity:0;transform:scale(.1) rotate(30deg);transform-origin:center bottom}50%{transform:rotate(-10deg)}70%{transform:rotate(3deg)}100%{opacity:1;transform:scale(1)}}
  @keyframes lightSpeedIn{0%{transform:translateX(100%) skewX(-30deg);opacity:0}60%{transform:skewX(20deg);opacity:1}80%{transform:skewX(-5deg);opacity:1}100%{transform:translateX(0);opacity:1}}
  @keyframes lightSpeedOut{from{opacity:1}to{transform:translateX(100%) skewX(30deg);opacity:0}}
  @keyframes rotateIn{from{transform:rotate(-200deg);opacity:0}to{transform:rotate(0);opacity:1}}
  @keyframes rotateOut{from{opacity:1}to{transform:rotate(200deg);opacity:0}}
  @keyframes rotateInDownLeft{from{transform-origin:left bottom;transform:rotate(45deg);opacity:0}to{transform-origin:left bottom;transform:rotate(0);opacity:1}}
  @keyframes rotateInDownRight{from{transform-origin:right bottom;transform:rotate(-45deg);opacity:0}to{transform-origin:right bottom;transform:rotate(0);opacity:1}}
  @keyframes rotateInUpLeft{from{transform-origin:left bottom;transform:rotate(45deg);opacity:0}to{transform-origin:left bottom;transform:rotate(0);opacity:1}}
  @keyframes rotateInUpRight{from{transform-origin:right bottom;transform:rotate(-90deg);opacity:0}to{transform-origin:right bottom;transform:rotate(0);opacity:1}}
  @keyframes rotateOutDownLeft{from{transform-origin:left bottom;opacity:1}to{transform-origin:left bottom;transform:rotate(45deg);opacity:0}}
  @keyframes rotateOutDownRight{from{transform-origin:right bottom;opacity:1}to{transform-origin:right bottom;transform:rotate(-45deg);opacity:0}}
  @keyframes rotateOutUpLeft{from{opacity:1}to{transform-origin:left bottom;transform:rotate(45deg);opacity:0}}
  @keyframes rotateOutUpRight{from{opacity:1}to{transform-origin:right bottom;transform:rotate(90deg);opacity:0}}
  @keyframes zoomIn{0%{opacity:0;transform:scale3d(.3,.3,.3)}50%{opacity:1}}
  @keyframes zoomOut{0%{opacity:1}50%{opacity:0;transform:scale3d(.3,.3,.3)}100%{opacity:0}}
  @keyframes bounceIn{0%,20%,40%,60%,80%,100%{animation-timing-function:cubic-bezier(.215,.61,.355,1)}0%{opacity:0;transform:scale3d(.3,.3,.3)}20%{transform:scale3d(1.1,1.1,1.1)}40%{transform:scale3d(.9,.9,.9)}60%{opacity:1;transform:scale3d(1.03,1.03,1.03)}80%{transform:scale3d(.97,.97,.97)}100%{opacity:1;transform:scale3d(1,1,1)}}
  @keyframes bounceOut{20%{transform:scale3d(.9,.9,.9)}50%,55%{opacity:1;transform:scale3d(1.1,1.1,1.1)}100%{opacity:0;transform:scale3d(.3,.3,.3)}}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}} @keyframes fadeOut{from{opacity:1}to{opacity:0}}
  @keyframes fadeInDown{from{opacity:0;transform:translate3d(0,-100%,0)}to{opacity:1;transform:translate3d(0,0,0)}}
  @keyframes fadeOutDown{from{opacity:1}to{opacity:0;transform:translate3d(0,100%,0)}}
  @keyframes fadeInUp{from{opacity:0;transform:translate3d(0,100%,0)}to{opacity:1;transform:translate3d(0,0,0)}}
  @keyframes fadeOutUp{from{opacity:1}to{opacity:0;transform:translate3d(0,-100%,0)}}
  @keyframes fadeInLeft{from{opacity:0;transform:translate3d(-100%,0,0)}to{opacity:1;transform:translate3d(0,0,0)}}
  @keyframes fadeOutLeft{from{opacity:1}to{opacity:0;transform:translate3d(-100%,0,0)}}
  @keyframes fadeInRight{from{opacity:0;transform:translate3d(100%,0,0)}to{opacity:1;transform:translate3d(0,0,0)}}
  @keyframes fadeOutRight{from{opacity:1}to{opacity:0;transform:translate3d(100%,0,0)}}
  @keyframes slideInDown{from{transform:translate3d(0,-100%,0);visibility:visible}to{transform:translate3d(0,0,0)}}
  @keyframes slideInLeft{from{transform:translate3d(-100%,0,0);visibility:visible}to{transform:translate3d(0,0,0)}}
  @keyframes slideInRight{from{transform:translate3d(100%,0,0);visibility:visible}to{transform:translate3d(0,0,0)}}
  @keyframes slideInUp{from{transform:translate3d(0,100%,0);visibility:visible}to{transform:translate3d(0,0,0)}}
  @keyframes slideOutDown{from{transform:translate3d(0,0,0)}to{visibility:hidden;transform:translate3d(0,100%,0)}}
  @keyframes slideOutLeft{from{transform:translate3d(0,0,0)}to{visibility:hidden;transform:translate3d(-100%,0,0)}}
  @keyframes slideOutRight{from{transform:translate3d(0,0,0)}to{visibility:hidden;transform:translate3d(100%,0,0)}}
  @keyframes slideOutUp{from{transform:translate3d(0,0,0)}to{visibility:hidden;transform:translate3d(0,-100%,0)}}
  @keyframes zoomInDown{0%{opacity:0;transform:scale3d(.1,.1,.1) translate3d(0,-1000px,0);animation-timing-function:cubic-bezier(.55,.055,.675,.19)}60%{opacity:1;transform:scale3d(.475,.475,.475) translate3d(0,60px,0);animation-timing-function:cubic-bezier(.175,.885,.32,1)}}
  @keyframes zoomInLeft{0%{opacity:0;transform:scale3d(.1,.1,.1) translate3d(-1000px,0,0);animation-timing-function:cubic-bezier(.55,.055,.675,.19)}60%{opacity:1;transform:scale3d(.475,.475,.475) translate3d(10px,0,0);animation-timing-function:cubic-bezier(.175,.885,.32,1)}}
  @keyframes zoomInRight{0%{opacity:0;transform:scale3d(.1,.1,.1) translate3d(1000px,0,0);animation-timing-function:cubic-bezier(.55,.055,.675,.19)}60%{opacity:1;transform:scale3d(.475,.475,.475) translate3d(-10px,0,0);animation-timing-function:cubic-bezier(.175,.885,.32,1)}}
  @keyframes zoomInUp{0%{opacity:0;transform:scale3d(.1,.1,.1) translate3d(0,1000px,0);animation-timing-function:cubic-bezier(.55,.055,.675,.19)}60%{opacity:1;transform:scale3d(.475,.475,.475) translate3d(0,-60px,0);animation-timing-function:cubic-bezier(.175,.885,.32,1)}}
  @keyframes zoomOutDown{40%{opacity:1;transform:scale3d(.475,.475,.475) translate3d(0,-60px,0);animation-timing-function:cubic-bezier(.55,.055,.675,.19)}100%{opacity:0;transform:scale3d(.1,.1,.1) translate3d(0,2000px,0);transform-origin:center bottom;animation-timing-function:cubic-bezier(.175,.885,.32,1)}}
  @keyframes zoomOutLeft{40%{opacity:1;transform:scale3d(.475,.475,.475) translate3d(42px,0,0)}100%{opacity:0;transform:scale(.1) translate3d(-2000px,0,0);transform-origin:left center}}
  @keyframes zoomOutRight{40%{opacity:1;transform:scale3d(.475,.475,.475) translate3d(-42px,0,0)}100%{opacity:0;transform:scale(.1) translate3d(2000px,0,0);transform-origin:right center}}
  @keyframes zoomOutUp{40%{opacity:1;transform:scale3d(.475,.475,.475) translate3d(0,60px,0);animation-timing-function:cubic-bezier(.55,.055,.675,.19)}100%{opacity:0;transform:scale3d(.1,.1,.1) translate3d(0,-2000px,0);transform-origin:center bottom;animation-timing-function:cubic-bezier(.175,.885,.32,1)}}
</style>
</head>
<body>
  <div class="particles" id="particles"></div>
  <div class="container">
    <h1>Audio GNARLS — Multi-Line Title Engine (All Effects, In→Hold→Out)</h1>
    <p class="subtitle">Each line now has an <strong>in</strong>-effect and an <strong>out</strong>-effect (with an optional looping <strong>hold</strong>). Mix & match effects, fonts, colors — per line. Randomize to explore the full space.</p>

    <div class="title-wrap">
      <div class="audio-title" id="title"></div>
      <div class="effect-name" id="effect-name">Ready</div>
    </div>

    <div class="controls">
      <div class="grid">
        <div class="stack">
          <label class="field"><span>Line 1</span><input id="line1" placeholder="Audio" value="Audio" /></label>
          <label class="field"><span>In</span><select id="fx1In"></select></label>
          <label class="field"><span>Hold</span><select id="fx1Hold"></select></label>
          <label class="field"><span>Out</span><select id="fx1Out"></select></label>
        </div>
        <div class="stack">
          <label class="field"><span>Line 2</span><input id="line2" placeholder="GNARLS" value="GNARLS" /></label>
          <label class="field"><span>In</span><select id="fx2In"></select></label>
          <label class="field"><span>Hold</span><select id="fx2Hold"></select></label>
          <label class="field"><span>Out</span><select id="fx2Out"></select></label>
        </div>
        <div class="stack">
          <label class="field" title="Milliseconds between frames / phases">
            <span>Interval</span>
            <input id="seq-interval" type="number" min="50" step="10" value="600" />
            <span>ms</span>
          </label>
          <label class="field" title="How many times the sequence repeats before stopping">
            <span>Repeats</span>
            <input id="seq-repeats" type="number" min="1" step="1" value="6" />
          </label>
          <label class="field" title="Hold duration per line (ms)">
            <span>Hold ms</span>
            <input id="hold-ms" type="number" min="0" step="50" value="1000" />
          </label>
        </div>
      </div>

      <div class="row">
        <button id="render-once">Render Once</button>
        <button id="play-seq">Play Sequence</button>
        <button id="stop-seq">Stop Sequence</button>
        <button id="randomize">Randomize Everything</button>
        <button id="font-btn">Change Font</button>
      </div>

      <div class="row">
        <span class="muted">Presets:</span>
        <button data-preset="single" class="preset">Single Line</button>
        <button data-preset="double" class="preset">Two Lines</button>
        <button data-preset="wordpulse" class="preset">Word Strobe</button>
      </div>
    </div>

    <div class="footer">Audio GNARLS | Flexible Multi-Line Visual Title System — All Effects</div>
  </div>

<script>
(() => {
  /* ------------------------ Particles ------------------------ */
  const particlesEl = document.getElementById('particles');
  (function makeParticles(){
    const frag = document.createDocumentFragment();
    for (let i=0;i<90;i++){
      const p = document.createElement('div');
      const size = Math.random()*6+2;
      p.className='particle';
      p.style.width=p.style.height=`${size}px`;
      p.style.left=`${Math.random()*100}%`;
      p.style.top=`${Math.random()*100}%`;
      p.style.opacity = (Math.random()*0.8+0.2).toFixed(2);
      p.style.animation = `float ${12+Math.random()*10}s ease-in-out ${Math.random()*5}s infinite`;
      p.style.color = `hsl(${(Math.random()*360)|0} 100% 70%)`;
      frag.appendChild(p);
    }
    particlesEl.appendChild(frag);
  })();

  /* ------------------------ Renderer ------------------------ */
  const titleEl = document.getElementById('title');
  const effectNameEl = document.getElementById('effect-name');
  const fonts = [
    "'Arial Black', sans-serif","'Courier New', monospace","'Impact', sans-serif","'Georgia', serif",
    "'Trebuchet MS', sans-serif","'Lucida Console', monospace","'Palatino Linotype', serif","'Verdana', sans-serif"
  ];
  let fontIdx = 0;

  const palettes = [
    {color:'var(--pink)',  shadow:'0 0 10px var(--pink),0 0 20px var(--pink)'},
    {color:'var(--cyan)',  shadow:'0 0 10px var(--cyan),0 0 20px var(--cyan)'},
    {color:'var(--yellow)',shadow:'0 0 10px var(--yellow),0 0 20px var(--yellow)'},
    {color:'var(--green)', shadow:'0 0 10px var(--green),0 0 20px var(--green)'},
    {color:'var(--blue)',  shadow:'0 0 10px var(--blue),0 0 20px var(--blue)'},
    {color:'#ff5500',      shadow:'0 0 10px #ff5500,0 0 20px #ff5500'}
  ];
  const rand = arr => arr[(Math.random()*arr.length)|0];

  const Renderer = {
    setLines(lines){
      titleEl.innerHTML = '';
      const frag = document.createDocumentFragment();
      lines.forEach((lineText,i) => {
        const line = document.createElement('div');
        line.className = 'line';
        line.dataset.lineIndex = i;
        if (!lineText){ frag.appendChild(line); return; }
        for (const ch of lineText){
          const span = document.createElement('span');
          span.className = 'char';
          span.innerHTML = ch === ' ' ? '&nbsp;' : ch;
          line.appendChild(span);
        }
        frag.appendChild(line);
      });
      titleEl.appendChild(frag);
      return this.getLines();
    },
    getLines(){ return Array.from(titleEl.querySelectorAll('.line')); },
    getCharsOf(lineIdx){
      const line = this.getLines()[lineIdx];
      return line ? Array.from(line.querySelectorAll('.char')) : [];
    },
    setStyle(color, shadow, target=titleEl){ target.style.color = color; target.style.textShadow = shadow; },
    applyKeyframeToChars(lineIdx, key, {duration='1s', iter='forwards', easing='', perCharDelay=.05, applyOnTitle=false}={}){
      if (applyOnTitle) titleEl.style.animation = `${key} ${duration} ${easing} ${iter}`.trim();
      const chars = this.getCharsOf(lineIdx);
      chars.forEach((ch,i)=>{
        ch.style.animation = `${key} ${duration} ${easing} ${iter} ${i*perCharDelay}s`.replace(/\s+/g,' ').trim();
      });
    },
    revealChars(lineIdx,{from, to='translate(0,0) scale(1) rotate(0)', dur=.8, delayStep=.06, easing='cubic-bezier(0.68,-0.55,0.265,1.55)', extra}={}){
      const chars = this.getCharsOf(lineIdx);
      chars.forEach((ch,i)=>{
        ch.style.opacity = 0;
        ch.style.transform = typeof from === 'function' ? from(i) : from;
        ch.style.transition = `transform ${dur}s ${i*delayStep}s ${easing}, opacity ${dur}s ${i*delayStep}s ${easing}`;
        if (extra) extra(ch,i);
        requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ ch.style.opacity = 1; ch.style.transform = to; }); });
      });
    },
    hideChars(lineIdx,{to='translateY(-80px) scale(0.7)', dur=.6, delayStep=.05, easing='ease-in', extra}={}){
      const chars = this.getCharsOf(lineIdx);
      chars.forEach((ch,i)=>{
        ch.style.transition = `transform ${dur}s ${i*delayStep}s ${easing}, opacity ${dur}s ${i*delayStep}s ${easing}, filter ${dur}s ${i*delayStep}s ${easing}`;
        if (extra) extra(ch,i);
        requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ ch.style.opacity = 0; ch.style.transform = typeof to === 'function' ? to(i) : to; ch.style.filter='blur(3px)'; }); });
      });
    },
    clearAnimations(){
      titleEl.style.animation = '';
      titleEl.querySelectorAll('.char,.line').forEach(el=>{
        el.style.animation = 'none';
        el.style.transition = 'none';
        el.style.transform = '';
        el.style.opacity = '';
        el.style.filter = '';
        el.style.textShadow = '';
        el.style.color = '';
        // force reflow to allow re-applying animations
        void el.offsetHeight;
        el.style.animation = '';
      });
    }
  };

  /* ------------------------ Effects Registry ------------------------ */
  // Registry entries are {name, type: 'in'|'hold'|'out', fn(renderer,lineIdx,opts)}
  const FX_IN = [];
  const FX_HOLD = [];
  const FX_OUT = [];

  const regIn = (name, fn)=>FX_IN.push({name,fn});
  const regHold = (name, fn)=>FX_HOLD.push({name,fn});
  const regOut = (name, fn)=>FX_OUT.push({name,fn});

  /* JS-heavy IN effects */
  regIn('Zoom Crash', (R,i)=>{ R.setStyle('var(--pink)','0 0 10px var(--pink),0 0 20px var(--pink)'); R.revealChars(i,{from:'scale(0) translateY(-100px)',dur:.8,delayStep:.08}); });
  regIn('Slide From Right', (R,i)=>{ R.setStyle('var(--cyan)','0 0 10px var(--cyan),0 0 20px var(--cyan)'); R.revealChars(i,{from:'translateX(200px) rotateY(-90deg)',dur:.7,delayStep:.06,easing:'ease-out'}); });
  regIn('Jumbled Scramble', (R,i)=>{ R.setStyle('#ff5500','0 0 15px #ff5500'); const chars=R.getCharsOf(i); const original=chars.map(ch=>ch.textContent);
    chars.forEach((ch,idx)=>{ ch.textContent=''; ch.style.opacity=0; ch.style.transform='rotateX(90deg) translateY(50px)'; ch.style.transition=`all .5s ${idx*.07}s ease-in`;
      const pool='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%'; let n=0; const run=()=>{ if(n<10){ ch.textContent=pool[(Math.random()*pool.length)|0]; n++; setTimeout(run,40);} else { ch.textContent=original[idx]||''; ch.style.opacity=1; ch.style.transform='rotateX(0) translateY(0)'; } }; setTimeout(run,150+idx*60);
    });
  });
  regIn('3D Spin In', (R,i)=>{ R.setStyle('#fff','0 0 10px var(--green),0 0 20px var(--green)'); R.revealChars(i,{from:'rotateY(-180deg) scale(.2)',dur:.9,delayStep:.08,easing:'cubic-bezier(.175,.885,.32,1.275)'}); });
  regIn('Bounce Fall', (R,i)=>{ R.setStyle('#ff00ff','0 0 15px #ff00ff,0 0 30px #ff00ff'); R.revealChars(i,{from:'translateY(-200px) rotate(-30deg)',dur:1,delayStep:.05,easing:'cubic-bezier(.47,2.02,.31,1)'}); });
  regIn('Elastic Pop', (R,i)=>{ R.setStyle('var(--yellow)','0 0 10px var(--yellow),0 0 20px var(--yellow)'); R.revealChars(i,{from:'scale(0)',dur:.6,delayStep:.06}); });
  regIn('Spin & Zoom', (R,i)=>{ R.setStyle('var(--green)','0 0 10px var(--green),0 0 20px var(--green)'); R.revealChars(i,{from:(k)=>`rotate(${(Math.random()*360)|0}deg) scale(0)`,dur:1,delayStep:.07,easing:'ease-out'}); });
  regIn('Slide Up', (R,i)=>{ R.setStyle('var(--blue)','0 0 10px var(--blue),0 0 20px var(--blue)'); R.revealChars(i,{from:'translateY(100px) skewX(20deg)',dur:.7,delayStep:.05,easing:'ease-in-out'}); });
  regIn('Explode In', (R,i)=>{ R.setStyle('#ff5500','0 0 15px #f00'); R.revealChars(i,{from:()=>`translate(${(Math.random()-.5)*200}px, ${(Math.random()-.5)*100}px) scale(0)`,dur:1.2,delayStep:.06,easing:'ease-out'}); });
  regIn('Wave Motion', (R,i)=>{ R.setStyle('var(--cyan)','0 0 10px var(--cyan)'); R.revealChars(i,{from:'translateY(50px)',dur:.8,delayStep:.07,easing:'ease-in-out',extra:(ch,k)=>{ch.style.transitionDelay = `${k*.07 + 0.1*Math.sin(k*.5)}s`;}}); });
  regIn('Chaos Mode', (R,i)=>{ R.setStyle('#ff00ff','0 0 22px #ff00ff'); const chars=R.getCharsOf(i); const r=(a,b)=>a+Math.random()*(b-a);
    chars.forEach((ch,k)=>{ const rx=r(-180,180), ry=r(-180,180), rz=r(-180,180); const tx=r(-320,320), ty=r(-220,220), tz=r(-200,200); const kx=r(-30,30), ky=r(-30,30); const sc=(0.2+Math.random()*0.6).toFixed(2); const dur=(0.7+Math.random()*1.2).toFixed(2); const delay=(k*0.06+Math.random()*0.2).toFixed(2);
      ch.style.opacity=0; ch.style.filter='blur(8px)'; ch.style.transform=`translate3d(${tx}px,${ty}px,${tz}px) rotateX(${rx}deg) rotateY(${ry}deg) rotate(${rz}deg) skew(${kx}deg,${ky}deg) scale(${sc})`;
      ch.style.transition=`transform ${dur}s ${delay}s cubic-bezier(.2,.8,.2,1), opacity ${dur}s ${delay}s ease-out, filter ${dur}s ${delay}s ease-out`; });
    requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ chars.forEach((ch)=>{ ch.style.opacity=1; ch.style.filter='blur(0)'; ch.style.transform='translate3d(0,0,0) rotateX(0) rotateY(0) rotate(0) skew(0,0) scale(1)'; }); }); }); });

  /* CSS HOLD (looping) effects */
  const holdCSS = [
    ['Rainbow Text','rainbow','var(--pink)','0 0 10px var(--pink)',{duration:'2s',iter:'infinite',perCharDelay:.1}],
    ['Neon Glow','neon','#ff00de','0 0 5px #fff,0 0 10px #fff,0 0 15px #fff,0 0 20px #ff00de,0 0 35px #ff00de,0 0 40px #ff00de',{duration:'2s',iter:'infinite',perCharDelay:.1}],
    ['Hologram','hologram','#0ff','0 0 5px #0ff',{duration:'3s',iter:'infinite',perCharDelay:.1}],
    ['Fire Text','fire','#ff5500','0 0 5px #f00,0 0 10px #f50,0 0 15px #fa0,0 0 20px #fa0',{duration:'2s',iter:'infinite',perCharDelay:.1}],
    ['Matrix Code','matrix','#0f0','0 0 5px #0f0',{duration:'1.5s',iter:'infinite',perCharDelay:.1}],
    ['Digital Glitch','glitch','#f0f','0 0 10px #f0f',{duration:'.5s',iter:'infinite',perCharDelay:.05}],
    ['Levitate','levitate','var(--yellow)','0 0 10px var(--yellow)',{duration:'3s',iter:'infinite',easing:'ease-in-out',perCharDelay:.1}],
    ['Spin Text','spin','var(--cyan)','0 0 10px var(--cyan)',{duration:'5s',iter:'infinite',easing:'linear',perCharDelay:.1}],
    ['Bounce Text','bounce','var(--pink)','0 0 10px var(--pink)',{duration:'2s',iter:'infinite',perCharDelay:.1}],
    ['Stretch Text','stretch','var(--green)','0 0 10px var(--green)',{duration:'2s',iter:'infinite',perCharDelay:.1}],
    ['Swing Text','swing','#ff5500','0 0 10px #ff5500',{duration:'2s',iter:'infinite',perCharDelay:.1}],
    ['Twirl Text','twirl','var(--blue)','0 0 10px var(--blue)',{duration:'3s',iter:'infinite',perCharDelay:.1}],
    ['Morph Text','morph','var(--cyan)','0 0 10px var(--cyan)',{duration:'4s',iter:'infinite',perCharDelay:.1}],
    ['Flash','flash','var(--blue)','0 0 10px var(--blue)',{duration:'1s',iter:'infinite'}],
    ['Wobble','wobble','#f0f','0 0 10px #f0f',{duration:'1s',iter:'infinite'}],
    ['Tada','tada','var(--yellow)','0 0 10px var(--yellow)',{duration:'1s',iter:'infinite'}],
    ['Jello','jello','var(--cyan)','0 0 10px var(--cyan)',{duration:'1s',iter:'infinite'}],
    ['Heart Beat','heartBeat','var(--pink)','0 0 10px var(--pink)',{duration:'1.5s',iter:'infinite'}],
    ['Hinge (title)','hinge','var(--green)','0 0 10px var(--green)',{duration:'2s',applyOnTitle:true}]
  ];
  holdCSS.forEach(([name,key,color,shadow,opt])=>{
    regHold(name,(R,i)=>{ R.setStyle(color,shadow); R.applyKeyframeToChars(i,key,Object.assign({perCharDelay:.05},opt||{})); });
  });

  /* CSS / JS OUT effects */
  const outCSS = [
    ['Fade Out','fadeOut','var(--yellow)','0 0 10px var(--yellow)'],
    ['Fade Out Down','fadeOutDown','var(--pink)','0 0 10px var(--pink)'],
    ['Fade Out Up','fadeOutUp','#ff5500','0 0 10px #ff5500'],
    ['Fade Out Left','fadeOutLeft','#f0f','0 0 10px #f0f'],
    ['Fade Out Right','fadeOutRight','var(--cyan)','0 0 10px var(--cyan)'],
    ['Slide Out','slideOut','var(--blue)','0 0 10px var(--blue)'],
    ['Slide Out Down','slideOutDown','var(--yellow)','0 0 10px var(--yellow)'],
    ['Slide Out Left','slideOutLeft','var(--cyan)','0 0 10px var(--cyan)'],
    ['Slide Out Right','slideOutRight','var(--pink)','0 0 10px var(--pink)'],
    ['Slide Out Up','slideOutUp','var(--green)','0 0 10px var(--green)'],
    ['Zoom Out','zoomOut','var(--green)','0 0 10px var(--green)'],
    ['Zoom Out Down','zoomOutDown','var(--green)','0 0 10px var(--green)'],
    ['Zoom Out Left','zoomOutLeft','#ff5500','0 0 10px #ff5500'],
    ['Zoom Out Right','zoomOutRight','var(--blue)','0 0 10px var(--blue)'],
    ['Zoom Out Up','zoomOutUp','#f0f','0 0 10px #f0f'],
    ['Rotate Out','rotateOut','var(--cyan)','0 0 10px var(--cyan)'],
    ['Rotate Out Down Left','rotateOutDownLeft','#f0f','0 0 10px #f0f'],
    ['Rotate Out Down Right','rotateOutDownRight','var(--yellow)','0 0 10px var(--yellow)'],
    ['Rotate Out Up Left','rotateOutUpLeft','var(--cyan)','0 0 10px var(--cyan)'],
    ['Rotate Out Up Right','rotateOutUpRight','var(--pink)','0 0 10px var(--pink)'],
    ['Light Speed Out','lightSpeedOut','#f0f','0 0 10px #f0f'],
    ['Blur Out','blurOut','#ff5500','0 0 10px #ff5500'],
    ['Roll Out','rollOut','var(--pink)','0 0 10px var(--pink)']
  ];
  outCSS.forEach(([name,key,color,shadow])=>{
    regOut(name,(R,i)=>{ R.setStyle(color,shadow); R.applyKeyframeToChars(i,key,{duration:'0.8s',iter:'forwards',perCharDelay:.04}); });
  });

  // Handy JS out effects (fine control)
  regOut('Scatter Away', (R,i)=>{ R.hideChars(i,{to:(k)=>`translate(${(Math.random()-.5)*220}px,${-120 - Math.random()*120}px) rotate(${(Math.random()*120-60)|0}deg) scale(${0.4+Math.random()*0.4})`, dur:.7, delayStep:.04}); });
  regOut('Sink & Blur', (R,i)=>{ R.hideChars(i,{to:(k)=>`translateY(${40+Math.random()*60}px) scale(${0.8+Math.random()*0.1})`, dur:.6, delayStep:.05, easing:'ease-in'}); });

  /* --- UI OPTION LISTS --- */
  const IN_LIST = FX_IN.map(f=>f.name).concat([
    'Zoom In','Zoom In Down','Zoom In Left','Zoom In Right','Zoom In Up',
    'Rotate In','Rotate In Down Left','Rotate In Down Right','Rotate In Up Left','Rotate In Up Right',
    'Slide In','Slide In Down','Slide In Left','Slide In Right','Slide In Up',
    'Flip In','Roll In','Blur In','Bounce In','Appear','Implode'
  ]);
  const HOLD_LIST = FX_HOLD.map(f=>f.name);
  const OUT_LIST = FX_OUT.map(f=>f.name).concat([
    'Fade Out','Fade Out Down','Fade Out Up','Fade Out Left','Fade Out Right',
    'Slide Out','Slide Out Down','Slide Out Left','Slide Out Right','Slide Out Up',
    'Zoom Out','Zoom Out Down','Zoom Out Left','Zoom Out Right','Zoom Out Up',
    'Rotate Out','Rotate Out Down Left','Rotate Out Down Right','Rotate Out Up Left','Rotate Out Up Right',
    'Light Speed Out','Blur Out','Roll Out','Dissolve','Explode'
  ]);

  // Map basic CSS names to generic keyframes for IN as well
  const cssInMapper = new Map([
    ['Zoom In','zoomIn'],['Zoom In Down','zoomInDown'],['Zoom In Left','zoomInLeft'],['Zoom In Right','zoomInRight'],['Zoom In Up','zoomInUp'],
    ['Rotate In','rotateIn'],['Rotate In Down Left','rotateInDownLeft'],['Rotate In Down Right','rotateInDownRight'],
    ['Rotate In Up Left','rotateInUpLeft'],['Rotate In Up Right','rotateInUpRight'],
    ['Slide In','slideIn'],['Slide In Down','slideInDown'],['Slide In Left','slideInLeft'],['Slide In Right','slideInRight'],['Slide In Up','slideInUp'],
    ['Flip In','flipIn'],['Roll In','rollIn'],['Blur In','blurIn'],['Bounce In','bounceIn'],['Appear','appear'],['Implode','implode']
  ]);
  const cssOutMapper = new Map([
    ['Fade Out','fadeOut'],['Fade Out Down','fadeOutDown'],['Fade Out Up','fadeOutUp'],['Fade Out Left','fadeOutLeft'],['Fade Out Right','fadeOutRight'],
    ['Slide Out','slideOut'],['Slide Out Down','slideOutDown'],['Slide Out Left','slideOutLeft'],['Slide Out Right','slideOutRight'],['Slide Out Up','slideOutUp'],
    ['Zoom Out','zoomOut'],['Zoom Out Down','zoomOutDown'],['Zoom Out Left','zoomOutLeft'],['Zoom Out Right','zoomOutRight'],['Zoom Out Up','zoomOutUp'],
    ['Rotate Out','rotateOut'],['Rotate Out Down Left','rotateOutDownLeft'],['Rotate Out Down Right','rotateOutDownRight'],['Rotate Out Up Left','rotateOutUpLeft'],['Rotate Out Up Right','rotateOutUpRight'],
    ['Light Speed Out','lightSpeedOut'],['Blur Out','blurOut'],['Roll Out','rollOut'],['Dissolve','dissolve'],['Explode','explode']
  ]);

  /* ------------------------ Pipeline Runner ------------------------ */
  function applyInEffect(name, lineIdx){
    const fx = FX_IN.find(f=>f.name===name);
    if (fx) return fx.fn(Renderer,lineIdx);
    const key = cssInMapper.get(name);
    if (key){ const pal = rand(palettes); Renderer.setStyle(pal.color, pal.shadow); Renderer.applyKeyframeToChars(lineIdx,key,{duration:'0.8s',iter:'forwards',perCharDelay:.05}); }
  }
  function applyHoldEffect(name, lineIdx){
    const fx = FX_HOLD.find(f=>f.name===name);
    if (fx) return fx.fn(Renderer,lineIdx);
  }
  function applyOutEffect(name, lineIdx){
    const fx = FX_OUT.find(f=>f.name===name);
    if (fx) return fx.fn(Renderer,lineIdx);
    const key = cssOutMapper.get(name);
    if (key){ const pal = rand(palettes); Renderer.setStyle(pal.color, pal.shadow); Renderer.applyKeyframeToChars(lineIdx,key,{duration:'0.8s',iter:'forwards',perCharDelay:.04}); }
  }

  function runLinePipeline(lineIdx, {inFx, holdFx, outFx, holdMs=1000, font, palette}){
    const lineNode = Renderer.getLines()[lineIdx];
    if (!lineNode) return;
    if (font) lineNode.style.fontFamily = font;
    if (palette) Renderer.setStyle(palette.color, palette.shadow, lineNode);

    // IN
    applyInEffect(inFx, lineIdx);

    // HOLD (optional looping)
    const startHold = () => { if (holdFx) applyHoldEffect(holdFx, lineIdx); };

    // OUT (after hold)
    const startOut = () => { applyOutEffect(outFx, lineIdx); };

    // Timings: approximate in duration 800ms, hold per input, out 800ms
    setTimeout(startHold, 800);
    setTimeout(startOut, 800 + Math.max(0, holdMs));
  }

  function renderWithPipelines(lines, pipelines){
    Renderer.clearAnimations();
    const nodes = Renderer.setLines(lines);
    nodes.forEach((_, i)=>{
      const p = pipelines[i] || pipelines[pipelines.length-1];
      if (p) runLinePipeline(i, p);
    });
  }

  /* ------------------------ UI wiring ------------------------ */
  const $ = (id)=>document.getElementById(id);
  const line1 = $('line1'), line2 = $('line2');
  const fx1In=$('fx1In'), fx1Hold=$('fx1Hold'), fx1Out=$('fx1Out');
  const fx2In=$('fx2In'), fx2Hold=$('fx2Hold'), fx2Out=$('fx2Out');

  function fillSelect(sel, items){ sel.innerHTML=''; items.forEach(n=>sel.add(new Option(n,n))); }

  fillSelect(fx1In, IN_LIST); fillSelect(fx2In, IN_LIST);
  fillSelect(fx1Hold, HOLD_LIST); fillSelect(fx2Hold, HOLD_LIST);
  fillSelect(fx1Out, OUT_LIST); fillSelect(fx2Out, OUT_LIST);

  // Sensible defaults
  fx1In.value='Zoom Crash'; fx1Hold.value='Neon Glow'; fx1Out.value='Slide Out Up';
  fx2In.value='Slide From Right'; fx2Hold.value='Rainbow Text'; fx2Out.value='Fade Out Down';

  const EFFECT_LABEL = () => `${fx1In.value} → ${fx1Hold.value || '—'} → ${fx1Out.value}` + (line2.value ? `  ||  ${fx2In.value} → ${fx2Hold.value || '—'} → ${fx2Out.value}` : '');

  function renderOnce(){
    const lines = [line1.value, line2.value].filter((_,i)=> i===0 || line2.value!==''); // keep second blank only if explicitly blank
    const holdMs = Math.max(0, Number($('hold-ms').value)||1000);
    const pipelines = [
      {inFx:fx1In.value, holdFx:fx1Hold.value, outFx:fx1Out.value, holdMs, font:rand(fonts), palette:rand(palettes)},
      {inFx:fx2In.value, holdFx:fx2Hold.value, outFx:fx2Out.value, holdMs, font:rand(fonts), palette:rand(palettes)}
    ];
    renderWithPipelines(lines, pipelines);
    effectNameEl.textContent = EFFECT_LABEL();
  }

  // Randomize EVERYTHING: pipelines, fonts, palettes
  function randomizeAll(){
    const pick = (list)=>list[(Math.random()*list.length)|0];
    fx1In.value = pick(IN_LIST);   fx2In.value = pick(IN_LIST);
    fx1Hold.value = pick(HOLD_LIST); fx2Hold.value = pick(HOLD_LIST);
    fx1Out.value = pick(OUT_LIST); fx2Out.value = pick(OUT_LIST);
    // Random fonts for title and per-line also in pipeline
    titleEl.style.fontFamily = rand(fonts);
    renderOnce();
  }

  document.getElementById('render-once').addEventListener('click', renderOnce);
  document.getElementById('randomize').addEventListener('click', randomizeAll);
  document.getElementById('font-btn').addEventListener('click', ()=>{ fontIdx=(fontIdx+1)%fonts.length; titleEl.style.fontFamily = fonts[fontIdx]; });

  /* ------------------------ Sequencer ------------------------ */
  class Sequencer{
    constructor(){ this.timer=null; this.running=false; this.idx=0; this.frames=[]; this.repeats=1; this.loops=0; this.interval=600; }
    load(frames,{interval=600,repeats=1}={}){ this.frames=frames; this.interval=interval; this.repeats=repeats; this.idx=0; this.loops=0; }
    stop(){ this.running=false; clearTimeout(this.timer); this.timer=null; effectNameEl.textContent='Stopped'; }
    play(){
      if(!this.frames.length) return;
      this.running=true;
      const step=()=>{
        if(!this.running) return;
        const f = this.frames[this.idx];
        renderWithPipelines(f.lines, f.pipelines);
        effectNameEl.textContent = f.label || 'Sequence';
        this.idx++;
        if(this.idx>=this.frames.length){ this.idx=0; this.loops++; if(this.loops>=this.repeats){ this.stop(); return; } }
        this.timer = setTimeout(step, this.interval);
      };
      step();
    }
  }
  const SEQ = new Sequencer();

  /* ------------------------ Presets ------------------------ */
  function presetSingle(){
    const text = (line1.value + ' ' + line2.value).trim();
    const holdMs = Math.max(0, Number($('hold-ms').value)||1000);
    const p = {inFx:fx1In.value, holdFx:fx1Hold.value, outFx:fx1Out.value, holdMs, font:rand(fonts), palette:rand(palettes)};
    return [{ lines:[text], pipelines:[p], label:'Preset: Single Line' }];
  }
  function presetDouble(){
    const holdMs = Math.max(0, Number($('hold-ms').value)||1000);
    const p1 = {inFx:fx1In.value, holdFx:fx1Hold.value, outFx:fx1Out.value, holdMs, font:rand(fonts), palette:rand(palettes)};
    const p2 = {inFx:fx2In.value, holdFx:fx2Hold.value, outFx:fx2Out.value, holdMs, font:rand(fonts), palette:rand(palettes)};
    return [{ lines:[line1.value, line2.value], pipelines:[p1,p2], label:'Preset: Two Lines'}];
  }
  function presetWordPulse(){
    const a = line1.value || '';
    const b = line2.value || '';
    const holdMs = Math.max(0, Number($('hold-ms').value)||600);
    const pA = {inFx:fx1In.value, holdFx:fx1Hold.value, outFx:fx1Out.value, holdMs, font:rand(fonts), palette:rand(palettes)};
    const pB = {inFx:fx2In.value, holdFx:fx2Hold.value, outFx:fx2Out.value, holdMs, font:rand(fonts), palette:rand(palettes)};
    return [
      { label:'Word Strobe — A', lines:[a], pipelines:[pA] },
      { label:'Word Strobe — (blank)', lines:[''], pipelines:[{...pA}] },
      { label:'Word Strobe — B', lines:[b], pipelines:[pB] },
      { label:'Word Strobe — (blank)', lines:[''], pipelines:[{...pB}] }
    ];
  }

  function playPreset(kind){
    const interval = Math.max(50, Number(document.getElementById('seq-interval').value)||600);
    const repeats = Math.max(1, Math.floor(Number(document.getElementById('seq-repeats').value)||1));
    let frames = [];
    if (kind==='single') frames = presetSingle();
    else if (kind==='double') frames = presetDouble();
    else if (kind==='wordpulse') frames = presetWordPulse();
    else frames = presetDouble();
    SEQ.stop();
    SEQ.load(frames,{interval,repeats});
    SEQ.play();
  }

  document.getElementById('play-seq').addEventListener('click', ()=>{
    const lastPresetBtn = document.querySelector('.preset.active');
    const kind = lastPresetBtn ? lastPresetBtn.dataset.preset : 'double';
    playPreset(kind);
  });
  document.getElementById('stop-seq').addEventListener('click', ()=>SEQ.stop());

  document.querySelectorAll('.preset').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.preset').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const k = btn.dataset.preset;
      if (k==='single'){
        const text = (line1.value+' '+line2.value).trim();
        renderWithPipelines([text],[{inFx:fx1In.value, holdFx:fx1Hold.value, outFx:fx1Out.value, holdMs:Number($('hold-ms').value)||1000, font:rand(fonts), palette:rand(palettes)}]);
      }
      if (k==='double'){
        renderWithPipelines([line1.value, line2.value],[
          {inFx:fx1In.value, holdFx:fx1Hold.value, outFx:fx1Out.value, holdMs:Number($('hold-ms').value)||1000, font:rand(fonts), palette:rand(palettes)},
          {inFx:fx2In.value, holdFx:fx2Hold.value, outFx:fx2Out.value, holdMs:Number($('hold-ms').value)||1000, font:rand(fonts), palette:rand(palettes)}
        ]);
      }
      if (k==='wordpulse'){
        renderWithPipelines([line1.value],[
          {inFx:fx1In.value, holdFx:fx1Hold.value, outFx:fx1Out.value, holdMs:Number($('hold-ms').value)||600, font:rand(fonts), palette:rand(palettes)}
        ]);
      }
      effectNameEl.textContent = `Preset: ${btn.textContent}`;
    });
  });

  // Initial render
  randomizeAll(); // start with variety
  document.querySelector('[data-preset="double"]').classList.add('active');
})();
</script>
</body>
</html>
