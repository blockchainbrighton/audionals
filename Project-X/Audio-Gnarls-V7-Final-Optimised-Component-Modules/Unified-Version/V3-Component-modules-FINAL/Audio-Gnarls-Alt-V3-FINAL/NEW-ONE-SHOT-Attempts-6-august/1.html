<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oscilloscope Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-darker: #0a0a0a;
            --primary: #bb86fc;
            --primary-variant: #3700b3;
            --secondary: #03dac6;
            --surface: #1e1e1e;
            --on-surface: #e0e0e0;
            --error: #cf6679;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--bg-dark);
            color: var(--on-surface);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            border-bottom: 1px solid var(--primary-variant);
        }
        
        h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(187, 134, 252, 0.5);
        }
        
        .subtitle {
            color: var(--secondary);
            font-size: 1.1rem;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .visualization-panel {
            flex: 1;
            min-width: 300px;
            background: var(--surface);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }
        
        .controls-panel {
            flex: 0 0 300px;
            background: var(--surface);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        .panel-title {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--primary-variant);
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-darker);
        }
        
        #scopeCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary);
        }
        
        select, input, button {
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--primary-variant);
            background: var(--bg-darker);
            color: var(--on-surface);
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        button {
            background: var(--primary-variant);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(187, 134, 252, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .btn-group button {
            flex: 1;
        }
        
        .btn-mute {
            background: var(--error);
        }
        
        .btn-mute.active {
            background: var(--secondary);
        }
        
        .sequencer {
            background: var(--bg-darker);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .step-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin: 15px 0;
        }
        
        .step {
            aspect-ratio: 1;
            background: var(--surface);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .step:hover {
            background: var(--primary-variant);
        }
        
        .step.active {
            background: var(--primary);
            border-color: var(--secondary);
            transform: scale(1.05);
        }
        
        .step.recording {
            background: var(--error);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .shape-keys {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .key {
            background: var(--surface);
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border: 1px solid var(--primary-variant);
        }
        
        .key span {
            display: block;
            font-size: 0.9rem;
            color: var(--secondary);
            margin-top: 5px;
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            color: #777;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .controls-panel {
                flex: 1;
            }
            
            .shape-keys {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Oscilloscope Visualizer</h1>
        <p class="subtitle">Interactive audio synthesis with dynamic visualizations</p>
    </header>
    
    <div class="app-container">
        <div class="main-content">
            <div class="visualization-panel">
                <h2 class="panel-title">Visualization</h2>
                <div class="canvas-container">
                    <canvas id="scopeCanvas"></canvas>
                </div>
            </div>
            
            <div class="controls-panel">
                <h2 class="panel-title">Controls</h2>
                
                <div class="control-group">
                    <label class="control-label">Visual Shape</label>
                    <select id="shapeSelect">
                        <option value="circle">Circle</option>
                        <option value="square">Square</option>
                        <option value="butterfly">Butterfly</option>
                        <option value="lissajous">Lissajous</option>
                        <option value="spirograph">Spirograph</option>
                        <option value="harmonograph">Harmonograph</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Seed</label>
                    <input type="number" id="seedInput" value="12345" min="1">
                    <button id="setSeedBtn">Set Seed</button>
                </div>
                
                <div class="control-group">
                    <button id="startBtn">Start Audio + Draw</button>
                    <div class="btn-group">
                        <button id="stopBtn">Stop</button>
                        <button id="muteBtn" class="btn-mute">Mute</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <button id="sequencerBtn">Create Sequence</button>
                </div>
                
                <div class="sequencer" id="sequencerPanel" style="display: none;">
                    <h3>Step Sequencer</h3>
                    <div class="step-grid" id="stepGrid">
                        <!-- Steps will be generated by JS -->
                    </div>
                    <div class="btn-group">
                        <button id="playSeqBtn">Play</button>
                        <button id="stopSeqBtn">Stop</button>
                        <button id="clearSeqBtn">Clear</button>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Step Time (ms)</label>
                        <input type="range" id="stepTimeSlider" min="100" max="1000" value="500">
                        <span id="stepTimeValue">500ms</span>
                    </div>
                    <div class="shape-keys">
                        <div class="key">1<span>Circle</span></div>
                        <div class="key">2<span>Square</span></div>
                        <div class="key">3<span>Butterfly</span></div>
                        <div class="key">4<span>Lissajous</span></div>
                        <div class="key">5<span>Spirograph</span></div>
                        <div class="key">6<span>Harmonograph</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>Oscilloscope Visualizer App | Use keys 1-6 to record steps in sequencer mode</p>
    </footer>

    <script>
        // Custom Elements
        class OscApp extends HTMLElement {
            constructor() {
                super();
                this.attachShadow({ mode: 'open' });
            }
            
            connectedCallback() {
                this.shadowRoot.innerHTML = `
                    <style>
                        :host {
                            display: block;
                            width: 100%;
                            height: 100%;
                        }
                    </style>
                    <div id="app">
                        <slot></slot>
                    </div>
                `;
            }
        }
        
        class ScopeCanvas extends HTMLElement {
            constructor() {
                super();
                this.attachShadow({ mode: 'open' });
            }
            
            connectedCallback() {
                this.shadowRoot.innerHTML = `
                    <style>
                        :host {
                            display: block;
                            width: 100%;
                            height: 100%;
                        }
                        canvas {
                            width: 100%;
                            height: 100%;
                            display: block;
                        }
                    </style>
                    <canvas id="scopeCanvas"></canvas>
                `;
            }
        }
        
        customElements.define('osc-app', OscApp);
        customElements.define('scope-canvas', ScopeCanvas);
        
        // Main App Logic
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const canvas = document.getElementById('scopeCanvas');
            const ctx = canvas.getContext('2d');
            const shapeSelect = document.getElementById('shapeSelect');
            const seedInput = document.getElementById('seedInput');
            const setSeedBtn = document.getElementById('setSeedBtn');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const muteBtn = document.getElementById('muteBtn');
            const sequencerBtn = document.getElementById('sequencerBtn');
            const sequencerPanel = document.getElementById('sequencerPanel');
            const stepGrid = document.getElementById('stepGrid');
            const playSeqBtn = document.getElementById('playSeqBtn');
            const stopSeqBtn = document.getElementById('stopSeqBtn');
            const clearSeqBtn = document.getElementById('clearSeqBtn');
            const stepTimeSlider = document.getElementById('stepTimeSlider');
            const stepTimeValue = document.getElementById('stepTimeValue');
            
            // App State
            let isPlaying = false;
            let isMuted = false;
            let currentShape = 'circle';
            let seed = 12345;
            let sequence = Array(8).fill(null);
            let isRecording = false;
            let currentStep = 0;
            let sequencerInterval = null;
            let stepTime = 500;
            
            // Initialize canvas
            function resizeCanvas() {
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
            }
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            
            // PRNG for deterministic presets
            function mulberry32(seed) {
                return function() {
                    let t = seed += 0x6D2B79F5;
                    t = Math.imul(t ^ t >>> 15, t | 1);
                    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                    return ((t ^ t >>> 14) >>> 0) / 4294967296;
                };
            }
            
            let rng = mulberry32(seed);
            
            // Reset RNG with new seed
            function setSeed(newSeed) {
                seed = newSeed;
                rng = mulberry32(seed);
            }
            
            // Audio synthesis with Tone.js
            let synth;
            let lfo;
            let filter;
            
            function initAudio() {
                if (!synth) {
                    synth = new Tone.Synth({
                        oscillator: {
                            type: 'sine'
                        },
                        envelope: {
                            attack: 0.02,
                            decay: 0.1,
                            sustain: 0.3,
                            release: 0.5
                        }
                    }).toDestination();
                    
                    lfo = new Tone.LFO("4n", 300, 800).start();
                    filter = new Tone.Filter(1000, "lowpass");
                    lfo.connect(filter.frequency);
                    synth.connect(filter);
                }
            }
            
            function playNote() {
                if (!isPlaying || isMuted) return;
                
                // Generate deterministic parameters based on seed and shape
                const baseFreq = 100 + rng() * 500;
                const note = Tone.Frequency(baseFreq, "hz").toNote();
                
                synth.triggerAttackRelease(note, "8n");
            }
            
            // Visualization functions
            function drawCircle(ctx, time) {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = 100 + Math.sin(time * 0.01) * 50;
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.strokeStyle = '#bb86fc';
                ctx.lineWidth = 3;
                ctx.stroke();
            }
            
            function drawSquare(ctx, time) {
                const size = 150 + Math.sin(time * 0.01) * 50;
                const x = (canvas.width - size) / 2;
                const y = (canvas.height - size) / 2;
                
                ctx.beginPath();
                ctx.rect(x, y, size, size);
                ctx.strokeStyle = '#03dac6';
                ctx.lineWidth = 3;
                ctx.stroke();
            }
            
            function drawButterfly(ctx, time) {
                const scale = 50;
                ctx.beginPath();
                
                for (let t = 0; t < Math.PI * 2; t += 0.01) {
                    const r = Math.exp(Math.cos(t)) - 2 * Math.cos(4 * t) + Math.pow(Math.sin(t / 12), 5);
                    const x = canvas.width / 2 + scale * r * Math.sin(t);
                    const y = canvas.height / 2 - scale * r * Math.cos(t);
                    
                    if (t === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.closePath();
                ctx.strokeStyle = '#cf6679';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            
            function drawLissajous(ctx, time) {
                const a = 3 + Math.floor(rng() * 3);
                const b = 2 + Math.floor(rng() * 3);
                const scale = 100;
                
                ctx.beginPath();
                
                for (let t = 0; t < Math.PI * 4; t += 0.02) {
                    const x = canvas.width / 2 + scale * Math.sin(a * t + time * 0.005);
                    const y = canvas.height / 2 + scale * Math.sin(b * t);
                    
                    if (t === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.strokeStyle = '#bb86fc';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            
            function drawSpirograph(ctx, time) {
                const R = 100;
                const r = 30 + Math.sin(time * 0.005) * 20;
                const d = 50;
                const scale = 1;
                
                ctx.beginPath();
                
                for (let t = 0; t < Math.PI * 16; t += 0.05) {
                    const x = canvas.width / 2 + scale * ((R - r) * Math.cos(t) + d * Math.cos(((R - r) / r) * t));
                    const y = canvas.height / 2 + scale * ((R - r) * Math.sin(t) - d * Math.sin(((R - r) / r) * t));
                    
                    if (t === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.strokeStyle = '#03dac6';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            
            function drawHarmonograph(ctx, time) {
                const A1 = 100, A2 = 100;
                const f1 = 2, f2 = 3;
                const p1 = 0, p2 = Math.PI / 2;
                const d1 = 0.01, d2 = 0.01;
                const scale = 1;
                
                ctx.beginPath();
                
                for (let t = 0; t < 100; t += 0.05) {
                    const x = canvas.width / 2 + scale * A1 * Math.cos(f1 * t + p1) * Math.exp(-d1 * t);
                    const y = canvas.height / 2 + scale * A2 * Math.cos(f2 * t + p2) * Math.exp(-d2 * t);
                    
                    if (t === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.strokeStyle = '#cf6679';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            
            // Draw function
            function draw() {
                if (!isPlaying) return;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const time = Date.now();
                
                // Draw waveform
                ctx.beginPath();
                ctx.moveTo(0, canvas.height / 2);
                
                for (let i = 0; i < canvas.width; i++) {
                    const x = i;
                    const y = canvas.height / 2 + Math.sin(i * 0.05 + time * 0.002) * 30;
                    ctx.lineTo(x, y);
                }
                
                ctx.strokeStyle = 'rgba(187, 134, 252, 0.7)';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Draw shape
                switch (currentShape) {
                    case 'circle': drawCircle(ctx, time); break;
                    case 'square': drawSquare(ctx, time); break;
                    case 'butterfly': drawButterfly(ctx, time); break;
                    case 'lissajous': drawLissajous(ctx, time); break;
                    case 'spirograph': drawSpirograph(ctx, time); break;
                    case 'harmonograph': drawHarmonograph(ctx, time); break;
                }
                
                requestAnimationFrame(draw);
            }
            
            // Sequencer functions
            function initSequencer() {
                stepGrid.innerHTML = '';
                for (let i = 0; i < 8; i++) {
                    const step = document.createElement('div');
                    step.className = 'step';
                    step.dataset.index = i;
                    step.textContent = i + 1;
                    step.addEventListener('click', () => {
                        if (isRecording) {
                            sequence[i] = currentShape;
                            updateStepDisplay();
                        }
                    });
                    stepGrid.appendChild(step);
                }
                updateStepDisplay();
            }
            
            function updateStepDisplay() {
                const steps = stepGrid.querySelectorAll('.step');
                steps.forEach((step, index) => {
                    step.classList.remove('active', 'recording');
                    if (sequence[index]) {
                        step.classList.add('active');
                        step.textContent = getShapeKey(sequence[index]);
                    } else {
                        step.textContent = index + 1;
                    }
                    if (isRecording && index === currentStep) {
                        step.classList.add('recording');
                    }
                });
            }
            
            function getShapeKey(shape) {
                const keys = {
                    'circle': '1',
                    'square': '2',
                    'butterfly': '3',
                    'lissajous': '4',
                    'spirograph': '5',
                    'harmonograph': '6'
                };
                return keys[shape] || '';
            }
            
            function playSequence() {
                if (sequencerInterval) clearInterval(sequencerInterval);
                
                sequencerInterval = setInterval(() => {
                    if (sequence[currentStep]) {
                        currentShape = sequence[currentStep];
                        shapeSelect.value = currentShape;
                        playNote();
                    }
                    currentStep = (currentStep + 1) % 8;
                    updateStepDisplay();
                }, stepTime);
            }
            
            function stopSequence() {
                if (sequencerInterval) {
                    clearInterval(sequencerInterval);
                    sequencerInterval = null;
                }
                currentStep = 0;
                updateStepDisplay();
            }
            
            // Event Listeners
            shapeSelect.addEventListener('change', (e) => {
                currentShape = e.target.value;
                if (isRecording) {
                    sequence[currentStep] = currentShape;
                    updateStepDisplay();
                }
            });
            
            setSeedBtn.addEventListener('click', () => {
                setSeed(parseInt(seedInput.value) || 12345);
            });
            
            startBtn.addEventListener('click', () => {
                if (!isPlaying) {
                    isPlaying = true;
                    initAudio();
                    Tone.start();
                    draw();
                    startBtn.textContent = 'Playing...';
                }
            });
            
            stopBtn.addEventListener('click', () => {
                isPlaying = false;
                startBtn.textContent = 'Start Audio + Draw';
                if (sequencerInterval) stopSequence();
            });
            
            muteBtn.addEventListener('click', () => {
                isMuted = !isMuted;
                muteBtn.textContent = isMuted ? 'Unmute' : 'Mute';
                muteBtn.classList.toggle('active', !isMuted);
            });
            
            sequencerBtn.addEventListener('click', () => {
                sequencerPanel.style.display = sequencerPanel.style.display === 'none' ? 'block' : 'none';
                if (sequencerPanel.style.display === 'block') {
                    initSequencer();
                }
            });
            
            playSeqBtn.addEventListener('click', () => {
                isRecording = false;
                currentStep = 0;
                playSequence();
                updateStepDisplay();
            });
            
            stopSeqBtn.addEventListener('click', () => {
                stopSequence();
            });
            
            clearSeqBtn.addEventListener('click', () => {
                sequence = Array(8).fill(null);
                initSequencer();
            });
            
            stepTimeSlider.addEventListener('input', () => {
                stepTime = parseInt(stepTimeSlider.value);
                stepTimeValue.textContent = `${stepTime}ms`;
                if (sequencerInterval) {
                    stopSequence();
                    playSequence();
                }
            });
            
            // Keyboard controls
            document.addEventListener('keydown', (e) => {
                if (e.key >= '1' && e.key <= '6') {
                    const shapes = ['circle', 'square', 'butterfly', 'lissajous', 'spirograph', 'harmonograph'];
                    const index = parseInt(e.key) - 1;
                    
                    if (index < shapes.length) {
                        currentShape = shapes[index];
                        shapeSelect.value = currentShape;
                        
                        if (isRecording) {
                            sequence[currentStep] = currentShape;
                            updateStepDisplay();
                        }
                        
                        playNote();
                    }
                }
            });
            
            // Initialize
            initSequencer();
        });
    </script>
</body>
</html>