<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tiny 64‑Step Sequencer — Studio Edition</title>
  <style>
    :root{
      --bg:#0b0d10; --panel:#11151a; --panel-2:#0e1318; --muted:#2a323c; --soft:#222a33; --fg:#e9eef4; --fg-2:#b8c2cc; --acc:#7bc5ff; --acc-2:#51a8f5;
      --on:#1a7ae2; --off:#0d1117; --stepOn:#0f6bd6; --noteOn:#16a34a; --warn:#f5a524; --good:#34d399;
      --shadow:0 6px 20px rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.25);
      --radius:14px; --radius-sm:10px; --radius-xs:8px;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fb; --panel:#ffffff; --panel-2:#f2f5f8; --muted:#dde3ea; --soft:#e9eef4; --fg:#0f1720; --fg-2:#384555; --acc:#0ea5e9; --acc-2:#0284c7; --off:#fff; --on:#0ea5e9; --stepOn:#38bdf8; --noteOn:#22c55e; --shadow:0 8px 24px rgba(8,28,70,.08), 0 2px 8px rgba(8,28,70,.06); }
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.35 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Noto Sans, "Apple Color Emoji","Segoe UI Emoji"}
    *{box-sizing:border-box}

    /* Layout */
    .wrap{max-width:1200px;margin:0 auto;padding:18px;display:grid;gap:16px}

    header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;background:var(--panel);border:1px solid var(--muted);border-radius:var(--radius);padding:10px 12px;box-shadow:var(--shadow)}
    header .left, header .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .transport{display:flex;gap:8px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--muted);background:linear-gradient(180deg, var(--panel-2), var(--panel));border-radius:999px;color:var(--fg);cursor:pointer;user-select:none;box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
    .btn:hover{border-color:var(--acc)}
    .btn.primary{background:linear-gradient(180deg, var(--acc), var(--acc-2));color:#fff;border-color:transparent}
    .btn.danger{background:linear-gradient(180deg, #ef4444, #dc2626);color:#fff;border-color:transparent}

    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--muted);border-radius:999px;background:var(--panel-2);box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
    .pill input[type="number"], .pill input[type="text"]{background:transparent;color:var(--fg);border:1px solid var(--muted);border-radius:10px;padding:6px 8px}
    .checkbox{display:inline-flex;gap:8px;align-items:center}

    .statusbar{display:flex;gap:12px;align-items:center;color:var(--fg-2)}
    .lamp{width:10px;height:10px;border-radius:50%;background:#2f3a46;box-shadow:0 0 0 2px rgba(0,0,0,.15) inset}
    .lamp.on{background:var(--good);box-shadow:0 0 10px var(--good)}

    .panel{background:var(--panel);border:1px solid var(--muted);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}

    .row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center}
    .label{font-weight:700;color:var(--fg-2)}

    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .controls input[type="text"]{min-width:260px;flex:1}

    /* Piano */
    .pianoWrap{background:var(--panel);border:1px solid var(--muted);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .pianoHdr{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--muted);gap:10px}
    .pianoCtrls{display:flex;gap:8px;align-items:center}
    .piano{position:relative;background:linear-gradient(180deg, var(--soft), var(--panel));padding:12px 12px 8px}
    .pianoScroll{overflow:auto;border:1px solid var(--muted);border-radius:var(--radius-sm);background:var(--panel)}
    svg#pianoSvg{display:block}

    .noteBadge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--muted);background:var(--panel-2);font-variant-numeric:tabular-nums}

    /* Step bars */
    .barMarks{display:grid;grid-template-columns:repeat(64,1fr);gap:2px;margin:8px 0}
    .barMarks div{height:2px;background:transparent}
    .barMarks div:nth-child(4n+1){background:rgba(180,200,220,.35)}
    .barMarks div:nth-child(16n+1){background:var(--acc)}

    /* Grids */
    .gridWrap{background:var(--panel);border:1px solid var(--muted);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
    .gridTitle{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .gridTitle .hint{color:var(--fg-2)}
    .grid{display:grid;grid-template-columns:repeat(64,1fr);gap:3px}
    .cell{aspect-ratio:1.6/1;border:1px solid var(--muted);background:var(--off);cursor:pointer;position:relative;border-radius:6px;transition:transform .05s ease,border-color .15s ease, background .15s ease}
    .cell:hover{transform:translateY(-1px)}
    .cell.on{background:linear-gradient(180deg, var(--stepOn), var(--on));border-color:var(--acc)}
    .cell.note{background:linear-gradient(180deg, #16794a, var(--noteOn));border-color:#16a34a22}
    .cell.playhead{outline:2px solid var(--acc);outline-offset:-2px}

    /* Footer/status */
    #status{padding:10px 0;color:var(--fg-2)}

    /* Helpers */
    .hint{opacity:.9}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;background:var(--panel-2);border:1px solid var(--muted);padding:2px 6px;border-radius:6px}

    /* Responsive tweaks */
    @media (max-width: 720px){ .row{grid-template-columns:1fr} .label{opacity:.85} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="left transport">
        <button id="play" class="btn primary" title="Space">▶︎ Play</button>
        <button id="stop" class="btn" title="Stop">■ Stop</button>
        <label class="pill checkbox"><input type="checkbox" id="record"> <span>Record</span></label>
        <label class="pill">BPM <input id="bpm" type="number" value="120" min="40" max="240" style="width:74px"></label>
        <label class="pill">Swing <input id="swing" type="number" value="0" min="0" max="60" step="1" style="width:64px"> <span class="hint">%</span></label>
      </div>
      <div class="right statusbar">
        <span class="lamp" id="metro"></span>
        <span class="noteBadge"><strong id="barReadout">Bar 1</strong> <span class="hint">/ 4</span></span>
        <span class="noteBadge"><span class="hint">Step</span> <strong id="stepReadout">1</strong></span>
        <span class="hint">MIDI: USB keyboard or the on‑screen piano. Press <span class="kbd">Space</span> to play.</span>
      </div>
    </header>

    <div class="panel">
      <div class="row">
        <div class="label">Sample</div>
        <div class="controls">
          <input id="sampleUrl" type="text" placeholder="Sample URL (mp3/opus/wav) — optional">
          <input id="sampleFile" type="file" accept="audio/*">
          <button id="loadSample" class="btn">Load</button>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="label">Synth</div>
        <div class="controls">
          <input id="synthUrl" type="text" placeholder="Headless synth module URL (optional)">
          <button id="loadSynth" class="btn">Load Synth</button>
          <span class="hint">A simple built‑in demo synth is included.</span>
        </div>
      </div>
    </div>

    <!-- Full piano keyboard -->
    <div class="pianoWrap">
      <div class="pianoHdr">
        <div class="pianoCtrls">
          <label class="pill">Octave <input id="octave" type="number" min="-3" max="3" value="0" style="width:64px"></label>
          <label class="pill">Velocity <input id="velocity" type="number" min="1" max="127" value="100" style="width:72px"></label>
        </div>
        <div class="noteBadge"><span class="hint">Last note</span> <strong id="lastNote">—</strong></div>
      </div>
      <div class="piano">
        <div class="pianoScroll">
          <svg id="pianoSvg" height="160" aria-label="Piano keyboard"></svg>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="barMarks" aria-hidden="true"></div>
    </div>

    <div class="gridWrap">
      <div class="gridTitle"><strong>Sampler</strong><span class="hint">Toggle steps to place sample triggers</span></div>
      <div id="samplerGrid" class="grid" role="grid" aria-label="Sampler steps"></div>
    </div>

    <div class="gridWrap">
      <div class="gridTitle"><strong>Synth</strong><span class="hint">Tap a cell to clear a recorded note</span></div>
      <div id="synthGrid" class="grid" role="grid" aria-label="Synth steps"></div>
    </div>

    <div id="status" class="hint"></div>
  </div>

<script>
(() => {
  const steps = 64;
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const log = m => { $('#status').textContent = m; };

  // UI refs
  const playBtn = $('#play'), stopBtn = $('#stop'), bpmEl = $('#bpm'), recEl = $('#record');
  const swingEl = $('#swing');
  const samplerGrid = $('#samplerGrid'), synthGrid = $('#synthGrid');
  const metroLamp = $('#metro');
  const barReadout = $('#barReadout');
  const stepReadout = $('#stepReadout');
  const lastNoteEl = $('#lastNote');
  const velEl = $('#velocity');
  const octaveEl = $('#octave');

  // Audio Context
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  let isPlaying = false, currentStep = 0, nextNoteTime = 0, startTime = 0;
  let timerId = 0; const lookahead = 0.05; // 50ms
  const sampleSteps = new Array(steps).fill(false);
  const synthSteps  = new Array(steps).fill(null);
  let sampleBuf = null;
  let bpm = +bpmEl.value;
  let swingPct = +swingEl.value; // 0..60 (%) delay on off-beats

  const midiToHz = n => 440 * Math.pow(2, (n - 69) / 12);
  const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));

  // Built-in headless synth demo
  function demoSynth(context) {
    return {
      noteOn(note, time, dur=0.22, vel=1.0) {
        const osc = context.createOscillator();
        const gain = context.createGain();
        const filt = context.createBiquadFilter();
        filt.type = 'lowpass'; filt.frequency.setValueAtTime(Math.min(12000, midiToHz(note)*3), time);
        const lfo = context.createOscillator();
        const lfoGain = context.createGain();
        lfo.frequency.value = 5.5; lfoGain.gain.value = 10; // subtle vibrato
        lfo.connect(lfoGain).connect(osc.frequency);
        const freq = midiToHz(note);
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(freq, time);
        const peak = Math.max(0.05, vel);
        const a=.006,d=.07,s=.28,r=.14;
        gain.gain.setValueAtTime(0, time);
        gain.gain.linearRampToValueAtTime(peak, time + a);
        gain.gain.linearRampToValueAtTime(s*peak, time + a + d);
        gain.gain.setValueAtTime(s*peak, time + Math.max(dur, a+d));
        gain.gain.linearRampToValueAtTime(0, time + Math.max(dur, a+d) + r);
        osc.connect(filt).connect(gain).connect(context.destination);
        lfo.start(time);
        osc.start(time);
        osc.stop(time + Math.max(dur, a+d) + r + 0.02);
        lfo.stop(time + Math.max(dur, a+d) + r + 0.02);
      }
    }
  }
  let synth = demoSynth(ctx);

  // External synth loader
  $('#loadSynth').addEventListener('click', async () => {
    const url = $('#synthUrl').value.trim();
    if (!url) { synth = demoSynth(ctx); log('Using built‑in demo synth.'); return; }
    try {
      const mod = await import(url);
      const factory = mod.default || mod.createSynth || mod.synth || mod;
      const s = typeof factory === 'function' ? factory(ctx) : null;
      if (s && typeof s.noteOn === 'function') { synth = s; log('Loaded headless synth module.'); }
      else { synth = demoSynth(ctx); log('Module invalid. Using demo synth.'); }
    } catch (e) {
      synth = demoSynth(ctx);
      log('Failed to load synth module. Using demo synth.');
    }
  });

  // Sample loading
  $('#loadSample').addEventListener('click', async () => {
    await ctx.resume();
    const f = $('#sampleFile').files[0];
    const url = $('#sampleUrl').value.trim();
    try {
      let ab;
      if (f) ab = await f.arrayBuffer();
      else if (url) { const res = await fetch(url); ab = await res.arrayBuffer(); }
      else { log('Choose a file or paste a URL.'); return; }
      sampleBuf = await ctx.decodeAudioData(ab);
      log('Sample loaded.');
    } catch (e) { log('Could not load sample.'); }
  });

  // Grids
  const sampCells = [], synthCells = [];
  for (let i=0;i<steps;i++) {
    const c = document.createElement('div'); c.className='cell';
    c.title = `Step ${i+1}`;
    c.addEventListener('click', ()=>{ sampleSteps[i] = !sampleSteps[i]; render(); });
    samplerGrid.appendChild(c); sampCells.push(c);
  }
  for (let i=0;i<steps;i++) {
    const c = document.createElement('div'); c.className='cell';
    c.title = `Step ${i+1}`;
    c.addEventListener('click', ()=>{ if (synthSteps[i]!==null){ synthSteps[i]=null; render(); }});
    synthGrid.appendChild(c); synthCells.push(c);
  }
  const bm = document.querySelector('.barMarks');
  for (let i=0;i<steps;i++){ bm.appendChild(document.createElement('div')); }

  function stepDur() { return 60 / bpm / 4; }
  function swingOffset(step){
    // Simple swing: delay even (off-beat) steps by percentage of step duration
    const isOff = (step % 2)===1;
    return isOff ? stepDur() * (swingPct/100) : 0;
  }
  function schedule(step, time) {
    if (sampleSteps[step] && sampleBuf) { const src = ctx.createBufferSource(); src.buffer = sampleBuf; src.connect(ctx.destination); src.start(time + swingOffset(step)); }
    const note = synthSteps[step];
    if (note !== null) synth.noteOn(note, time + swingOffset(step), stepDur()*0.95, clamp(velEl.value/127, 0.1, 1));
  }
  function scheduler(){
    const ahead = ctx.currentTime + lookahead;
    while (nextNoteTime < ahead) {
      schedule(currentStep, nextNoteTime);
      // Visuals updated one step behind to match audio
      const ph = currentStep;
      requestAnimationFrame(()=>markPlayhead(ph));
      nextNoteTime += stepDur();
      currentStep = (currentStep + 1) % steps;
    }
  }
  function markPlayhead(step){
    const ph = (step + steps) % steps;
    sampCells.forEach((c,i)=> c.classList.toggle('playhead', i===ph));
    synthCells.forEach((c,i)=> c.classList.toggle('playhead', i===ph));
    const bar = Math.floor(ph/16) + 1;
    barReadout.textContent = `Bar ${bar}`;
    stepReadout.textContent = (ph % 16) + 1;
    // metronome lamp
    metroLamp.classList.toggle('on', (ph % 4)===0);
  }
  function render(){
    sampCells.forEach((c,i)=> c.classList.toggle('on', !!sampleSteps[i]));
    synthCells.forEach((c,i)=> c.classList.toggle('note', synthSteps[i]!==null));
  }
  function start(){
    if (isPlaying) return;
    ctx.resume();
    isPlaying = true; currentStep = 0; startTime = ctx.currentTime; nextNoteTime = startTime + 0.06;
    timerId = setInterval(scheduler, 25);
    log('Playing.');
  }
  function stop(){
    if (!isPlaying) return;
    isPlaying = false; clearInterval(timerId);
    sampCells.forEach(c=>c.classList.remove('playhead'));
    synthCells.forEach(c=>c.classList.remove('playhead'));
    metroLamp.classList.remove('on');
    log('Stopped.');
  }

  playBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
  bpmEl.addEventListener('change', e=>{ bpm = clamp(+e.target.value||120, 40, 240); e.target.value=bpm; });
  swingEl.addEventListener('change', e=>{ swingPct = clamp(+e.target.value||0,0,60); e.target.value=swingPct; });

  // MIDI support
  async function initMIDI(){
    if (!('requestMIDIAccess' in navigator)) return;
    try {
      const access = await navigator.requestMIDIAccess();
      function handleInput(input){ input.onmidimessage = ev => {
        const [st,d1,d2] = ev.data; const cmd = st & 0xf0;
        if (cmd === 0x90 && d2>0) triggerNote(d1,d2/127);
      }}
      access.inputs.forEach(handleInput);
      access.onstatechange = e => { if (e.port.type==='input' && e.port.state==='connected') handleInput(e.port); };
    } catch(e) {}
  }
  initMIDI();

  // === Full Piano (SVG) ===
  // 88-key range by default (A0=21 .. C8=108). We allow octave transpose via control (±3 octaves).
  const pianoSvg = document.getElementById('pianoSvg');
  const WHITE_W = 28, WHITE_H = 150, BLACK_W = 18, BLACK_H = 95;
  const A0 = 21, C8 = 108;
  const isBlack = n => [1,3,6,8,10].includes(n % 12);
  const pcToName = (pc => ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'])[pc]

  function buildPiano(){
    // Clear
    while (pianoSvg.firstChild) pianoSvg.removeChild(pianoSvg.firstChild);

    const transpose = clamp(parseInt(octaveEl.value)||0,-3,3) * 12;

    // First compute white key order/positions to anchor black keys
    const whites = [];
    let x = 0, whiteIndex = 0;
    for (let m=A0; m<=C8; m++){
      if (!isBlack(m)) {
        whites.push({midi:m, x:x, octave: Math.floor((m-12)/12)-1, name: pcToName(m%12)});
        x += WHITE_W; whiteIndex++;
      }
    }
    pianoSvg.setAttribute('width', whites.length*WHITE_W + 2);
    pianoSvg.setAttribute('height', WHITE_H + 2);

    // Draw white keys
    whites.forEach((w,i)=>{
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
      r.setAttribute('x', w.x+1); r.setAttribute('y', 1);
      r.setAttribute('width', WHITE_W-2); r.setAttribute('height', WHITE_H-2);
      r.setAttribute('rx', 6);
      r.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--off').trim());
      r.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--muted').trim());
      r.classList.add('w');
      g.appendChild(r);

      // Label for C and A notes
      const pc = w.midi % 12; const label = (pc===0||pc===9) ? `${pcToName(pc)}${Math.floor(w.midi/12)-1}` : '';
      if (label){
        const t = document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x', w.x + WHITE_W/2);
        t.setAttribute('y', WHITE_H - 10);
        t.setAttribute('text-anchor','middle');
        t.setAttribute('font-size','10');
        t.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--fg-2').trim());
        t.textContent = label;
        g.appendChild(t);
      }

      g.addEventListener('mousedown', () => {
        keyActive(w.midi+transpose, g, true);
      });
      window.addEventListener('mouseup', () => g.classList.remove('active'));

      pianoSvg.appendChild(g);
    });

    // Helper: map MIDI to white index for black positioning
    function whiteIndexForMidi(m){
      let idx=0; for (let k=A0;k<=m;k++){ if (!isBlack(k)) idx++; } return idx-1; // zero-based
    }
    // Black key X offset pattern within octave (relative to left white of pair)
    const blackOffsets = { 1: 0.68, 3: 1.58, 6: 3.68, 8: 4.58, 10: 5.48 };

    // Draw black keys on top
    for (let m=A0; m<=C8; m++){
      if (!isBlack(m)) continue;
      const pc = m%12; const beforeWhiteIdx = whiteIndexForMidi(m-1);
      const baseX = beforeWhiteIdx * WHITE_W;
      const xPos = baseX + Math.round(blackOffsets[pc]*WHITE_W) - Math.floor(BLACK_W/2);
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
      r.setAttribute('x', xPos+1); r.setAttribute('y', 1);
      r.setAttribute('width', BLACK_W); r.setAttribute('height', BLACK_H);
      r.setAttribute('rx', 4);
      r.setAttribute('fill', '#111');
      r.setAttribute('stroke', '#333');
      r.classList.add('b');
      g.appendChild(r);
      g.addEventListener('mousedown', () => { keyActive(m+transpose, g, false); });
      window.addEventListener('mouseup', () => g.classList.remove('active'));
      pianoSvg.appendChild(g);
    }
  }

  function keyActive(midi, g, isWhite){
    g.classList.add('active');
    const vel = clamp(velEl.value/127, 0.1, 1);
    triggerNote(midi, vel);
    lastNoteEl.textContent = noteName(midi);
    // visual highlight
    const r = g.querySelector('rect');
    const prevFill = r.getAttribute('fill');
    r.setAttribute('fill', isWhite? '#a7d3ff' : '#3b82f6');
    setTimeout(()=> r.setAttribute('fill', prevFill), 120);
  }

  function noteName(m){
    const pcs=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    return pcs[m%12] + (Math.floor(m/12)-1);
  }

  octaveEl.addEventListener('change', ()=>{ octaveEl.value = clamp(parseInt(octaveEl.value)||0,-3,3); buildPiano(); });
  velEl.addEventListener('change', ()=>{ velEl.value = clamp(parseInt(velEl.value)||100,1,127); });

  // Trigger helpers
  function triggerNote(note, vel){
    const t = ctx.currentTime;
    synth.noteOn(note, t, 0.25, vel);
    if (recEl.checked && isPlaying) {
      const idx = (currentStep + steps - 1) % steps;
      synthSteps[idx] = note; render();
    }
  }

  window.addEventListener('keydown', (e)=>{ if (e.code==='Space'){ e.preventDefault(); isPlaying?stop():start(); }});

  // Init
  buildPiano();
  render();
})();
</script>
</body>
</html>
