<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tiny 64‑Step Sequencer</title>
  <style>
    :root { --fg:#111; --bg:#fafafa; --muted:#ddd; --acc:#4a90e2; --on:#111; --off:#fff; }
    html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    header{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--muted)}
    header>*{margin:2px 0}
    .row{display:grid;grid-template-columns:70px 1fr;gap:.5rem;align-items:center;padding:8px 12px}
    .label{font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(64,1fr);gap:2px}
    .cell{aspect-ratio:1.6/1;border:1px solid #bbb;background:var(--off);cursor:pointer;position:relative}
    .cell.on{background:#9fd1ff;border-color:#7bbcff}
    .cell.note{background:#b7f7c5;border-color:#80e49a}
    .cell.playhead::after{content:"";position:absolute;inset:0;outline:2px solid var(--acc);outline-offset:-2px;pointer-events:none}
    .controls{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
    button,input[type="number"],input[type="text"]{padding:6px 10px;border:1px solid var(--muted);border-radius:7px;background:white}
    button{cursor:pointer}
    .pill{display:inline-flex;gap:.35rem;align-items:center;padding:6px 10px;border:1px solid var(--muted);border-radius:999px;background:white}
    .small{font-size:12px;color:#555}
    #status{padding:6px 12px;color:#444}
    .hint{opacity:.8}
    .barMarks{display:grid;grid-template-columns:repeat(64,1fr);gap:2px;margin:0 12px}
    .barMarks div{height:2px;background:transparent}
    .barMarks div:nth-child(16n+1){background:#aaa}
    .keyboard{display:flex;gap:2px;margin:12px;padding:6px;background:#eee;border-radius:6px;flex-wrap:wrap;max-width:720px}
    .key{flex:1 0 28px;height:80px;background:#fff;border:1px solid #aaa;border-radius:4px;cursor:pointer;display:flex;align-items:flex-end;justify-content:center;font-size:11px;user-select:none}
    .key.black{background:#333;color:#eee;height:50px;margin:0 -14px;z-index:2;flex:0 0 28px;position:relative;top:0}
    .key.active{background:#9fd1ff !important;border-color:#7bbcff}
  </style>
</head>
<body>
  <header>
    <div class="controls">
      <button id="play">▶︎ Play</button>
      <button id="stop">■ Stop</button>
      <label class="pill"><input type="checkbox" id="record"> Record</label>
      <label class="pill">BPM <input id="bpm" type="number" value="120" min="40" max="240" style="width:64px;margin-left:6px"></label>
    </div>
    <div class="small hint">MIDI: USB keyboard or use the on-screen keyboard. Click Play to unlock audio.</div>
  </header>

  <div class="row">
    <div class="label">Sample</div>
    <div class="controls" style="gap:.35rem">
      <input id="sampleUrl" type="text" placeholder="Sample URL (mp3/opus/wav) — optional" style="flex:1;min-width:240px">
      <input id="sampleFile" type="file" accept="audio/*">
      <button id="loadSample">Load</button>
    </div>
  </div>

  <div class="row">
    <div class="label">Synth</div>
    <div class="controls" style="gap:.35rem">
      <input id="synthUrl" type="text" placeholder="Headless synth module URL (optional)" style="flex:1;min-width:240px">
      <button id="loadSynth">Load Synth</button>
      <span class="small hint">(A simple built‑in demo synth is included)</span>
    </div>
  </div>

  <div class="keyboard" id="keyboard"></div>

  <div class="barMarks" aria-hidden="true"></div>

  <div class="row">
    <div class="label">Sampler</div>
    <div id="samplerGrid" class="grid" role="grid" aria-label="Sampler steps"></div>
  </div>

  <div class="row">
    <div class="label">Synth</div>
    <div id="synthGrid" class="grid" role="grid" aria-label="Synth steps"></div>
  </div>

  <div id="status"></div>

<script>
(() => {
  const steps = 64;
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const log = m => { const el=$('#status'); el.textContent = m; };

  // UI refs
  const playBtn = $('#play'), stopBtn = $('#stop'), bpmEl = $('#bpm'), recEl = $('#record');
  const samplerGrid = $('#samplerGrid'), synthGrid = $('#synthGrid');

  // Audio Context
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  let isPlaying = false, currentStep = 0, nextNoteTime = 0, startTime = 0;
  let timerId = 0; const lookahead = 0.05; // 50ms
  const sampleSteps = new Array(steps).fill(false);
  const synthSteps  = new Array(steps).fill(null);
  let sampleBuf = null;
  let bpm = +bpmEl.value;

  const midiToHz = n => 440 * Math.pow(2, (n - 69) / 12);

  // Built-in headless synth demo
  function demoSynth(context) {
    return {
      noteOn(note, time, dur=0.2, vel=1.0) {
        const osc = context.createOscillator();
        const gain = context.createGain();
        const filt = context.createBiquadFilter();
        filt.type = 'lowpass'; filt.frequency.setValueAtTime(Math.min(12000, midiToHz(note)*3), time);
        const freq = midiToHz(note);
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(freq, time);
        gain.gain.setValueAtTime(0, time);
        const a=.005,d=.06,s=.2,r=.12, peak = Math.max(0.05, vel);
        gain.gain.linearRampToValueAtTime(peak, time + a);
        gain.gain.linearRampToValueAtTime(s*peak, time + a + d);
        gain.gain.setValueAtTime(s*peak, time + Math.max(dur, a+d));
        gain.gain.linearRampToValueAtTime(0, time + Math.max(dur, a+d) + r);
        osc.connect(filt).connect(gain).connect(context.destination);
        osc.start(time);
        osc.stop(time + Math.max(dur, a+d) + r + 0.02);
      }
    }
  }
  let synth = demoSynth(ctx);

  // External synth loader
  $('#loadSynth').addEventListener('click', async () => {
    const url = $('#synthUrl').value.trim();
    if (!url) { synth = demoSynth(ctx); log('Using built‑in demo synth.'); return; }
    try {
      const mod = await import(url);
      const factory = mod.default || mod.createSynth || mod.synth || mod;
      const s = typeof factory === 'function' ? factory(ctx) : null;
      if (s && typeof s.noteOn === 'function') { synth = s; log('Loaded headless synth module.'); }
      else { synth = demoSynth(ctx); log('Module invalid. Using demo synth.'); }
    } catch (e) {
      synth = demoSynth(ctx);
      log('Failed to load synth module. Using demo synth.');
    }
  });

  // Sample loading
  $('#loadSample').addEventListener('click', async () => {
    await ctx.resume();
    const f = $('#sampleFile').files[0];
    const url = $('#sampleUrl').value.trim();
    try {
      let ab;
      if (f) ab = await f.arrayBuffer();
      else if (url) { const res = await fetch(url); ab = await res.arrayBuffer(); }
      else { log('Choose a file or paste a URL.'); return; }
      sampleBuf = await ctx.decodeAudioData(ab);
      log('Sample loaded.');
    } catch (e) { log('Could not load sample.'); }
  });

  // Grids
  const sampCells = [], synthCells = [];
  for (let i=0;i<steps;i++) {
    const c = document.createElement('div'); c.className='cell';
    c.addEventListener('click', ()=>{ sampleSteps[i] = !sampleSteps[i]; render(); });
    samplerGrid.appendChild(c); sampCells.push(c);
  }
  for (let i=0;i<steps;i++) {
    const c = document.createElement('div'); c.className='cell';
    c.addEventListener('click', ()=>{ if (synthSteps[i]!==null){ synthSteps[i]=null; render(); }});
    synthGrid.appendChild(c); synthCells.push(c);
  }
  const bm = document.querySelector('.barMarks');
  for (let i=0;i<steps;i++){ bm.appendChild(document.createElement('div')); }

  function stepDur() { return 60 / bpm / 4; }
  function schedule(step, time) {
    if (sampleSteps[step] && sampleBuf) { const src = ctx.createBufferSource(); src.buffer = sampleBuf; src.connect(ctx.destination); src.start(time); }
    const note = synthSteps[step];
    if (note !== null) synth.noteOn(note, time, stepDur()*0.95, 0.9);
  }
  function scheduler(){
    const ahead = ctx.currentTime + lookahead;
    while (nextNoteTime < ahead) {
      schedule(currentStep, nextNoteTime);
      nextNoteTime += stepDur();
      currentStep = (currentStep + 1) % steps;
    }
  }
  function animate(){
    if (!isPlaying) return;
    const ph = (currentStep + steps - 1) % steps;
    sampCells.forEach((c,i)=> c.classList.toggle('playhead', i===ph));
    synthCells.forEach((c,i)=> c.classList.toggle('playhead', i===ph));
    requestAnimationFrame(animate);
  }
  function render(){
    sampCells.forEach((c,i)=> c.classList.toggle('on', !!sampleSteps[i]));
    synthCells.forEach((c,i)=> c.classList.toggle('note', synthSteps[i]!==null));
  }
  function start(){
    if (isPlaying) return;
    ctx.resume();
    isPlaying = true; currentStep = 0; startTime = ctx.currentTime; nextNoteTime = startTime + 0.06;
    timerId = setInterval(scheduler, 25);
    animate();
    log('Playing.');
  }
  function stop(){
    if (!isPlaying) return;
    isPlaying = false; clearInterval(timerId);
    sampCells.forEach(c=>c.classList.remove('playhead'));
    synthCells.forEach(c=>c.classList.remove('playhead'));
    log('Stopped.');
  }

  playBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
  bpmEl.addEventListener('change', e=>{ bpm = Math.max(40, Math.min(240, +e.target.value||120)); });

  // MIDI support
  async function initMIDI(){
    if (!('requestMIDIAccess' in navigator)) return;
    try {
      const access = await navigator.requestMIDIAccess();
      function handleInput(input){ input.onmidimessage = ev => {
        const [st,d1,d2] = ev.data; const cmd = st & 0xf0;
        if (cmd === 0x90 && d2>0) triggerNote(d1,d2/127);
      }}
      access.inputs.forEach(handleInput);
      access.onstatechange = e => { if (e.port.type==='input' && e.port.state==='connected') handleInput(e.port); };
    } catch(e) {}
  }
  initMIDI();

  // Virtual keyboard
  const keys = [60,62,64,65,67,69,71,72]; // C major scale
  const kb = $('#keyboard');
  keys.forEach(note => {
    const k = document.createElement('div');
    k.className='key';
    k.textContent = note;
    k.addEventListener('mousedown', ()=>{ k.classList.add('active'); triggerNote(note,1); });
    k.addEventListener('mouseup', ()=>k.classList.remove('active'));
    k.addEventListener('mouseleave', ()=>k.classList.remove('active'));
    kb.appendChild(k);
  });

  function triggerNote(note, vel){
    const t = ctx.currentTime;
    synth.noteOn(note, t, 0.25, vel);
    if (recEl.checked && isPlaying) {
      const idx = (currentStep + steps - 1) % steps;
      synthSteps[idx] = note; render();
    }
  }

  window.addEventListener('keydown', (e)=>{ if (e.code==='Space'){ e.preventDefault(); isPlaying?stop():start(); }});
  render();
})();
</script>
</body>
</html>
