// playbackEngine.js
(()=>{const e=window.globalData||(window.globalData={isPlaying:!1,currentSongIndex:0,songsArray:[],audioBuffers:{},reverseAudioBuffers:{},audioContext:new(window.AudioContext||window.webkitAudioContext),masterGain:null,gainNodes:{},isArtworkCover:!0,isVisualiserCover:!1}),{audioContext:n}=e,t=.1,o=25;let a=null,r={};const s=new Set,i=new Set;function c(){const{songsArray:i,currentSongIndex:l}=e;if(!i.length)return console.error("No songs available for playback.");const p=i[l%i.length],y=p.projectSequences||{},f=60/p.bpm/4,m=64*f;e.currentSongIndex%=i.length,r={},s.clear(),console.log(`Starting playback for Song: ${p.id} (${e.currentSongIndex+1}/${i.length}) with ${Object.keys(y).length} sequences.`),console.log(`Song BPM: ${p.bpm}`);let b=0;for(const[e,t]of Object.entries(y))r[e]={nextStepIndex:0,nextStepTime:n.currentTime+b,stepDuration:f,endTime:n.currentTime+b+m,completed:!1},b+=m;e.currentSongId=p.id,GainNodeHelper.createGainNodesForSong(p),GainNodeHelper.prepareNextSong(i[(e.currentSongIndex+1)%i.length]),e.isPlaying=!0,a=setInterval((()=>function(o){const a=n.currentTime;let s=!0;for(const[n,i]of Object.entries(o.projectSequences||{})){const c=r[n];if(c&&!c.completed)if(a>=c.endTime)c.completed=!0,console.log(`Sequence ${n} has completed.`);else for(s=!1;c.nextStepTime<a+t&&e.isPlaying;){const{nextStepIndex:e,nextStepTime:t,stepDuration:a}=c;for(const[n,a]of Object.entries(i)){const r=parseInt(n.slice(2),10),s=o.channels[r];if(!s){console.warn(`Channel index ${r} not found in song ${o.id}.`);continue}const i=a.steps?.find((n=>"number"==typeof n?n===e:n.index===e));if(void 0!==i){const e="object"==typeof i&&i.reverse;u(o,s,t,e)}}if(c.nextStepIndex++,c.nextStepIndex>=64){c.completed=!0,console.log(`Sequence ${n} has completed all steps.`);break}c.nextStepTime+=a}}s&&(console.log("All sequences have completed."),function(){if(!e.isPlaying)return;e.currentSongIndex=(e.currentSongIndex+1)%e.songsArray.length,setTimeout((()=>{e.isPlaying&&d({preserveIsPlaying:!0,callback:c})}),200)}())}(p)),o),console.log("Sequences scheduled and playback started."),document.dispatchEvent(new CustomEvent("playbackStarted",{detail:{success:!0}})),g(p)}function l(){if(!e.isPlaying)return console.log("Playback is not in progress.");d(),console.log("Playback stopped."),document.dispatchEvent(new CustomEvent("playbackStopped",{detail:{success:!0}})),p()}function d(n={}){clearInterval(a),n.preserveIsPlaying||(e.isPlaying=!1),r={},s.clear(),i.forEach((e=>{try{e.stop(),e.disconnect()}catch(e){console.error("Error stopping/disconnecting an audio source:",e)}})),i.clear(),e.currentSongId&&(GainNodeHelper.cleanupGainNodesForSong(e.currentSongId),e.currentSongId=null),n.callback&&n.callback()}e.masterGain||(e.masterGain=n.createGain(),e.masterGain.connect(n.destination)),e.togglePlayback=()=>e.isPlaying?l():c(),e.startPlayback=c,e.stopPlayback=l,e.resetPlayback=()=>d({callback:c});const u=(t,o,a,r)=>{const c=`${t.id}_${o.id}_${r?"reverse":"normal"}`,l=r?e.reverseAudioBuffers[t.id]?.[o.id]:e.audioBuffers[t.id]?.[o.id];if(!l)return void(s.has(c)||(s.add(c),console.warn(`Audio buffer missing for Song: ${t.id}, Channel: ${o.id}${r?" (Reverse)":""}`)));const d=n.createBufferSource();d.buffer=l,d.playbackRate.value=o.metadata.playbackSpeed||1;const u=e.gainNodes?.[t.id]?.[o.id]||e.masterGain;d.connect(u),d.start(a),i.add(d),d.onended=()=>i.delete(d)};e.initializePlaybackEngine=()=>{if(!e.songsArray.length)return console.error("No songs available for playback.");console.log("Playback Engine Initialization Complete."),console.log("Playback is ready. Click the artwork to start.")};const g=e=>{const n=document.getElementById("nowPlayingContainer");if(!n)return console.warn("Now Playing Container not found.");const{projectName:t,artistName:o}=getProjectAndArtist(e);n.querySelector(".songTitle").textContent=t,n.querySelector(".artistName").textContent=o},p=()=>{const e=document.getElementById("nowPlayingContainer");if(!e)return console.warn("Now Playing Container not found.");e.querySelector(".songTitle").textContent="No song playing",e.querySelector(".artistName").textContent=""},y=()=>{document.addEventListener("DOMContentLoaded",(()=>{const n=document.getElementById("artworkCover"),t=document.getElementById("artworkImage"),o=document.getElementById("loadingSpinner");e.isArtworkCover&&artworkUrl.length?(t.src=artworkUrl[0],n.classList.remove("hidden"),o.style.display="none",t.addEventListener("click",e.togglePlayback),console.log("Artwork cover is set up for playback toggle.")):console.warn("Artwork cover is not enabled or no artwork URL provided.")}))};document.addEventListener("initialAudioBuffersReady",(n=>{n.detail.success&&(e.initializePlaybackEngine(),console.log("Initial audio buffers are ready."))})),["playbackStarted","playbackStopped"].forEach((e=>{document.addEventListener(e,(n=>{n.detail.success&&console.log(`Playback has been successfully ${"playbackStarted"===e?"started":"stopped"}.`)}))})),y(),Object.keys(e.audioBuffers).length&&e.initializePlaybackEngine()})();
