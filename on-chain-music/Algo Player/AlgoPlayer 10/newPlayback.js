// new playback.js 

!function(){const e=window.globalData||(window.globalData={}),t=e.audioContext;e.isPlaying=!1;let n,s={},o=0,i=new Set,a=[];const c=()=>e.isPlaying?d():r(),r=()=>{if(e.isPlaying)return;const{songsArray:a,audioBuffers:c,reverseAudioBuffers:r}=e;if(!a.length)return;o>=a.length&&(o=0);const d=a[o],u=d.projectSequences||{},p=15/d.bpm,m=64*p;s={},i.clear();let g=0;for(const e in u){const n=t.currentTime+g;s[e]={nextStepIndex:0,nextStepTime:n,stepDur:p,startTime:n,endTime:n+m,completed:!1},g+=m}e.isPlaying=!0,n=setInterval((()=>l(d,c,r)),25),document.dispatchEvent(new CustomEvent("playbackStarted",{detail:{success:!0}}))},d=()=>{e.isPlaying&&(clearInterval(n),e.isPlaying=!1,s={},i.clear(),a.forEach((e=>{e.stop(),e.disconnect()})),a=[],document.dispatchEvent(new CustomEvent("playbackStopped",{detail:{success:!0}})))};document.addEventListener("keydown",(t=>{const n=e.songsArray.length;"ArrowRight"===t.key?o=(o+1)%n:"ArrowLeft"===t.key&&(o=(o-1+n)%n),e.isPlaying&&(d(),r())}));const l=(n,o,i)=>{const a=t.currentTime;let c=!0;for(const t in n.projectSequences||{}){const r=s[t];if(r&&!r.completed)if(a>=r.endTime)r.completed=!0;else for(c=!1;r.nextStepTime<a+.1&&e.isPlaying;){const e=r.nextStepIndex;for(const s in n.projectSequences[t]){const a=parseInt(s.replace("ch",""),10),c=n.channels[a];if(!c)continue;const d=(n.projectSequences[t][s].steps||[]).find((t=>t===e||t.index===e));if(void 0!==d){const e="object"==typeof d&&d.reverse;u(n,c,r.nextStepTime,e,o,i)}}if(r.nextStepIndex++,r.nextStepIndex>=64){r.completed=!0;break}r.nextStepTime+=r.stepDur}}c&&p(n)},u=(n,s,o,c,r,d)=>{const l=c?d[n.id]?.[s.id]:r[n.id]?.[s.id];if(!l){const e=`${n.id}_${s.id}_${c?"reverse":"normal"}`;return void(i.has(e)||i.add(e))}const u=t.createBufferSource();u.buffer=l,u.playbackRate.value=s.metadata.playbackSpeed||1,u.connect(e.masterGain||t.destination),u.start(o),a.push(u)},p=t=>{const n=e.songsArray.length;e.isLoopedPlayback?e.isMultipleSongs&&e.isSequentialPlayback?(o=(o+1)%n,r()):r():e.isMultipleSongs&&e.isSequentialPlayback?(o++,o<n?r():d()):d()},m=()=>{e.songsArray.length&&console.log("Playback Engine Initialized.")};document.addEventListener("initialAudioBuffersReady",(e=>{e.detail.success&&m()})),document.addEventListener("DOMContentLoaded",(()=>{const t=document.getElementById("artworkImage");e.isArtworkCover&&artworkUrl.length&&(t.src=artworkUrl[0],document.getElementById("artworkCover").classList.remove("hidden"),document.getElementById("loadingSpinner").style.display="none",t.addEventListener("click",c))})),Object.keys(e.audioBuffers||{}).length&&m()}();
