// main.js
(async()=>{function e(e,f,g,y,S,b,w){[{name:"pitchShift",applyFn:(e,t)=>a(e,t,w)},{name:"harmonize",applyFn:(e,t)=>n(e,f,g,t,b,w)},{name:"delay",applyFn:(e,t)=>r(e,t,S)},{name:"reverse",applyFn:(e,t)=>o(e)},{name:"filter",applyFn:(e,t)=>i(e,t,w)},{name:"tremolo",applyFn:(e,t)=>d(e,t,w)},{name:"distortion",applyFn:(e,t)=>m(e,t,w)},{name:"bitcrusher",applyFn:(e,t)=>u(e,t,w)},{name:"pan",applyFn:(e,t)=>c(e,t,w)},{name:"reverb",applyFn:(e,t)=>l(e,t,w)},{name:"volumeChange",applyFn:(e,t)=>s(e,t,w)},{name:"chorus",applyFn:(e,a)=>t(e,a,w)},{name:"leslie",applyFn:(e,t)=>p(e,t,S)},{name:"delayBpmLinked",applyFn:(e,t)=>h(e,t,S)}].forEach((t=>{const a=window.EffectsModule.getEffectParams(t.name,y,S,w);a&&t.applyFn(e,a)}));e.metadata.requiresReversal,e.metadata.playbackSpeed;if(b.totalGain>b.maxTotalGain){const t=b.maxTotalGain/b.totalGain;e.metadata.volume=(e.metadata.volume||1)*t}b.totalGain+=e.metadata.volume||1}await new Promise((e=>{window.EffectsModule&&window.EffectsModule.effectsConfig?e():document.addEventListener("effectsLoaded",e,{once:!0})}));const t=(e,{rate:t,depth:a,feedback:n,mix:r},o)=>{e.metadata.chorus={rate:t,depth:a,feedback:n,mix:r}},a=(e,{shifts:t},a)=>{const n=t[Math.floor(a()*t.length)];e.metadata.playbackSpeed*=n},n=(e,t,a,{intervals:n,maxHarmonyChannels:r},o,s)=>{o.harmonyChannelsAdded>=r||n.forEach((n=>{if(o.harmonyChannelsAdded>=r)return;const s=JSON.parse(JSON.stringify(e));s.id=`${e.id}_harmony_${t}_${n}`,s.metadata.playbackSpeed*=n,s.metadata.volume=.8*(s.metadata.volume||1),a.channels.push(s),o.harmonyChannelsAdded++}))},r=(e,{noteValue:t,maxDelayRepeats:a},n)=>{const r=6e4/n,o={quarter:r,eighth:r/2,sixteenth:r/4};e.metadata.delay={time:o[t]||r,repeats:a}},o=e=>{e.metadata.requiresReversal=!0},s=(e,{range:t},a)=>{const[n,r]=t;e.metadata.volume=(e.metadata.volume||1)*(a()*(r-n)+n)},c=(e,{positions:t},a)=>{e.metadata.pan=t[Math.floor(a()*t.length)]},l=(e,{decayTimeRange:t,mixRange:a},n)=>{e.metadata.reverb={decayTime:n()*(t[1]-t[0])+t[0],mix:n()*(a[1]-a[0])+a[0]}},i=(e,{types:t,frequencyRange:a,QRange:n},r)=>{e.metadata.filter={type:t[Math.floor(r()*t.length)],frequency:r()*(a[1]-a[0])+a[0],Q:r()*(n[1]-n[0])+n[0]}},d=(e,{rateRange:t,depthRange:a},n)=>{e.metadata.tremolo={rate:n()*(t[1]-t[0])+t[0],depth:n()*(a[1]-a[0])+a[0]}},m=(e,{amountRange:t},a)=>{e.metadata.distortion={amount:a()*(t[1]-t[0])+t[0]}},u=(e,{bitDepthRange:t,sampleRateRange:a},n)=>{e.metadata.bitcrusher={bitDepth:Math.floor(n()*(t[1]-t[0]+1))+t[0],sampleRate:n()*(a[1]-a[0])+a[0]}},p=(e,{rotationSpeed:t,depth:a,mix:n},r)=>{e.metadata.leslie={rotationSpeed:t,depth:a,mix:n}},h=(e,{time:t,feedback:a,mix:n},r)=>{e.metadata.delayBpmLinked={time:t,feedback:a,mix:n}},f=new Set(["7c42769c1763cc8f045aada7914e8158223e45e7a4f197b49f918b1c005d36fci0","3364803cb3032ce95f4138a214c15a9b36dcb70f574a477f27615d448e1cdeb8i0"]),g=["projectName","artistName","projectBPM","currentSequence","channelURLs","channelVolume","channelPlaybackSpeed","trimSettings","projectChannelNames","startSliderValue","endSliderValue","totalSampleDuration","start","end","projectSequences","steps"],y=g.reduce(((e,t,a)=>(e[t]=a,e)),{}),S=Array.from({length:16},((e,t)=>String.fromCharCode(65+t))),b=S.reduce(((e,t,a)=>(e[t]=a,e)),{}),w=({projectSequences:e})=>{const t=new Set,a=[];return Object.keys(e).sort(((e,t)=>+e.slice(9)-+t.slice(9))).forEach((n=>{Object.entries(e[n]).forEach((([e,{steps:n}])=>{n.forEach((n=>{if("number"==typeof n||void 0!==n?.index){const r=`${e}_${n.reverse?"r":"f"}`;t.has(r)||(t.add(r),a.push({channelId:e,reverse:n.reverse||!1}))}}))}))})),a},q=(e,t)=>{const a=[],n=[];for(let e=2;e<=t;e+=2)n.push(e);return n.forEach((t=>{const n=e()<.5?"mute":"unmute",r=Math.floor(4*e())+1;a.push({sequence:t,action:n,numChannels:r})})),a},x=songDataUrls.filter((e=>e.trim()&&!e.trim().startsWith("//")));if(x.length){window.pako||await async function(){try{const e=await fetch("/content/2109694f44c973892fb8152cf5c68607fb19288c045af1abc1716c1c3b4d69e6i0"),t=await e.text(),a=(new DOMParser).parseFromString(t,"text/html").querySelector("script");if(!a||!a.textContent.includes("pako"))throw new Error("Pako library not found.");document.head.append(Object.assign(document.createElement("script"),{textContent:a.textContent}))}catch(e){console.error("[Initialization] Error loading Pako:",e)}}();const E=(await Promise.all(x.map((async(e,t)=>{try{const a=await(async e=>{try{const t=await fetch(e);if(!t.ok)throw new Error(`Network error for ${e}`);const a=new Uint8Array(await t.arrayBuffer()),n=window.pako.inflate(a),r=new TextDecoder("utf-8").decode(n);return(e=>{const t=e=>Array.isArray(e)?e.map(t):e&&"object"==typeof e?Object.entries(e).reduce(((e,[a,n])=>{const r=g[a]||a;return e[r]="projectSequences"===r?Object.fromEntries(Object.entries(n).map((([e,t])=>[`Sequence${e.replace(/^s/,"")}`,Object.fromEntries(Object.entries(t).map((([e,t])=>{const a=(t[y.steps]||[]).flatMap((e=>{if("number"==typeof e)return e;if(e?.r){const[t,a]=e.r;return Array.from({length:a-t+1},((e,a)=>t+a))}return"string"==typeof e&&e.endsWith("r")?{index:parseInt(e.slice(0,-1),10),reverse:!0}:[]}));return[`ch${b[e]}`,{steps:a}]})))]))):t(n),e}),{}):e;return t(e)})(JSON.parse(r))}catch(t){throw console.error(`[Initialization] Error fetching/deserializing ${e}:`,t),t}})(e);return{data:a,index:t}}catch(t){return console.error(`[Initialization] Failed ${e}:`,t),null}}))).then((e=>{const t=e.filter(Boolean);if(!t.length)throw new Error("[Initialization] No valid data.");return t}))).sort(((e,t)=>e.index-t.index)).map((({data:e,index:t})=>{const{projectName:a="The Infinite Ordinal",artistName:n="melophonic",projectBPM:r=120,projectSequences:o={},channelURLs:s=[],channelVolume:c=[],channelPlaybackSpeed:l=[],trimSettings:i={}}=e,d=S.map(((e,t)=>{const a=Object.entries(o).reduce(((e,[a,n])=>{const r=n[`ch${t}`];return r&&e.push({sequenceName:a,steps:r.steps}),e}),[]),n={volume:c[t]??1,playbackSpeed:l[t]??1,trimStartTime_Percentage:i[t]?.start||0,trimEndTime_Percentage:i[t]?.end||100,requiresReversal:a.some((e=>e.steps.some((e=>"object"==typeof e&&e.reverse)))),channelSequence:a,originalBPM:r},d=s[t];return f.has(d)&&(n.isLoop=!0),{id:e,url:d||"URL_not_found",metadata:n}}));return{id:`Song ${t+1}: ${a}`,artist:n,bpm:r,totalSequences:Object.keys(o).length,totalChannels:d.length,channels:d,projectSequences:o}})).flatMap((e=>e.channels));function v(e){let t=e;const a=6364136223846793005n,n=1442695040888963407n,r=18446744073709551616n;return function(){return t=(a*t+n)%r,Number(t)/Number(r)}}const j=(e,t,a)=>{const n=[...e];for(let e=n.length-1;e>0;e--){const t=Math.floor(a()*(e+1));[n[e],n[t]]=[n[t],n[e]]}return n.slice(0,t)},k=(e,t,a)=>{const n=[...e.filter((e=>!e.isMuted))];for(let e=n.length-1;e>0;e--){const t=Math.floor(a()*(e+1));[n[e],n[t]]=[n[t],n[e]]}return n.slice(0,t).map((e=>e.id))},C=(e,t,a)=>{const n=[...e.filter((e=>e.isMuted))];for(let e=n.length-1;e>0;e--){const t=Math.floor(a()*(e+1));[n[e],n[t]]=[n[t],n[e]]}return n.slice(0,t).map((e=>e.id))};async function M(t,a=100,n=null){const r=[60,120,140,160,180,240],o=[],s={};let c;try{c=BigInt(t)}catch(e){console.error(`[seedDebug] Invalid seed string: "${t}". Using base seed 0.`),c=0n}let l=c||1n;const i=e=>{const t=v(e);return r[Math.floor(t()*r.length)]},d=(e,t,a=1e6)=>{for(let n=e,r=0;r<a;r++,n+=1n)if(i(n)===t)return n;throw new Error(`[seedDebug] Could not find seed producing BPM ${t} within ${a} attempts.`)};for(let t=0;t<a;t++){if(null!==n)try{l=d(l,n)}catch(e){console.error(e.message);break}const a=v(l),r=null!==n?n:i(l),c=j(E,16,a),m=[{startSeq:1,count:16},{startSeq:5,count:4},{startSeq:17,count:4},{startSeq:25,count:4}].flatMap((({startSeq:e,count:t})=>Array.from({length:t},((t,a)=>{const n=c[a];return n?{channel:JSON.parse(JSON.stringify(n)),activationSeq:e}:null})).filter(Boolean)));let u=[...new Set(m.flatMap((({channel:e})=>e.metadata.channelSequence?.map((e=>e.sequenceName))||[])))].sort(((e,t)=>(parseInt(e.replace("Sequence",""))||0)-(parseInt(t.replace("Sequence",""))||0)));u=u.slice(0,28);const p={id:`The Infinite Ordinal Remix #${t+1}`,projectName:"The Infinite Ordinal",artist:"melophonic",bpm:r,totalSequences:u.length,totalChannels:m.length,channels:[],projectSequences:Object.fromEntries(u.map((e=>[e,{}]))),seed:l.toString(),muteSchedule:[]},h={harmonyChannelsAdded:0,maxHarmonyChannels:window.EffectsModule?.effectsConfig?.harmonize?.maxHarmonyChannels||2,totalGain:0,maxTotalGain:10},f=u.length,g=q(a,f);p.muteSchedule=g,await Promise.all(m.map((async({channel:t,activationSeq:n},r)=>{const o=`ch${r}`,s={id:o,url:t.url,metadata:{...t.metadata,originalBPM:p.bpm,activationSeq:n,isMuted:!1}};await e(s,r,p,n,p.bpm,h,a),p.channels.push(s),t.metadata.channelSequence?.forEach((e=>{p.projectSequences[e.sequenceName]&&(p.projectSequences[e.sequenceName]={...p.projectSequences[e.sequenceName],[o]:{steps:e.steps}})}))}))),g.forEach((e=>{const{sequence:t,action:n,numChannels:r}=e;if("mute"===n){const t=k(p.channels,r,a);e.channels=t,t.forEach((e=>{const t=p.channels.find((t=>t.id===e));t&&(t.metadata.isMuted=!0)}))}else if("unmute"===n){const t=C(p.channels,r,a);e.channels=t,t.forEach((e=>{const t=p.channels.find((t=>t.id===e));t&&(t.metadata.isMuted=!1)}))}})),console.log(`[seedDebug] Generated Song with Seed: ${l} | BPM: ${r}`),o.push(p),s[r]||(s[r]=[]),s[r].push(p),l+=1n}return console.log(`[seedDebug] Generated ${o.length} song mixes.`),console.log("[seedDebug] Songs by BPM:",s),globalData.songsByBPM=s,o}const O=await M(window.seed);void 0===globalData.initialized&&Object.assign(globalData,{songsArray:O,currentSongIndex:0,currentSequenceIndex:0,initialSampleOrder:O.length?w(O[0]):null,isSingleSong:1===O.length,isMultipleSongs:O.length>1,initialized:!0}),globalData.isArtworkCover&&artworkUrl.length&&(e=>{const t=document.getElementById("artworkImage");t&&(t.src=e,t.parentElement.style.display="flex")})(artworkUrl[0]),document.dispatchEvent(new CustomEvent("dataLoadingComplete",{detail:{success:!0,totalSongs:globalData.songsArray.length,songs:globalData.songsArray.map((({id:e,totalSequences:t})=>({id:e,totalSequences:t})))}})),window.generateMixesBySeed=M}else console.log("[Initialization] No valid song data URLs to process.")})();
