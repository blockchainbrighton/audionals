<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Audionals ToneJS (v14.7.40) Bridge</title>
    <style>
        /* Hide the body as this is a bridging module */
        body { display: none; }

        /* Styles for the header */
        #header {
            display: none; /* Hidden initially */
            padding: 20px;
            background-color: #282c34;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            font-size: 24px;
        }

        /* Styles for the instructions */
        #instructions {
            display: none; /* Hidden by default */
            padding: 20px;
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #instructions.visible {
            display: block; /* Show when the 'visible' class is added */
        }

        pre {
            background-color: #f4f4f4;
            padding: 10px;
            overflow-x: auto;
        }

        code {
            background-color: #f4f4f4;
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* Styles for displaying messages */
        #message {
            padding: 10px;
            margin: 20px;
            font-family: Arial, sans-serif;
            border-radius: 4px;
            text-align: center;
        }

        #message.success {
            background-color: #d4edda;
            color: #155724;
        }

        #message.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Styles for the Demo Apps */
        #demoAppContainer, #additionalDemoContainer {
            display: none; /* Hidden initially */
            padding: 20px;
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        #demoButton, #additionalDemoButton {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            transition: background-color 0.3s;
        }

        #demoButton:hover, #additionalDemoButton:hover {
            background-color: #0056b3;
        }

        #playNoteButton, #playChordButton, #startSequencerButton, #stopSequencerButton {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #28a745;
            color: white;
            transition: background-color 0.3s;
            margin: 5px;
        }

        #playNoteButton:hover, #playChordButton:hover, #startSequencerButton:hover, #stopSequencerButton:hover {
            background-color: #1e7e34;
        }

        /* Additional styles for better visibility */
        #demoAppHeader, #additionalDemoHeader {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
        }

        #demoStatus, #additionalDemoStatus {
            margin-top: 15px;
            font-size: 14px;
            color: #555;
        }

        /* Styles for Synth Controls */
        .control-group {
            margin: 10px 0;
            text-align: left;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .control-group input, .control-group select {
            width: 100%;
            padding: 5px;
            font-size: 14px;
        }

        /* Styles for Visualization Canvas */
        #visualization {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Styles for Virtual Keyboard */
        #virtualKeyboard {
            margin-top: 20px;
        }

        .key {
            display: inline-block;
            width: 40px;
            height: 150px;
            margin: 1px;
            background: white;
            border: 1px solid #000;
            border-radius: 0 0 5px 5px;
            position: relative;
            cursor: pointer;
            box-sizing: border-box;
        }

        .key.black {
            width: 30px;
            height: 100px;
            background: black;
            position: absolute;
            top: 0;
            left: 28px;
            z-index: 1;
            color: white;
            border: 1px solid #000;
            border-radius: 0 0 3px 3px;
        }

        .key.active {
            background-color: #f1c40f;
        }
    </style>
</head>
<body>
    <!-- Header Display -->
    <div id="header">
        Audionals and the OB1s present Tone.js
    </div>

    <!-- ToneJS Bridge Module Inclusion -->
    <script>
        /**
         * ToneJS Bridge Module
         * 
         * Fetches the ToneJS library from an external HTML file, decodes and decompresses
         * the embedded Base64-encoded GZIP data, and injects the library into the document.
         */
        const ToneJSBridge = (() => {
            let isLoaded = false;
            let loadPromise = null;

            /**
             * Fetches the external HTML file containing the Base64-encoded GZIP ToneJS library.
             * @param {string} url - The URL of the external HTML file.
             * @returns {Promise<string>} - The Base64-encoded GZIP data.
             */
            async function fetchExternalLibrary(url) {
                console.log(`Fetching external library from: ${url}`);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch external library: ${response.status} ${response.statusText}`);
                }
                const htmlText = await response.text();

                // Parse the fetched HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, "text/html");

                // Extract the <textarea id="base64Input"> content
                const textarea = doc.querySelector("#base64Input");
                if (!textarea) {
                    throw new Error("No <textarea id='base64Input'> found in the external HTML.");
                }

                let base64EncodedGzip = textarea.value.trim();
                console.log(`Raw Base64 data extracted: ${base64EncodedGzip.substring(0, 50)}...`);

                // Remove whitespace and data URI prefix if present
                base64EncodedGzip = base64EncodedGzip.replace(/\s/g, "").replace(/^data:application\/octet-stream;base64,/, "");

                if (!base64EncodedGzip) {
                    throw new Error("Base64 encoded content is empty.");
                }

                console.log("Base64 data sanitized successfully.");
                return base64EncodedGzip;
            }

            /**
             * Decompresses the Base64-encoded GZIP data and returns the decompressed text.
             * @param {string} base64EncodedGzip - The Base64-encoded GZIP string.
             * @returns {Promise<string>} - The decompressed ToneJS library as text.
             */
            async function decompressLibrary(base64EncodedGzip) {
                console.log("Starting decompression of the library.");
                // Decode Base64 to binary string
                let binaryString;
                try {
                    binaryString = atob(base64EncodedGzip);
                } catch (error) {
                    console.error("Base64 decoding failed:", error);
                    throw new Error("Base64 decoding failed. Ensure the data is correctly encoded.");
                }

                // Convert binary string to Uint8Array
                const uintArray = Uint8Array.from(binaryString, char => char.charCodeAt(0));

                // Decompress the GZIP data
                const decompressedText = await decompressData(uintArray);
                console.log("Decompression successful.");
                return decompressedText;
            }

            /**
             * Decompresses GZIP data using the DecompressionStream API or pako as a fallback.
             * @param {Uint8Array} data - The GZIP-compressed data.
             * @returns {Promise<string>} - The decompressed text.
             */
            async function decompressData(data) {
                if ("DecompressionStream" in window) {
                    try {
                        console.log("Using DecompressionStream for decompression.");
                        const ds = new DecompressionStream("gzip");
                        const decompressedStream = new Response(data).body.pipeThrough(ds);
                        const blob = await new Response(decompressedStream).blob();
                        const text = await blob.text();
                        return text;
                    } catch (error) {
                        console.error("DecompressionStream failed:", error);
                        throw new Error("DecompressionStream failed. Ensure the data is valid GZIP format.");
                    }
                } else {
                    // Fallback to pako (ensure pako is loaded if you uncomment the pako script)
                    if (typeof pako === "undefined") {
                        throw new Error("DecompressionStream is not supported and pako is not loaded.");
                    }
                    try {
                        console.log("Using pako for decompression.");
                        const decompressed = pako.ungzip(data, { to: "string" });
                        return decompressed;
                    } catch (error) {
                        console.error("pako decompression failed:", error);
                        throw new Error("pako decompression failed. Ensure the data is valid GZIP format.");
                    }
                }
            }

            /**
             * Injects the decompressed ToneJS library into the document.
             * @param {string} libraryText - The decompressed ToneJS library as text.
             */
            function injectLibrary(libraryText) {
                console.log("Injecting ToneJS library into the document.");
                const script = document.createElement("script");
                script.textContent = libraryText;
                document.body.appendChild(script);
                console.log("ToneJS library injected successfully.");
            }

            /**
             * Loads the ToneJS library from the specified external HTML file.
             * @param {string} externalHtmlUrl - The URL of the external HTML file containing the library.
             * @returns {Promise<void>}
             */
            async function load(externalHtmlUrl) {
                if (isLoaded) {
                    console.log("ToneJS is already loaded.");
                    return Promise.resolve();
                }
                if (loadPromise) {
                    return loadPromise;
                }

                loadPromise = (async () => {
                    try {
                        console.log("Loading ToneJS library...");
                        const base64Gzip = await fetchExternalLibrary(externalHtmlUrl);
                        const libraryText = await decompressLibrary(base64Gzip);
                        injectLibrary(libraryText);
                        isLoaded = true;
                        console.log("ToneJS library loaded successfully.");
                        // Dispatch a custom event to signal that ToneJS is loaded
                        document.dispatchEvent(new Event("tonejsLoaded"));
                    } catch (error) {
                        console.error("Error loading ToneJS library:", error);
                        // Dispatch an event for error handling
                        document.dispatchEvent(new CustomEvent("tonejsLoadError", { detail: error }));
                        throw error;
                    }
                })();

                return loadPromise;
            }

            return {
                load
            };
        })();
    </script>

    <!-- Instructions Display -->
    <div id="instructions">
        <h2>How to Use the OB1 ToneJS Bridge for Web3 / On-Chain Music Production</h2>
        <p>This bridge allows you to load the ToneJS library from an on-chain inscribed HTML file. Follow the steps below to integrate ToneJS into your own web3 project:</p>
        <ol>
            <li><strong>Include the Bridge Script:</strong> Add the bridge script to your HTML file.</li>
            <li><strong>Initialize the Bridge:</strong> Call the <code>ToneJSBridge.load()</code> method with the URL of this inscribed HTML file.</li>
            <li><strong>Use ToneJS:</strong> Once loaded, you can utilize ToneJS as usual in your scripts.</li>
            <li><strong> Eternal / Immutable Thanks to: The Ordinal Based 1 Team, for inscribing the Tone.js library, as well as Audionals and jim.btc for building this bridge to make it accessible for everyone.</strong></li>
        </ol>
        <h3>Example Integration:</h3>
        <pre>
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
<head>
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;My Web3 App with ToneJS&lt;/title&gt;
    &lt;style&gt;
        body { font-family: Arial, sans-serif; margin: 20px; }
        #playButton { padding: 10px 20px; font-size: 16px; }
        #status { margin-top: 20px; }
    &lt;/style&gt;
</head>
<body&gt;

    &lt;button id="playButton"&gt;Play a Note&lt;/button&gt;
    &lt;div id="status"&gt;Status: Loading ToneJS...&lt;/div&gt;

    &lt;!-- Include the ToneJS Bridge Script --&gt;
    &lt;script src="path/to/tonejs-bridge.html"&gt;&lt;/script&gt;
    &lt;!-- Replace "path/to/" with the actual path to your bridge HTML file --&gt;

    &lt;script&gt;
        /**
         * Updates the status message on the page.
         * @param {string} message - The status message to display.
         * @param {string} type - The type of message ('loading', 'success', 'error').
         */
        function updateStatus(message, type) {
            const statusDiv = document.getElementById("status");
            statusDiv.textContent = "Status: " + message;
            statusDiv.className = type;
        }

        /**
         * Sets up event listeners and handles user interactions.
         */
        function setupSampleUsage() {
            const playButton = document.getElementById("playButton");
            const status = document.getElementById("status");

            playButton.addEventListener("click", async () => {
                if (typeof Tone === "undefined") {
                    updateStatus("ToneJS is not loaded.", "error");
                    console.error("ToneJS is not loaded.");
                    return;
                }

                try {
                    updateStatus("Playing note...", "loading");
                    // Create a synth and connect it to the main output (your speakers)
                    const synth = new Tone.Synth().toDestination();

                    // Play a middle 'C' for the duration of an 8th note
                    synth.triggerAttackRelease("C4", "8n");
                    updateStatus("Note played successfully!", "success");
                } catch (error) {
                    updateStatus("Error playing note.", "error");
                    console.error("Error playing note:", error);
                }
            });

            // Listen for the custom event indicating that ToneJS has been loaded
            document.addEventListener("tonejsLoaded", () => {
                updateStatus("ToneJS loaded. Ready to play!", "success");
                console.log("ToneJS has been loaded and is ready to use.");

                // Update the version number in the header
                if (typeof Tone !== "undefined" && Tone.version) {
                    document.getElementById("header").textContent = "ToneJS Bridge - Version " + Tone.version;
                } else {
                    document.getElementById("header").textContent = "ToneJS Bridge - Version Unknown";
                }
            });

            document.addEventListener("tonejsLoadError", (event) => {
                updateStatus("Failed to load ToneJS.", "error");
                console.error("ToneJS Load Error:", event.detail);
            });
        }

        // Initialize the sample usage once the DOM is fully loaded
        document.addEventListener("DOMContentLoaded", setupSampleUsage);
    &lt;/script&gt;
</pre>
    </div>

    <!-- Message Display -->
    <div id="message"></div>

    <!-- Existing Demo Application Section -->
    <div id="demoAppContainer">
        <div id="demoAppHeader">ðŸŽµ Simple ToneJS Demo App ðŸŽµ</div>
        <button id="playNoteButton">Play Middle C</button>
        <div id="demoStatus">Status: Ready to play.</div>
    </div>

    <!-- New Additional Demo Application Section -->
    <div id="additionalDemoContainer">
        <div id="additionalDemoHeader">ðŸŽ¶ Advanced ToneJS Demo App ðŸŽ¶</div>

        <!-- Synth Controls -->
        <div class="control-group">
            <label for="oscillatorType">Oscillator Type:</label>
            <select id="oscillatorType">
                <option value="sine">Sine</option>
                <option value="square">Square</option>
                <option value="triangle">Triangle</option>
                <option value="sawtooth">Sawtooth</option>
                <option value="fmsine">FM Sine</option>
            </select>
        </div>

        <div class="control-group">
            <label for="envelopeAttack">Envelope Attack:</label>
            <input type="range" id="envelopeAttack" min="0" max="1" step="0.01" value="0.1">
            <span id="envelopeAttackValue">0.1</span>
        </div>

        <div class="control-group">
            <label for="envelopeDecay">Envelope Decay:</label>
            <input type="range" id="envelopeDecay" min="0" max="1" step="0.01" value="0.1">
            <span id="envelopeDecayValue">0.1</span>
        </div>

        <div class="control-group">
            <label for="envelopeSustain">Envelope Sustain:</label>
            <input type="range" id="envelopeSustain" min="0" max="1" step="0.01" value="0.5">
            <span id="envelopeSustainValue">0.5</span>
        </div>

        <div class="control-group">
            <label for="envelopeRelease">Envelope Release:</label>
            <input type="range" id="envelopeRelease" min="0" max="1" step="0.01" value="0.5">
            <span id="envelopeReleaseValue">0.5</span>
        </div>

        <!-- Effects Controls -->
        <div class="control-group">
            <label for="reverb">Reverb:</label>
            <input type="range" id="reverb" min="0" max="1" step="0.01" value="0.3">
            <span id="reverbValue">0.3</span>
        </div>

        <div class="control-group">
            <label for="delay">Delay:</label>
            <input type="range" id="delay" min="0" max="1" step="0.01" value="0.3">
            <span id="delayValue">0.3</span>
        </div>

        <!-- Sequencer Controls -->
        <div>
            <button id="startSequencerButton">Start Sequencer</button>
            <button id="stopSequencerButton">Stop Sequencer</button>
        </div>

        <!-- Visualization Canvas -->
        <canvas id="visualization" width="600" height="200"></canvas>

        <!-- Virtual Keyboard -->
        <div id="virtualKeyboard">
            <div class="key" data-note="C4">C</div>
            <div class="key black" data-note="C#4">C#</div>
            <div class="key" data-note="D4">D</div>
            <div class="key black" data-note="D#4">D#</div>
            <div class="key" data-note="E4">E</div>
            <div class="key" data-note="F4">F</div>
            <div class="key black" data-note="F#4">F#</div>
            <div class="key" data-note="G4">G</div>
            <div class="key black" data-note="G#4">G#</div>
            <div class="key" data-note="A4">A</div>
            <div class="key black" data-note="A#4">A#</div>
            <div class="key" data-note="B4">B</div>
            <div class="key" data-note="C5">C</div>
        </div>

        <!-- Demo Controls and Status -->
        <button id="playChordButton">Play C Major Chord</button>
        <div id="additionalDemoStatus">Status: Ready to play chord.</div>
    </div>

    <!-- Invocation of the Bridge Module -->
<script>
    // ======= Added: Intercept and Log createScriptProcessor Calls =======
    (function() {
        // Store the original createScriptProcessor method
        const originalCreateScriptProcessor = AudioContext.prototype.createScriptProcessor;

        // Override the createScriptProcessor method
        AudioContext.prototype.createScriptProcessor = function(bufferSize, numberOfInputChannels, numberOfOutputChannels) {
            console.warn("createScriptProcessor was called. It is deprecated and should be replaced with AudioWorkletNode.");
            console.trace(); // Trace the call stack to identify where it's called from
            return originalCreateScriptProcessor.apply(this, arguments);
        };
    })();
    // ================================================================

    // Function to inspect AudioWorkletNode and related features in Tone.js
    function inspectForAudioWorkletReferences() {
        if (typeof Tone === "undefined") {
            console.error("Tone.js library is not loaded.");
            return;
        }

        const workletReferences = [];
        const searchTerms = ["AudioWorklet", "AudioWorkletNode", "worklet", "processor"];

        for (const key in Tone) {
            if (typeof Tone[key] === "function" || typeof Tone[key] === "object") {
                try {
                    const stringified = Tone[key].toString();
                    searchTerms.forEach(function(term) {
                        if (stringified.includes(term)) {
                            workletReferences.push({ key: key, term: term });
                        }
                    });
                } catch (e) {
                    console.error("Error inspecting Tone." + key + ":", e);
                }
            }
        }

        if (workletReferences.length > 0) {
            console.log("Found references to AudioWorklet-related features in Tone.js:");
            workletReferences.forEach(function(ref) {
                console.log("- Found \"" + ref.term + "\" in Tone." + ref.key);
            });
        } else {
            console.log("No direct references to AudioWorklet or related features found in Tone.js.");
        }
    }

    // Function to inspect Tone.js for ScriptProcessorNode usage
    function inspectForScriptProcessorUsage() {
        if (typeof Tone === "undefined") {
            console.error("Tone.js library is not loaded.");
            return;
        }

        const scriptProcessorReferences = [];

        for (const key in Tone) {
            if (typeof Tone[key] === "function" || typeof Tone[key] === "object") {
                try {
                    const stringified = Tone[key].toString();
                    if (stringified.includes("ScriptProcessorNode")) {
                        scriptProcessorReferences.push(key);
                    }
                } catch (e) {
                    console.error("Error inspecting Tone." + key + ":", e);
                }
            }
        }

        if (scriptProcessorReferences.length > 0) {
            console.log("Found references to ScriptProcessorNode in Tone.js:", scriptProcessorReferences);
        } else {
            console.log("No direct references to ScriptProcessorNode found in Tone.js.");
        }
    }

    // Listen for the 'tonejsLoaded' event to perform inspections and initialize demos
    document.addEventListener("tonejsLoaded", function() {
        // Show the header
        const header = document.getElementById("header");
        header.style.display = "block";

        // Update the header with the version number
        if (typeof Tone !== "undefined" && Tone.version) {
            header.textContent = "From Audionals and Ordinal Based 1's :::: Tone.js v" + Tone.version;
        } else {
            header.textContent = "From Audionals and Ordinal Based 1s :::: Tone.js - Version Unknown";
        }

        // Show the body now that ToneJS is loaded
        document.body.style.display = "block";

        // Display a success message
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = "ToneJS is loaded successfully!";
        messageDiv.className = "success";

        // Show the instructions
        const instructions = document.getElementById("instructions");
        instructions.classList.add("visible");

        // Run inspections
        inspectForAudioWorkletReferences();
        inspectForScriptProcessorUsage();

        // Show the existing Demo App
        showDemoAppButton();

        // Initialize the Additional Demo
        initializeAdditionalDemo();
    });

    // Listen for the 'tonejsLoadError' event to display error message
    document.addEventListener("tonejsLoadError", function(event) {
        // Show the header even if there's an error
        const header = document.getElementById("header");
        header.style.display = "block";
        header.textContent = "Audionals and the OB1s present Tone.js";

        // Show the body even if there's an error
        document.body.style.display = "block";

        // Display an error message
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = "Failed to load ToneJS: " + event.detail.message;
        messageDiv.className = "error";
    });

    document.addEventListener("DOMContentLoaded", function() {
        // Hard-coded URL to the external HTML file containing the ToneJS library
        const externalLibraryURL = "https://ordinals.com/content/1bda678460ef08fb64435b57c9b69fd78fd4556822ccd8e9839b4eb71b3621edi0";

        // Load the ToneJS library using the bridge
        ToneJSBridge.load(externalLibraryURL)
            .then(function() {
                console.log("ToneJS has been loaded and is ready to use.");
                // Optionally, dispatch an event or call a callback here
            })
            .catch(function(error) {
                console.error("Failed to load ToneJS:", error);
                // Optionally, handle the error accordingly
            });
    });

    /**
     * Function to create and display the Demo App Button after ToneJS is loaded.
     */
    function showDemoAppButton() {
        // Create the Demo Button if it doesn't exist
        if (!document.getElementById("openDemoButton")) {
            const demoButton = document.createElement("button");
            demoButton.id = "openDemoButton";
            demoButton.textContent = "Open Demo Music App";
            demoButton.style.padding = "10px 20px";
            demoButton.style.fontSize = "16px";
            demoButton.style.margin = "20px auto";
            demoButton.style.display = "block";
            demoButton.style.cursor = "pointer";
            demoButton.style.border = "none";
            demoButton.style.borderRadius = "5px";
            demoButton.style.backgroundColor = "#17a2b8";
            demoButton.style.color = "white";
            demoButton.style.transition = "background-color 0.3s";

            demoButton.addEventListener("mouseover", function() {
                demoButton.style.backgroundColor = "#138496";
            });

            demoButton.addEventListener("mouseout", function() {
                demoButton.style.backgroundColor = "#17a2b8";
            });

            demoButton.addEventListener("click", function() {
                // Show the Demo App Container
                const demoAppContainer = document.getElementById("demoAppContainer");
                demoAppContainer.style.display = "block";

                // Hide the Demo Button after opening the Demo App
                demoButton.style.display = "none";

                // Initialize the Demo App
                initializeDemoApp();
            });

            // Append the Demo Button to the body
            document.body.appendChild(demoButton);
        }
    }

    /**
     * Function to initialize the Demo App's functionalities.
     */
    function initializeDemoApp() {
        const playNoteButton = document.getElementById("playNoteButton");
        const demoStatus = document.getElementById("demoStatus");

        playNoteButton.addEventListener("click", function() {
            if (typeof Tone === "undefined") {
                demoStatus.textContent = "Status: ToneJS is not loaded.";
                demoStatus.style.color = "#721c24"; // Error color
                console.error("ToneJS is not loaded.");
                return;
            }

            try {
                demoStatus.textContent = "Status: Playing Middle C...";
                demoStatus.style.color = "#333";

                // Create a synth and connect it to the main output (your speakers)
                const synth = new Tone.Synth().toDestination();

                // Play a middle 'C' for the duration of an 8th note
                synth.triggerAttackRelease("C4", "8n");

                demoStatus.textContent = "Status: Middle C played successfully!";
                demoStatus.style.color = "#155724"; // Success color
            } catch (error) {
                demoStatus.textContent = "Status: Error playing note.";
                demoStatus.style.color = "#721c24"; // Error color
                console.error("Error playing note:", error);
            }
        });
    }

    /**
     * ======= Added: Additional Demo Section =======
     * This demo showcases advanced functionalities of Tone.js including interactive synth controls,
     * effects processing, a simple sequencer, real-time visualization, and a virtual keyboard interface.
     */
    function initializeAdditionalDemo() {
        // Create and display the Additional Demo Container
        const additionalDemoContainer = document.getElementById("additionalDemoContainer");

        // Automatically display the additional demo after a short delay
        setTimeout(function() {
            additionalDemoContainer.style.display = "block";
            initializeAdditionalDemoFunctionality();
        }, 1000); // Adjust the delay as needed
    }

    /**
     * Function to initialize the Additional Demo's functionalities.
     */
    function initializeAdditionalDemoFunctionality() {
        // === Synth Controls ===
        const oscillatorType = document.getElementById("oscillatorType");
        const envelopeAttack = document.getElementById("envelopeAttack");
        const envelopeAttackValue = document.getElementById("envelopeAttackValue");
        const envelopeDecay = document.getElementById("envelopeDecay");
        const envelopeDecayValue = document.getElementById("envelopeDecayValue");
        const envelopeSustain = document.getElementById("envelopeSustain");
        const envelopeSustainValue = document.getElementById("envelopeSustainValue");
        const envelopeRelease = document.getElementById("envelopeRelease");
        const envelopeReleaseValue = document.getElementById("envelopeReleaseValue");

        // Update display values for envelopes
        envelopeAttack.addEventListener("input", function() {
            envelopeAttackValue.textContent = envelopeAttack.value;
            if (currentSynth) {
                currentSynth.envelope.attack = parseFloat(envelopeAttack.value);
            }
        });

        envelopeDecay.addEventListener("input", function() {
            envelopeDecayValue.textContent = envelopeDecay.value;
            if (currentSynth) {
                currentSynth.envelope.decay = parseFloat(envelopeDecay.value);
            }
        });

        envelopeSustain.addEventListener("input", function() {
            envelopeSustainValue.textContent = envelopeSustain.value;
            if (currentSynth) {
                currentSynth.envelope.sustain = parseFloat(envelopeSustain.value);
            }
        });

        envelopeRelease.addEventListener("input", function() {
            envelopeReleaseValue.textContent = envelopeRelease.value;
            if (currentSynth) {
                currentSynth.envelope.release = parseFloat(envelopeRelease.value);
            }
        });

        oscillatorType.addEventListener("change", function() {
            if (currentSynth) {
                currentSynth.oscillator.type = oscillatorType.value;
            }
        });

        // === Effects Controls ===
        const reverbControl = document.getElementById("reverb");
        const reverbValue = document.getElementById("reverbValue");
        const delayControl = document.getElementById("delay");
        const delayValue = document.getElementById("delayValue");

        reverbControl.addEventListener("input", function() {
            reverbValue.textContent = reverbControl.value;
            if (reverb) {
                reverb.decay = parseFloat(reverbControl.value);
            }
        });

        delayControl.addEventListener("input", function() {
            delayValue.textContent = delayControl.value;
            if (delay) {
                delay.delayTime.value = parseFloat(delayControl.value);
            }
        });

        // === Sequencer Controls ===
        const startSequencerButton = document.getElementById("startSequencerButton");
        const stopSequencerButton = document.getElementById("stopSequencerButton");
        let isSequencerRunning = false;

        startSequencerButton.addEventListener("click", function() {
            if (isSequencerRunning) return;
            isSequencerRunning = true;
            Tone.Transport.start();
            additionalDemoStatus.textContent = "Status: Sequencer started.";
            additionalDemoStatus.style.color = "#155724"; // Success color
        });

        stopSequencerButton.addEventListener("click", function() {
            if (!isSequencerRunning) return;
            isSequencerRunning = false;
            Tone.Transport.stop();
            Tone.Transport.cancel(); // Clear scheduled events
            additionalDemoStatus.textContent = "Status: Sequencer stopped.";
            additionalDemoStatus.style.color = "#721c24"; // Error color
        });

        // === Visualization ===
        const visualization = document.getElementById("visualization");
        const canvasCtx = visualization.getContext("2d");
        const analyser = new Tone.Analyser("fft", 256);
        Tone.Master.connect(analyser);

        function drawVisualization() {
            const bufferLength = analyser.size;
            const dataArray = analyser.getValue();

            canvasCtx.fillStyle = "#ffffff";
            canvasCtx.fillRect(0, 0, visualization.width, visualization.height);

            const barWidth = (visualization.width / bufferLength) * 2.5;
            let posX = 0;

            for (let i = 0; i < bufferLength; i++) {
                const barHeight = dataArray[i] / 255 * visualization.height;

                canvasCtx.fillStyle = "rgb(" + (barHeight + 100) + ",50,50)";
                canvasCtx.fillRect(posX, visualization.height - barHeight, barWidth, barHeight);

                posX += barWidth + 1;
            }

            requestAnimationFrame(drawVisualization);
        }

        drawVisualization();

        // === Virtual Keyboard ===
        const virtualKeyboard = document.getElementById("virtualKeyboard");
        const keys = virtualKeyboard.querySelectorAll(".key");
        let currentSynth = null;

        keys.forEach(function(key) {
            key.addEventListener("mousedown", function() {
                const note = key.getAttribute("data-note");
                playVirtualKey(note, key);
            });

            key.addEventListener("mouseup", function() {
                stopVirtualKey();
            });

            key.addEventListener("mouseleave", function() {
                stopVirtualKey();
            });
        });

        function playVirtualKey(note, keyElement) {
            if (!currentSynth) {
                currentSynth = new Tone.Synth({
                    oscillator: {
                        type: document.getElementById("oscillatorType").value
                    },
                    envelope: {
                        attack: parseFloat(document.getElementById("envelopeAttack").value),
                        decay: parseFloat(document.getElementById("envelopeDecay").value),
                        sustain: parseFloat(document.getElementById("envelopeSustain").value),
                        release: parseFloat(document.getElementById("envelopeRelease").value)
                    }
                }).chain(
                    reverb,
                    delay,
                    Tone.Destination
                );
            }

            currentSynth.oscillator.type = document.getElementById("oscillatorType").value;
            currentSynth.envelope.attack = parseFloat(document.getElementById("envelopeAttack").value);
            currentSynth.envelope.decay = parseFloat(document.getElementById("envelopeDecay").value);
            currentSynth.envelope.sustain = parseFloat(document.getElementById("envelopeSustain").value);
            currentSynth.envelope.release = parseFloat(document.getElementById("envelopeRelease").value);

            keyElement.classList.add("active");
            currentSynth.triggerAttack(note);
        }

        function stopVirtualKey() {
            if (currentSynth) {
                currentSynth.triggerRelease();
                // Remove active class from all keys
                keys.forEach(function(key) {
                    key.classList.remove("active");
                });
            }
        }

        // === Tone.js Components ===
        let reverb = new Tone.Reverb({
            decay: parseFloat(document.getElementById("reverb").value),
            wet: 0.5
        }).toDestination();
        reverb.generate();

        let delay = new Tone.FeedbackDelay({
            delayTime: parseFloat(document.getElementById("delay").value),
            feedback: 0.5,
            wet: 0.5
        }).toDestination();

        // === Sequencer Setup ===
        const synthSequence = new Tone.Sequence(function(time, note) {
            // Play each note in the sequence
            synthSequence.synth.triggerAttackRelease(note, "8n", time);
        }, ["C4", "E4", "G4", "B4"], "4n");

        // Assign synth to the sequencer
        synthSequence.synth = new Tone.Synth({
            oscillator: {
                type: document.getElementById("oscillatorType").value
            },
            envelope: {
                attack: parseFloat(document.getElementById("envelopeAttack").value),
                decay: parseFloat(document.getElementById("envelopeDecay").value),
                sustain: parseFloat(document.getElementById("envelopeSustain").value),
                release: parseFloat(document.getElementById("envelopeRelease").value)
            }
        }).chain(
            reverb,
            delay,
            Tone.Destination
        );

        // Update sequencer synth when controls change
        oscillatorType.addEventListener("change", function() {
            if (synthSequence.synth) {
                synthSequence.synth.oscillator.type = oscillatorType.value;
            }
        });

        envelopeAttack.addEventListener("input", function() {
            if (synthSequence.synth) {
                synthSequence.synth.envelope.attack = parseFloat(envelopeAttack.value);
            }
        });

        envelopeDecay.addEventListener("input", function() {
            if (synthSequence.synth) {
                synthSequence.synth.envelope.decay = parseFloat(envelopeDecay.value);
            }
        });

        envelopeSustain.addEventListener("input", function() {
            if (synthSequence.synth) {
                synthSequence.synth.envelope.sustain = parseFloat(envelopeSustain.value);
            }
        });

        envelopeRelease.addEventListener("input", function() {
            if (synthSequence.synth) {
                synthSequence.synth.envelope.release = parseFloat(envelopeRelease.value);
            }
        });

        // === Additional Demo Play Chord ===
        const playChordButton = document.getElementById("playChordButton");
        const additionalDemoStatus = document.getElementById("additionalDemoStatus");

        playChordButton.addEventListener("click", function() {
            if (typeof Tone === "undefined") {
                additionalDemoStatus.textContent = "Status: ToneJS is not loaded.";
                additionalDemoStatus.style.color = "#721c24"; // Error color
                console.error("ToneJS is not loaded.");
                return;
            }

            try {
                additionalDemoStatus.textContent = "Status: Playing C Major Chord...";
                additionalDemoStatus.style.color = "#333";

                // Create a PolySynth and connect it to the main output (your speakers)
                const polySynth = new Tone.PolySynth(Tone.Synth).chain(
                    reverb,
                    delay,
                    Tone.Destination
                );

                // Define the notes for a C Major chord
                const notes = ["C4", "E4", "G4"];

                // Trigger the chord
                polySynth.triggerAttackRelease(notes, "2n");

                additionalDemoStatus.textContent = "Status: C Major Chord played successfully!";
                additionalDemoStatus.style.color = "#155724"; // Success color
            } catch (error) {
                additionalDemoStatus.textContent = "Status: Error playing chord.";
                additionalDemoStatus.style.color = "#721c24"; // Error color
                console.error("Error playing chord:", error);
            }
        });
    }
        /**
         * ======= End: Additional Demo Section =======
         */
</script>
</body>
</html>