<!DOCTYPE html>
<html>
<head>
    <title>TRUTH</title>
</head>
<body>
    <!-- Your existing scripts and variables -->
    <script>
        window.seed = 98;
        window.songDataUrl = "/content/5527d0cc95ce5ce6eedf4e275234da8b1fe087512d0db618b6de1aaad437c96bi0";
    </script>
    <script src="/content/799b9bb3e731b50c366365f22b9504f7704f9a51d3d45572d0d980b7a192000di0"></script>

    <script>
     function getAssignments() {
        const assignments = [];
        for (let i = TOTAL_CHANNELS; i >= 1; i--) {
            const { arrayIndex, cci2 } = renderingState[i] || {};
            if (arrayIndex !== undefined && cci2 !== undefined) {
                assignments.push(`Channel ${TOTAL_CHANNELS - i + 1}: ArrayIndex=${arrayIndex}, CCI2=${cci2}`);
            }
        }
        console.log("Assignments gathered:", assignments);
        return assignments;
    }

    document.addEventListener('playbackStarted', () => {
        window.playbackStartTime = Date.now();
        console.log(`Playback started at ${window.playbackStartTime}`);
    });

    function getTimecode() {
        return window.playbackStartTime ? Date.now() - window.playbackStartTime : 0;
    }

    function downloadCurrentVisualState() {
        console.log("downloadCurrentVisualState function called");
        const canvases = document.querySelectorAll('canvas');
        canvases.forEach((canvas, i) => console.log(`Canvas ${i} dimensions: ${canvas.width} x ${canvas.height}`));
        const canvas = canvases[1];
        if (!canvas) return console.error("No canvas element found.");
        console.log("Canvas selected with dimensions:", canvas.width, canvas.height);
        setTimeout(() => {
            const metadata = {
                accessLevel: AccessLevel,
                seed: window.seed,
                assignments: getAssignments(),
                timecode: getTimecode()
            };
            console.log("Metadata collected:", metadata);
            const metadataString = `
    Seed: ${metadata.seed}
    Access Level: ${metadata.accessLevel}
    Channel Effect Assignments: 
    ${metadata.assignments.join('\n')}
    Timecode: ${metadata.timecode} ms
            `.trim();
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = canvas.width;
            finalCanvas.height = canvas.height;
            const ctx = finalCanvas.getContext('2d');
            ctx.drawImage(canvas, 0, 0, finalCanvas.width, finalCanvas.height);
            console.log("Image drawn on finalCanvas with dimensions:", finalCanvas.width, finalCanvas.height);
            const padding = 10, fontSize = 12, lineHeight = fontSize * 1.2;
            ctx.font = `${fontSize}px Arial`;
            ctx.fillStyle = '#1b1b1b';
            ctx.shadowColor = 'black';
            ctx.shadowBlur = 4;
            ctx.textAlign = 'right';
            metadataString.split('\n').reverse().forEach((line, i) => {
                ctx.fillText(line, finalCanvas.width - padding, finalCanvas.height - padding - (i * lineHeight));
            });
            console.log("Text drawn on finalCanvas");
            finalCanvas.toBlob(blob => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `visual_state_${new Date().toISOString()}.jpeg`;
                link.click();
                console.log("Download link clicked");
            }, 'image/jpeg');
        }, 1000);
    }

    document.addEventListener('keydown', (e) => {
        console.log("Keydown event detected:", e.key);
        if (e.key.toLowerCase() === 'p') downloadCurrentVisualState();
    });

    </script>
    
    
</body>
</html>
