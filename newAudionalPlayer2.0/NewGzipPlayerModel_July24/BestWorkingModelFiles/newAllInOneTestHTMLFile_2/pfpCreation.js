// pfpCapture.js
let playbackStarted=!1,lastCapture=0;function getAssignments(){const e=[];for(let t=TOTAL_CHANNELS;t>=1;t--){const{arrayIndex:n,cci2:a}=renderingState[t]||{};void 0!==n&&void 0!==a&&e.push(`Channel ${TOTAL_CHANNELS-t+1}: ArrayIndex=${n}, CCI2=${a}`)}return e}const psTimeEvent=e=>playbackStarted=e;document.addEventListener("playbackStarted",(()=>{window.psTime=Date.now(),psTimeEvent(!0)})),document.addEventListener("playbackStopped",(()=>psTimeEvent(!1)));const captureCanvas=e=>{const t=document.querySelectorAll("canvas")[1];if(!t)return;const n=document.createElement("canvas");Object.assign(n,{width:t.width,height:t.height}),n.getContext("2d").drawImage(t,0,0,n.width,n.height),e(n,window.psTime?Date.now()-window.psTime:0)},processAndDownloadCanvas=(e,t)=>{const n={accessLevel:AccessLevel,seed:window.seed,assignments:getAssignments(),timecode:t},a=`\nSeed: ${n.seed}\nAccess Level: ${n.accessLevel}\nChannel Effect Assignments: \n${n.assignments.join("\n")}\nTimecode: ${n.timecode} ms\n    `.trim(),s=e.getContext("2d");Object.assign(s,{font:"14px Arial",fillStyle:"#1b1b1b",shadowColor:"black",textAlign:"right"}),a.split("\n").reverse().forEach(((t,n)=>{s.fillText(t,e.width-10,e.height-10-16.8*n)})),e.toBlob((e=>{const t=document.createElement("a");Object.assign(t,{href:URL.createObjectURL(e),download:`visual_state_${(new Date).toISOString()}.jpeg`}),t.click()}),"image/jpeg")},debounce=(e,t)=>{let n;return(...a)=>{clearTimeout(n),n=setTimeout((()=>e.apply(this,a)),t)}},handleKeydown=debounce((e=>{const t=Date.now();"p"===e.key.toLowerCase()&&isTrippy&&playbackStarted&&t-lastCapture>=3e4&&(lastCapture=t,captureCanvas(processAndDownloadCanvas))}),200);document.addEventListener("keydown",handleKeydown);
