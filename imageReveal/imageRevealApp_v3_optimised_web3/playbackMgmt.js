// playbackMgmt.js
(()=>{const t=document.getElementById("playBtn"),e=document.getElementById("log"),a=window.AudioContext||window.webkitAudioContext,n=document.getElementById("clickToBeginText"),d=t=>{e&&(e.textContent+=`${(new Date).toLocaleTimeString()}: ${t}\n`,e.scrollTop=e.scrollHeight)};if(!a)return t.textContent="Audio not supported",void(t.disabled=!0);n||console.warn('"Click to Begin" text element not found.');let o=new a,i=Array(audioParts.length),r=0,s=null,c=!0,l=!1;const u=()=>{t.disabled=c,t.textContent=c?"Loadingâ€¦":l?"Stop Mix":"Play Mix"};(async()=>{try{d(`Fetching first part â†’ ${audioParts[0]}`);const t=await(await fetch(audioParts[0])).arrayBuffer();i[0]=await o.decodeAudioData(t),c=!1,u(),d(`First part ready (${i[0].duration.toFixed(2)}â€¯s).`),await Promise.all(audioParts.slice(1).map((async(t,e)=>{const a=await(await fetch(t)).arrayBuffer();i[e+1]=await o.decodeAudioData(a),d(`Decoded part ${e+2}/${audioParts.length}`)}))),d("All parts decoded. âœ…")}catch(t){c=!1,u(),d(`Preload failed: ${t.message}`)}})();const p=()=>{if(!l)return;if(r>=i.length)return l=!1,u(),d("Finished. ðŸŽ‰"),void y();const t=i[r];if(!t)return d(`Part ${r+1} buffer not ready, retrying...`),void setTimeout(p,200);s=o.createBufferSource(),s.buffer=t,s.connect(o.destination),s.start(),d(`â–¶ Part ${r+1}/${i.length} (${t.duration.toFixed(2)}â€¯s)`),r++,s.onended=()=>{s=null,l&&p()}},y=()=>document.dispatchEvent(new Event("playbackStopped")),f=async()=>{c||l||("suspended"===o.state&&await o.resume(),l=!0,r=0,u(),document.dispatchEvent(new Event("playbackStarted")),p())},g=()=>{if(l){if(l=!1,s)try{s.onended=null,s.stop()}catch(t){d(`Error stopping active source: ${t.message}`)}s=null,d("Stopped by user."),u(),y()}};t.onclick=()=>l?g():f(),document.addEventListener("togglePlayback",(()=>l?g():f())),document.addEventListener("playbackStarted",(()=>{n&&n.classList.add("hidden")})),document.addEventListener("playbackStopped",(()=>{n&&n.classList.remove("hidden")}))})();