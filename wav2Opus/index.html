<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <title>Audio & Image Conversion Tools</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<main>
  <!-- Audio Conversion Section -->
  <section id="audio-section" class="conversion-section">
    <h1 id="audio-section-heading">WAV to MP3/Opus Converter</h1>

    <button id="showInfoBtn" class="button-small centered">
      Click for Instructions and Audio Conversion Information
    </button>

    <!-- ARIA attributes added for accessibility -->
    <div id="audioInfoContainer" class="info-popup hidden" role="dialog" aria-modal="true" aria-labelledby="audio-section-heading" aria-describedby="audioInfoContent">
      <button id="closeInfoBtn" class="close-info-btn" title="Close" aria-label="Close">Ã—</button>
      <div id="audioInfoContent">
        <!-- Content will be injected here by audio-formats-explained.js -->
      </div>
    </div>

    <div class="form-group">
      <label for="fileInput">1. Select WAV File:</label>
      <input type="file" id="fileInput" accept=".wav,audio/wav,audio/x-wav">
    </div>

    <fieldset id="formatOptions" class="form-group">
      <legend>2. Choose Output Format & Quality:</legend>
      <div class="radio-group">
        <label><input type="radio" name="format" value="opus"checked> Opus</label>
        <label><input type="radio" name="format" value="mp3" > MP3</label>
      </div>
      <div id="opusSettings" class="settings-group hidden">
        <label for="opusBitrate">Opus Bitrate (kbps):</label>
        <input type="range" id="opusBitrate" min="16" max="256" value="96" step="8">
        <span id="opusBitrateValue">96 kbps</span>
        <span id="estSizeOpus" class="estimate"></span>
      </div>
      <div id="mp3Settings" class="settings-group">
        <label for="mp3Quality">MP3 Quality (VBR -q:a, 0=Worst/Smallest File, 9=Best/Largest File):</label>
        <input type="range" id="mp3Quality" min="0" max="9" value="4" step="1">
        <span id="mp3QualityValue">4</span>
        <span id="estSizeMp3" class="estimate" style="display: none;"></span>
      </div>

    </fieldset>

    <div class="button-container">
      <button id="playSampleBtn" disabled>Play Original</button>
      <button id="convertBtn" disabled>3. Convert</button>
    </div>

    <div id="originalAudioContainer">
        <!-- Original audio player will be injected here -->
    </div>
    <!-- Status message with aria-live for screen reader announcements -->
    <div id="status" aria-live="polite">Status: Initializing FFmpeg...</div>
    <!-- Progress bar linked to status message -->
    <progress id="progress" value="0" max="100" class="hidden" aria-labelledby="status"></progress>
    <div id="result">
        <!-- Conversion result (download link/player) will appear here -->
    </div>
    <div id="base64Container" class="base64-container hidden">
      <fieldset>
        <legend>4. Base64 Conversion:</legend>
        <div id="base64Result">
            <!-- Base64 status/info will appear here -->
        </div>
        <details>
          <summary>Show Base64 Output</summary>
          <div id="base64Output" class="base64-output">
              <!-- Base64 string will appear here -->
          </div>
        </details>
        <div class="button-group">
          <button id="copyBase64Btn" class="copy-button">Copy Base64</button>
          <button id="downloadBase64Btn" class="download-button">Download as TXT</button>
        </div>
      </fieldset>
    </div>
  </section>

  <!-- Image Conversion Section -->
  <section id="image-section" class="conversion-section">
    <h1>Image to Base64 Converter</h1>
    
    <div class="file-input-container">
      <label for="image-file-input" class="custom-file-upload">
        Select Image File
      </label>
      <input type="file" id="image-file-input" accept="image/*">
    </div>
    
    <div class="preview-container">
      <img id="image-preview" alt="Image Preview" style="display: none;">
    </div>
    
    <div class="info-container">
      <p id="file-size-info"></p>
    </div>
    
    <div class="button-container">
      <button id="convert-image-button" disabled>Convert to Base64</button>
    </div>
    
    <div class="output-container">
      <details>
        <summary>Show Base64 Output</summary>
        <textarea id="base64-output" style="display: none;" readonly></textarea>
      </details>
    </div>
    
    <div class="button-container">
      <button id="download-base64-button" disabled>Download Base64 as Text</button>
    </div>
  </section>

  <!-- Metadata Input Modal -->
<div id="metadataModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="metadataModalTitle">
  <div class="modal-content">
    <h2 id="metadataModalTitle">Enter Audio Metadata</h2>
    <form id="metadataForm">

      <div class="form-group">
        <label for="titleInput">Title/Name:</label>
        <input type="text" id="titleInput" name="title" required>
      </div>

      <div class="form-group">
        <label for="instrumentInput">Instrument:</label>
        <input type="text" id="instrumentInput" name="instrument" required>
      </div>

      <div class="form-group">
        <label for="noteInput">Note:</label>
        <!-- Input linked to datalist -->
        <input type="text" id="noteInput" name="note" required list="noteList" placeholder="e.g., C#4">
        <!-- Datalist for note suggestions -->
        <datalist id="noteList">
          <!-- Options will be populated by JavaScript -->
        </datalist>
      </div>

      <div class="form-group">
        <label for="frequencyInput">Frequency:</label>
        <!-- Frequency field is now read-only and calculated -->
        <input type="text" id="frequencyInput" name="frequency" readonly placeholder="Calculated from Note">
      </div>

      <div class="form-group form-group-checkbox">
        <input type="checkbox" id="loopCheckbox" name="isLoop">
        <label for="loopCheckbox">Is this a loop?</label>
      </div>

      <div id="bpmGroup" class="form-group hidden">
        <label for="bpmInput">BPM/Tempo:</label>
        <input type="number" id="bpmInput" name="bpm" min="1">
      </div>

      <div class="button-container modal-buttons">
        <button type="submit" id="submitMetadataBtn">Generate HTML</button>
        <button type="button" id="cancelMetadataBtn">Cancel</button>
      </div>
    </form>
  </div>
  <div class="modal-overlay"></div>
</div>
<!-- End Metadata Input Modal -->

<!-- Add this JavaScript to handle the conditional BPM field -->
<script>
 document.addEventListener('DOMContentLoaded', () => {
  const loopCheckbox = document.getElementById('loopCheckbox');
  const bpmGroup = document.getElementById('bpmGroup');
  const bpmInput = document.getElementById('bpmInput');
  const noteInput = document.getElementById('noteInput');
  const frequencyInput = document.getElementById('frequencyInput');
  const noteList = document.getElementById('noteList');

  const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
  // Map note names (using sharps) to their semitone offset from C
  const noteOffsets = {
      'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4, 'F': 5,
      'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11
  };

  // --- Populate Note Datalist (C0 to A8) ---
  function generateNoteOptions() {
    for (let octave = 0; octave <= 8; octave++) {
      for (let i = 0; i < notes.length; i++) {
        const noteName = notes[i];
        // Stop after A8
        if (octave === 8 && i > notes.indexOf('A')) {
           break;
        }
        const fullNote = `${noteName}${octave}`;
        const option = document.createElement('option');
        option.value = fullNote;
        noteList.appendChild(option);
      }
    }
  }

  // --- Calculate Frequency from Note ---
  function noteToFrequency(note) {
    const noteRegex = /^([A-G])(#|b)?([0-8])$/i;
    const match = note.match(noteRegex);

    if (!match) {
      return null; // Invalid note format
    }

    let noteName = match[1].toUpperCase();
    const accidental = match[2]; // #, b, or undefined
    const octave = parseInt(match[3], 10);

    // Normalize to sharps for calculation (e.g., Db becomes C#)
    if (accidental === 'b') {
        const originalOffset = noteOffsets[noteName];
        const sharpOffset = (originalOffset - 1 + 12) % 12; // Find the equivalent sharp offset
        // Find the note name corresponding to the sharp offset
        noteName = Object.keys(noteOffsets).find(key => noteOffsets[key] === sharpOffset && !key.includes('b')) || noteName;
    } else if (accidental === '#') {
        noteName += '#';
    }


    // Ensure the normalized note name is valid (e.g. handles E#, B# etc. if needed, though noteOffsets map handles common ones)
    if (!(noteName in noteOffsets)) {
        // This check might be redundant if the regex is strict enough and noteOffsets comprehensive
        console.warn(`Could not map note: ${noteName}`);
        return null;
    }

    // A4 = MIDI 69. C4 = MIDI 60. C0 = MIDI 12.
    // Formula: MIDI_Note = note_offset_from_C0 + 12
    // Let's use A4=69 standard directly.
    const noteOffset = noteOffsets[noteName];
    // MIDI note number calculation: (Octave + 1) * 12 + semitone_offset_from_C
    // Simpler: Base MIDI for octave 0 + octave * 12
    // C0 = 12, C#0 = 13,... B0 = 23
    // A0 = 21, A4 = 21 + 4*12 = 69
    // C0 = 12, C4 = 12 + 4*12 = 60
    const midiNum = noteOffset + (octave * 12) + 12; // Using C0 = 12 base

    // Check against valid MIDI range (approx C0=12 to A8=117)
    if (midiNum < 12 || midiNum > 117) {
        console.warn(`Calculated MIDI number ${midiNum} out of expected range for ${note}`);
        // You might allow it or return null depending on strictness
        // return null;
    }


    // Frequency calculation: f = 440 * 2^((MIDI - 69) / 12)
    const frequency = 440 * Math.pow(2, (midiNum - 69) / 12);
    return frequency;
  }

  // --- Update Frequency Display ---
  function updateFrequencyDisplay() {
    const noteValue = noteInput.value.trim();
    const frequency = noteToFrequency(noteValue);

    if (frequency !== null) {
      // Format to 2 decimal places and add Hz
      frequencyInput.value = `${frequency.toFixed(2)} Hz`;
    } else {
      frequencyInput.value = ''; // Clear if note is invalid
      // Optional: Add validation feedback to the user
    }
  }


  // --- Toggle BPM Field Logic ---
  function toggleBpmField() {
    if (loopCheckbox.checked) {
      bpmGroup.classList.remove('hidden');
      bpmInput.required = true;
    } else {
      bpmGroup.classList.add('hidden');
      bpmInput.required = false;
      bpmInput.value = '';
    }
  }

  // --- Event Listeners ---
  // Populate notes when the script runs
  generateNoteOptions();

  // Listen for input changes on the note field
  noteInput.addEventListener('input', updateFrequencyDisplay);

  // Listen for changes on the loop checkbox
  loopCheckbox.addEventListener('change', toggleBpmField);

  // --- Optional: Clear form on cancel ---
  const cancelBtn = document.getElementById('cancelMetadataBtn');
  const form = document.getElementById('metadataForm');
  const modal = document.getElementById('metadataModal'); // Assuming you have a way to close the modal

  cancelBtn.addEventListener('click', () => {
      form.reset(); // Resets form fields to initial state (empty in this case)
      updateFrequencyDisplay(); // Clear calculated frequency
      toggleBpmField(); // Ensure BPM field is hidden if checkbox was checked
      modal.classList.add('hidden'); // Example: Hide the modal
  });

  // --- Optional: Handle form submission ---
  // You might want to read the calculated frequency here if needed
  form.addEventListener('submit', (event) => {
      // event.preventDefault(); // Prevent default if handling via JS/AJAX
      console.log("Form submitted");
      // Access values like:
      console.log("Title:", document.getElementById('titleInput').value);
      console.log("Note:", noteInput.value);
      console.log("Calculated Frequency:", frequencyInput.value); // It's readonly, but value is submitted
      console.log("Is Loop:", loopCheckbox.checked);
      if(loopCheckbox.checked) {
          console.log("BPM:", bpmInput.value);
      }
      // Add your logic to process the data
  });

});
</script>

    <!-- Load FFmpeg library FIRST -->
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <!-- Load Modular JavaScript Files -->
    <script src="config-state.js" defer></script>
    <script src="dom-elements.js" defer></script>
    <script src="utils.js" defer></script>
  
    <!-- Load the NEW HTML template generator function FIRST -->
    <script src="OB1_Template2.js" defer></script> <!-- Or template.js -->
  
    <!-- THEN load the script that USES the generator -->
    <script src="ob1-generator.js" defer></script>
  
    <script src="audio-formats-explained.js" defer></script>
    <script src="ui-helpers.js" defer></script>
    <script src="audio-player.js" defer></script>
    <script src="ffmpeg-handler.js" defer></script>
    <script src="file-handler.js" defer></script>
    <script src="base64-handler.js" defer></script>
    <script src="conversion-process.js" defer></script>
    <script src="event-listeners.js" defer></script>
    
    <script src="main.js" defer></script>
  
    <!-- Load Image Conversion Script as Module -->
    <script type="module">
      import { initializeImageConverter } from './image-to-base64.js';
      document.addEventListener('DOMContentLoaded', initializeImageConverter);
    </script>
  
    <!-- Ensure the Generate OB1 button exists -->
    <div class="control-container" style="text-align: center; margin-top: 20px; padding: 15px; border-top: 1px solid #ccc;">
      <h2>Generate New Audional HTML File</h2>
      <button id="generateOB1Button" class="control-button" disabled style="padding: 10px 20px; font-size: 1.1em;">Generate Clickable HTML (OB1)</button>
      <p style="font-size: 0.9em; color: #555;">Requires both Audio (Opus format recommended) and Image Base64 data to be generated above.</p>
    </div>

    <a href="https://audionals.com/OB1ModularApr25/TEST_Generated_HTML_FILES/Tester" class="button-link" target="_blank" rel="noopener noreferrer">
      Test Generated HTML Files Here
    </a>
  </body>
  </html>