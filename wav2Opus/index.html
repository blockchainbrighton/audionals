<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <!-- Title reflects both functionalities -->
  <title>Audional Art Tools: WAV to WebM & Image to Base64</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<main>
  <!-- Audio Conversion Section (Current Version) -->
  <section id="audio-section" class="conversion-section">
    <h1 id="audio-section-heading">WAV to WebM Converter</h1> <!-- Updated Title -->

    <!-- Info Buttons Container (Current Version) -->
    <div class="info-button-container centered">
      <button id="showAudioInfoBtn" class="button-small info-button">
        Audio Format Info
      </button>
      <button id="showAudionalInfoBtn" class="button-small info-button">
        Audional Instructions
      </button>
    </div>

    <!-- Audio Info Popup (Current Version) -->
    <div id="audioInfoContainer" class="info-popup hidden" role="dialog" aria-modal="true" aria-labelledby="audio-section-heading" aria-describedby="audioInfoContent">
      <button id="closeAudioInfoBtn" class="close-info-btn" title="Close" aria-label="Close Audio Format Information">×</button>
      <div id="audioInfoContent">
        <!-- Content injected by audio-formats-explained.js -->
      </div>
    </div>

    <!-- Audional Instructions Popup (Current Version) -->
    <div id="audionalInfoContainer" class="info-popup hidden" role="dialog" aria-modal="true" aria-labelledby="audional-info-title" aria-describedby="audionalInfoContent">
      <button id="closeAudionalInfoBtn" class="close-info-btn" title="Close" aria-label="Close Audional Instructions">×</button>
      <div id="audionalInfoContent">
         <h2 id="audional-info-title">Generating Audional Art</h2>
         <!-- Content from previous step goes here -->
         <p>Welcome to the cutting edge where audio meets visual art on the Bitcoin blockchain!</p>
         <p><strong>Audionals</strong> are a unique type of Bitcoin Ordinal that embed audio data directly into the inscription, often paired with a visual element. They represent a historical moment in digital art and music technology.</p>
         <p><strong>Using this Tool for Audionals:</strong></p>
         <ol>
           <li><strong>Prepare Your Audio:</strong> Start with a high-quality <code>.wav</code> file of your sound or music loop.</li>
           <li><strong>Convert to WebM (Opus):</strong> Use the "WAV to WebM Converter" section above to change your WAV file into a <strong>WebM</strong> file using the efficient <strong>Opus</strong> codec.
             <ul>
                 <li>Choose a bitrate that balances quality and file size. Lower bitrates (~32-64kbps) are often sufficient for loops and keep inscription costs down, but experiment!</li>
                 <li>The tool will generate the required <strong>Base64 string</strong> for the WebM/Opus audio in the "Base64 Conversion" fieldset below the converter.</li>
             </ul>
           </li>
           <li><strong>Prepare Your Visual:</strong> Use the "Image to Base64 Converter" section below to generate a Base64 string for your cover image (e.g., PNG, JPG, GIF, WEBP). Small dimensions and optimized images are recommended.</li>
           <li><strong>Generate the Audional HTML:</strong> Once you have *both* the audio Base64 and the image Base64:
               <ul>
                 <li>Click the "Generate Clickable HTML (OB1)" button further down the page.</li>
                 <li>Fill in the metadata (Title, Instrument, Note, etc.) in the popup modal. This information helps categorize and describe your Audional.</li>
                 <li>The tool will combine the audio, image, and metadata into a single HTML file ready for download.</li>
               </ul>
           </li>
           <li><strong>Inscribe Your Audional:</strong> This generated HTML file is what you will inscribe as a Bitcoin Ordinal using an inscription service (like OrdinalsBot, UniSat, Xverse, Ordinals Wallet, etc.). Choose "HTML" or "Text" (and paste the full HTML content) as the inscription type.</li>
         </ol>
         <p><strong>Why WebM/Opus?</strong> It offers excellent audio quality at very small file sizes compared to MP3 or WAV, making it ideal for blockchain inscriptions where data size matters.</p>
         <p><em>You are participating in a groundbreaking fusion of music, art, and technology. Happy inscribing!</em></p>
      </div>
    </div>

    <!-- Audio Converter Form Elements (Current Version) -->
    <div class="form-group">
      <label for="fileInput">1. Select WAV File:</label>
      <input type="file" id="fileInput" accept=".wav,audio/wav,audio/x-wav">
    </div>

    <fieldset id="formatOptions" class="form-group">
      <legend>2. Choose Output Quality (WebM/Opus):</legend>
      <div class="radio-group">
        <!-- Hide Opus Radio -->
        <label style="display: none;"><input type="radio" name="format" value="opus"> Opus</label>
        <!-- Hide MP3 Radio -->
        <label style="display: none;"><input type="radio" name="format" value="mp3"> MP3</label>
        <!-- Keep WebM Radio, make sure it's checked -->
        <label><input type="radio" name="format" value="webm" checked> WebM (Opus)</label>
      </div>

      <!-- Opus Settings (Used for WebM) - Ensure this is visible -->
      <div id="opusSettings" class="settings-group"> <!-- Removed 'hidden' class -->
        <label for="opusBitrate">Opus Bitrate (kbps):</label>
        <input type="range" id="opusBitrate" min="16" max="256" value="96" step="8">
        <span id="opusBitrateValue">96 kbps</span>
        <!-- Hide Opus Estimate -->
        <span id="estSizeOpus" class="estimate" style="display: none;"></span>
        <!-- Keep WebM Estimate -->
        <span id="estSizeWebm" class="estimate"></span>
      </div>

      <!-- Hide MP3 Settings -->
      <div id="mp3Settings" class="settings-group hidden" style="display: none;">
        <label for="mp3Quality">MP3 Quality (VBR -q:a, 0=Best/Largest File, 9=Worst/Smallest File):</label>
        <input type="range" id="mp3Quality" min="0" max="9" value="4" step="1">
        <span id="mp3QualityValue">4</span>
        <span id="estSizeMp3" class="estimate"></span>
      </div>
    </fieldset>

    <div class="button-container">
      <button id="playSampleBtn" disabled>Play Original</button>
      <button id="convertBtn" disabled>3. Convert to WebM</button> <!-- Updated Button Text -->
    </div>

    <div id="originalAudioContainer">
        <!-- Original audio player will be injected here -->
    </div>
    <div id="status" aria-live="polite">Status: Initializing FFmpeg...</div>
    <progress id="progress" value="0" max="100" class="hidden" aria-labelledby="status"></progress>
    <div id="result">
        <!-- Conversion result (download link/player) will appear here -->
    </div>
    <!-- Audio Base64 Output Section (Current Version) -->
    <div id="base64Container" class="base64-container hidden">
      <fieldset>
        <legend>4. Audio Base64 Conversion:</legend> <!-- Clarified Legend -->
        <div id="base64Result">
            <!-- Base64 status/info will appear here -->
        </div>
        <details>
          <summary>Show Audio Base64 Output</summary> <!-- Clarified Summary -->
          <div id="base64Output" class="base64-output"> <!-- Keep this ID for audio base64 -->
              <!-- Audio Base64 string will appear here -->
          </div>
        </details>
        <div class="button-group">
          <button id="copyBase64Btn" class="copy-button">Copy Audio Base64</button> <!-- Clarified Button -->
          <button id="downloadBase64Btn" class="download-button">Download Audio Base64 as TXT</button> <!-- Clarified Button -->
        </div>
      </fieldset>
    </div>
  </section> <!-- End of Audio Conversion Section -->


  <!-- ****************************************************** -->
  <!-- *** INSERTED Image Conversion Section FROM OLDER FILE *** -->
  <!-- ****************************************************** -->
  <section id="image-section" class="conversion-section">
    <h1>Image to Base64 Converter</h1>

    <div class="file-input-container">
      <label for="image-file-input" class="custom-file-upload">
        Select Image File
      </label>
      <input type="file" id="image-file-input" accept="image/*"> <!-- Keep this ID -->
    </div>

    <div class="preview-container">
      <img id="image-preview" alt="Image Preview" style="display: none;"> <!-- Keep this ID -->
    </div>

    <div class="info-container">
      <p id="file-size-info"></p> <!-- Keep this ID -->
    </div>

    <div class="button-container">
      <button id="convert-image-button" disabled>Convert to Base64</button> <!-- Keep this ID -->
    </div>

    <div class="output-container">
        <fieldset> <!-- Optional: Wrap in fieldset like the audio section for consistency -->
            <legend>Image Base64 Output:</legend>
            <details>
              <summary>Show Image Base64 Output</summary>
              <!-- Use a different ID for the image output area -->
              <textarea id="image-base64-output" class="base64-output" style="display: none; min-height: 100px;" readonly></textarea>
              <!-- Note: Using textarea matches old file, but added class for similar styling -->
            </details>
            <div class="button-group"> <!-- Added button group for consistency -->
              <!-- Use a different ID for the image copy button -->
              <button id="copy-image-base64-button" class="copy-button" disabled>Copy Image Base64</button>
               <!-- Use a different ID for the image download button -->
              <button id="download-image-base64-button" class="download-button" disabled>Download Image Base64 as TXT</button>
            </div>
      </fieldset>
    </div>
    <!-- Removed the separate download button div from older file, integrated into fieldset -->

  </section> <!-- End of Image Conversion Section -->


  <!-- Metadata Input Modal (Current Version - Keep As Is) -->
  <div id="metadataModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="metadataModalTitle">
    <!-- ... Modal content remains the same ... -->
    <div class="modal-content">
      <h2 id="metadataModalTitle">Enter Audio Metadata</h2>
      <form id="metadataForm">
        <!-- All form groups (Title, Instrument, Note, etc.) -->
         <div class="form-group">
           <label for="titleInput">Title/Name:</label>
           <input type="text" id="titleInput" name="title" required>
         </div>
         <div class="form-group">
           <label for="instrumentInput">Instrument:</label>
           <input type="text" id="instrumentInput" name="instrument" required>
         </div>
         <div class="form-group">
           <label for="noteInput">Note:</label>
           <input type="text" id="noteInput" name="note" required list="noteList" placeholder="e.g., C#4">
           <datalist id="noteList"></datalist>
         </div>
         <div class="form-group">
           <label for="frequencyInput">Frequency:</label>
           <input type="text" id="frequencyInput" name="frequency" readonly placeholder="Calculated from Note">
         </div>
         <div class="form-group form-group-checkbox">
           <input type="checkbox" id="loopCheckbox" name="isLoop">
           <label for="loopCheckbox">Is this a loop?</label>
         </div>
         <div id="bpmGroup" class="form-group hidden">
           <label for="bpmInput">BPM/Tempo:</label>
           <input type="number" id="bpmInput" name="bpm" min="1">
         </div>
         <div class="button-container modal-buttons">
           <button type="submit" id="submitMetadataBtn">Generate HTML</button>
           <button type="button" id="cancelMetadataBtn">Cancel</button>
         </div>
      </form>
    </div>
    <div class="modal-overlay"></div>
  </div>
  <!-- End Metadata Input Modal -->

  <!-- Embedded Note/Frequency/Loop Script (Current Version - Keep As Is) -->
  <script>
    // ... The script for note list, frequency calc, loop checkbox remains the same ...
    document.addEventListener('DOMContentLoaded', () => {
      const loopCheckbox = document.getElementById('loopCheckbox');
      const bpmGroup = document.getElementById('bpmGroup');
      const bpmInput = document.getElementById('bpmInput');
      const noteInput = document.getElementById('noteInput');
      const frequencyInput = document.getElementById('frequencyInput');
      const noteList = document.getElementById('noteList');
      const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
      const noteOffsets = {'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4, 'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11};
      function generateNoteOptions() { /* ... */
         for (let octave = 0; octave <= 8; octave++) {
           for (let i = 0; i < notes.length; i++) {
             const noteName = notes[i];
             if (octave === 8 && i > notes.indexOf('A')) { break; }
             const fullNote = `${noteName}${octave}`;
             const option = document.createElement('option');
             option.value = fullNote;
             noteList.appendChild(option);
           }
         }
      }
      function noteToFrequency(note) { /* ... */
        const noteRegex = /^([A-G])(#|b)?([0-8])$/i;
        const match = note.match(noteRegex);
        if (!match) { return null; }
        let noteName = match[1].toUpperCase(); const accidental = match[2]; const octave = parseInt(match[3], 10);
        if (accidental === 'b') { const originalOffset = noteOffsets[noteName]; const sharpOffset = (originalOffset - 1 + 12) % 12; noteName = Object.keys(noteOffsets).find(key => noteOffsets[key] === sharpOffset && !key.includes('b')) || noteName; } else if (accidental === '#') { noteName += '#'; }
        if (!(noteName in noteOffsets)) { console.warn(`Could not map note: ${noteName}`); return null; }
        const noteOffset = noteOffsets[noteName];
        const midiNum = noteOffset + (octave * 12) + 12;
        if (midiNum < 12 || midiNum > 117) { console.warn(`Calculated MIDI number ${midiNum} out of expected range for ${note}`); }
        const frequency = 440 * Math.pow(2, (midiNum - 69) / 12); return frequency;
      }
      function updateFrequencyDisplay() { /* ... */
         const noteValue = noteInput.value.trim(); const frequency = noteToFrequency(noteValue);
         if (frequency !== null) { frequencyInput.value = `${frequency.toFixed(2)} Hz`; } else { frequencyInput.value = ''; }
      }
      function toggleBpmField() { /* ... */
        if (loopCheckbox.checked) { bpmGroup.classList.remove('hidden'); bpmInput.required = true; } else { bpmGroup.classList.add('hidden'); bpmInput.required = false; bpmInput.value = ''; }
      }
      generateNoteOptions();
      noteInput.addEventListener('input', updateFrequencyDisplay);
      loopCheckbox.addEventListener('change', toggleBpmField);
      const cancelBtn = document.getElementById('cancelMetadataBtn'); const form = document.getElementById('metadataForm'); const modal = document.getElementById('metadataModal');
      cancelBtn.addEventListener('click', () => { form.reset(); updateFrequencyDisplay(); toggleBpmField(); modal.classList.add('hidden'); });
      form.addEventListener('submit', (event) => { /* event.preventDefault(); */ console.log("Form submitted"); /* ... access values ... */ });
    });
  </script>

  <!-- Load FFmpeg library FIRST (Keep As Is) -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

  <!-- Load Modular JavaScript Files (Keep As Is) -->
  <script src="config-state.js" defer></script>
  <script src="dom-elements.js" defer></script>
  <script src="utils.js" defer></script>
  <script src="OB1_Template2.js" defer></script>
  <script src="ob1-generator.js" defer></script>
  <script src="audio-formats-explained.js" defer></script>
  <script src="ui-helpers.js" defer></script>
  <script src="audio-player.js" defer></script>
  <script src="ffmpeg-handler.js" defer></script>
  <script src="file-handler.js" defer></script>
  <script src="base64-handler.js" defer></script> <!-- Handles audio base64 -->
  <script src="conversion-process.js" defer></script>
  <script src="event-listeners.js" defer></script>
  <script src="main.js" defer></script>

  <!-- Load Image Conversion Script as Module (Keep As Is - Crucial for Image Section) -->
  <script type="module">
    import { initializeImageConverter } from './image-to-base64.js';
    // Make sure image-to-base64.js uses the correct IDs if you changed them below
    // e.g., 'image-file-input', 'image-preview', 'file-size-info', 'convert-image-button',
    // 'image-base64-output', 'copy-image-base64-button', 'download-image-base64-button'
    document.addEventListener('DOMContentLoaded', initializeImageConverter);
  </script>

  <!-- Generate OB1 Button Area (Current Version - Keep As Is) -->
  <div class="control-container" style="text-align: center; margin-top: 20px; padding: 15px; border-top: 1px solid #ccc;">
    <h2>Generate New Audional HTML File</h2>
    <button id="generateOB1Button" class="control-button" disabled style="padding: 10px 20px; font-size: 1.1em;">Generate Clickable HTML (OB1)</button>
    <p style="font-size: 0.9em; color: #555;">Requires both Audio (WebM/Opus recommended) and Image Base64 data to be generated above.</p>
  </div>

  <!-- Test Link (Current Version - Keep As Is) -->
  <a href="https://audionals.com/OB1ModularApr25/TEST_Generated_HTML_FILES/Tester" class="button-link" target="_blank" rel="noopener noreferrer">
    Test Generated HTML Files Here
  </a>

</main>

</body>
</html>