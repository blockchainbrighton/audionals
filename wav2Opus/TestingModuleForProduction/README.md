# OB1 - Audional Art Player

## Overview

OB1 is a web-based application designed to present "Audional Art" – a combination of a static visual (image) with interactive audio playback. Users can click the main image to toggle audio looping and use a control panel or keyboard shortcuts to manipulate audio parameters like tempo, pitch, volume, and playback direction. The application also supports MIDI input for triggering samples at different pitches.

The core audio and image data are embedded directly into the `index.html` file as Base64 strings, making the application self-contained once loaded. The UI is dynamically built using JavaScript.

## Features

*   **Embedded Media:** Image and audio (Opus format) are embedded as Base64 strings.
*   **Interactive Playback:**
    *   Click the main image to toggle audio looping.
    *   "Play Once" button for a single playback.
    *   Toggle reverse playback.
*   **Audio Controls:**
    *   **Volume:** Adjust output volume.
    *   **Tempo (BPM):** Control the playback speed when looping (especially for 'one-shot' samples retriggered by the scheduler).
    *   **Pitch:** Adjust playback rate, affecting the perceived pitch.
    *   **Multiplier:** Subdivides the beat for faster retriggering of 'one-shot' samples in a loop.
*   **Keyboard Shortcuts:** Extensive shortcuts for all audio controls and playback actions.
*   **MIDI Input:** Connect a MIDI controller to play the sample at different pitches.
*   **Dynamic UI:** The user interface, including controls and metadata display, is generated by JavaScript.
*   **Responsive Design:** The layout adapts to different screen sizes.
*   **Info Panel:** A toggleable side panel displays keyboard shortcuts.
*   **Visual Feedback:** The main image briefly animates when audio is triggered.

## Getting Started

### Prerequisites

*   A modern web browser that supports:
    *   Web Audio API
    *   ES6 Modules (`<script type="module">`)
    *   Web MIDI API (for MIDI functionality)
*   A local web server (due to ES6 module usage and potential security restrictions with `file:///` URLs).

### Running Locally

1.  **Save Files:** Download all the provided files (`abbreviatedIndex.html`, `style.css`, `main.js`, `audioProcessor.js`, `uiUpdater.js`, `layout.js`, `keyboardShortcuts.js`, `midiHandler.js`, `utils.js`, and `imageAnimation.js` – see note below) into a single directory.
    *   **Note on `imageAnimation.js`**: The content for `imageAnimation.js` is provided at the very end of the prompt, after `uiUpdater.js`. Ensure this is saved as `imageAnimation.js`. There's a likely bug in `audioProcessor.js` where `triggerAnimation` is imported from `uiUpdater.js` instead of `imageAnimation.js`. For it to work as intended, you might need to change `import { showError, triggerAnimation } from './uiUpdater.js';` in `audioProcessor.js` to `import { triggerAnimation } from './imageAnimation.js';` and `import { showError } from './uiUpdater.js';`.
2.  **Serve Files:**
    *   Navigate to the directory in your terminal.
    *   If you have Node.js installed, you can use `npx http-server`:
        ```bash
        npx http-server
        ```
    *   Alternatively, use any simple web server (e.g., Python's `http.server`, VS Code's "Live Server" extension).
3.  **Open in Browser:**
    *   Open your web browser and navigate to the address provided by the web server (e.g., `http://localhost:8080/abbreviatedIndex.html`).

## Usage

### Main Interaction

*   **Click the Image:** Clicking the large central image will toggle the audio loop on or off.
*   **Controls Panel (Left Column):**
    *   **Title Bar:** Shows "OB1 - Audional Art". The "ℹ️" button toggles the visibility of the controls column and the reference/shortcuts column.
    *   **Audio Metadata:** Displays information about the embedded audio (Instrument, Note, Frequency). This is initially in the HTML but moved into the dynamically generated controls column.
    *   **Error Display:** Shows any operational errors.
    *   **Buttons:**
        *   `Play Once`: Plays the audio sample once.
        *   `Play Loop: On/Off`: Toggles looping of the audio.
        *   `Reverse: On/Off`: Toggles reverse playback.
    *   **Sliders:**
        *   `Volume`: Adjusts the master volume (0% to 150%).
        *   `Tempo`: Adjusts the Beats Per Minute (1 to 400 BPM). This primarily affects how often 'one-shot' samples are retriggered when looped.
        *   `Pitch`: Adjusts the playback rate (1% to 1000% of original pitch).
        *   `Multiplier`: Sets a schedule multiplier (x1 to x8). When looping 'one-shot' samples, this divides the beat, causing the sample to trigger more frequently (e.g., x2 for 8th notes if tempo is for quarter notes).
    *   **MIDI Controls:**
        *   `MIDI In:`: A dropdown to select an available MIDI input device.
        *   `MIDI Status`: Displays the current status of MIDI connection.
*   **Reference Panel (Right Column):**
    *   Provides a quick reference for all available keyboard shortcuts. This panel can be toggled using the "ℹ️" button in the controls column.

### Keyboard Shortcuts

The application offers a rich set of keyboard shortcuts:

*   **Playback:**
    *   `Spacebar`: Play sample once.
    *   `R`: Toggle Reverse Playback.
    *   `I`: Toggle info/controls panels visibility.
*   **Volume & Mute:**
    *   `Arrow Up`: Increase Volume.
    *   `Arrow Down`: Decrease Volume.
    *   `M`: Toggle Mute/Unmute.
*   **Tempo (BPM):**
    *   `Shift + = / +`: Increase Tempo (+1 BPM).
    *   `Shift + - / _`: Decrease Tempo (-1 BPM).
    *   `Ctrl/Cmd + Shift + = / +`: Increase Tempo (+10 BPM).
    *   `Ctrl/Cmd + Shift + - / _`: Decrease Tempo (-10 BPM).
*   **Pitch / Playback Rate:**
    *   `Shift + ] / }`: Increase Pitch slightly.
    *   `Shift + [ / {`: Decrease Pitch slightly.
    *   `Ctrl/Cmd + Shift + ] / }`: Increase Pitch significantly (semitone up).
    *   `Ctrl/Cmd + Shift + [ / {`: Decrease Pitch significantly (semitone down).
    *   `=`: Double Current Pitch (x2).
    *   `-`: Halve Current Pitch (x0.5).
    *   `0`: Reset Pitch to 1.0x.
*   **Schedule Multiplier:**
    *   `1` through `7`: Set multiplier to 1, 2, 3, 4, 8, 16, 32 respectively.
    *   `8`: Sets multiplier to 8 (same as `5`).

*(Note: `Ctrl` can be `Cmd` on macOS for Tempo/Pitch shortcuts).*
Shortcuts are generally disabled if an input field, textarea, or select element is focused.

### MIDI Usage

1.  Connect a MIDI device to your computer.
2.  The application should attempt to auto-connect. If not, or if you have multiple devices, select your desired MIDI input device from the "MIDI In:" dropdown in the controls panel.
3.  Playing notes on your MIDI controller will trigger the audio sample. The pitch of the sample will be adjusted to match the MIDI note played, based on the original sample's frequency.

## Development

### Technology Stack

*   **HTML5:** Structure of the page.
*   **CSS3:** Styling and layout, including responsive design and animations.
*   **JavaScript (ES6+ Modules):** Application logic, DOM manipulation, audio processing, event handling.
*   **Web Audio API:** For all audio decoding, processing, and playback.
*   **Web MIDI API:** For MIDI input handling.

### Project Structure

*   `abbreviatedIndex.html`: The main entry point. Contains embedded Base64 image and audio data, and loads CSS and the main JavaScript module.
*   `style.css`: All CSS rules for styling the application, including layout, responsiveness, and animations.
*   `main.js`: The main application script. Initializes the UI, audio, MIDI, and keyboard shortcuts. Sets up event listeners and orchestrates the different modules.
*   `layout.js`: Responsible for dynamically building the HTML structure of the application (controls column, image area, reference panel).
*   `audioProcessor.js`: Handles all audio-related tasks:
    *   Decoding Base64 audio data.
    *   Playing samples (once or looped).
    *   Reversing audio.
    *   Managing tempo, pitch, and volume.
    *   Contains an internal `timingManager` for precise scheduling of looped 'one-shot' samples and managing the loop start time and multiplier.
    *   Determines `sampleType` ('one-shot' or 'loop') from a (currently missing in `abbreviatedIndex.html`) HTML element `#audio-meta-sample-type`. If this element is missing, it defaults to 'one-shot'.
*   `uiUpdater.js`: A collection of functions to update various parts of the UI (e.g., button text, slider value displays, error messages, image source).
*   `keyboardShortcuts.js`: Manages all keyboard input for controlling application features.
*   `midiHandler.js`: Initializes and manages MIDI input, device selection, and message handling.
*   `utils.js`: Utility functions (e.g., `base64ToArrayBuffer`, `clamp`, `createElement`, `_isInputFocused`).
*   `imageAnimation.js`: Contains logic to trigger a CSS animation on the main image when audio plays.

### Core Logic Flow: Clicking Image to Play Audio

1.  **Setup (`main.js`):**
    *   `bootstrap()` is called on DOM ready.
    *   `buildLayout(appContainer)` (from `layout.js`) constructs the UI, including the main image (`#main-image`).
    *   `initializeApp()`:
        *   Finds UI elements.
        *   Initializes `audioProcessor.js` with embedded audio data.
        *   `setupEventListeners()` attaches a `click` listener to `#main-image` that calls `handleLoopToggle`.
2.  **User Click on Image:**
    *   The `click` event on `#main-image` triggers `handleLoopToggle()` in `main.js`.
3.  **`handleLoopToggle()` (`main.js`):**
    *   Checks the current looping state via `audio.getLoopingState()`.
    *   Calls `audio.resumeContext()` to ensure the `AudioContext` is active (required by browsers for user-initiated audio).
    *   Calls either `audio.startLoop()` or `audio.stopLoop()` from `audioProcessor.js`.
    *   Updates the loop button text via `ui.updateLoopButton()`.
4.  **`audio.startLoop()` (`audioProcessor.js`):**
    *   Ensures `AudioContext` is ready.
    *   If `sampleType` is 'one-shot' (default if `#audio-meta-sample-type` is missing/misconfigured):
        *   It uses its internal `timingManager` to schedule repeated playback. `timingManager.startLoop(callback)` is called, where the `callback` is a function `time => _play(_selectBuffer(), time, currentGlobalPitch, false, true)`.
        *   The `timingManager` then repeatedly calls this callback at intervals determined by `currentTempo` and `scheduleMultiplier`.
    *   If `sampleType` is 'loop':
        *   It starts a silent scheduler via `timingManager.startLoop(() => {})`.
        *   It then calls `_play(_selectBuffer(), startTime, currentGlobalPitch, true, false)` once. The `true` for loop in `_play` tells the `AudioBufferSourceNode` to loop natively.
5.  **`_play()` (`audioProcessor.js`):**
    *   Creates an `AudioBufferSourceNode`.
    *   Assigns the decoded (and potentially reversed) audio buffer to it.
    *   Sets its `playbackRate.value` based on `currentGlobalPitch`.
    *   If `loop` is true (for `sampleType === 'loop'`), sets `source.loop = true`.
    *   Connects the source to `mainGainNode` (which controls volume).
    *   Calls `triggerAnimation()` (from `imageAnimation.js`, though currently mis-imported via `uiUpdater.js`) to animate the image.
    *   Starts playback via `source.start(time)`.
6.  **Image Animation (`imageAnimation.js`):**
    *   `triggerAnimation()` adds a CSS class (`.shake-all-directions-animation`) to the main image.
    *   `style.css` defines this class with a keyframe animation.
    *   A `setTimeout` removes the class after the animation duration.

### Modifying Embedded Media

To change the image or audio:

1.  **Get Base64 Data:**
    *   **Image:** Convert your desired image (e.g., JPEG, PNG) to a Base64 string. Many online converters are available.
    *   **Audio:** Convert your audio file to Opus format first (e.g., using FFmpeg or Audacity), then convert the Opus file to a Base64 string.
2.  **Update `abbreviatedIndex.html`:**
    *   Replace the content of `const imageBase64 = \`...\`;` with your new image Base64 string (without the `data:image/...;base64,` prefix, as the code adds it if missing, but it's safer to provide just the raw Base64 part).
    *   Replace the content of `const audioBase64_Opus = \`...\`;` with your new Opus audio Base64 string (similarly, raw Base64 is fine).
3.  **Update Audio Metadata (Optional but Recommended):**
    *   In `abbreviatedIndex.html`, update the content of these `<span>` elements within the `div.audio-metadata` if your new audio has different properties:
        *   `<span id="audio-meta-instrument">...</span>`
        *   `<span id="audio-meta-note">...</span>`
        *   `<span id="audio-meta-frequency">...</span>` (This is crucial for MIDI pitch calculations)
    *   **Important for Looping:** To enable native Web Audio looping for samples that are designed to loop seamlessly, you would add an element like `<span id="audio-meta-sample-type" style="display:none;">loop</span>` within the `#app` div in `abbreviatedIndex.html`. If this element is missing or its content is not "loop", `audioProcessor.js` will treat the sample as 'one-shot' and use its internal scheduler for looping, which re-triggers the entire sample.

## Potential Improvements / Future Work

*   **Build Process:** Implement a build process (e.g., using Webpack, Rollup, or Parcel) for bundling, minification, and managing dependencies.
*   **Error Handling:** More robust error handling and user feedback.
*   **State Management:** For a larger application, consider a more formal state management solution.
*   **Dynamic Media Loading:** Allow users to upload their own image and audio files instead of hardcoding Base64.
*   **Visualizations:** Integrate WebGL or Canvas API for dynamic audio visualizations.
*   **Testing:** Add unit and integration tests.
*   **Accessibility:** Further review and improve accessibility (ARIA attributes, focus management).
*   **Fix `triggerAnimation` import:** Correct the import path for `triggerAnimation` in `audioProcessor.js` to point to `imageAnimation.js`.
*   **Clarify `sampleType` setup:** Ensure `audio-meta-sample-type` element is correctly documented and its placement in `abbreviatedIndex.html` is clear for developers wanting to use native looping.

## License

