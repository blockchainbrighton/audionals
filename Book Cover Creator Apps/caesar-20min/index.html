<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Studio Canvas: Poster & Book Designer</title>
<style>
  :root {
    --primary: #6366f1;
    --primary-hover: #4f46e5;
    --bg-gradient: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
    --panel-bg: rgba(30, 41, 59, 0.7);
    --border: rgba(255, 255, 255, 0.1);
  }

  * { margin:0; padding:0; box-sizing:border-box; }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-gradient);
    color: white;
    min-height: 100vh;
    overflow-x: hidden;
  }

  .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

  /* Header & Top Bar */
  .header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 30px; 
    background: var(--panel-bg);
    padding: 15px 30px;
    border-radius: 16px;
    border: 1px solid var(--border);
    backdrop-filter: blur(10px);
  }
  
  .brand h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.5px; }
  .brand span { color: var(--primary); }

  .mode-switch {
    display: flex;
    background: rgba(0,0,0,0.3);
    padding: 4px;
    border-radius: 8px;
  }
  
  .mode-btn {
    padding: 8px 20px;
    border: none;
    background: transparent;
    color: #94a3b8;
    cursor: pointer;
    border-radius: 6px;
    font-weight: 600;
    transition: all 0.2s;
  }
  
  .mode-btn.active {
    background: var(--primary);
    color: white;
    box-shadow: 0 2px 10px rgba(99, 102, 241, 0.3);
  }

  /* Main Layout */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 30px;
    height: calc(100vh - 140px);
  }

  /* Canvas Area */
  .canvas-section {
    background: var(--panel-bg);
    border: 1px solid var(--border);
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }

  .canvas-wrapper {
    position: relative;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  }

  .canvas {
    position: relative;
    background-color: #eee;
    background-size: cover;
    background-position: center;
    overflow: hidden;
    cursor: crosshair;
  }

  /* Aspect Ratios */
  /* Poster: 2:3 Landscape */
  .canvas-wrapper.mode-poster .canvas {
    width: 600px;
    height: 400px;
  }
  
  /* Book: 6:9 Portrait */
  .canvas-wrapper.mode-book .canvas {
    width: 400px;
    height: 600px;
  }

  /* Visual Polish for Book Mode */
  .canvas-wrapper.mode-book::before {
    content: '';
    position: absolute;
    top: 0; left: 0; bottom: 0; width: 10px;
    background: linear-gradient(to right, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
    z-index: 50;
    pointer-events: none;
  }
  
  .canvas-wrapper.mode-book::after {
    content: '';
    position: absolute;
    top: 0; left: 10px; bottom: 0; width: 2px;
    background: rgba(0,0,0,0.2);
    z-index: 50;
    pointer-events: none;
  }

  /* Safe Zone Overlay (Toggleable) */
  .safe-zone {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    border: 12.5px solid rgba(255, 0, 100, 0.15); /* Approx 0.125in bleed + margin visual */
    border-radius: 2px;
    pointer-events: none;
    z-index: 100;
    display: none;
  }
  .safe-zone.visible { display: block; }
  .safe-zone::after {
    content: 'SAFE ZONE';
    position: absolute;
    top: 5px; right: 5px;
    font-size: 10px;
    color: rgba(255, 0, 100, 0.5);
    font-weight: bold;
  }

  /* Draggable Elements */
  .canvas-element {
    position: absolute;
    cursor: grab;
    user-select: none;
    transform: translate(-50%, -50%);
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }
  .canvas-element:active { cursor: grabbing; }

  /* Sidebar */
  .controls-section {
    display: flex;
    flex-direction: column;
    gap: 20px;
    overflow-y: auto;
    padding-right: 5px;
  }

  /* File Loader */
  .loader-box {
    background: linear-gradient(45deg, var(--primary), #ec4899);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
  }
  .loader-btn {
    background: white;
    color: var(--primary);
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: transform 0.2s;
  }
  .loader-btn:hover { transform: translateY(-2px); }

  /* Asset Grid */
  .asset-group h3 { 
    font-size: 0.9rem; 
    text-transform: uppercase; 
    letter-spacing: 1px; 
    color: #94a3b8; 
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
  }
  
  .asset-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 10px;
    max-height: 200px;
    overflow-y: auto;
    background: rgba(0,0,0,0.2);
    padding: 10px;
    border-radius: 8px;
  }

  .asset-item {
    aspect-ratio: 1;
    background: #334155;
    border-radius: 6px;
    cursor: pointer;
    overflow: hidden;
    border: 2px solid transparent;
    transition: all 0.2s;
  }
  
  .asset-item:hover { border-color: var(--primary); }
  .asset-item img { width: 100%; height: 100%; object-fit: cover; }

  /* Sliders */
  .slider-group {
    background: var(--panel-bg);
    padding: 15px;
    border-radius: 12px;
    border: 1px solid var(--border);
  }
  .slider-row { margin-bottom: 15px; }
  .slider-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
  input[type=range] { width: 100%; accent-color: var(--primary); }

  /* Footer Controls */
  .canvas-toolbar {
    position: absolute;
    bottom: 20px;
    display: flex;
    gap: 10px;
    background: rgba(0,0,0,0.6);
    padding: 8px;
    border-radius: 50px;
    backdrop-filter: blur(5px);
  }
  
  .tool-btn {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.2);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
  }
  .tool-btn:hover { background: rgba(255,255,255,0.1); }

  /* Utility */
  .hidden { display: none !important; }
  
  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

</style>
</head>
<body>

<div class="container">
  <header class="header">
    <div class="brand">
      <h1>STUDIO<span>CANVAS</span></h1>
    </div>
    <div class="mode-switch">
      <button class="mode-btn active" onclick="setMode('poster')">Poster Mode</button>
      <button class="mode-btn" onclick="setMode('book')">Book Mode</button>
    </div>
  </header>

  <div class="main-grid">
    
    <!-- Left: Canvas Area -->
    <div class="canvas-section">
      <div id="canvasWrapper" class="canvas-wrapper mode-poster">
        <div id="canvas" class="canvas">
          <div id="safeZone" class="safe-zone"></div>
          
          <!-- Poster Elements -->
          <img id="poster-text" class="canvas-element mode-specific mode-poster-el" src="" alt="Text" style="top:20%; left:50%; width:300px; display:block;">
          <img id="poster-char" class="canvas-element mode-specific mode-poster-el" src="" alt="Character" style="top:60%; left:50%; width:250px; display:block;">
          
          <!-- Book Elements -->
          <img id="book-title" class="canvas-element mode-specific mode-book-el" src="" alt="Title" style="top:15%; left:50%; width:300px; display:none;">
          <img id="book-author" class="canvas-element mode-specific mode-book-el" src="" alt="Author" style="bottom:15%; left:50%; width:200px; display:none;">
        </div>
      </div>

      <div class="canvas-toolbar">
        <button class="tool-btn" onclick="toggleSafeZone()" title="Toggle Safe Zone Guides">üìè</button>
        <button class="tool-btn" onclick="resetLayout()" title="Reset Layout">‚Üª</button>
        <button class="tool-btn" style="background: var(--primary); border:none;" onclick="downloadCanvas()" title="Download">‚¨á</button>
      </div>
    </div>

    <!-- Right: Controls -->
    <div class="controls-section">
      
      <!-- Project Loader -->
      <div class="loader-box">
        <label class="loader-btn">
          üìÅ Load Project Folder
          <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none">
        </label>
        <p style="font-size:0.8rem; margin-top:8px; opacity:0.8;">Select folder containing: covers, titles, authors, backgrounds...</p>
      </div>

      <!-- Dynamic Asset Lists -->
      <div id="assetContainer">
        <!-- Poster Assets -->
        <div id="group-poster" class="mode-group">
          <div class="asset-group">
            <h3>Backgrounds <span id="count-backgrounds">0</span></h3>
            <div class="asset-grid" id="list-backgrounds"></div>
          </div>
          <div class="asset-group" style="margin-top:20px">
            <h3>Characters <span id="count-characters">0</span></h3>
            <div class="asset-grid" id="list-characters"></div>
          </div>
          <div class="asset-group" style="margin-top:20px">
            <h3>Text Styles <span id="count-text">0</span></h3>
            <div class="asset-grid" id="list-text"></div>
          </div>
        </div>

        <!-- Book Assets -->
        <div id="group-book" class="mode-group hidden">
          <div class="asset-group">
            <h3>Covers <span id="count-covers">0</span></h3>
            <div class="asset-grid" id="list-covers"></div>
          </div>
          <div class="asset-group" style="margin-top:20px">
            <h3>Titles <span id="count-titles">0</span></h3>
            <div class="asset-grid" id="list-titles"></div>
          </div>
          <div class="asset-group" style="margin-top:20px">
            <h3>Authors <span id="count-authors">0</span></h3>
            <div class="asset-grid" id="list-authors"></div>
          </div>
        </div>
      </div>

      <!-- Size Sliders -->
      <div class="slider-group">
        <h3>Adjust Sizes</h3>
        <div class="slider-row">
          <div class="slider-header"><span>Element A (Title/Text)</span></div>
          <input type="range" min="20" max="200" value="100" oninput="resizeElement('A', this.value)">
        </div>
        <div class="slider-row">
          <div class="slider-header"><span>Element B (Author/Char)</span></div>
          <input type="range" min="20" max="200" value="100" oninput="resizeElement('B', this.value)">
        </div>
      </div>

    </div>
  </div>
</div>

<script>
// --- State ---
let currentMode = 'poster'; // 'poster' or 'book'
const assets = {
  poster: { backgrounds: [], characters: [], text: [] },
  book: { covers: [], titles: [], authors: [] }
};

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
  // Setup Dragging for all potential elements
  enableDrag(document.getElementById('poster-text'));
  enableDrag(document.getElementById('poster-char'));
  enableDrag(document.getElementById('book-title'));
  enableDrag(document.getElementById('book-author'));
  
  // Initialize Background Dragging (Panning)
  initBackgroundDrag();

  // Folder Loader Listener
  document.getElementById('folderInput').addEventListener('change', handleFolderLoad);
});

// --- Mode Switching ---
function setMode(mode) {
  currentMode = mode;
  
  // Update UI Buttons
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');

  // Update Canvas Shape & Elements
  const wrapper = document.getElementById('canvasWrapper');
  const posterEls = document.querySelectorAll('.mode-poster-el');
  const bookEls = document.querySelectorAll('.mode-book-el');
  const posterGroup = document.getElementById('group-poster');
  const bookGroup = document.getElementById('group-book');

  if (mode === 'book') {
    wrapper.classList.remove('mode-poster');
    wrapper.classList.add('mode-book');
    posterEls.forEach(el => el.style.display = 'none');
    bookEls.forEach(el => el.style.display = 'block');
    posterGroup.classList.add('hidden');
    bookGroup.classList.remove('hidden');
  } else {
    wrapper.classList.remove('mode-book');
    wrapper.classList.add('mode-poster');
    posterEls.forEach(el => el.style.display = 'block');
    bookEls.forEach(el => el.style.display = 'none');
    posterGroup.classList.remove('hidden');
    bookGroup.classList.add('hidden');
  }
}

// --- File Handling (The Magic) ---
function handleFolderLoad(e) {
  const files = e.target.files;
  // Reset assets
  assets.poster = { backgrounds: [], characters: [], text: [] };
  assets.book = { covers: [], titles: [], authors: [] };

  // Scan files
  Array.from(files).forEach(file => {
    // webkitRelativePath looks like "ProjectFolder/covers/image.png"
    const path = file.webkitRelativePath.toLowerCase();
    const validImage = /\.(png|jpg|jpeg|webp)$/i.test(path);
    
    if (!validImage) return;

    const url = URL.createObjectURL(file);

    // Mapping Logic
    if (path.includes('/backgrounds/') || path.includes('/posters/')) {
      assets.poster.backgrounds.push(url);
    } else if (path.includes('/characters/')) {
      assets.poster.characters.push(url);
    } else if (path.includes('/text/')) {
      assets.poster.text.push(url);
    } else if (path.includes('/covers/')) {
      assets.book.covers.push(url);
    } else if (path.includes('/titles/')) {
      assets.book.titles.push(url);
    } else if (path.includes('/authors/')) {
      assets.book.authors.push(url);
    }
  });

  renderAssetLists();
}

function renderAssetLists() {
  // Helper to fill a grid
  const fill = (listId, countId, items, onClick) => {
    const container = document.getElementById(listId);
    document.getElementById(countId).innerText = items.length;
    container.innerHTML = '';
    items.forEach(src => {
      const div = document.createElement('div');
      div.className = 'asset-item';
      const img = document.createElement('img');
      img.src = src;
      div.appendChild(img);
      div.onclick = () => onClick(src);
      container.appendChild(div);
    });
  };

  // Poster Lists
  fill('list-backgrounds', 'count-backgrounds', assets.poster.backgrounds, (src) => setBackground(src));
  fill('list-characters', 'count-characters', assets.poster.characters, (src) => document.getElementById('poster-char').src = src);
  fill('list-text', 'count-text', assets.poster.text, (src) => document.getElementById('poster-text').src = src);

  // Book Lists
  fill('list-covers', 'count-covers', assets.book.covers, (src) => setBackground(src));
  fill('list-titles', 'count-titles', assets.book.titles, (src) => document.getElementById('book-title').src = src);
  fill('list-authors', 'count-authors', assets.book.authors, (src) => document.getElementById('book-author').src = src);
}

// --- Canvas Operations ---
function setBackground(src) {
  const canvas = document.getElementById('canvas');
  canvas.style.backgroundImage = `url(${src})`;
  // Reset background position
  canvas.style.backgroundPosition = 'center';
  canvas.style.backgroundSize = 'cover';
}

function resizeElement(target, value) {
  // Maps sliders to specific elements based on active mode
  let elA, elB;
  if (currentMode === 'poster') {
    elA = document.getElementById('poster-text');
    elB = document.getElementById('poster-char');
  } else {
    elA = document.getElementById('book-title');
    elB = document.getElementById('book-author');
  }
  
  // Base sizes
  const baseSizes = { 
    'poster-text': 300, 'poster-char': 250,
    'book-title': 300, 'book-author': 200
  };

  if (target === 'A' && elA) {
    const base = baseSizes[elA.id] || 200;
    elA.style.width = (base * (value / 100)) + 'px';
  } else if (target === 'B' && elB) {
    const base = baseSizes[elB.id] || 200;
    elB.style.width = (base * (value / 100)) + 'px';
  }
}

function toggleSafeZone() {
  document.getElementById('safeZone').classList.toggle('visible');
}

function resetLayout() {
  const canvas = document.getElementById('canvas');
  canvas.style.backgroundPosition = 'center';
  
  if (currentMode === 'poster') {
    const txt = document.getElementById('poster-text');
    const char = document.getElementById('poster-char');
    txt.style.top = '20%'; txt.style.left = '50%';
    char.style.top = '60%'; char.style.left = '50%';
  } else {
    const title = document.getElementById('book-title');
    const author = document.getElementById('book-author');
    title.style.top = '15%'; title.style.left = '50%';
    author.style.bottom = '15%'; author.style.left = '50%'; author.style.top = 'auto';
  }
}

// --- Interaction Logic ---
function enableDrag(element) {
  let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  element.onmousedown = dragMouseDown;

  function dragMouseDown(e) {
    e.preventDefault();
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e.preventDefault();
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    
    // Calculate percentage positions to keep responsive
    const parent = element.parentElement;
    const newTop = (element.offsetTop - pos2);
    const newLeft = (element.offsetLeft - pos1);
    
    element.style.top = newTop + "px";
    element.style.left = newLeft + "px";
  }

  function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
  }
}

// Background Panning
function initBackgroundDrag() {
  const canvas = document.getElementById('canvas');
  let isDragging = false;
  let startX, startY;
  let bgPosX = 50, bgPosY = 50; // Percentages

  canvas.addEventListener('mousedown', (e) => {
    if (e.target !== canvas && e.target.id !== 'safeZone') return; // Don't drag if clicking an element
    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    
    // Parse current background position if set
    const style = window.getComputedStyle(canvas);
    const pos = style.backgroundPosition.split(' ');
    // Simple parse handling
    if(pos.length === 2) {
      if(pos.includes('%')) bgPosX = parseFloat(pos);
      if(pos[1].includes('%')) bgPosY = parseFloat(pos[1]);
    }
  });

  window.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    
    // Sensitivity factor
    const speed = 0.2;
    
    bgPosX += dx * speed;
    bgPosY += dy * speed;
    
    // Clamp 0-100
    bgPosX = Math.min(100, Math.max(0, bgPosX));
    bgPosY = Math.min(100, Math.max(0, bgPosY));

    canvas.style.backgroundPosition = `${bgPosX}% ${bgPosY}%`;
    
    startX = e.clientX;
    startY = e.clientY;
  });

  window.addEventListener('mouseup', () => { isDragging = false; });
}

// --- Download Logic ---
function downloadCanvas() {
  const canvasDiv = document.getElementById('canvas');
  const width = currentMode === 'book' ? 1800 : 2700;
  const height = currentMode === 'book' ? 2700 : 1800;
  
  const c = document.createElement('canvas');
  c.width = width;
  c.height = height;
  const ctx = c.getContext('2d');

  // 1. Draw Background
  const bgUrl = window.getComputedStyle(canvasDiv).backgroundImage.slice(5, -2);
  const bgImg = new Image();
  bgImg.crossOrigin = "anonymous";
  
  bgImg.onload = () => {
    // Background drawing math (simulating 'cover' + 'position')
    const bgRatio = bgImg.width / bgImg.height;
    const canvasRatio = width / height;
    let drawW, drawH, offsetX, offsetY;

    if (bgRatio > canvasRatio) {
      drawH = height;
      drawW = height * bgRatio;
    } else {
      drawW = width;
      drawH = width / bgRatio;
    }

    // Parse background position percentages
    const style = window.getComputedStyle(canvasDiv);
    let pos = style.backgroundPosition.split(' ');
    let posX = parseFloat(pos) || 50;
    let posY = parseFloat(pos[1]) || 50;

    offsetX = (width - drawW) * (posX / 100);
    offsetY = (height - drawH) * (posY / 100);

    ctx.drawImage(bgImg, offsetX, offsetY, drawW, drawH);

    // 2. Draw Elements
    const elements = currentMode === 'poster' 
      ? [document.getElementById('poster-text'), document.getElementById('poster-char')]
      : [document.getElementById('book-title'), document.getElementById('book-author')];

    let loadedCount = 0;
    
    // Helper to finish download
    const finish = () => {
      const link = document.createElement('a');
      link.download = `studio-export-${currentMode}.png`;
      link.href = c.toDataURL('image/png');
      link.click();
    };

    if (elements.length === 0) finish();

    elements.forEach(el => {
      if (el.style.display === 'none' || !el.src) {
        loadedCount++;
        if (loadedCount === elements.length) finish();
        return;
      }

      const img = new Image();
      img.crossOrigin = "anonymous";
      img.src = el.src;
      img.onload = () => {
        // Map DOM position to Canvas position
        const rect = el.getBoundingClientRect();
        const parentRect = canvasDiv.getBoundingClientRect();
        
        const scaleX = width / parentRect.width;
        const scaleY = height / parentRect.height;

        const x = (rect.left - parentRect.left) * scaleX;
        const y = (rect.top - parentRect.top) * scaleY;
        const w = rect.width * scaleX;
        const h = rect.height * scaleY;

        ctx.drawImage(img, x, y, w, h);
        
        loadedCount++;
        if (loadedCount === elements.length) finish();
      };
    });
  };
  
  if (bgUrl) bgImg.src = bgUrl;
  else alert("Please select a background/cover first.");
}
</script>
</body>
</html>
