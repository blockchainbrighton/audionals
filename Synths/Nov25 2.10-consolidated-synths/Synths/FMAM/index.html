<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FM / AM</title>
    <style>
        :root {
            --bg-dark: #121216;
            --bg-panel: #1e1e24;
            --accent-main: #00d4ff;
            --accent-glow: #00d4ff88;
            --accent-sec: #d900ff;
            --text-main: #e0e0e0;
            --text-dim: #777;
            --knob-size: 50px;
            /* Keyboard Colors */
            --key-white: #fffff0;
            --key-black: #111;
        }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            user-select: none;
        }

        /* --- LOADER --- */
        #loader-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }
        
        .loader-spinner {
            width: 40px; height: 40px;
            border: 4px solid var(--accent-main);
            border-top: 4px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #start-btn {
            padding: 15px 40px;
            background: var(--accent-main);
            color: var(--bg-dark);
            border: none;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            display: none;
            box-shadow: 0 0 20px var(--accent-glow);
        }

        /* --- MAIN UI --- */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            opacity: 0;
            transition: opacity 1s;
        }

        header {
            height: 50px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            background: #000;
        }

        h1 { margin: 0; font-size: 1.2rem; color: var(--accent-main); text-shadow: 0 0 5px var(--accent-glow); }
        
        .status-bar { font-size: 0.8rem; color: var(--text-dim); display: flex; gap: 15px; }
        .led { width: 10px; height: 10px; background: #333; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .led.active { background: var(--accent-sec); box-shadow: 0 0 8px var(--accent-sec); }

        /* --- SYNTH PANEL --- */
        #synth-panel {
            flex: 1;
            display: grid;
            grid-template-columns: 200px 1fr 250px; /* Preset/Vis | Controls | Master/FX */
            gap: 2px;
            background: #000;
            overflow: hidden;
        }

        .panel-section {
            background: var(--bg-panel);
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .control-group {
            border: 1px solid #333;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .group-title {
            font-size: 0.7rem; color: var(--accent-main); margin-bottom: 10px;
            text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 2px;
        }

        /* PRESETS LIST */
        #preset-list { list-style: none; padding: 0; margin: 0; }
        .preset-item {
            padding: 8px; border-bottom: 1px solid #333; cursor: pointer; font-size: 0.8rem;
            transition: background 0.2s;
        }
        .preset-item:hover { background: #333; }
        .preset-item.active { color: var(--accent-main); border-left: 3px solid var(--accent-main); background: #222; }

        /* KNOBS & SLIDERS */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px;
        }

        .knob-container {
            display: flex; flex-direction: column; align-items: center;
        }
        
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            border-radius: 50%;
            background: var(--accent-main);
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #444; border-radius: 2px;
        }

        .knob-label { font-size: 0.7rem; margin-top: 5px; text-align: center; color: #aaa; }
        .knob-val { font-size: 0.6rem; color: var(--accent-main); }

        /* VISUALIZER */
        #visualizer-container {
            width: 100%; height: 120px;
            background: #000;
            margin-bottom: 10px;
            border: 1px solid #333;
            position: relative;
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* --- IMPROVED KEYBOARD CSS --- */
        #keyboard-container {
            /* Layout handled by shared module */
            margin-top: 10px;
            border-top: 4px solid #000;
        }

        /* Responsive Tweaks */
        @media (max-width: 800px) {
            #synth-panel { grid-template-columns: 1fr; overflow-y: scroll; }
            #visualizer-container { display: none; }
        }
    </style>
</head>
<body>

    <!-- LOADER -->
    <div id="loader-overlay">
        <div class="loader-spinner" id="spinner"></div>
        <div id="loader-text">Initializing Web3 Audio...</div>
        <button id="start-btn">BOOT SYSTEM</button>
    </div>

    <!-- MAIN APP -->
    <div id="app-container">
        <header>
            <h1>FM / AM <span style="font-size:0.7em; color:#777;">// DX POLY // v1.2</span></h1>
            <div class="status-bar">
                <div><span class="led" id="midi-led"></span>MIDI</div>
                <div><span class="led" id="voice-led"></span>VOICE</div>
                <div id="cpu-load">CPU: --%</div>
            </div>
        </header>

        <div id="synth-panel">
            
            <!-- LEFT: PRESETS & VISUALS -->
            <div class="panel-section" style="border-right: 1px solid #000;">
                <div id="visualizer-container"></div>
                <div class="control-group">
                    <div class="group-title">PATCHES</div>
                    <ul id="preset-list">
                        <!-- Filled by JS -->
                    </ul>
                </div>
            </div>

            <!-- MIDDLE: SYNTH ENGINE -->
            <div class="panel-section">
                
                <!-- FM OPERATORS -->
                <div class="control-group">
                    <div class="group-title">FM OPERATORS & TIMBRE</div>
                    <div class="controls-grid">
                        <div class="knob-container">
                            <input type="range" id="harmonicity" min="0.1" max="10" step="0.1" value="1">
                            <span class="knob-label">RATIO</span>
                            <span class="knob-val" id="val-harmonicity">1.0</span>
                        </div>
                        <div class="knob-container">
                            <input type="range" id="modIndex" min="0" max="50" step="0.1" value="10">
                            <span class="knob-label">INDEX</span>
                            <span class="knob-val" id="val-modIndex">10</span>
                        </div>
                        <div class="knob-container">
                            <input type="range" id="detune" min="-100" max="100" value="0">
                            <span class="knob-label">DETUNE</span>
                            <span class="knob-val" id="val-detune">0</span>
                        </div>
                    </div>
                </div>

                <!-- ENVELOPES -->
                <div class="control-group">
                    <div class="group-title">ENVELOPES (AMP & MOD)</div>
                    <div class="controls-grid">
                        <div class="knob-container">
                            <input type="range" id="envAttack" min="0.001" max="2" step="0.01" value="0.01">
                            <span class="knob-label">ATTACK</span>
                        </div>
                        <div class="knob-container">
                            <input type="range" id="envDecay" min="0.1" max="5" step="0.1" value="0.5">
                            <span class="knob-label">DECAY</span>
                        </div>
                        <div class="knob-container">
                            <input type="range" id="envSustain" min="0" max="1" step="0.01" value="0.5">
                            <span class="knob-label">SUSTAIN</span>
                        </div>
                        <div class="knob-container">
                            <input type="range" id="envRelease" min="0.1" max="5" step="0.1" value="1">
                            <span class="knob-label">RELEASE</span>
                        </div>
                    </div>
                </div>

                <!-- FILTER -->
                <div class="control-group">
                    <div class="group-title">FILTER (POST FM)</div>
                    <div class="controls-grid">
                        <div class="knob-container">
                            <input type="range" id="cutoff" min="100" max="5000" step="10" value="2000">
                            <span class="knob-label">CUTOFF</span>
                        </div>
                        <div class="knob-container">
                            <input type="range" id="resonance" min="0" max="20" step="0.5" value="1">
                            <span class="knob-label">RES</span>
                        </div>
                    </div>
                </div>

            </div>

            <!-- RIGHT: FX & GLOBAL -->
            <div class="panel-section" style="border-left: 1px solid #000;">
                
                <div class="control-group">
                    <div class="group-title">GLOBAL</div>
                    <div class="knob-container">
                        <input type="range" id="bpm" min="60" max="180" value="120">
                        <span class="knob-label">BPM</span>
                        <span class="knob-val" id="val-bpm">120</span>
                    </div>
                    <div class="knob-container" style="margin-top:10px;">
                        <input type="range" id="masterVol" min="-60" max="0" value="-10">
                        <span class="knob-label">VOLUME</span>
                    </div>
                </div>

                <div class="control-group">
                    <div class="group-title">EFFECTS CHAIN</div>
                    
                    <!-- Chorus -->
                    <div class="knob-container">
                        <span class="knob-label">CHORUS DEPTH</span>
                        <input type="range" id="chorusDepth" min="0" max="1" step="0.01" value="0">
                    </div>

                    <!-- Tremolo -->
                    <div class="knob-container" style="margin-top:5px">
                        <span class="knob-label">TREMOLO RATE (Sync)</span>
                        <input type="range" id="tremoloRate" min="1" max="16" step="1" value="4">
                        <span class="knob-val" id="val-tremoloRate">4n</span>
                    </div>

                    <!-- Delay -->
                    <div class="knob-container" style="margin-top:5px">
                        <span class="knob-label">DELAY MIX</span>
                        <input type="range" id="delayWet" min="0" max="1" step="0.01" value="0">
                    </div>

                    <!-- Reverb -->
                    <div class="knob-container" style="margin-top:5px">
                        <span class="knob-label">REVERB MIX</span>
                        <input type="range" id="reverbWet" min="0" max="1" step="0.01" value="0.2">
                    </div>
                </div>

            </div>
        </div>

        <!-- NEW KEYBOARD CONTAINER -->
        <div id="keyboard-container">
            <!-- Generated by JS -->
        </div>
        <div style="text-align:center; font-size: 0.7rem; color: #555; padding-bottom:5px;">Click & Drag keys for Glissando</div>
    </div>

    <script type="module">
        import { SynthKeyboard } from '../../shared/keyboard.js';
        // ========================================================
        // 1. STATE & UTILS
        // ========================================================
        const runtimeState = {
            Tone: null,
            THREE: null,
            audioCtx: null,
            synth: null,
            fx: {
                filter: null,
                chorus: null,
                tremolo: null,
                delay: null,
                reverb: null,
                limiter: null
            },
            analyser: null,
            presets: [],
            currentPreset: 0,
            midiAccess: null,
            // Track active notes for glissando safety
            activeNotes: [] 
        };

        const setLoaderStatus = (msg, isError = false) => {
            const el = document.getElementById('loader-text');
            if (el) el.innerText = msg;
            if (isError) {
                if (el) el.style.color = '#ff4444';
                const s = document.getElementById('spinner');
                if (s) s.style.display = 'none';
            }
        };

        // ========================================================
        // 2. BLOCKCHAIN LOADERS
        // ========================================================
        
        function loadToneJSAndBoot({ 
            toneUrl = 'https://ordinals.com/content/04813d7748d918bd8a3069cb1823ebc9586f0ce16cd6a97a784581ec38d13062i0',
            setLoaderStatus,
            runtimeState,
            boot
        }) {
            setLoaderStatus('Loading Audio Engine...');
            import(toneUrl)
                .then(() => {
                    runtimeState.Tone = window.Tone;
                    console.log('[FM / AM] Tone.js loaded:', runtimeState.Tone?.version ?? 'Unknown');
                    
                    setLoaderStatus('Loading Visuals...');
                    loadThreeJS()
                        .then(three => {
                            runtimeState.THREE = three;
                            console.log('[FM / AM] Three.js loaded');
                        })
                        .catch(err => console.warn('Three.js failed (optional)', err))
                        .finally(() => {
                            setLoaderStatus('Ready');
                            const btn = document.getElementById('start-btn');
                            btn.style.display = 'block';
                            btn.onclick = () => {
                                document.getElementById('loader-overlay').style.opacity = 0;
                                setTimeout(() => {
                                    const el = document.getElementById('loader-overlay');
                                    if(el) el.remove();
                                }, 500);
                                document.getElementById('app-container').style.opacity = 1;
                                boot();
                            };
                        });
                })
                .catch(err => {
                    setLoaderStatus('Failed to load Tone.js. App cannot start.', true);
                    console.error('[FM / AM] Critical Tone.js load error:', err);
                });
        }

        function loadThreeJS(threeUrl = 'https://ordinals.com/content/0d013bb60fc5bf5a6c77da7371b07dc162ebc7d7f3af0ff3bd00ae5f0c546445i0') {
            return import(threeUrl).then(mod => window.THREE);
        }

        // ========================================================
        // 3. SYNTH ENGINE & FX
        // ========================================================
        
        async function setupAudio() {
            const T = runtimeState.Tone;
            await T.start(); // AudioContext resume
            T.context.lookAhead = 0;
            T.Transport.start(); // Start global clock

            // --- FX Chain ---
            const filter = new T.Filter({
                type: "lowpass",
                frequency: 2000,
                rolloff: -12,
                Q: 1
            });

            // Tremolo
            const tremolo = new T.Tremolo({
                frequency: "4n",
                depth: 0,
                spread: 0
            }).start();

            // Chorus
            const chorus = new T.Chorus({
                frequency: 1.5,
                delayTime: 3.5,
                depth: 0, // IMPORTANT: Standard property, not Signal
                feedback: 0.1,
                spread: 180
            }).start();

            // Delay
            const delay = new T.FeedbackDelay({
                delayTime: "8n.",
                feedback: 0.3,
                wet: 0
            });

            // Reverb
            const reverb = new T.Reverb({
                decay: 3,
                wet: 0.2,
                preDelay: 0.01
            });
            await reverb.generate();

            const limiter = new T.Limiter(-1);
            const master = new T.Volume(-10).toDestination();

            // --- FM Poly Synth ---
            const synth = new T.PolySynth(T.FMSynth, {
                maxPolyphony: 10,
                voice: {
                    harmonicity: 1,
                    modulationIndex: 10,
                    detune: 0,
                    oscillator: { type: "sine" },
                    modulation: { type: "sine" },
                    modulationEnvelope: { attack: 0.01, decay: 0.5, sustain: 1.0, release: 0.5 },
                    envelope: { attack: 0.01, decay: 0.5, sustain: 0.8, release: 1 }
                }
            });

            synth.chain(filter, tremolo, chorus, delay, reverb, limiter, master);

            const analyser = new T.Analyser("fft", 256);
            master.connect(analyser);

            runtimeState.synth = synth;
            runtimeState.fx = { filter, tremolo, chorus, delay, reverb, limiter, master };
            runtimeState.analyser = analyser;
        }

        // ========================================================
        // 4. PRESETS DATA
        // ========================================================
        const PRESETS = [
            {
                name: "Init EP",
                harmonicity: 1, modIndex: 5, detune: 0, cutoff: 3000,
                env: { attack: 0.01, decay: 0.3, sustain: 0.6, release: 1.0 },
                fx: { chorus: 0.2, reverb: 0.2, delay: 0, tremolo: 0 }
            },
            {
                name: "Classic DX",
                harmonicity: 14, modIndex: 2, detune: 5, cutoff: 5000,
                env: { attack: 0.001, decay: 0.4, sustain: 0.0, release: 0.4 },
                fx: { chorus: 0.5, reverb: 0.3, delay: 0.1, tremolo: 0 }
            },
            {
                name: "Glass Bells",
                harmonicity: 3.5, modIndex: 10, detune: 0, cutoff: 4000,
                env: { attack: 0.05, decay: 1, sustain: 0.4, release: 3 },
                fx: { chorus: 0.1, reverb: 0.6, delay: 0.3, tremolo: 0.5 }
            },
            {
                name: "Tine Keys",
                harmonicity: 4, modIndex: 15, detune: -2, cutoff: 1500,
                env: { attack: 0.005, decay: 0.5, sustain: 0.3, release: 0.5 },
                fx: { chorus: 0.4, reverb: 0.2, delay: 0, tremolo: 0.7 }
            },
            {
                name: "Digital Roads",
                harmonicity: 1, modIndex: 20, detune: 4, cutoff: 800,
                env: { attack: 0.01, decay: 0.5, sustain: 0.8, release: 0.8 },
                fx: { chorus: 0.8, reverb: 0.3, delay: 0.2, tremolo: 0.4 }
            },
            {
                name: "Lofi Warp",
                harmonicity: 0.5, modIndex: 40, detune: 20, cutoff: 600,
                env: { attack: 0.1, decay: 0.2, sustain: 1, release: 2 },
                fx: { chorus: 0, reverb: 0.1, delay: 0.4, tremolo: 0.9 }
            },
            {
                name: "Bright FM",
                harmonicity: 2, modIndex: 8, detune: 10, cutoff: 5000,
                env: { attack: 0.001, decay: 0.5, sustain: 0.5, release: 0.5 },
                fx: { chorus: 0.3, reverb: 0.2, delay: 0, tremolo: 0 }
            },
            {
                name: "Deep Pad",
                harmonicity: 1.01, modIndex: 3, detune: -10, cutoff: 1000,
                env: { attack: 1.5, decay: 1, sustain: 1, release: 3 },
                fx: { chorus: 0.5, reverb: 0.8, delay: 0.4, tremolo: 0.2 }
            }
        ];

        function loadPreset(index) {
            const p = PRESETS[index];
            if(!p) return;
            runtimeState.currentPreset = index;

            document.querySelectorAll('.preset-item').forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });

            // Synth Params
            runtimeState.synth.set({
                harmonicity: p.harmonicity,
                modulationIndex: p.modIndex,
                detune: p.detune,
                envelope: p.env,
                modulationEnvelope: p.env 
            });

            document.getElementById('harmonicity').value = p.harmonicity;
            document.getElementById('modIndex').value = p.modIndex;
            document.getElementById('detune').value = p.detune;
            
            document.getElementById('envAttack').value = p.env.attack;
            document.getElementById('envDecay').value = p.env.decay;
            document.getElementById('envSustain').value = p.env.sustain;
            document.getElementById('envRelease').value = p.env.release;

            // FX Params
            // Handle Signals vs Primitives safely
            const fx = runtimeState.fx;
            
            if(fx.filter.frequency.rampTo) fx.filter.frequency.rampTo(p.cutoff, 0.1);
            else fx.filter.frequency.value = p.cutoff;
            document.getElementById('cutoff').value = p.cutoff;

            // Chorus Depth is a plain property in this Tone version context
            fx.chorus.depth = p.fx.chorus; 
            document.getElementById('chorusDepth').value = p.fx.chorus;

            if(fx.tremolo.depth.rampTo) fx.tremolo.depth.rampTo(p.fx.tremolo, 0.1);
            else fx.tremolo.depth.value = p.fx.tremolo;

            if(fx.delay.wet.rampTo) fx.delay.wet.rampTo(p.fx.delay, 0.1);
            else fx.delay.wet.value = p.fx.delay;
            document.getElementById('delayWet').value = p.fx.delay;

            const rWet = p.fx.fx_reverb ?? p.fx.reverb;
            if(fx.reverb.wet.rampTo) fx.reverb.wet.rampTo(rWet, 0.1);
            else fx.reverb.wet.value = rWet;
            document.getElementById('reverbWet').value = rWet;

            updateLabels();
        }

        // ========================================================
        // 5. MIDI & NOTE HANDLING
        // ========================================================
        function setupMIDI() {
            if (navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess()
                    .then(access => {
                        runtimeState.midiAccess = access;
                        const inputs = access.inputs.values();
                        for (let input of inputs) {
                            input.onmidimessage = handleMIDIMessage;
                        }
                        access.onstatechange = (e) => {
                            if(e.port.type === 'input' && e.port.state === 'connected') {
                                e.port.onmidimessage = handleMIDIMessage;
                            }
                        }
                        console.log('[FM / AM] MIDI Connected');
                    })
                    .catch(e => console.log('MIDI not available', e));
            }
        }

        function handleMIDIMessage(msg) {
            const [status, data1, data2] = msg.data;
            const cmd = status >> 4;
            const note = data1;
            const velocity = data2;

            const led = document.getElementById('midi-led');
            if(led) {
                led.classList.add('active');
                setTimeout(() => led.classList.remove('active'), 100);
            }

            if (cmd === 9 && velocity > 0) { 
                noteOn(note, velocity / 127);
            } else if (cmd === 8 || (cmd === 9 && velocity === 0)) { 
                noteOff(note);
            } else if (cmd === 11) { 
                handleCC(data1, data2);
            }
        }

        // --- WRAPPERS FOR GLISSANDO/SAFETY ---

        function noteOn(midiNote, velocity = 1) {
            // Prevent stuck notes logic
            if(!runtimeState.activeNotes.includes(midiNote)) {
                runtimeState.activeNotes.push(midiNote);
                triggerNoteOn(midiNote, velocity);
                highlightKey(midiNote, true);
            }
        }

        function noteOff(midiNote) {
            runtimeState.activeNotes = runtimeState.activeNotes.filter(n => n !== midiNote);
            triggerNoteOff(midiNote);
            highlightKey(midiNote, false);
        }

        function highlightKey(midiNote, isActive) {
            if (runtimeState.keyboard) runtimeState.keyboard.triggerVisual(midiNote, isActive);
        }

        // --- AUDIO TRIGGERS ---

        function triggerNoteOn(midiNote, velocity) {
            const T = runtimeState.Tone;
            const freq = T.Frequency(midiNote, "midi");
            runtimeState.synth.triggerAttack(freq, T.now(), velocity);
            
            const vLed = document.getElementById('voice-led');
            if(vLed) vLed.classList.add('active');
        }

        function triggerNoteOff(midiNote) {
            const T = runtimeState.Tone;
            const freq = T.Frequency(midiNote, "midi");
            runtimeState.synth.triggerRelease(freq);
            
            // Just a visual check, polyphony makes this approximate for LEDs
            if(runtimeState.activeNotes.length === 0) {
                const vLed = document.getElementById('voice-led');
                if(vLed) vLed.classList.remove('active');
            }
        }

        function handleCC(cc, val) {
            const norm = val / 127;
            const fx = runtimeState.fx;
            switch(cc) {
                case 1: // Mod Wheel -> Tremolo Depth
                    if(fx.tremolo.depth.rampTo) fx.tremolo.depth.rampTo(norm, 0.1);
                    else fx.tremolo.depth.value = norm;
                    break;
                case 74: // Brightness -> Filter
                    const freq = 100 + (norm * 5000);
                    fx.filter.frequency.rampTo(freq, 0.1);
                    document.getElementById('cutoff').value = freq;
                    break;
                case 91: // Reverb
                    if(fx.reverb.wet.rampTo) fx.reverb.wet.rampTo(norm, 0.1);
                    else fx.reverb.wet.value = norm;
                    document.getElementById('reverbWet').value = norm;
                    break;
            }
        }

        // ========================================================
        // 6. UI & INTERACTIONS
        // ========================================================

        function setupUI() {
            // Populate Presets
            const list = document.getElementById('preset-list');
            PRESETS.forEach((p, i) => {
                const li = document.createElement('li');
                li.className = 'preset-item';
                li.innerText = `${i+1}. ${p.name}`;
                li.onclick = () => loadPreset(i);
                list.appendChild(li);
            });

            // Signal Binding Helper
            const bindSignal = (id, signal) => {
                const el = document.getElementById(id);
                if(!el) return;
                el.oninput = (e) => {
                    const val = parseFloat(e.target.value);
                    if(signal && signal.rampTo) signal.rampTo(val, 0.1);
                    else if(signal) signal.value = val;
                };
            };

            // Synth Params
            document.getElementById('harmonicity').oninput = (e) => {
                const val = parseFloat(e.target.value);
                runtimeState.synth.set({ harmonicity: val });
                updateLabels();
            };
            document.getElementById('modIndex').oninput = (e) => {
                const val = parseFloat(e.target.value);
                runtimeState.synth.set({ modulationIndex: val });
                updateLabels();
            };
            
            bindSignal('detune', runtimeState.synth.detune);

            // Envelope
            ['envAttack', 'envDecay', 'envSustain', 'envRelease'].forEach(k => {
                document.getElementById(k).oninput = (e) => {
                    const val = parseFloat(e.target.value);
                    const prop = k.replace('env', '').toLowerCase();
                    runtimeState.synth.set({
                        envelope: { [prop]: val },
                        modulationEnvelope: { [prop]: val }
                    });
                }
            });

            // FX
            bindSignal('cutoff', runtimeState.fx.filter.frequency);
            bindSignal('resonance', runtimeState.fx.filter.Q);
            
            document.getElementById('chorusDepth').oninput = (e) => {
                const val = parseFloat(e.target.value);
                runtimeState.fx.chorus.depth = val;
            };

            bindSignal('delayWet', runtimeState.fx.delay.wet);
            bindSignal('reverbWet', runtimeState.fx.reverb.wet);
            bindSignal('masterVol', runtimeState.fx.master.volume);

            // Global
            document.getElementById('bpm').oninput = (e) => {
                const val = parseFloat(e.target.value);
                runtimeState.Tone.Transport.bpm.value = val;
                updateLabels();
            };

            const tremRateEl = document.getElementById('tremoloRate');
            const tremRates = ['1m', '2n', '4n', '4t', '8n', '8t', '16n', '32n'];
            tremRateEl.max = tremRates.length - 1;
            tremRateEl.oninput = (e) => {
                const r = tremRates[parseInt(e.target.value)];
                runtimeState.fx.tremolo.frequency.value = r;
                document.getElementById('val-tremoloRate').innerText = r;
            }

            createVirtualKeyboard();
        }

        function updateLabels() {
            ['harmonicity', 'modIndex', 'detune', 'bpm'].forEach(id => {
                const el = document.getElementById('val-' + id);
                const input = document.getElementById(id);
                if(el && input) el.innerText = input.value;
            });
        }

        function createVirtualKeyboard() {
            // Initialize Shared Keyboard
            runtimeState.keyboard = new SynthKeyboard('keyboard-container', {
                startNote: 48, // C3
                responsive: true,
                onNoteOn: (midi) => noteOn(midi, 1),
                onNoteOff: (midi) => noteOff(midi)
            });
            
            // Computer Keyboard Map
            const keyMap = {
                'z': 48, 's': 49, 'x': 50, 'd': 51, 'c': 52, 'v': 53, 'g': 54, 'b': 55, 'h': 56, 'n': 57, 'j': 58, 'm': 59,
                'q': 60, '2': 61, 'w': 62, '3': 63, 'e': 64, 'r': 65, '5': 66, 't': 67, '6': 68, 'y': 69, '7': 70, 'u': 71
            };

            window.addEventListener('keydown', (e) => {
                if(keyMap[e.key] && !e.repeat) {
                    noteOn(keyMap[e.key], 1);
                }
            });
            window.addEventListener('keyup', (e) => {
                if(keyMap[e.key]) {
                    noteOff(keyMap[e.key]);
                }
            });
        }

        // ========================================================
        // 7. VISUALS
        // ========================================================
        function initVisuals() {
            const container = document.getElementById('visualizer-container');
            const THREE = runtimeState.THREE;

            if (THREE) {
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ alpha: true });
                renderer.setSize(container.clientWidth, container.clientHeight);
                container.appendChild(renderer.domElement);

                const geometry = new THREE.BufferGeometry();
                const count = 256;
                const positions = new Float32Array(count * 3);
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                const material = new THREE.LineBasicMaterial({ color: 0x00d4ff });
                const line = new THREE.Line(geometry, material);
                scene.add(line);

                camera.position.z = 2;

                const animateThree = () => {
                    requestAnimationFrame(animateThree);
                    const values = runtimeState.analyser.getValue();
                    
                    const pos = line.geometry.attributes.position.array;
                    for(let i=0; i<count; i++) {
                        const v = values[i] === -Infinity ? -100 : values[i];
                        const y = (v + 60) * 0.02; 
                        pos[i*3] = (i / count) * 4 - 2; 
                        pos[i*3 + 1] = y; 
                        pos[i*3 + 2] = 0; 
                    }
                    line.geometry.attributes.position.needsUpdate = true;
                    renderer.render(scene, camera);
                };
                animateThree();

                window.addEventListener('resize', () => {
                    if(container.clientWidth) {
                        camera.aspect = container.clientWidth / container.clientHeight;
                        camera.updateProjectionMatrix();
                        renderer.setSize(container.clientWidth, container.clientHeight);
                    }
                });

            } else {
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                const ctx = canvas.getContext('2d');
                
                const draw = () => {
                    requestAnimationFrame(draw);
                    if(canvas.width !== container.clientWidth) {
                        canvas.width = container.clientWidth;
                        canvas.height = container.clientHeight;
                    }

                    const values = runtimeState.analyser.getValue();
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#00d4ff';
                    ctx.beginPath();
                    
                    const sliceWidth = canvas.width * 1.0 / values.length;
                    let x = 0;

                    for(let i = 0; i < values.length; i++) {
                        const v = (values[i] + 100) / 100; 
                        const y = canvas.height - (v * canvas.height / 2);

                        if(i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                        x += sliceWidth;
                    }
                    ctx.stroke();
                };
                draw();
            }
        }

        // ========================================================
        // 8. BOOTSTRAP
        // ========================================================
        
        async function boot() {
            try {
                await setupAudio();
                setupUI(); // Sets up listeners
                setupMIDI();
                initVisuals();
                loadPreset(0); // Load default preset cleanly
                console.log('[FM / AM] System Online');
            } catch (e) {
                console.error("Boot error", e);
                alert("Audio Engine Initialization Failed. See Console.");
            }
        }

        loadToneJSAndBoot({
            setLoaderStatus,
            runtimeState,
            boot
        });

    </script>
</body>
</html>