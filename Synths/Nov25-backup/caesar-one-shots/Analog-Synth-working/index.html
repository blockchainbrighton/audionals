<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOP Matrix Mono | Rebuilt</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --panel: #252525;
            --border: #333;
            --accent: #ff9900;
            --text: #ddd;
            --knob: #111;
            --key-white: #fffff0;
            --key-black: #151515;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
        }

        /* LOADER */
        #loader-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        #start-btn {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 1.2rem;
            background: var(--accent);
            color: #000;
            border: none;
            font-weight: bold;
            cursor: pointer;
            display: none;
            text-transform: uppercase;
        }
        #start-btn:hover { background: #ffb340; }

        /* MAIN RACK */
        #rack {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-width: 1000px;
            width: 100%;
            background: #000;
            padding: 10px;
            border: 2px solid #444;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            opacity: 0;
            transition: opacity 1s;
        }
        #rack.active { opacity: 1; }

        /* MODULES */
        .module {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 10px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .module.wide { grid-column: span 2; }
        .module.full { grid-column: span 4; }

        .header {
            font-size: 0.7rem;
            color: #888;
            border-bottom: 1px solid #444;
            margin-bottom: 8px;
            padding-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
        }

        /* CONTROLS */
        .row {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            gap: 5px;
            flex: 1;
        }
        
        .ctrl {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 50px;
        }
        .ctrl label {
            font-size: 0.6rem;
            margin-top: 5px;
            color: #aaa;
            text-align: center;
        }

        /* KNOBS */
        .knob-wrap {
            width: 45px; height: 45px;
            position: relative;
        }
        .knob {
            width: 100%; height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #444, #111);
            border: 1px solid #555;
            position: relative;
            cursor: ns-resize;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .knob::after {
            content: '';
            position: absolute;
            top: 10%; left: 50%;
            width: 2px; height: 40%;
            background: var(--accent);
            transform: translateX(-50%);
            pointer-events: none;
        }

        /* SLIDERS */
        input[type="range"].v-slider {
            -webkit-appearance: slider-vertical;
            width: 8px;
            height: 80px;
            background: transparent;
        }

        /* SELECT */
        select {
            background: #111; color: var(--accent);
            border: 1px solid #444;
            font-size: 0.7rem;
            width: 100%;
            margin-bottom: 5px;
        }

        /* KEYBOARD (The requested Flex design) */
        #keyboard {
            display: flex;
            height: 100px;
            background: #111;
            justify-content: center;
            position: relative;
            margin-top: 10px;
            padding: 10px 0;
            border-top: 4px solid #222;
        }
        .key {
            position: relative;
            width: 40px; /* Fixed Width */
            height: 100%;
            background: var(--key-white);
            border: 1px solid #999;
            border-radius: 0 0 4px 4px;
            margin: 0 1px;
            cursor: pointer;
            z-index: 1;
        }
        .key.black {
            width: 24px;
            height: 60%;
            background: var(--key-black);
            /* Negative Margins for Overlay */
            margin-left: -13px;
            margin-right: -13px;
            z-index: 2;
            border: 1px solid #000;
            border-radius: 0 0 2px 2px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }
        .key.active {
            background: var(--accent);
            box-shadow: 0 0 15px var(--accent);
        }
        .key.black.active {
            background: #cc7a00; /* Darker orange */
        }

        /* VISUALS */
        canvas#scope {
            width: 100%; height: 60px;
            background: #000;
            border: 1px solid #444;
        }
        
        #preset-list {
            display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px;
        }
        .p-btn {
            background: #333; border: 1px solid #555; color: #ccc;
            padding: 4px 8px; font-family: inherit; font-size: 0.7rem;
            cursor: pointer; white-space: nowrap;
        }
        .p-btn:hover { border-color: var(--accent); }
        
        .midi-led {
            width: 8px; height: 8px; background: #300; border-radius: 50%;
            display: inline-block; margin-left: 5px;
        }
        .midi-led.on { background: #f00; box-shadow: 0 0 5px #f00; }

    </style>
</head>
<body>

    <div id="loader-overlay">
        <div style="color: #888; margin-bottom: 10px;">INITIALIZING...</div>
        <div id="loader-msg" style="color: var(--accent);">Loading Tone.js</div>
        <button id="start-btn">POWER ON</button>
    </div>

    <div id="rack">
        <!-- HEADER -->
        <div class="module full" style="display:flex; flex-direction:row; align-items:center; justify-content:space-between;">
            <div style="font-weight:bold; font-size:1.2rem; color:var(--accent);">BOP MATRIX MONO</div>
            <div style="display:flex; align-items:center; gap:10px; font-size:0.7rem;">
                MIDI <div id="midi-led" class="midi-led"></div>
                <select id="midi-in" style="width:100px; margin:0;"><option>None</option></select>
            </div>
        </div>

        <!-- OSC 1 -->
        <div class="module">
            <div class="header">Oscillator 1</div>
            <select id="osc1-type">
                <option value="sawtooth">Sawtooth</option>
                <option value="square">Square</option>
                <option value="pulse">Pulse</option>
                <option value="triangle">Triangle</option>
            </select>
            <div class="row">
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="osc1-oct" data-min="-2" data-max="2" data-step="1" data-val="0"></div></div>
                    <label>Oct</label>
                </div>
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="osc1-tune" data-min="-1200" data-max="1200" data-val="0"></div></div>
                    <label>Tune</label>
                </div>
            </div>
        </div>

        <!-- OSC 2 -->
        <div class="module">
            <div class="header">Oscillator 2</div>
            <select id="osc2-type">
                <option value="square">Square</option>
                <option value="sawtooth">Sawtooth</option>
                <option value="pulse">Pulse</option>
                <option value="triangle">Triangle</option>
            </select>
            <div class="row">
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="osc2-oct" data-min="-2" data-max="2" data-step="1" data-val="-1"></div></div>
                    <label>Oct</label>
                </div>
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="osc2-tune" data-min="-1200" data-max="1200" data-val="7"></div></div>
                    <label>Tune</label>
                </div>
            </div>
        </div>

        <!-- MIXER -->
        <div class="module">
            <div class="header">Mixer</div>
            <div class="row">
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="mix-osc1" data-min="0" data-max="1" data-val="1"></div></div>
                    <label>Osc 1</label>
                </div>
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="mix-osc2" data-min="0" data-max="1" data-val="0.5"></div></div>
                    <label>Osc 2</label>
                </div>
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="mix-noise" data-min="0" data-max="0.5" data-val="0"></div></div>
                    <label>Noise</label>
                </div>
            </div>
        </div>

        <!-- FILTER -->
        <div class="module">
            <div class="header">Filter (24dB)</div>
            <div class="row">
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="filt-cut" data-min="50" data-max="12000" data-exp="1" data-val="2000"></div></div>
                    <label>Freq</label>
                </div>
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="filt-res" data-min="0" data-max="20" data-val="1"></div></div>
                    <label>Res</label>
                </div>
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="filt-env-amt" data-min="0" data-max="5000" data-val="2000"></div></div>
                    <label>Env</label>
                </div>
            </div>
        </div>

        <!-- AMP ENV -->
        <div class="module">
            <div class="header">Amp Env</div>
            <div class="row">
                <div class="ctrl"><input type="range" class="v-slider" id="amp-a" min="0.005" max="2" step="0.01" value="0.01"><label>A</label></div>
                <div class="ctrl"><input type="range" class="v-slider" id="amp-d" min="0.0" max="2" step="0.01" value="0.1"><label>D</label></div>
                <div class="ctrl"><input type="range" class="v-slider" id="amp-s" min="0" max="1" step="0.01" value="1.0"><label>S</label></div>
                <div class="ctrl"><input type="range" class="v-slider" id="amp-r" min="0.01" max="4" step="0.01" value="0.1"><label>R</label></div>
            </div>
        </div>

        <!-- FILT ENV -->
        <div class="module">
            <div class="header">Filter Env</div>
            <div class="row">
                <div class="ctrl"><input type="range" class="v-slider" id="filt-a" min="0.005" max="2" step="0.01" value="0.01"><label>A</label></div>
                <div class="ctrl"><input type="range" class="v-slider" id="filt-d" min="0.0" max="2" step="0.01" value="0.2"><label>D</label></div>
                <div class="ctrl"><input type="range" class="v-slider" id="filt-s" min="0" max="1" step="0.01" value="0.5"><label>S</label></div>
                <div class="ctrl"><input type="range" class="v-slider" id="filt-r" min="0.01" max="4" step="0.01" value="0.5"><label>R</label></div>
            </div>
        </div>

        <!-- MODULATION -->
        <div class="module">
            <div class="header">Modulation</div>
            <div class="row">
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="lfo-rate" data-min="0.1" data-max="20" data-val="5"></div></div>
                    <label>LFO Hz</label>
                </div>
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="lfo-amt" data-min="0" data-max="1000" data-val="0"></div></div>
                    <label>LFO>VCF</label>
                </div>
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="glide" data-min="0" data-max="0.5" data-val="0"></div></div>
                    <label>Glide</label>
                </div>
            </div>
        </div>

        <!-- FX -->
        <div class="module">
            <div class="header">Output / FX</div>
            <div class="row">
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="dist" data-min="0" data-max="1" data-val="0"></div></div>
                    <label>Drive</label>
                </div>
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="delay" data-min="0" data-max="0.6" data-val="0.2"></div></div>
                    <label>Delay</label>
                </div>
                <div class="ctrl">
                    <div class="knob-wrap"><div class="knob" id="vol" data-min="-60" data-max="0" data-val="-10"></div></div>
                    <label>Vol</label>
                </div>
            </div>
        </div>

        <!-- VISUAL & PRESETS -->
        <div class="module full">
            <div class="header">Visuals & Presets</div>
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <canvas id="scope"></canvas>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; gap: 5px;">
                    <div id="preset-list">
                        <!-- Buttons -->
                    </div>
                    <div style="font-size: 0.7rem; color: #666;">Click & Drag Keys to Glissando</div>
                </div>
            </div>
        </div>

        <!-- KEYBOARD -->
        <div class="module full" style="padding:0; border:none; background:transparent;">
            <div id="keyboard">
                <!-- Generated by JS -->
            </div>
        </div>

    </div>

    <script type="module">
        const state = {
            Tone: null,
            synth: null,
            activeNotes: [], // Note stack for mono priority
            activeKeys: [], // For glissando tracking
            midiAccess: null
        };

        // 1. LOADER
        const loaderMsg = document.getElementById('loader-msg');
        const startBtn = document.getElementById('start-btn');
        
        import('https://ordinals.com/content/04813d7748d918bd8a3069cb1823ebc9586f0ce16cd6a97a784581ec38d13062i0')
            .then(module => {
                state.Tone = window.Tone;
                loaderMsg.innerText = "Ready.";
                startBtn.style.display = 'block';
                
                startBtn.onclick = async () => {
                    await state.Tone.start();
                    initSynth();
                    initUI();
                    initMIDI();
                    drawScope();
                    document.getElementById('loader-overlay').style.opacity = 0;
                    setTimeout(() => document.getElementById('loader-overlay').remove(), 500);
                    document.getElementById('rack').classList.add('active');
                }
            })
            .catch(e => {
                loaderMsg.innerText = "Error Loading Tone.js";
                loaderMsg.style.color = 'red';
                console.error(e);
            });

        // 2. SYNTH ENGINE (Robust Mono Architecture)
        function initSynth() {
            const T = state.Tone;
            
            const s = {};
            
            // Sources
            s.osc1 = new T.Oscillator(440, "sawtooth").start();
            s.osc2 = new T.Oscillator(440, "square").start();
            s.noise = new T.Noise("pink").start();

            // Gains
            s.gain1 = new T.Gain(0.5);
            s.gain2 = new T.Gain(0.5);
            s.gainN = new T.Gain(0);

            // Filter
            s.filter = new T.Filter({ type: "lowpass", frequency: 2000, rolloff: -24, Q: 1 });

            // VCA & Envelopes
            s.ampEnv = new T.AmplitudeEnvelope({ attack:0.01, decay:0.1, sustain:1, release:0.1 });
            
            // Filter Env (Using Signal for bipolar modulation logic)
            s.filtEnv = new T.Envelope({ attack:0.01, decay:0.2, sustain:0.5, release:0.5 });
            s.filtEnvScale = new T.Gain(2000); // Amount

            // FX
            s.dist = new T.Distortion(0);
            s.delay = new T.FeedbackDelay("8n", 0.3); s.delay.wet.value = 0;
            s.master = new T.Volume(-10);
            s.wave = new T.Waveform(1024);

            // Modulators
            s.lfo = new T.LFO(5, 0, 1).start();
            s.lfoGain = new T.Gain(0);

            // Routing
            s.osc1.connect(s.gain1); s.gain1.connect(s.filter);
            s.osc2.connect(s.gain2); s.gain2.connect(s.filter);
            s.noise.connect(s.gainN); s.gainN.connect(s.filter);

            s.filter.connect(s.dist);
            s.dist.connect(s.ampEnv);
            s.ampEnv.connect(s.delay);
            s.delay.connect(s.master);
            s.master.chain(T.Destination, s.wave);

            // Mod Routing
            s.filtEnv.connect(s.filtEnvScale);
            s.filtEnvScale.connect(s.filter.frequency);
            
            s.lfo.connect(s.lfoGain);
            s.lfoGain.connect(s.filter.frequency);

            state.synth = s;
            state.params = { osc1Oct:0, osc2Oct:-1, glide:0 };
            
            loadPreset(presets[0]); // Init sound
        }

        // 3. NOTE LOGIC
        function triggerNote(midi, vel) {
            const s = state.synth;
            const T = state.Tone;
            const freq = T.Frequency(midi, "midi").toFrequency();
            const now = T.now();

            // Pitch Logic
            const f1 = freq * Math.pow(2, state.params.osc1Oct);
            const f2 = freq * Math.pow(2, state.params.osc2Oct);

            if (state.params.glide > 0 && state.activeNotes.length > 0) {
                s.osc1.frequency.rampTo(f1, state.params.glide, now);
                s.osc2.frequency.rampTo(f2, state.params.glide, now);
            } else {
                s.osc1.frequency.setValueAtTime(f1, now);
                s.osc2.frequency.setValueAtTime(f2, now);
                // Retrigger Envs if not legato or first note
                s.ampEnv.triggerAttack(now, vel);
                s.filtEnv.triggerAttack(now);
            }
        }

        function noteOn(midi, vel=1) {
            // Glissando check
            if(state.activeKeys.includes(midi)) return;
            state.activeKeys.push(midi);

            // Stack logic
            state.activeNotes.push(midi);
            triggerNote(midi, vel);
            
            updateKeyVisuals(midi, true);
        }

        function noteOff(midi) {
            state.activeKeys = state.activeKeys.filter(k => k !== midi);
            const idx = state.activeNotes.indexOf(midi);
            if(idx > -1) state.activeNotes.splice(idx, 1);

            if(state.activeNotes.length > 0) {
                const last = state.activeNotes[state.activeNotes.length-1];
                triggerNote(last, 1); // return to previous
            } else {
                const now = state.Tone.now();
                state.synth.ampEnv.triggerRelease(now);
                state.synth.filtEnv.triggerRelease(now);
            }
            
            updateKeyVisuals(midi, false);
        }

        function updateKeyVisuals(midi, on) {
            const k = document.querySelector(`.key[data-midi="${midi}"]`);
            if(k) {
                if(on) k.classList.add('active'); else k.classList.remove('active');
            }
        }

        // 4. UI GENERATION
        function initUI() {
            // Keyboard
            const kb = document.getElementById('keyboard');
            const start = 48; // C3
            const keys = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
            for(let i=0; i<25; i++) {
                const midi = start + i;
                const note = keys[i%12];
                const isBlack = note.includes('#');
                const div = document.createElement('div');
                div.className = `key ${isBlack?'black':'white'}`;
                div.dataset.midi = midi;
                
                // Mouse Events
                const on = () => noteOn(midi);
                const off = () => noteOff(midi);
                div.onmousedown = on;
                div.onmouseup = off;
                div.onmouseleave = off;
                div.onmouseenter = (e) => { if(e.buttons === 1) on(); };
                div.ontouchstart = (e) => { e.preventDefault(); on(); };
                div.ontouchend = (e) => { e.preventDefault(); off(); };
                
                kb.appendChild(div);
            }

            // Knobs
            document.querySelectorAll('.knob').forEach(k => {
                const id = k.id;
                let val = parseFloat(k.dataset.val);
                const min = parseFloat(k.dataset.min);
                const max = parseFloat(k.dataset.max);
                const step = parseFloat(k.dataset.step) || 0;
                const exp = k.dataset.exp ? true : false;

                const updateVisual = (v) => {
                    let pct = 0;
                    if(exp) {
                        pct = (Math.log(v) - Math.log(min)) / (Math.log(max) - Math.log(min));
                    } else {
                        pct = (v - min) / (max - min);
                    }
                    if(pct < 0) pct=0; if(pct>1) pct=1;
                    k.style.transform = `rotate(${-135 + (pct * 270)}deg)`;
                };
                updateVisual(val);

                let startY, startVal;
                k.onmousedown = (e) => {
                    startY = e.clientY;
                    startVal = val;
                    const move = (ev) => {
                        const d = (startY - ev.clientY);
                        // Linear scale for drag, mapped to exp if needed
                        let norm = (startVal - min) / (max - min); 
                        // Simple increment logic
                        let inc = d * ((max-min)/200);
                        let newVal = startVal + inc;
                        if(newVal < min) newVal = min; if(newVal > max) newVal = max;
                        if(step) newVal = Math.round(newVal/step)*step;
                        val = newVal;
                        updateVisual(val);
                        updateParam(id, val);
                    };
                    const up = () => {
                        window.removeEventListener('mousemove', move);
                        window.removeEventListener('mouseup', up);
                    };
                    window.addEventListener('mousemove', move);
                    window.addEventListener('mouseup', up);
                };
            });

            // Sliders
            document.querySelectorAll('input[type="range"]').forEach(s => {
                s.oninput = (e) => updateParam(s.id, parseFloat(e.target.value));
            });

            // Selects
            document.querySelectorAll('select').forEach(s => {
                if(s.id.startsWith('osc')) {
                    s.onchange = (e) => updateParam(s.id, e.target.value);
                }
            });

            // Presets
            const pList = document.getElementById('preset-list');
            presets.forEach((p, i) => {
                const btn = document.createElement('button');
                btn.className = 'p-btn';
                btn.innerText = p.name;
                btn.onclick = () => loadPreset(p);
                pList.appendChild(btn);
            });
        }

        // 5. PARAMETER HANDLING
        function updateParam(id, val) {
            const s = state.synth;
            if(!s) return;
            const T = state.Tone;

            switch(id) {
                case 'osc1-type': s.osc1.type = val; break;
                case 'osc1-oct': state.params.osc1Oct = val; break;
                case 'osc1-tune': s.osc1.detune.value = val; break;
                
                case 'osc2-type': s.osc2.type = val; break;
                case 'osc2-oct': state.params.osc2Oct = val; break;
                case 'osc2-tune': s.osc2.detune.value = val; break;

                case 'mix-osc1': s.gain1.gain.rampTo(val, 0.1); break;
                case 'mix-osc2': s.gain2.gain.rampTo(val, 0.1); break;
                case 'mix-noise': s.gainN.gain.rampTo(val, 0.1); break;

                case 'filt-cut': s.filter.frequency.rampTo(val, 0.1); break;
                case 'filt-res': s.filter.Q.value = val; break;
                case 'filt-env-amt': s.filtEnvScale.gain.value = val; break;

                case 'amp-a': s.ampEnv.attack = val; break;
                case 'amp-d': s.ampEnv.decay = val; break;
                case 'amp-s': s.ampEnv.sustain = val; break;
                case 'amp-r': s.ampEnv.release = val; break;

                case 'filt-a': s.filtEnv.attack = val; break;
                case 'filt-d': s.filtEnv.decay = val; break;
                case 'filt-s': s.filtEnv.sustain = val; break;
                case 'filt-r': s.filtEnv.release = val; break;

                case 'lfo-rate': s.lfo.frequency.value = val; break;
                case 'lfo-amt': s.lfoGain.gain.value = val; break;
                case 'glide': state.params.glide = val; break;

                case 'dist': s.dist.distortion = val; break;
                case 'delay': s.delay.wet.value = val; break;
                case 'vol': s.master.volume.value = val; break;
            }
        }

        // 6. PRESETS
        const presets = [
            { name: "INIT", o1:'sawtooth', o2:'square', mix1:1, mix2:0, cut:2000, res:1, envAmt:1000, dist:0, del:0 },
            { name: "BASS", o1:'square', o2:'triangle', mix1:0.8, mix2:0.8, cut:400, res:5, envAmt:500, dist:0.2, del:0 },
            { name: "LEAD", o1:'sawtooth', o2:'sawtooth', mix1:0.6, mix2:0.6, cut:5000, res:2, envAmt:0, dist:0.4, del:0.3 },
            { name: "ACID", o1:'sawtooth', o2:'square', mix1:1, mix2:0, cut:600, res:15, envAmt:3000, dist:0.8, del:0.2 }
        ];

        function loadPreset(p) {
            // Helper to set UI and Param
            const set = (id, val) => {
                const el = document.getElementById(id);
                if(!el) return;
                // Set internal
                updateParam(id, val);
                // Set UI visual
                if(el.classList.contains('knob')) {
                    el.dataset.val = val;
                    // trigger visual update logic duplicate (simplified here)
                    const min = parseFloat(el.dataset.min);
                    const max = parseFloat(el.dataset.max);
                    const exp = el.dataset.exp;
                    let pct = exp ? (Math.log(val)-Math.log(min))/(Math.log(max)-Math.log(min)) : (val-min)/(max-min);
                    el.style.transform = `rotate(${-135 + (pct*270)}deg)`;
                } else if(el.tagName === 'SELECT' || el.type === 'range') {
                    el.value = val;
                }
            };

            set('osc1-type', p.o1); set('osc2-type', p.o2);
            set('mix-osc1', p.mix1); set('mix-osc2', p.mix2);
            set('filt-cut', p.cut); set('filt-res', p.res); set('filt-env-amt', p.envAmt);
            set('dist', p.dist); set('delay', p.del);
        }

        // 7. VISUALIZER
        function drawScope() {
            const canvas = document.getElementById('scope');
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.clientWidth;
            const height = canvas.height = canvas.clientHeight;

            function loop() {
                requestAnimationFrame(loop);
                if(!state.synth) return;
                const data = state.synth.wave.getValue();
                ctx.fillStyle = "#000";
                ctx.fillRect(0,0,width,height);
                ctx.strokeStyle = "#0f0";
                ctx.lineWidth = 2;
                ctx.beginPath();
                const slice = width / data.length;
                let x = 0;
                for(let i=0; i<data.length; i++) {
                    const v = data[i];
                    const y = (v + 1) / 2 * height;
                    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                    x+=slice;
                }
                ctx.stroke();
            }
            loop();
        }

        // 8. MIDI
        function initMIDI() {
            if(navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess().then(access => {
                    const sel = document.getElementById('midi-in');
                    for(let input of access.inputs.values()) {
                        const opt = document.createElement('option');
                        opt.text = input.name;
                        sel.add(opt);
                        input.onmidimessage = handleMIDI;
                    }
                });
            }
        }

        function handleMIDI(msg) {
            const [cmd, note, vel] = msg.data;
            const led = document.getElementById('midi-led');
            led.classList.add('on'); setTimeout(()=>led.classList.remove('on'), 100);

            if(cmd === 144 && vel > 0) noteOn(note);
            if(cmd === 128 || (cmd === 144 && vel === 0)) noteOff(note);
            if(cmd === 176) { // CC
                if(note === 74) { // Cutoff
                    const val = 50 + (vel/127)*10000;
                    document.getElementById('filt-cut').style.transform = `rotate(${ -135 + (vel/127)*270 }deg)`; // Visual hack
                    updateParam('filt-cut', val);
                }
            }
        }

    </script>
</body>
</html>