<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOP Matrix Analog Mono Synth</title>
    <style>
        :root {
            --bg-color: #222;
            --panel-color: #333;
            --panel-border: #444;
            --text-color: #ccc;
            --accent-color: #ff9900;
            --knob-color: #111;
            --knob-indicator: #fff;
            --led-off: #400;
            --led-on: #f00;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
        }

        h1 {
            color: var(--accent-color);
            text-shadow: 0 0 5px var(--accent-color);
            margin-bottom: 10px;
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #loader-status {
            margin-bottom: 20px;
            color: #888;
            font-size: 0.8rem;
        }

        /* Synth Container */
        .synth-case {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            border: 2px solid #555;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 1200px;
            width: 100%;
            opacity: 0.5;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        .synth-case.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Grid Layout */
        .modules-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .module {
            background: var(--panel-color);
            border: 1px solid var(--panel-border);
            border-radius: 4px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 140px;
            flex: 1;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }

        .module-title {
            font-size: 0.7rem;
            font-weight: bold;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
            border-bottom: 1px solid #444;
            width: 100%;
            text-align: center;
            padding-bottom: 5px;
        }

        /* Controls */
        .control-row {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 8px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 5px;
        }

        .label {
            font-size: 0.6rem;
            margin-top: 5px;
            text-align: center;
        }

        /* Knobs */
        .knob-container {
            position: relative;
            width: 40px;
            height: 40px;
        }

        .knob {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #555, #000);
            position: relative;
            cursor: ns-resize;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .knob::after {
            content: '';
            position: absolute;
            top: 5%;
            left: 50%;
            width: 2px;
            height: 45%;
            background: var(--knob-indicator);
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(0deg); /* Set by JS */
        }

        /* Sliders */
        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100px;
        }

        input[type=range][orient=vertical] {
            writing-mode: bt-lr; /* IE */
            -webkit-appearance: slider-vertical; /* WebKit */
            width: 8px;
            height: 80px;
            padding: 0 5px;
        }
        
        /* Standard Horizontal Slider styling for browsers that don't support vertical well */
        .h-slider {
            width: 100%;
            margin: 10px 0;
        }

        /* Toggles */
        .toggle {
            appearance: none;
            width: 30px;
            height: 15px;
            background: #222;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            border: 1px solid #555;
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            width: 11px;
            height: 11px;
            background: #666;
            border-radius: 50%;
            transition: 0.2s;
        }

        .toggle:checked {
            background: #442200;
            border-color: var(--accent-color);
        }

        .toggle:checked::after {
            left: 16px;
            background: var(--accent-color);
        }

        /* Select */
        select {
            background: #222;
            color: #ccc;
            border: 1px solid #555;
            font-family: monospace;
            font-size: 0.7rem;
            width: 100%;
            margin-bottom: 5px;
        }

        /* Oscilloscope */
        canvas#scope {
            width: 100%;
            height: 80px;
            background: #000;
            border: 1px solid #444;
            border-radius: 4px;
            box-shadow: inset 0 0 20px rgba(0,0,0,1);
        }

        /* Keyboard */
        .keyboard {
            display: flex;
            justify-content: center;
            height: 120px;
            margin-top: 15px;
            position: relative;
            background: #111;
            padding: 5px;
            border-radius: 4px;
            overflow: hidden;
        }

        .key {
            background: #fff;
            border: 1px solid #888;
            border-radius: 0 0 3px 3px;
            margin: 0 1px;
            flex: 1;
            position: relative;
            cursor: pointer;
            transition: background 0.05s;
        }

        .key.black {
            background: #000;
            border: 1px solid #000;
            height: 65%;
            width: 60%; /* Relative to white key width */
            margin-left: -30%;
            margin-right: -30%;
            z-index: 2;
            flex: 0 0 auto; /* Don't grow */
        }

        .key.active {
            background: var(--accent-color) !important;
            box-shadow: 0 0 10px var(--accent-color);
        }

        /* Presets */
        .presets {
            display: flex;
            gap: 5px;
            overflow-x: auto;
            padding-bottom: 5px;
            width: 100%;
        }

        .preset-btn {
            background: #333;
            color: #aaa;
            border: 1px solid #555;
            padding: 5px 10px;
            font-family: monospace;
            font-size: 0.7rem;
            cursor: pointer;
            white-space: nowrap;
        }

        .preset-btn:hover {
            background: #444;
            color: #fff;
        }

        .preset-btn.selected {
            background: var(--accent-color);
            color: #000;
            border-color: var(--accent-color);
        }

        .midi-led {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--led-off);
            margin-left: 10px;
            display: inline-block;
        }
        .midi-led.on {
            background: var(--led-on);
            box-shadow: 0 0 5px red;
        }
    </style>
</head>
<body>

    <h1>BOP Matrix Mono</h1>
    <div id="loader-status">Initializing Runtime...</div>

    <div class="synth-case" id="synth-ui">
        <!-- Top Row: Oscilloscope & Global -->
        <div class="modules-row" style="flex-wrap: nowrap;">
            <div class="module" style="flex: 2;">
                <div class="module-title">MASTER & VISUAL <span id="midi-indicator" class="midi-led"></span></div>
                <canvas id="scope"></canvas>
                <div class="control-row" style="margin-top:10px;">
                    <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="masterVol" data-min="-60" data-max="0" data-value="-6"></div></div>
                        <div class="label">VOL</div>
                    </div>
                     <div class="control-group">
                        <button id="init-audio-btn" class="preset-btn" style="margin-top: 8px;">START AUDIO</button>
                    </div>
                </div>
            </div>
            <div class="module" style="flex: 3;">
                <div class="module-title">PRESETS</div>
                <div class="presets" id="preset-container">
                    <!-- Presets injected here -->
                </div>
            </div>
        </div>

        <!-- Main Row: Sound Engine -->
        <div class="modules-row">
            <!-- OSC 1 -->
            <div class="module">
                <div class="module-title">OSC 1</div>
                <select data-param="osc1Type">
                    <option value="sawtooth">Sawtooth</option>
                    <option value="square">Square</option>
                    <option value="pulse">Pulse</option>
                    <option value="triangle">Triangle</option>
                </select>
                <div class="control-row">
                    <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="osc1Oct" data-min="-2" data-max="2" data-step="1" data-value="0"></div></div>
                        <div class="label">OCT</div>
                    </div>
                    <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="osc1Detune" data-min="-1200" data-max="1200" data-value="0"></div></div>
                        <div class="label">TUNE</div>
                    </div>
                </div>
            </div>

            <!-- OSC 2 -->
            <div class="module">
                <div class="module-title">OSC 2</div>
                <select data-param="osc2Type">
                    <option value="sawtooth">Sawtooth</option>
                    <option value="square">Square</option>
                    <option value="pulse">Pulse</option>
                    <option value="triangle">Triangle</option>
                </select>
                <div class="control-row">
                    <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="osc2Oct" data-min="-2" data-max="2" data-step="1" data-value="0"></div></div>
                        <div class="label">OCT</div>
                    </div>
                    <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="osc2Detune" data-min="-1200" data-max="1200" data-value="10"></div></div>
                        <div class="label">TUNE</div>
                    </div>
                </div>
            </div>

             <!-- MIXER -->
             <div class="module">
                <div class="module-title">MIXER</div>
                <div class="control-row">
                    <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="mixOsc1" data-min="0" data-max="1" data-value="0.8"></div></div>
                        <div class="label">OSC 1</div>
                    </div>
                    <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="mixOsc2" data-min="0" data-max="1" data-value="0.6"></div></div>
                        <div class="label">OSC 2</div>
                    </div>
                     <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="mixNoise" data-min="0" data-max="0.5" data-value="0"></div></div>
                        <div class="label">NOISE</div>
                    </div>
                </div>
            </div>

            <!-- FILTER -->
            <div class="module">
                <div class="module-title">FILTER (24dB)</div>
                <div class="control-row">
                    <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="cutoff" data-min="20" data-max="15000" data-exp="true" data-value="2000"></div></div>
                        <div class="label">FREQ</div>
                    </div>
                    <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="resonance" data-min="0" data-max="20" data-value="1"></div></div>
                        <div class="label">RES</div>
                    </div>
                     <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="filterEnvAmt" data-min="0" data-max="5000" data-value="2000"></div></div>
                        <div class="label">ENV</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modules-row">
            <!-- AMP ENV -->
             <div class="module">
                <div class="module-title">AMP ENV</div>
                <div class="control-row">
                    <div class="control-group"><input type="range" orient="vertical" data-param="ampA" min="0.005" max="2" step="0.01" value="0.01"><div class="label">A</div></div>
                    <div class="control-group"><input type="range" orient="vertical" data-param="ampD" min="0.0" max="2" step="0.01" value="0.1"><div class="label">D</div></div>
                    <div class="control-group"><input type="range" orient="vertical" data-param="ampS" min="0" max="1" step="0.01" value="0.8"><div class="label">S</div></div>
                    <div class="control-group"><input type="range" orient="vertical" data-param="ampR" min="0.01" max="4" step="0.01" value="0.2"><div class="label">R</div></div>
                </div>
            </div>

            <!-- FILTER ENV -->
            <div class="module">
                <div class="module-title">FILTER ENV</div>
                <div class="control-row">
                    <div class="control-group"><input type="range" orient="vertical" data-param="filtA" min="0.005" max="2" step="0.01" value="0.01"><div class="label">A</div></div>
                    <div class="control-group"><input type="range" orient="vertical" data-param="filtD" min="0.0" max="2" step="0.01" value="0.2"><div class="label">D</div></div>
                    <div class="control-group"><input type="range" orient="vertical" data-param="filtS" min="0" max="1" step="0.01" value="0.5"><div class="label">S</div></div>
                    <div class="control-group"><input type="range" orient="vertical" data-param="filtR" min="0.01" max="4" step="0.01" value="0.5"><div class="label">R</div></div>
                </div>
            </div>

            <!-- MODULATION -->
            <div class="module">
                <div class="module-title">LFO / MOD</div>
                <div class="control-row">
                    <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="lfoRate" data-min="0.1" data-max="20" data-value="5"></div></div>
                        <div class="label">RATE</div>
                    </div>
                    <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="lfoDepth" data-min="0" data-max="1000" data-value="0"></div></div>
                        <div class="label">FILT</div>
                    </div>
                     <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="pwmAmt" data-min="0" data-max="1" data-value="0"></div></div>
                        <div class="label">PWM</div>
                    </div>
                </div>
                <div class="control-row">
                    <div class="control-group">
                        <input type="checkbox" class="toggle" data-param="legato">
                        <div class="label">LEGATO</div>
                    </div>
                    <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="glide" data-min="0" data-max="0.5" data-value="0"></div></div>
                        <div class="label">GLIDE</div>
                    </div>
                </div>
            </div>

            <!-- EFFECTS -->
             <div class="module">
                <div class="module-title">FX</div>
                <div class="control-row">
                    <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="dist" data-min="0" data-max="1" data-value="0"></div></div>
                        <div class="label">DIST</div>
                    </div>
                    <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="delayTime" data-min="0.01" data-max="0.5" data-value="0.2"></div></div>
                        <div class="label">D.TIME</div>
                    </div>
                    <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="delayFb" data-min="0" data-max="0.9" data-value="0.3"></div></div>
                        <div class="label">F.BACK</div>
                    </div>
                     <div class="control-group">
                        <div class="knob-container"><div class="knob" data-param="delayMix" data-min="0" data-max="1" data-value="0.2"></div></div>
                        <div class="label">D.MIX</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="keyboard-container" class="keyboard">
            <!-- Keys generated by JS -->
        </div>
    </div>

    <script type="module">
        // ---------------------------------------------------------------------
        // 1. LOADER (Provided)
        // ---------------------------------------------------------------------
        
        // Runtime State to hold the Tone instance and Synth
        const runtimeState = {
            Tone: null,
            synth: null,
            midiAccess: null
        };

        function setLoaderStatus(msg, isError = false) {
            const el = document.getElementById('loader-status');
            el.textContent = msg;
            if(isError) el.style.color = 'red';
        }

        function loadToneJSAndBoot({ 
            toneUrl = 'https://ordinals.com/content/04813d7748d918bd8a3069cb1823ebc9586f0ce16cd6a97a784581ec38d13062i0',
            setLoaderStatus,
            runtimeState,
            boot
        }) {
            setLoaderStatus('Loading Audio Engine...');
            import(toneUrl)
                .then(() => {
                    runtimeState.Tone = window.Tone;
                    console.log('[BOP Matrix] Tone.js loaded:', runtimeState.Tone?.version ?? 'Unknown');
                    boot();
                })
                .catch(err => {
                    setLoaderStatus('Failed to load Tone.js. App cannot start.', true);
                    console.error('[BOP Matrix] Critical Tone.js load error:', err);
                });
        }

        // ---------------------------------------------------------------------
        // 2. SYNTH ENGINE CLASS
        // ---------------------------------------------------------------------

        class AnalogMonoSynth {
            constructor(Tone) {
                this.Tone = Tone;
                this.activeNotes = []; // Stack for mono priority
                this.params = {}; // Store current parameter values
                
                // --- Audio Graph ---
                
                // Oscillators
                this.osc1 = new Tone.Oscillator(0, "sawtooth").start();
                this.osc2 = new Tone.Oscillator(0, "square").start();
                this.noise = new Tone.Noise("pink").start();

                // Oscillator Gains (Level)
                this.gain1 = new Tone.Gain(0.5);
                this.gain2 = new Tone.Gain(0.5);
                this.gainNoise = new Tone.Gain(0);

                // Pulse Width Modulation LFO (for Pulse waves)
                this.pwmLfo = new Tone.LFO(2, 0.1, 0.9).start(); // Modulates 10% to 90% width

                // Main LFO (Vibrato / Filter Mod)
                this.lfo = new Tone.LFO(5, 0, 1).start();

                // Filter
                this.filter = new Tone.Filter({
                    type: "lowpass",
                    frequency: 2000,
                    rolloff: -24,
                    Q: 1
                });

                // Envelopes
                this.ampEnv = new Tone.AmplitudeEnvelope({
                    attack: 0.01, decay: 0.1, sustain: 0.8, release: 0.2
                });

                this.filterEnv = new Tone.FrequencyEnvelope({
                    attack: 0.01, decay: 0.2, sustain: 0.5, release: 0.5,
                    baseFrequency: 200,
                    octaves: 4
                });

                // FX Chain
                this.dist = new Tone.Distortion(0);
                this.delay = new Tone.FeedbackDelay("8n", 0.3);
                this.masterVol = new Tone.Volume(0); // controlled by master knob
                this.limiter = new Tone.Limiter(-1);

                // Oscilloscope Analysis
                this.waveform = new Tone.Waveform(1024);

                // --- Connections ---

                // Osc 1 -> Gain -> Filter
                this.osc1.connect(this.gain1);
                this.gain1.connect(this.filter);

                // Osc 2 -> Gain -> Filter
                this.osc2.connect(this.gain2);
                this.gain2.connect(this.filter);

                // Noise -> Gain -> Filter
                this.noise.connect(this.gainNoise);
                this.gainNoise.connect(this.filter);

                // Filter -> Dist -> AmpEnv -> Delay -> Master -> Waveform -> Out
                this.filter.connect(this.dist);
                this.dist.connect(this.ampEnv);
                this.ampEnv.connect(this.delay);
                this.delay.connect(this.masterVol);
                this.masterVol.chain(this.limiter, this.waveform, Tone.Destination);

                // Modulations
                this.filterEnv.connect(this.filter.frequency);
                
                // LFO Mod connections are dynamic (gain nodes) or direct
                this.lfoFilterGain = new Tone.Gain(0); // Amount of LFO to Filter
                this.lfo.connect(this.lfoFilterGain);
                this.lfoFilterGain.connect(this.filter.frequency);

                // PWM Logic
                // Only Pulse oscillators have .width. We connect to both just in case user switches type.
                // Tone.js Osc types don't all have width. We handle this in setParam.
                // For now, assume 'pulse' type can be modulated.
                
                this.state = {
                    osc1Oct: 0,
                    osc2Oct: 0,
                    osc1Detune: 0,
                    osc2Detune: 0,
                    glide: 0,
                    legato: false,
                    lastNote: null
                };
            }

            // --- Core Logic ---

            triggerNoteOn(midi, velocity) {
                const freq = this.Tone.Frequency(midi, "midi");
                const time = this.Tone.now();

                // Push to stack
                this.activeNotes.push({ midi, freq, velocity });
                
                // Legato logic
                const isLegato = this.state.legato && this.activeNotes.length > 1;
                const glideTime = isLegato ? this.state.glide : 0;

                // Set Pitch
                this.setPitch(freq, glideTime);

                // Trigger Envelopes (retrigger if not legato, or if stack size is 1)
                if (!isLegato) {
                    this.ampEnv.triggerAttack(time, velocity);
                    this.filterEnv.triggerAttack(time);
                }
            }

            triggerNoteOff(midi) {
                // Remove from stack
                const index = this.activeNotes.findIndex(n => n.midi === midi);
                if (index > -1) this.activeNotes.splice(index, 1);

                const time = this.Tone.now();

                if (this.activeNotes.length > 0) {
                    // Glide back to previous note
                    const prev = this.activeNotes[this.activeNotes.length - 1];
                    this.setPitch(prev.freq, this.state.glide);
                } else {
                    // Release
                    this.ampEnv.triggerRelease(time);
                    this.filterEnv.triggerRelease(time);
                }
            }

            setPitch(freq, glideTime) {
                const f = this.Tone.Frequency(freq).toFrequency();
                // Osc 1
                const f1 = f * Math.pow(2, this.state.osc1Oct);
                if (glideTime > 0) this.osc1.frequency.rampTo(f1, glideTime);
                else this.osc1.frequency.setValueAtTime(f1, this.Tone.now());

                // Osc 2
                const f2 = f * Math.pow(2, this.state.osc2Oct);
                if (glideTime > 0) this.osc2.frequency.rampTo(f2, glideTime);
                else this.osc2.frequency.setValueAtTime(f2, this.Tone.now());
            }

            // --- Parameter Handling ---

            setParam(id, value) {
                const now = this.Tone.now();
                
                // Store for UI update if needed (not implemented here to keep simple)
                this.params[id] = value;

                switch(id) {
                    // OSC 1
                    case 'osc1Type': 
                        this.osc1.type = value; 
                        if(value === 'pulse') this.pwmLfo.connect(this.osc1.width);
                        else try { this.pwmLfo.disconnect(this.osc1.width); } catch(e){}
                        break;
                    case 'osc1Oct': 
                        this.state.osc1Oct = parseInt(value); 
                        // Retrigger pitch update if holding note
                        if(this.activeNotes.length) this.setPitch(this.activeNotes[this.activeNotes.length-1].freq, 0);
                        break;
                    case 'osc1Detune': this.osc1.detune.rampTo(value, 0.1); break;

                    // OSC 2
                    case 'osc2Type': 
                        this.osc2.type = value;
                        if(value === 'pulse') this.pwmLfo.connect(this.osc2.width);
                        else try { this.pwmLfo.disconnect(this.osc2.width); } catch(e){}
                        break;
                    case 'osc2Oct': 
                        this.state.osc2Oct = parseInt(value); 
                         if(this.activeNotes.length) this.setPitch(this.activeNotes[this.activeNotes.length-1].freq, 0);
                        break;
                    case 'osc2Detune': this.osc2.detune.rampTo(value, 0.1); break;

                    // MIXER
                    case 'mixOsc1': this.gain1.gain.rampTo(value, 0.1); break;
                    case 'mixOsc2': this.gain2.gain.rampTo(value, 0.1); break;
                    case 'mixNoise': this.gainNoise.gain.rampTo(value, 0.1); break;

                    // FILTER
                    case 'cutoff': this.filter.frequency.rampTo(value, 0.1); break;
                    case 'resonance': this.filter.Q.value = value; break;
                    case 'filterEnvAmt': 
                        // Scale base frequency vs env amount
                        // Simplification: adjust octaves of envelope
                        // 1000 -> roughly 5 octaves
                        this.filterEnv.octaves = value / 200; 
                        break;

                    // ENVELOPES (Amp)
                    case 'ampA': this.ampEnv.attack = value; break;
                    case 'ampD': this.ampEnv.decay = value; break;
                    case 'ampS': this.ampEnv.sustain = value; break;
                    case 'ampR': this.ampEnv.release = value; break;

                    // ENVELOPES (Filt)
                    case 'filtA': this.filterEnv.attack = value; break;
                    case 'filtD': this.filterEnv.decay = value; break;
                    case 'filtS': this.filterEnv.sustain = value; break;
                    case 'filtR': this.filterEnv.release = value; break;

                    // MODULATION
                    case 'lfoRate': this.lfo.frequency.rampTo(value, 0.1); break;
                    case 'lfoDepth': 
                        // Modulate filter
                        this.lfoFilterGain.gain.rampTo(value, 0.1);
                        break;
                    case 'pwmAmt':
                        this.pwmLfo.min = 0.5 - (value * 0.45);
                        this.pwmLfo.max = 0.5 + (value * 0.45);
                        break;
                    case 'glide': this.state.glide = value; break;
                    case 'legato': this.state.legato = (value === true || value === "on"); break;

                    // FX
                    case 'dist': this.dist.distortion = value; break;
                    case 'delayTime': this.delay.delayTime.rampTo(value, 0.1); break;
                    case 'delayFb': this.delay.feedback.value = value; break;
                    case 'delayMix': this.delay.wet.value = value; break;

                    // MASTER
                    case 'masterVol': this.masterVol.volume.rampTo(value, 0.1); break;
                }
            }
        }

        // ---------------------------------------------------------------------
        // 3. BOOT SEQUENCE & PRESETS
        // ---------------------------------------------------------------------

        const PRESETS = {
            "Init Mono": {
                osc1Type: 'sawtooth', osc1Oct: 0, osc1Detune: 0,
                osc2Type: 'square', osc2Oct: -1, osc2Detune: 5,
                mixOsc1: 1, mixOsc2: 0, mixNoise: 0,
                cutoff: 2000, resonance: 1, filterEnvAmt: 2000,
                ampA: 0.01, ampD: 0.1, ampS: 1, ampR: 0.1,
                filtA: 0.01, filtD: 0.2, filtS: 0.5, filtR: 0.5,
                lfoRate: 5, lfoDepth: 0, pwmAmt: 0,
                glide: 0, legato: false,
                dist: 0, delayTime: 0.2, delayFb: 0.3, delayMix: 0
            },
            "Warm Lead": {
                osc1Type: 'sawtooth', osc1Oct: 0, osc1Detune: -5,
                osc2Type: 'sawtooth', osc2Oct: 0, osc2Detune: 5,
                mixOsc1: 0.7, mixOsc2: 0.7, mixNoise: 0,
                cutoff: 1200, resonance: 2, filterEnvAmt: 1000,
                ampA: 0.05, ampD: 0.2, ampS: 0.8, ampR: 0.3,
                filtA: 0.1, filtD: 0.5, filtS: 0.2, filtR: 0.5,
                lfoRate: 6, lfoDepth: 100, pwmAmt: 0,
                glide: 0.1, legato: true,
                dist: 0.1, delayTime: 0.3, delayFb: 0.4, delayMix: 0.3
            },
            "Rubbery Bass": {
                osc1Type: 'square', osc1Oct: -1, osc1Detune: 0,
                osc2Type: 'triangle', osc2Oct: -2, osc2Detune: 0,
                mixOsc1: 0.8, mixOsc2: 0.8, mixNoise: 0,
                cutoff: 400, resonance: 8, filterEnvAmt: 800,
                ampA: 0.01, ampD: 0.3, ampS: 0.4, ampR: 0.1,
                filtA: 0.01, filtD: 0.2, filtS: 0.1, filtR: 0.1,
                lfoRate: 0.1, lfoDepth: 0, pwmAmt: 0.2,
                glide: 0, legato: false,
                dist: 0.4, delayMix: 0
            },
            "PWM Sweep": {
                osc1Type: 'pulse', osc1Oct: 0, osc1Detune: 0,
                osc2Type: 'pulse', osc2Oct: 0, osc2Detune: 10,
                mixOsc1: 0.7, mixOsc2: 0.7, mixNoise: 0,
                cutoff: 3000, resonance: 1, filterEnvAmt: 0,
                ampA: 0.01, ampD: 0.1, ampS: 1, ampR: 0.5,
                filtA: 0, filtD: 0, filtS: 1, filtR: 0,
                lfoRate: 0.5, lfoDepth: 0, pwmAmt: 0.9,
                glide: 0.2, legato: true,
                dist: 0, delayMix: 0.4
            },
             "Acidic Bite": {
                osc1Type: 'sawtooth', osc1Oct: 0, osc1Detune: 0,
                osc2Type: 'square', osc2Oct: -1, osc2Detune: 0,
                mixOsc1: 1, mixOsc2: 0.2, mixNoise: 0,
                cutoff: 600, resonance: 15, filterEnvAmt: 2500,
                ampA: 0.01, ampD: 0.1, ampS: 0.1, ampR: 0.1,
                filtA: 0.01, filtD: 0.15, filtS: 0, filtR: 0.1,
                lfoRate: 12, lfoDepth: 200, pwmAmt: 0,
                glide: 0.1, legato: true,
                dist: 0.8, delayMix: 0.2
            },
             "Noise FX": {
                osc1Type: 'sawtooth', osc1Oct: 1, osc1Detune: 0,
                mixOsc1: 0, mixOsc2: 0, mixNoise: 1,
                cutoff: 5000, resonance: 10, filterEnvAmt: 2000,
                ampA: 0.01, ampD: 1.0, ampS: 0, ampR: 2,
                filtA: 0.01, filtD: 0.5, filtS: 0, filtR: 1,
                lfoRate: 15, lfoDepth: 5000, pwmAmt: 0,
                glide: 0, legato: false,
                dist: 1, delayTime: 0.1, delayFb: 0.8, delayMix: 0.5
            }
        };

        function loadPreset(name) {
            const p = PRESETS[name];
            if (!p) return;
            
            // Update internal synth params
            for (const [key, val] of Object.entries(p)) {
                if (runtimeState.synth) runtimeState.synth.setParam(key, val);
                
                // Update UI
                const input = document.querySelector(`[data-param="${key}"]`);
                if (input) {
                    if (input.tagName === 'SELECT') {
                        input.value = val;
                    } else if (input.classList.contains('toggle')) {
                        input.checked = val;
                    } else if (input.classList.contains('knob')) {
                        // Update knob rotation visual
                        const min = parseFloat(input.dataset.min);
                        const max = parseFloat(input.dataset.max);
                        // normalize 0-1
                        let norm = 0;
                        if(input.dataset.exp) {
                            // approximation for visual update of exp knobs
                             norm = (Math.log(val) - Math.log(min)) / (Math.log(max) - Math.log(min));
                        } else {
                             norm = (val - min) / (max - min);
                        }
                        const deg = -135 + (norm * 270);
                        input.style.setProperty('--rot', deg + 'deg');
                        
                        // Update internal CSS var for rotation
                        const sheet = document.styleSheets;
                        // Hacky way to rotate pseudo element: set style directly on element then read in css?
                        // Easier: Set transform on ::after via JS is hard. 
                        // Used styling: .knob::after { transform: ... rotate(var(--rot, -135deg)) }
                        // Let's add that var to CSS now
                        input.style.setProperty('--rot', deg+'deg');
                        
                        // Update data-value for logic
                        input.dataset.value = val;
                    } else {
                        // Sliders
                        input.value = val;
                    }
                }
            }
            
            // Highlight button
            document.querySelectorAll('.preset-btn').forEach(b => {
                b.classList.toggle('selected', b.textContent === name);
            });
        }

        function boot() {
            setLoaderStatus("Audio Engine Ready. Click Start.");
            
            // Setup UI Interactions
            setupUI();
            setupKeyboard();

            const startBtn = document.getElementById('init-audio-btn');
            startBtn.addEventListener('click', async () => {
                await runtimeState.Tone.start();
                runtimeState.synth = new AnalogMonoSynth(runtimeState.Tone);
                setLoaderStatus("Synth Active");
                startBtn.style.display = 'none';
                document.getElementById('synth-ui').classList.add('active');
                
                // Start Oscilloscope Loop
                drawScope();
                
                // Initialize MIDI
                setupMIDI();
                
                // Load default preset
                loadPreset("Init Mono");
            });
        }

        // ---------------------------------------------------------------------
        // 4. UI & INTERACTION
        // ---------------------------------------------------------------------

        function setupUI() {
            // Knob Logic
            document.querySelectorAll('.knob').forEach(knob => {
                // Set initial rotation css variable
                knob.style.setProperty('--rot', '-135deg');
                
                // We need a style rule for this to work, let's inject it
                knob.style.transform = 'rotate(var(--rot))'; 
                // Wait, rotating the whole knob rotates the gradient background too, which is good for 3D effect.
                // But the marker is ::after. If we rotate the div, both rotate. Good.

                let startY;
                let startVal;
                
                const onMove = (e) => {
                    e.preventDefault();
                    const delta = startY - e.clientY;
                    const min = parseFloat(knob.dataset.min);
                    const max = parseFloat(knob.dataset.max);
                    const step = parseFloat(knob.dataset.step) || (max - min) / 200;
                    
                    let val = startVal + (delta * ((max - min) / 200)); // Sensitivity
                    
                    if (val < min) val = min;
                    if (val > max) val = max;
                    
                    // Snap if step provided
                    if (knob.dataset.step) {
                        val = Math.round(val / step) * step;
                    }

                    knob.dataset.value = val;
                    
                    // Visual update
                    let norm = (val - min) / (max - min);
                    // Handle exponential knobs visually? (Optional, skipped for simplicity)
                    const deg = -135 + (norm * 270);
                    knob.style.setProperty('--rot', deg + 'deg');

                    // Trigger Synth Param
                    if(runtimeState.synth) {
                        runtimeState.synth.setParam(knob.dataset.param, val);
                    }
                };

                const onUp = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                };

                knob.addEventListener('mousedown', (e) => {
                    startY = e.clientY;
                    startVal = parseFloat(knob.dataset.value);
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                });
            });

            // Sliders & Selects
            document.querySelectorAll('input[type=range], select, input[type=checkbox]').forEach(el => {
                el.addEventListener('input', (e) => {
                    const val = el.type === 'checkbox' ? el.checked : el.value;
                    if(runtimeState.synth) {
                        runtimeState.synth.setParam(el.dataset.param, val);
                    }
                });
            });

            // Presets
            const pContainer = document.getElementById('preset-container');
            Object.keys(PRESETS).forEach(name => {
                const btn = document.createElement('div');
                btn.className = 'preset-btn';
                btn.textContent = name;
                btn.onclick = () => loadPreset(name);
                pContainer.appendChild(btn);
            });
        }

        function setupKeyboard() {
            const keys = [
                { n: 'C', f: 0 }, { n: 'C#', f: 1, b: true }, { n: 'D', f: 2 }, { n: 'D#', f: 3, b: true },
                { n: 'E', f: 4 }, { n: 'F', f: 5 }, { n: 'F#', f: 6, b: true }, { n: 'G', f: 7 },
                { n: 'G#', f: 8, b: true }, { n: 'A', f: 9 }, { n: 'A#', f: 10, b: true }, { n: 'B', f: 11 },
                { n: 'C', f: 12 }
            ];
            const baseNote = 48; // C3
            const container = document.getElementById('keyboard-container');
            
            keys.forEach((k, i) => {
                const el = document.createElement('div');
                el.className = `key ${k.b ? 'black' : ''}`;
                el.dataset.midi = baseNote + k.f;
                
                // Mouse Events
                el.addEventListener('mousedown', () => {
                    if(runtimeState.synth) {
                        runtimeState.synth.triggerNoteOn(parseInt(el.dataset.midi), 1);
                        el.classList.add('active');
                    }
                });
                el.addEventListener('mouseup', () => {
                    if(runtimeState.synth) {
                        runtimeState.synth.triggerNoteOff(parseInt(el.dataset.midi));
                        el.classList.remove('active');
                    }
                });
                el.addEventListener('mouseleave', () => {
                    if(el.classList.contains('active') && runtimeState.synth) {
                        runtimeState.synth.triggerNoteOff(parseInt(el.dataset.midi));
                        el.classList.remove('active');
                    }
                });

                container.appendChild(el);
            });
        }

        // ---------------------------------------------------------------------
        // 5. MIDI
        // ---------------------------------------------------------------------

        function setupMIDI() {
            if (navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess().then(onMIDISuccess, () => setLoaderStatus("MIDI Failed"));
            }
        }

        function onMIDISuccess(midiAccess) {
            const inputs = midiAccess.inputs.values();
            for (let input of inputs) {
                input.onmidimessage = getMIDIMessage;
            }
            setLoaderStatus("MIDI Ready");
        }

        function getMIDIMessage(message) {
            const command = message.data;
            const note = message.data;
            const velocity = (message.data.length > 2) ? message.data : 0;
            const led = document.getElementById('midi-indicator');

            // Blink LED
            led.classList.add('on');
            setTimeout(() => led.classList.remove('on'), 100);

            // Note On (144-159)
            if (command >= 144 && command <= 159) {
                if (velocity > 0) {
                    runtimeState.synth.triggerNoteOn(note, velocity / 127);
                    highlightKey(note, true);
                } else {
                    runtimeState.synth.triggerNoteOff(note);
                    highlightKey(note, false);
                }
            }
            // Note Off (128-143)
            else if (command >= 128 && command <= 143) {
                runtimeState.synth.triggerNoteOff(note);
                highlightKey(note, false);
            }
            // Control Change (176-191)
            else if (command >= 176 && command <= 191) {
                // CC Mapping
                const ccNumber = note; // In CC message, 2nd byte is number
                const ccValue = velocity; // 3rd byte is value
                mapCC(ccNumber, ccValue);
            }
        }

        function highlightKey(midi, active) {
            // Simple visual mapping for the visible octave
            const visibleKeys = document.querySelectorAll('.key');
            visibleKeys.forEach(k => {
                if(parseInt(k.dataset.midi) === midi) {
                    if(active) k.classList.add('active');
                    else k.classList.remove('active');
                }
            });
        }

        function mapCC(num, val) {
            // Generic mapping (Simple example)
            const norm = val / 127;
            switch(num) {
                case 1: // Mod Wheel -> LFO Depth
                     runtimeState.synth.setParam('lfoDepth', norm * 1000);
                     break;
                case 74: // Cutoff
                     runtimeState.synth.setParam('cutoff', 100 + (norm * 10000));
                     break;
            }
        }

        // ---------------------------------------------------------------------
        // 6. OSCILLOSCOPE RENDER
        // ---------------------------------------------------------------------

        function drawScope() {
            const canvas = document.getElementById('scope');
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.clientWidth;
            const height = canvas.height = canvas.clientHeight;

            function loop() {
                requestAnimationFrame(loop);
                if(!runtimeState.synth) return;

                const values = runtimeState.synth.waveform.getValue();
                ctx.fillStyle = 'rgb(20, 20, 20)';
                ctx.fillRect(0, 0, width, height);
                
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#0f0'; // Retro Green
                ctx.beginPath();

                const sliceWidth = width / values.length;
                let x = 0;

                for (let i = 0; i < values.length; i++) {
                    const v = values[i]; // -1 to 1
                    const y = (v + 1) / 2 * height;

                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);

                    x += sliceWidth;
                }
                ctx.stroke();
            }
            loop();
        }

        // ---------------------------------------------------------------------
        // 7. INIT
        // ---------------------------------------------------------------------
        loadToneJSAndBoot({
            setLoaderStatus,
            runtimeState,
            boot
        });

    </script>
</body>
</html>
