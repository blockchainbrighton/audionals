<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON HORIZON | 80s Poly Synth</title>
    <style>
        :root {
            --bg-dark: #050510;
            --panel-bg: #111118;
            --neon-pink: #ff00ff;
            --neon-cyan: #00ffff;
            --neon-yellow: #ffee00;
            --text-color: #e0e0e0;
            --knob-size: 50px;
            --crt-scanline: rgba(18, 16, 16, 0.1);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
        }

        /* Loading Overlay */
        #loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s;
        }

        #loader h1 {
            color: var(--neon-pink);
            text-shadow: 0 0 10px var(--neon-pink);
            font-size: 2rem;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 4px;
        }

        #start-btn {
            background: transparent;
            border: 2px solid var(--neon-cyan);
            color: var(--neon-cyan);
            padding: 15px 40px;
            font-size: 1.2rem;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 0 15px var(--neon-cyan);
            transition: all 0.2s;
            display: none;
        }

        #start-btn:hover {
            background: var(--neon-cyan);
            color: #000;
        }

        #status-text { margin-top: 15px; color: #666; font-size: 0.8rem; }

        /* Main Synth UI */
        #synth-container {
            position: relative;
            width: 1100px;
            height: 700px;
            display: grid;
            grid-template-rows: 1fr 240px;
            gap: 10px;
            z-index: 10;
            opacity: 0;
            transition: opacity 1s ease-in;
            pointer-events: none; /* Enabled after boot */
        }

        /* 3D Visualizer Background */
        #visualizer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
            opacity: 0.6;
        }

        /* Control Panel */
        .panel {
            background: rgba(17, 17, 24, 0.85);
            border: 1px solid var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: auto 1fr;
            gap: 15px;
            border-radius: 4px;
        }

        .section {
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .section-title {
            position: absolute;
            top: -10px;
            background: var(--panel-bg);
            padding: 0 5px;
            font-size: 0.7rem;
            color: var(--neon-pink);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
            margin-top: 10px;
        }

        /* Knobs */
        .knob-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .knob {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: conic-gradient(var(--neon-cyan) 0%, var(--neon-cyan) 0%, #333 0%, #333 100%);
            position: relative;
            cursor: ns-resize;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
        }

        .knob::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 32px; height: 32px;
            background: #1a1a1a;
            border-radius: 50%;
        }

        .knob-label {
            font-size: 0.6rem;
            margin-top: 5px;
            color: #aaa;
            text-align: center;
        }

        /* Display Screen */
        .screen-section {
            grid-column: span 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #lcd-display {
            background: #121212;
            border: 2px solid #333;
            height: 80px;
            border-radius: 4px;
            padding: 10px;
            color: var(--neon-yellow);
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
            text-shadow: 0 0 5px var(--neon-yellow);
        }

        #patch-name { font-size: 1rem; font-weight: bold; }
        #midi-status { font-size: 0.7rem; color: var(--neon-cyan); }

        .preset-nav {
            display: flex;
            gap: 5px;
        }

        .btn {
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.7rem;
            flex: 1;
        }
        .btn:hover { background: #333; border-color: var(--neon-cyan); }
        .btn.active { background: var(--neon-cyan); color: #000; }

        /* Keyboard */
        #keyboard-container {
            /* Layout handled by shared module */
            position: relative;
            z-index: 2;
            background: #000;
            border-top: 5px solid var(--neon-pink);
            box-shadow: 0 -5px 20px rgba(255, 0, 255, 0.2);
            margin-top: 10px;
        }

        /* CRT Effect */
        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 9999;
        }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div id="visualizer"></div>

    <!-- Loading Screen -->
    <div id="loader">
        <h1>BOP Matrix v1.0</h1>
        <div id="status-text">Initializing Neural Net...</div>
        <button id="start-btn">INITIALIZE SYSTEM</button>
    </div>

    <!-- Synth UI -->
    <div id="synth-container">
        
        <div class="panel">
            <!-- Global / Presets -->
            <div class="screen-section">
                <div id="lcd-display">
                    <div id="patch-name">INIT PAD</div>
                    <div id="midi-status">MIDI: Disconnected</div>
                </div>
                <div class="preset-nav">
                    <button class="btn" id="prev-preset">&lt;</button>
                    <button class="btn" id="next-preset">&gt;</button>
                </div>
                <div style="margin-top: 10px; display: flex; gap:5px;">
                    <button class="btn" id="arp-toggle">ARP: OFF</button>
                    <button class="btn" id="latch-toggle">LATCH</button>
                </div>
            </div>

            <!-- OSC -->
            <div class="section">
                <div class="section-title">Oscillator</div>
                <div class="controls-grid">
                    <div class="knob-container">
                        <div class="knob" data-param="detune" data-min="-50" data-max="50" data-value="0"></div>
                        <div class="knob-label">Detune</div>
                    </div>
                    <div class="knob-container">
                        <div class="knob" data-param="subLevel" data-min="-60" data-max="0" data-value="-10"></div>
                        <div class="knob-label">Sub Osc</div>
                    </div>
                    <div class="knob-container">
                        <div class="knob" data-param="pulseWidth" data-min="0" data-max="1" data-value="0.5"></div>
                        <div class="knob-label">PWM</div>
                    </div>
                    <div class="knob-container">
                        <div class="knob" data-param="glide" data-min="0" data-max="1" data-value="0"></div>
                        <div class="knob-label">Glide</div>
                    </div>
                </div>
            </div>

            <!-- FILTER -->
            <div class="section">
                <div class="section-title">VCF</div>
                <div class="controls-grid">
                    <div class="knob-container">
                        <div class="knob" data-param="cutoff" data-min="20" data-max="10000" data-value="2000" data-scale="log"></div>
                        <div class="knob-label">Cutoff</div>
                    </div>
                    <div class="knob-container">
                        <div class="knob" data-param="resonance" data-min="0" data-max="20" data-value="1"></div>
                        <div class="knob-label">Reso</div>
                    </div>
                    <div class="knob-container">
                        <div class="knob" data-param="filterEnv" data-min="0" data-max="7000" data-value="2000"></div>
                        <div class="knob-label">Env Amt</div>
                    </div>
                </div>
            </div>

            <!-- ENV -->
            <div class="section">
                <div class="section-title">Envelope</div>
                <div class="controls-grid">
                    <div class="knob-container">
                        <div class="knob" data-param="attack" data-min="0.01" data-max="2" data-value="0.1"></div>
                        <div class="knob-label">Attack</div>
                    </div>
                    <div class="knob-container">
                        <div class="knob" data-param="decay" data-min="0.1" data-max="5" data-value="1"></div>
                        <div class="knob-label">Decay</div>
                    </div>
                    <div class="knob-container">
                        <div class="knob" data-param="sustain" data-min="0" data-max="1" data-value="0.5"></div>
                        <div class="knob-label">Sustain</div>
                    </div>
                    <div class="knob-container">
                        <div class="knob" data-param="release" data-min="0.1" data-max="8" data-value="1"></div>
                        <div class="knob-label">Release</div>
                    </div>
                </div>
            </div>

            <!-- FX 1 -->
            <div class="section">
                <div class="section-title">Modulation</div>
                <div class="controls-grid">
                    <div class="knob-container">
                        <div class="knob" data-param="chorusDepth" data-min="0" data-max="1" data-value="0.5"></div>
                        <div class="knob-label">Chorus</div>
                    </div>
                     <div class="knob-container">
                        <div class="knob" data-param="delayMix" data-min="0" data-max="1" data-value="0.3"></div>
                        <div class="knob-label">Delay</div>
                    </div>
                    <div class="knob-container">
                        <div class="knob" data-param="delayTime" data-min="0" data-max="1" data-value="0.3"></div>
                        <div class="knob-label">Time</div>
                    </div>
                </div>
            </div>

            <!-- FX 2 -->
            <div class="section">
                <div class="section-title">Ambience</div>
                <div class="controls-grid">
                    <div class="knob-container">
                        <div class="knob" data-param="reverbMix" data-min="0" data-max="1" data-value="0.3"></div>
                        <div class="knob-label">Reverb</div>
                    </div>
                    <div class="knob-container">
                        <div class="knob" data-param="reverbDecay" data-min="1" data-max="10" data-value="3"></div>
                        <div class="knob-label">Size</div>
                    </div>
                    <div class="knob-container">
                        <div class="knob" data-param="volume" data-min="-40" data-max="0" data-value="-6"></div>
                        <div class="knob-label">Master</div>
                    </div>
                </div>
            </div>

        </div>

        <div id="keyboard-container">
            <!-- Keys generated by JS -->
        </div>

    </div>

    <script type="module">
        import { SynthKeyboard } from '../../shared/keyboard.js';
        const runtimeState = {
            Tone: null, THREE: null, synth: null, fx: {},
            visuals: { scene: null, camera: null, renderer: null, mesh: null, analyzer: null },
            midi: { access: null, inputs: [] },
            arp: { enabled: false, latch: false, pattern: null, heldNotes: new Set(), latchedNotes: [], tempo: 120 }
        };

        function loadToneJSAndBoot({ toneUrl = 'https://ordinals.com/content/04813d7748d918bd8a3069cb1823ebc9586f0ce16cd6a97a784581ec38d13062i0', setLoaderStatus, runtimeState, boot }) {
            setLoaderStatus('Loading Audio Engine...');
            import(toneUrl).then(() => {
                runtimeState.Tone = window.Tone;
                loadThreeJS().then(three => { runtimeState.THREE = three; boot(); }).catch(err => { console.warn('Three.js failed'); boot(); });
            }).catch(err => setLoaderStatus('Failed to load Tone.js', true));
        }

        function loadThreeJS(threeUrl = 'https://ordinals.com/content/0d013bb60fc5bf5a6c77da7371b07dc162ebc7d7f3af0ff3bd00ae5f0c546445i0') {
            return import(threeUrl).then(mod => window.THREE);
        }

        function setLoaderStatus(msg, error = false) {
            const el = document.getElementById('status-text');
            el.innerText = msg; if (error) el.style.color = 'red';
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadToneJSAndBoot({ setLoaderStatus, runtimeState, boot: initApp });
        });

        function initApp() {
            setLoaderStatus('System Ready.');
            const btn = document.getElementById('start-btn');
            btn.style.display = 'block';
            btn.addEventListener('click', async () => {
                await runtimeState.Tone.start(); await runtimeState.Tone.context.resume();
                runtimeState.Tone.context.lookAhead = 0;
                setupAudio(); setupUI(); setupMIDI(); if(runtimeState.THREE) setupVisuals();
                document.getElementById('loader').style.opacity = 0;
                setTimeout(() => { document.getElementById('loader').style.display = 'none'; document.getElementById('synth-container').style.opacity = 1; document.getElementById('synth-container').style.pointerEvents = 'all'; }, 500);
            });
        }

        function setupAudio() {
            const Tone = runtimeState.Tone;
            runtimeState.synth = new Tone.PolySynth(Tone.MonoSynth, {
                maxPolyphony: 10, volume: -6,
                oscillator: { type: "fatsawtooth", count: 3, spread: 20 },
                envelope: { attack: 0.1, decay: 0.3, sustain: 0.5, release: 1 },
                filter: { Q: 1, type: "lowpass", rolloff: -24 },
                filterEnvelope: { attack: 0.05, decay: 0.2, sustain: 0.5, release: 1, baseFrequency: 200, octaves: 4, exponent: 2 }
            });
            runtimeState.fx.chorus = new Tone.Chorus(4, 2.5, 0.5).toDestination().start();
            runtimeState.fx.delay = new Tone.PingPongDelay("8n", 0.3).toDestination();
            runtimeState.fx.reverb = new Tone.Reverb({ decay: 3, wet: 0.3 }).toDestination();
            runtimeState.fx.limiter = new Tone.Limiter(-1).toDestination();
            runtimeState.fx.analyzer = new Tone.Analyser('fft', 64);
            runtimeState.synth.chain(runtimeState.fx.chorus, runtimeState.fx.delay, runtimeState.fx.reverb, runtimeState.fx.limiter, runtimeState.fx.analyzer);
                runtimeState.arp.pattern = new Tone.Pattern((time, noteMidi) => { 
                    const note = runtimeState.Tone.Frequency(noteMidi, "midi").toNote();
                    runtimeState.synth.triggerAttackRelease(note, "16n", time); 
                }, [], "up");            runtimeState.arp.pattern.interval = "16n";
            Tone.Transport.bpm.value = 110; Tone.Transport.start();
            loadPreset(0);
        }

        const PRESETS = [
            { name: "NEON NIGHTS", osc: "fatsawtooth", detune: 0, sub: -10, pwm: 0, glide: 0.05, filter: { cut: 2500, res: 2, env: 3000 }, env: { a: 0.05, d: 2, s: 0.4, r: 1.5 }, fx: { ch: 0.6, del: 0.3, dt: "8n.", rev: 0.4, rd: 4 } },
            { name: "BLADE PAD", osc: "fatsawtooth", detune: 10, sub: -5, pwm: 0, glide: 0.2, filter: { cut: 800, res: 0.5, env: 500 }, env: { a: 1.5, d: 3, s: 0.8, r: 4 }, fx: { ch: 0.8, del: 0.5, dt: "4n", rev: 0.7, rd: 6 } },
            { name: "CHROME BASS", osc: "fatsquare", detune: -5, sub: 0, pwm: 0.5, glide: 0, filter: { cut: 400, res: 4, env: 2000 }, env: { a: 0.01, d: 0.4, s: 0.2, r: 0.2 }, fx: { ch: 0.2, del: 0.1, dt: "16n", rev: 0.1, rd: 1.5 } },
            { name: "DREAMWAVE", osc: "triangle", detune: 5, sub: -60, pwm: 0, glide: 0.1, filter: { cut: 4000, res: 0, env: 0 }, env: { a: 0.5, d: 1, s: 1, r: 2 }, fx: { ch: 1, del: 0.6, dt: "4n", rev: 0.6, rd: 8 } },
            { name: "RETRO PLUCK", osc: "square", detune: 2, sub: -15, pwm: 0.2, glide: 0, filter: { cut: 100, res: 5, env: 3000 }, env: { a: 0.01, d: 0.3, s: 0, r: 0.4 }, fx: { ch: 0.4, del: 0.4, dt: "8n", rev: 0.3, rd: 2 } },
            { name: "LASER KEYS", osc: "sawtooth", detune: 0, sub: -60, pwm: 0, glide: 0, filter: { cut: 8000, res: 1, env: 0 }, env: { a: 0.01, d: 0.2, s: 0.6, r: 0.2 }, fx: { ch: 0.2, del: 0.2, dt: "16n", rev: 0.2, rd: 2 } },
            { name: "VHS STRINGS", osc: "pwm", detune: 15, sub: -10, pwm: 0.8, glide: 0.1, filter: { cut: 1200, res: 0, env: 200 }, env: { a: 2, d: 1, s: 0.9, r: 3 }, fx: { ch: 1, del: 0.2, dt: "4n", rev: 0.6, rd: 5 } },
            { name: "HORIZON LEAD", osc: "fatsawtooth", detune: 0, sub: -5, pwm: 0, glide: 0.2, filter: { cut: 5000, res: 3, env: 1000 }, env: { a: 0.05, d: 0.5, s: 0.5, r: 0.5 }, fx: { ch: 0.5, del: 0.6, dt: "8n", rev: 0.4, rd: 3 } }
        ];

        let currentPresetIndex = 0;
    function loadPreset(index) {
        const p = PRESETS[index];
        const s = runtimeState.synth; const f = runtimeState.fx;
        document.getElementById('patch-name').innerText = p.name;
        s.set({ oscillator: { type: p.osc }, envelope: { attack: p.env.a, decay: p.env.d, sustain: p.env.s, release: p.env.r }, filterEnvelope: { baseFrequency: p.filter.cut, octaves: p.filter.env > 0 ? 4 : 0 } });
        s.options.detune = p.detune; s.set({ portamento: p.glide });
        
        // Fix: Handle Chorus.depth which might be a primitive number in older Tone versions
        if (f.chorus.depth && typeof f.chorus.depth.value !== 'undefined') {
            f.chorus.depth.value = p.fx.ch;
        } else {
            f.chorus.depth = p.fx.ch;
        }

        f.delay.wet.value = p.fx.del; 
        f.delay.delayTime.value = p.fx.dt; 
        f.reverb.wet.value = p.fx.rev; 
        f.reverb.decay = p.fx.rd;
        updateKnobUI('detune', p.detune); updateKnobUI('cutoff', p.filter.cut); updateKnobUI('resonance', p.filter.res); updateKnobUI('filterEnv', p.filter.env);
        updateKnobUI('attack', p.env.a); updateKnobUI('decay', p.env.d); updateKnobUI('sustain', p.env.s); updateKnobUI('release', p.env.r);
        updateKnobUI('chorusDepth', p.fx.ch); updateKnobUI('delayMix', p.fx.del); updateKnobUI('reverbMix', p.fx.rev); updateKnobUI('reverbDecay', p.fx.rd);
        updateKnobUI('glide', p.glide); updateKnobUI('subLevel', p.sub);
    }

        function updateKnobUI(param, val) {
            const knob = document.querySelector(`.knob[data-param="${param}"]`);
            if(!knob) return;
            const min = parseFloat(knob.dataset.min); const max = parseFloat(knob.dataset.max); const scale = knob.dataset.scale || 'linear';
            let pct = (scale === 'log') ? Math.log(val / min) / Math.log(max / min) : (val - min) / (max - min);
            if(pct < 0) pct = 0; if(pct > 1) pct = 1;
            knob.style.background = `conic-gradient(var(--neon-cyan) ${pct*270}deg, #333 0deg)`;
            knob.dataset.value = val;
        }

        function setupUI() {
            document.querySelectorAll('.knob').forEach(knob => {
                let isDragging = false; let startY; let startVal;
                knob.addEventListener('mousedown', (e) => { isDragging = true; startY = e.clientY; startVal = parseFloat(knob.dataset.value); document.body.style.cursor = 'ns-resize'; });
                window.addEventListener('mouseup', () => { isDragging = false; document.body.style.cursor = 'default'; });
                window.addEventListener('mousemove', (e) => {
                    if (!isDragging) return; e.preventDefault();
                    const delta = startY - e.clientY; const min = parseFloat(knob.dataset.min); const max = parseFloat(knob.dataset.max); const param = knob.dataset.param; const scale = knob.dataset.scale || 'linear';
                    let currentPct = (scale === 'log') ? Math.log(startVal / min) / Math.log(max / min) : (startVal - min) / (max - min);
                    let newPct = Math.max(0, Math.min(1, currentPct + (delta / 200)));
                    let newVal = (scale === 'log') ? min * Math.pow(max / min, newPct) : min + newPct * (max - min);
                    knob.style.background = `conic-gradient(var(--neon-cyan) ${newPct * 270}deg, #333 0deg)`; knob.dataset.value = newVal; updateSynthParam(param, newVal);
                });
            });
            document.getElementById('prev-preset').addEventListener('click', () => { currentPresetIndex = (currentPresetIndex - 1 + PRESETS.length) % PRESETS.length; loadPreset(currentPresetIndex); });
            document.getElementById('next-preset').addEventListener('click', () => { currentPresetIndex = (currentPresetIndex + 1) % PRESETS.length; loadPreset(currentPresetIndex); });
            const arpBtn = document.getElementById('arp-toggle');
            arpBtn.addEventListener('click', () => {
                runtimeState.arp.enabled = !runtimeState.arp.enabled; arpBtn.innerText = `ARP: ${runtimeState.arp.enabled ? 'ON' : 'OFF'}`; arpBtn.classList.toggle('active');
                if(!runtimeState.arp.enabled) { runtimeState.arp.pattern.stop(); runtimeState.arp.latchedNotes = []; }
            });
            const latchBtn = document.getElementById('latch-toggle');
            latchBtn.addEventListener('click', () => { runtimeState.arp.latch = !runtimeState.arp.latch; latchBtn.classList.toggle('active'); if(!runtimeState.arp.latch) runtimeState.arp.latchedNotes = []; });
            generateKeyboard();
        }

        function updateSynthParam(param, value) {
            const s = runtimeState.synth; const f = runtimeState.fx;
            switch(param) {
                case 'cutoff': s.set({ filter: { frequency: value }, filterEnvelope: { baseFrequency: value } }); break;
                case 'resonance': s.set({ filter: { Q: value } }); break;
                case 'filterEnv': s.set({ filterEnvelope: { octaves: value > 100 ? 4 : 0 } }); break;
                case 'attack': s.set({ envelope: { attack: value } }); break;
                case 'decay': s.set({ envelope: { decay: value } }); break;
                case 'sustain': s.set({ envelope: { sustain: value } }); break;
                case 'release': s.set({ envelope: { release: value } }); break;
                case 'detune': s.set({ detune: value }); break;
                case 'chorusDepth': 
                    if (f.chorus.depth && typeof f.chorus.depth.value !== 'undefined') f.chorus.depth.value = value;
                    else f.chorus.depth = value; 
                    break;
                case 'delayMix': f.delay.wet.value = value; break;
                case 'reverbMix': f.reverb.wet.value = value; break;
                case 'reverbDecay': f.reverb.decay = value; f.reverb.generate(); break;
                case 'volume': s.volume.value = value; break;
                case 'glide': s.set({ portamento: value }); break;
            }
        }

        function generateKeyboard() {
            runtimeState.keyboard = new SynthKeyboard('keyboard-container', {
                startNote: 48, // C3
                responsive: true,
                onNoteOn: (midi) => noteOn(midi, 1),
                onNoteOff: (midi) => noteOff(midi)
            });
        }

        function noteOn(midi, velocity = 0.8) {
            if(runtimeState.keyboard) runtimeState.keyboard.triggerVisual(midi, true);
                if(runtimeState.arp.enabled) { 
                    runtimeState.arp.heldNotes.add(midi); 
                    updateArp(); 
                } else { 
                    const note = runtimeState.Tone.Frequency(midi, "midi").toNote();
                    runtimeState.synth.triggerAttack(note, runtimeState.Tone.now(), velocity); 
                }
            }
            
            function noteOff(midi) {
                if(runtimeState.keyboard) runtimeState.keyboard.triggerVisual(midi, false);
                if(runtimeState.arp.enabled) { 
                    runtimeState.arp.heldNotes.delete(midi); 
                    updateArp(); 
                } else { 
                    const note = runtimeState.Tone.Frequency(midi, "midi").toNote();
                    runtimeState.synth.triggerRelease(note); 
                }
            }
        function updateArp() {
            const arp = runtimeState.arp; let notes = Array.from(arp.heldNotes).sort((a,b) => a - b);
            if (notes.length > 0) { 
                if(arp.latch) arp.latchedNotes = notes; 
                arp.pattern.values = notes; 
                if(arp.pattern.state !== "started") arp.pattern.start(); 
            } else if (!arp.latch) arp.pattern.stop();
        }

        function setupMIDI() {
            if (navigator.requestMIDIAccess) navigator.requestMIDIAccess().then(access => {
                const inputs = access.inputs.values(); let count = 0;
                for (let input of inputs) { input.onmidimessage = (m) => {
                    const [c, n, v] = m.data; const Tone = runtimeState.Tone;
                    if (c === 144 && v > 0) noteOn(n, v/127);
                    else if (c === 128 || (c === 144 && v === 0)) noteOff(n);
                    else if (c === 176) { if(n===1) updateKnobUI('chorusDepth', v/127); if(n===74) updateKnobUI('cutoff', 20 + (v/127)*8000); }
                }; count++; }
                if(count > 0) document.getElementById('midi-status').innerText = `MIDI: ${count} Device(s)`;
            });
        }

        function setupVisuals() {
            const THREE = runtimeState.THREE; const container = document.getElementById('visualizer');
            const scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x050510, 0.0025);
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000); camera.position.z = 5; camera.position.y = 1;
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight); container.appendChild(renderer.domElement);
            const geometry = new THREE.PlaneGeometry(100, 100, 40, 40);
            const material = new THREE.MeshBasicMaterial({ color: 0xff00ff, wireframe: true, transparent: true, opacity: 0.3 });
            const plane = new THREE.Mesh(geometry, material); plane.rotation.x = -Math.PI / 2; plane.position.y = -1; scene.add(plane);
            const sunGeo = new THREE.CircleGeometry(10, 32); const sunMat = new THREE.MeshBasicMaterial({ color: 0xffaa00 }); const sun = new THREE.Mesh(sunGeo, sunMat); sun.position.z = -50; sun.position.y = 5; scene.add(sun);
            window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
            function animate() {
                requestAnimationFrame(animate);
                if(runtimeState.fx.analyzer) { const values = runtimeState.fx.analyzer.getValue(); const bass = values[0]; material.opacity = 0.2 + ((bass + 100) / 200); }
                plane.position.z = (Date.now() * 0.005) % 2; renderer.render(scene, camera);
            }
            animate();
        }
    </script>
</body>
</html>