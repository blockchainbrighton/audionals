<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUMINA | Web3 Ordinal Synth</title>
    <style>
        :root {
            --bg: #111216;
            --panel: #1a1c23;
            --accent: #00f0ff;
            --accent-dim: #007a82;
            --text: #e0e6ed;
            --text-dim: #8b9bb4;
            --knob-bg: #2a2d35;
            --keys-white: #e0e0e0;
            --keys-black: #111;
            --led-off: #333;
            --led-on: #0f0;
        }

        * { box-sizing: border-box; user-select: none; }
        
        body {
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* LOADER */
        #loader-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }
        .loader-text { margin-bottom: 20px; font-size: 1.2rem; color: var(--accent); letter-spacing: 2px; }
        .start-btn {
            padding: 15px 40px;
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
            font-size: 1.5rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 3px;
            transition: all 0.2s;
            display: none;
        }
        .start-btn:hover { background: var(--accent); color: var(--bg); box-shadow: 0 0 20px var(--accent); }

        /* MAIN LAYOUT */
        #synth-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            gap: 15px;
            opacity: 0; /* Hidden until loaded */
            transition: opacity 1s;
        }

        /* HEADER & STATUS */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel);
            padding: 15px;
            border-radius: 8px;
            border-bottom: 2px solid var(--accent);
        }
        .brand { font-size: 1.8rem; font-weight: bold; color: var(--text); letter-spacing: 4px; }
        .brand span { color: var(--accent); }
        
        .status-panel {
            display: flex;
            gap: 20px;
            font-size: 0.8rem;
            color: var(--text-dim);
        }
        .status-item { display: flex; align-items: center; gap: 6px; }
        .led { width: 8px; height: 8px; border-radius: 50%; background: var(--led-off); box-shadow: inset 0 0 2px #000; transition: background 0.1s; }
        .led.active { background: var(--accent); box-shadow: 0 0 5px var(--accent); }

        /* PRESETS */
        .preset-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            background: var(--panel);
            padding: 10px;
            border-radius: 8px;
        }
        .preset-btn {
            background: var(--knob-bg);
            border: 1px solid #444;
            color: var(--text-dim);
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            text-align: center;
        }
        .preset-btn:hover { border-color: var(--accent); color: var(--text); }
        .preset-btn.active { background: var(--accent-dim); border-color: var(--accent); color: #fff; }

        /* CONTROLS GRID */
        .controls-area {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 240px;
            gap: 15px;
            flex: 1;
            min-height: 250px;
        }
        
        .module {
            background: var(--panel);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            border: 1px solid #333;
        }
        .module-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: var(--text-dim);
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .knob-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: center;
            flex: 1;
        }

        /* KNOB COMPONENT */
        .knob-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 60px;
        }
        .knob-dial {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--knob-bg);
            position: relative;
            border: 2px solid #444;
            cursor: ns-resize;
        }
        .knob-dial::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 2px; height: 50%;
            background: var(--accent);
            transform-origin: top center;
            transform: translate(-50%, 0) rotate(var(--angle, 0deg));
            pointer-events: none;
        }
        .knob-label { font-size: 0.7rem; margin-top: 8px; color: var(--text-dim); }
        .knob-val { font-size: 0.7rem; color: var(--accent); margin-top: 2px; opacity: 0; transition: opacity 0.2s; }
        .knob-container:hover .knob-val { opacity: 1; }

        /* VISUALIZER & PB */
        .vis-module {
            position: relative;
            display: flex;
            flex-direction: column;
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        /* Canvas for Three.js */
        #c { width: 100%; height: 100%; display: block; }
        
        #pb-container {
            height: 20px;
            background: #222;
            position: relative;
            margin-top: 5px;
            border-radius: 4px;
            overflow: hidden;
        }
        #pb-bar {
            position: absolute;
            top: 0; bottom: 0;
            left: 50%;
            width: 0%;
            background: var(--accent);
            opacity: 0.7;
            transition: width 0.05s, left 0.05s;
        }
        .pb-label { font-size: 0.7rem; color: #666; text-align: center; margin-top: 2px; }

    </style>
</head>
<body>

    <!-- LOADING SCREEN -->
    <div id="loader-overlay">
        <div class="loader-text" id="loader-status">INITIALIZING...</div>
        <button class="start-btn" id="boot-btn">INITIALIZE SYSTEM</button>
    </div>

    <!-- SYNTH UI -->
    <div id="synth-container">
        <div class="header-bar">
            <div class="brand">LUMINA <span>LEAD</span></div>
            <div class="status-panel">
                <div class="status-item"><div class="led" id="led-midi"></div> MIDI</div>
                <div class="status-item"><div class="led" id="led-audio"></div> AUDIO</div>
            </div>
        </div>

        <div class="preset-bar" id="preset-container"></div>

        <div class="controls-area">
            
            <!-- OSC & ENV -->
            <div class="module">
                <div class="module-title">Source & Env</div>
                <div class="knob-group">
                    <div class="knob-container" data-param="oscType" data-type="select">
                        <div class="knob-label">WAVE</div>
                    </div>
                    <div class="knob-container" data-param="portamento" data-min="0" data-max="1">
                        <div class="knob-dial"></div>
                        <div class="knob-label">GLIDE</div>
                        <div class="knob-val"></div>
                    </div>
                    <div class="knob-container" data-param="attack" data-min="0.001" data-max="2">
                        <div class="knob-dial"></div>
                        <div class="knob-label">ATTACK</div>
                        <div class="knob-val"></div>
                    </div>
                    <div class="knob-container" data-param="release" data-min="0.01" data-max="5">
                        <div class="knob-dial"></div>
                        <div class="knob-label">RELEASE</div>
                        <div class="knob-val"></div>
                    </div>
                </div>
            </div>

            <!-- FILTER -->
            <div class="module">
                <div class="module-title">Filter & Mod</div>
                <div class="knob-group">
                    <div class="knob-container" data-param="cutoff" data-min="100" data-max="10000">
                        <div class="knob-dial"></div>
                        <div class="knob-label">CUTOFF</div>
                        <div class="knob-val"></div>
                    </div>
                    <div class="knob-container" data-param="resonance" data-min="0" data-max="10">
                        <div class="knob-dial"></div>
                        <div class="knob-label">RES</div>
                        <div class="knob-val"></div>
                    </div>
                    <div class="knob-container" data-param="vibDepth" data-min="0" data-max="0.5">
                        <div class="knob-dial"></div>
                        <div class="knob-label">VIB DEPTH</div>
                        <div class="knob-val"></div>
                    </div>
                    <div class="knob-container" data-param="vibRate" data-min="1" data-max="20">
                        <div class="knob-dial"></div>
                        <div class="knob-label">VIB RATE</div>
                        <div class="knob-val"></div>
                    </div>
                </div>
            </div>

            <!-- FX -->
            <div class="module">
                <div class="module-title">Effects</div>
                <div class="knob-group">
                    <div class="knob-container" data-param="delayAmt" data-min="0" data-max="1">
                        <div class="knob-dial"></div>
                        <div class="knob-label">DELAY</div>
                        <div class="knob-val"></div>
                    </div>
                    <div class="knob-container" data-param="reverbAmt" data-min="0" data-max="1">
                        <div class="knob-dial"></div>
                        <div class="knob-label">REVERB</div>
                        <div class="knob-val"></div>
                    </div>
                    <div class="knob-container" data-param="width" data-min="0" data-max="1">
                        <div class="knob-dial"></div>
                        <div class="knob-label">WIDTH</div>
                        <div class="knob-val"></div>
                    </div>
                    <div class="knob-container" data-param="drive" data-min="0" data-max="1">
                        <div class="knob-dial"></div>
                        <div class="knob-label">DRIVE</div>
                        <div class="knob-val"></div>
                    </div>
                </div>
            </div>

            <!-- VISUALIZER -->
            <div class="vis-module">
                <canvas id="c"></canvas>
                <div style="padding: 5px; background: #111;">
                    <div id="pb-container">
                        <div id="pb-bar"></div>
                    </div>
                    <div class="pb-label">PITCH BEND</div>
                </div>
            </div>
        </div>

        <div id="keyboard"></div>
    </div>

    <!-- MODULE SCRIPT -->
    <script type="module">
        // --- 1. IMPORT THREE.JS FROM ORDINAL ---
        import * as THREE from 'https://ordinals.com/content/0d013bb60fc5bf5a6c77da7371b07dc162ebc7d7f3af0ff3bd00ae5f0c546445i0';
        import { SynthKeyboard } from '../../shared/keyboard.js';

        // --- GLOBAL STATE ---
        const runtimeState = {
            Tone: null,
            synth: null,
            fx: {
                distortion: null,
                delay: null,
                reverb: null,
                widener: null,
                vibrato: null,
                filter: null
            },
            waveform: null, // Analyser
            currentPresetIdx: 0,
            isMouseDown: false, // For glissando
            keyboard: null
        };

        const PRESETS = [
            {
                name: "Init Lead",
                oscType: "sawtooth",
                attack: 0.01, release: 0.1,
                cutoff: 20000, res: 0,
                delay: 0, reverb: 0, width: 0, drive: 0,
                glide: 0, vibDepth: 0, vibRate: 5
            },
            {
                name: "Saw Lead",
                oscType: "fatsawtooth",
                attack: 0.01, release: 0.4,
                cutoff: 4000, res: 2,
                delay: 0.3, reverb: 0.2, width: 0.5, drive: 0.2,
                glide: 0.05, vibDepth: 0.1, vibRate: 6
            },
            {
                name: "Sync Hook",
                oscType: "pulse",
                attack: 0.001, release: 0.2,
                cutoff: 3000, res: 5,
                delay: 0.2, reverb: 0.1, width: 0.2, drive: 0.8,
                glide: 0, vibDepth: 0.05, vibRate: 8
            },
            {
                name: "Shimmer",
                oscType: "square",
                attack: 0.01, release: 2,
                cutoff: 1200, res: 4,
                delay: 0.5, reverb: 0.6, width: 0.8, drive: 0,
                glide: 0, vibDepth: 0.2, vibRate: 4
            },
            {
                name: "EDM Stack",
                oscType: "fatsawtooth",
                attack: 0.01, release: 0.3,
                cutoff: 8000, res: 0,
                delay: 0.4, reverb: 0.4, width: 1, drive: 0.4,
                glide: 0, vibDepth: 0, vibRate: 0
            }
        ];

        // --- 2. THREE.JS VISUALIZER SETUP ---
        let visMesh;
        const initThreeJS = () => {
            const canvas = document.getElementById('c');
            const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
            
            const scene = new THREE.Scene();
            scene.background = null; 

            const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 100);
            camera.position.z = 2.5;

            const geometry = new THREE.IcosahedronGeometry(1, 2);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00f0ff, 
                wireframe: true 
            });
            visMesh = new THREE.Mesh(geometry, material);
            scene.add(visMesh);

            function resize() {
                const width = canvas.clientWidth;
                const height = canvas.clientHeight;
                if (canvas.width !== width || canvas.height !== height) {
                    renderer.setSize(width, height, false);
                    camera.aspect = width / height;
                    camera.updateProjectionMatrix();
                }
            }

            function render(t) {
                resize();
                
                visMesh.rotation.x = t * 0.0007;
                visMesh.rotation.y = t * 0.0011;

                if (runtimeState.waveform && runtimeState.Tone) {
                    const buffer = runtimeState.waveform.getValue();
                    let sum = 0;
                    for(let i=0; i<buffer.length; i+=10) {
                        sum += Math.abs(buffer[i]);
                    }
                    const avg = sum / (buffer.length / 10);
                    const scale = 1 + (avg * 1.5);
                    visMesh.scale.set(scale, scale, scale);
                }

                renderer.render(scene, camera);
                requestAnimationFrame(render);
            }
            requestAnimationFrame(render);
        };

        // --- 3. TONE.JS LOADER (ORDINAL METHOD) ---
        function loadToneJSAndBoot({ 
            toneUrl = 'https://ordinals.com/content/04813d7748d918bd8a3069cb1823ebc9586f0ce16cd6a97a784581ec38d13062i0',
            setLoaderStatus,
            runtimeState,
            boot
        }) {
            setLoaderStatus('Loading Audio Engine...');
            import(toneUrl)
                .then((module) => {
                    runtimeState.Tone = window.Tone || module.default || module;
                    if (runtimeState.Tone) {
                        boot();
                    } else {
                        throw new Error("Tone object not found");
                    }
                })
                .catch(err => {
                    setLoaderStatus('Failed to load Tone.js. App cannot start.', true);
                });
        }

        // --- 4. APP LOGIC ---
        const statusEl = document.getElementById('loader-status');
        const setLoaderStatus = (msg, isError = false) => {
            statusEl.innerText = msg;
            if(isError) statusEl.style.color = '#ff3333';
        };

        const boot = () => {
            setLoaderStatus('Engine Ready.');
            const btn = document.getElementById('boot-btn');
            btn.style.display = 'block';
            
            btn.onclick = async () => {
                const T = runtimeState.Tone;
                await T.start();
                
                initAudio();
                initUI();
                initMIDI();
                initThreeJS();

                document.getElementById('loader-overlay').style.opacity = 0;
                document.getElementById('synth-container').style.opacity = 1;
                setTimeout(() => document.getElementById('loader-overlay').remove(), 1000);
                document.getElementById('led-audio').classList.add('active');
            };
        };

        function initAudio() {
            const T = runtimeState.Tone;
            const widener = new T.Chorus(4, 2.5, 0.5).toDestination().start();
            const delay = new T.PingPongDelay("8n", 0.2).connect(widener);
            const reverb = new T.Freeverb({ roomSize: 0.7, dampening: 3000 }).connect(delay);
            const limiter = new T.Limiter(-1).connect(reverb);
            const filter = new T.Filter(20000, "lowpass", -12).connect(limiter);
            const distortion = new T.Distortion(0).connect(filter);

            const synth = new T.MonoSynth({
                oscillator: { type: "sawtooth" },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.5, release: 1 },
                filterEnvelope: { attack: 0.01, decay: 0.5, sustain: 1, release: 2, baseFrequency: 20000, octaves: 0 },
                volume: -6
            });
            
            synth.disconnect();
            synth.connect(distortion);

            const vibrato = new T.LFO(5, -50, 50).start();
            vibrato.connect(synth.detune);
            vibrato.amplitude.value = 0;

            const waveform = new T.Waveform(256);
            limiter.connect(waveform);

            runtimeState.synth = synth;
            runtimeState.fx.delay = delay;
            runtimeState.fx.reverb = reverb;
            runtimeState.fx.widener = widener;
            runtimeState.fx.filter = filter;
            runtimeState.fx.distortion = distortion;
            runtimeState.fx.vibrato = vibrato;
            runtimeState.waveform = waveform;

            loadPreset(0);
        }

        function loadPreset(idx) {
            const p = PRESETS[idx];
            const s = runtimeState.synth;
            const fx = runtimeState.fx;
            runtimeState.currentPresetIdx = idx;
            updateKnobVisuals(p);

            s.oscillator.type = p.oscType;
            s.envelope.attack = p.attack;
            s.envelope.release = p.release;
            s.portamento = p.glide;
            
            fx.filter.frequency.value = p.cutoff; 
            fx.filter.Q.value = p.res;
            fx.delay.wet.value = p.delay;
            fx.reverb.wet.value = p.reverb;
            fx.widener.wet.value = p.width;
            fx.distortion.distortion = p.drive;
            fx.vibrato.frequency.value = p.vibRate;
            fx.vibrato.amplitude.value = p.vibDepth;

            document.querySelectorAll('.preset-btn').forEach((b, i) => {
                b.classList.toggle('active', i === idx);
            });
        }

        // --- UI UTILS ---
        function formatValue(param, val) {
            if (typeof val === 'string') return val.toUpperCase();
            if (val === undefined || val === null) return "---";
            if(param === 'cutoff') return Math.round(val) + ' Hz';
            if(param === 'attack' || param === 'release' || param === 'portamento') return val.toFixed(2) + ' s';
            return val.toFixed(2);
        }

        function updateKnobVisuals(p) {
            document.querySelectorAll('.knob-container').forEach(k => {
                const param = k.dataset.param;
                if(!p.hasOwnProperty(param)) return;
                const val = p[param];
                if(k.dataset.type === 'select') {
                     k.querySelector('.knob-label').innerText = formatValue(param, val);
                     return;
                }
                const min = parseFloat(k.dataset.min);
                const max = parseFloat(k.dataset.max);
                if(!isNaN(val)) {
                    const percent = (val - min) / (max - min);
                    const angle = -135 + (percent * 270);
                    k.querySelector('.knob-dial').style.setProperty('--angle', `${angle}deg`);
                }
                k.querySelector('.knob-val').innerText = formatValue(param, val);
            });
        }

        function initUI() {
            // Presets
            const pContainer = document.getElementById('preset-container');
            PRESETS.forEach((p, i) => {
                const btn = document.createElement('div');
                btn.className = 'preset-btn';
                btn.innerText = p.name;
                btn.onclick = () => loadPreset(i);
                pContainer.appendChild(btn);
            });

            // Knobs
            document.querySelectorAll('.knob-container').forEach(k => {
                const dial = k.querySelector('.knob-dial');
                if(!dial) return; 
                const valDisplay = k.querySelector('.knob-val');
                const param = k.dataset.param;
                const min = parseFloat(k.dataset.min);
                const max = parseFloat(k.dataset.max);
                let isDragging = false;
                let startY, startVal;

                dial.onmousedown = (e) => {
                    isDragging = true;
                    startY = e.clientY;
                    startVal = getCurrentParamValue(param);
                    document.body.style.cursor = 'ns-resize';
                };

                window.addEventListener('mousemove', (e) => {
                    if(!isDragging) return;
                    const delta = startY - e.clientY;
                    const range = max - min;
                    const sensitivity = 200; 
                    let newVal = startVal + (delta / sensitivity) * range;
                    newVal = Math.max(min, Math.min(max, newVal));
                    setParam(param, newVal);
                    const percent = (newVal - min) / (max - min);
                    const angle = -135 + (percent * 270);
                    dial.style.setProperty('--angle', `${angle}deg`);
                    valDisplay.innerText = formatValue(param, newVal);
                });

                window.addEventListener('mouseup', () => {
                    isDragging = false;
                    document.body.style.cursor = 'default';
                });
            });

            const waveKnob = document.querySelector('.knob-container[data-param="oscType"]');
            if(waveKnob) {
                waveKnob.onclick = () => {
                    const types = ['sawtooth', 'square', 'triangle', 'sine', 'pulse', 'fatsawtooth'];
                    let current = runtimeState.synth.oscillator.type;
                    let idx = types.indexOf(current);
                    let next = types[(idx + 1) % types.length];
                    runtimeState.synth.oscillator.type = next;
                    waveKnob.querySelector('.knob-label').innerText = next.toUpperCase();
                };
            }

            // --- KEYBOARD GENERATION (Shared Module) ---
            runtimeState.keyboard = new SynthKeyboard('keyboard', {
                startNote: 48, // C3
                numKeys: 25,
                onNoteOn: (midi) => {
                    const freq = runtimeState.Tone.Frequency(midi, "midi");
                    triggerNoteOn(freq, 1);
                },
                onNoteOff: (midi) => {
                    triggerNoteOff();
                }
            });
        }

        function getCurrentParamValue(param) {
            const s = runtimeState.synth;
            const fx = runtimeState.fx;
            switch(param) {
                case 'portamento': return s.portamento;
                case 'attack': return s.envelope.attack;
                case 'release': return s.envelope.release;
                case 'cutoff': return fx.filter.frequency.value;
                case 'resonance': return fx.filter.Q.value;
                case 'vibDepth': return fx.vibrato.amplitude.value;
                case 'vibRate': return fx.vibrato.frequency.value;
                case 'delayAmt': return fx.delay.wet.value;
                case 'reverbAmt': return fx.reverb.wet.value;
                case 'width': return fx.widener.wet.value;
                case 'drive': return fx.distortion.distortion;
            }
            return 0;
        }

        function setParam(param, val) {
            const s = runtimeState.synth;
            const fx = runtimeState.fx;
            switch(param) {
                case 'portamento': s.portamento = val; break;
                case 'attack': s.envelope.attack = val; break;
                case 'release': s.envelope.release = val; break;
                case 'cutoff': fx.filter.frequency.rampTo(val, 0.1); break;
                case 'resonance': fx.filter.Q.value = val; break;
                case 'vibDepth': fx.vibrato.amplitude.rampTo(val, 0.1); break;
                case 'vibRate': fx.vibrato.frequency.rampTo(val, 0.1); break;
                case 'delayAmt': fx.delay.wet.value = val; break;
                case 'reverbAmt': fx.reverb.wet.value = val; break;
                case 'width': fx.widener.wet.value = val; break;
                case 'drive': fx.distortion.distortion = val; break;
            }
        }

        function triggerNoteOn(note, velocity) {
            if(runtimeState.synth) runtimeState.synth.triggerAttack(note, runtimeState.Tone.now(), velocity);
        }

        function triggerNoteOff(note) {
            if(runtimeState.synth) runtimeState.synth.triggerRelease(runtimeState.Tone.now());
        }

        // --- MIDI ---
        function initMIDI() {
            if (navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess().then(onMIDISuccess, () => console.warn('MIDI Fail'));
            }
        }

        function onMIDISuccess(midiAccess) {
            document.getElementById('led-midi').classList.add('active');
            for (let input of midiAccess.inputs.values()) {
                input.onmidimessage = getMIDIMessage;
            }
        }

        function getMIDIMessage(message) {
            const command = message.data[0];
            const note = message.data[1];
            const velocity = (message.data.length > 2) ? message.data[2] : 0;
            const T = runtimeState.Tone;

            if (command >= 144 && command <= 159) {
                if (velocity > 0) {
                    const freq = T.Frequency(note, "midi");
                    triggerNoteOn(freq, velocity / 127);
                    if (runtimeState.keyboard) runtimeState.keyboard.triggerVisual(note, true);
                } else {
                    triggerNoteOff();
                    if (runtimeState.keyboard) runtimeState.keyboard.triggerVisual(note, false);
                }
            }
            if (command >= 128 && command <= 143) {
                triggerNoteOff();
                if (runtimeState.keyboard) runtimeState.keyboard.triggerVisual(note, false);
            }
            if (command >= 224 && command <= 239) {
                const lsb = message.data[1];
                const msb = message.data[2];
                const val = (msb << 7) + lsb; 
                const normalized = (val - 8192) / 8192; 
                
                const bar = document.getElementById('pb-bar');
                if(normalized < 0) {
                    bar.style.left = ((1 + normalized) * 50) + '%';
                    bar.style.width = (Math.abs(normalized) * 50) + '%';
                } else {
                    bar.style.left = '50%';
                    bar.style.width = (normalized * 50) + '%';
                }

                const cents = normalized * 200; 
                if(runtimeState.synth) runtimeState.synth.detune.setValueAtTime(cents, T.now());
            }
        }

        loadToneJSAndBoot({ setLoaderStatus, runtimeState, boot });

    </script>
</body>
</html>