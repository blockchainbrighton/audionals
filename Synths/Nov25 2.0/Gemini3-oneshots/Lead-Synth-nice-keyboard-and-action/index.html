<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZERO-ONE Expressive Lead Synth</title>
    <style>
        :root {
            --bg: #121214;
            --panel: #1e1e24;
            --accent: #00f0ff;
            --accent-dim: #007a82;
            --text: #e0e0e0;
            --knob-bg: #2a2a30;
            --key-w: #fffff0; /* Updated to clean white */
            --key-b: #111;    /* Updated to clean black */
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- Loader --- */
        #loader-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        #start-btn {
            margin-top: 20px;
            padding: 15px 30px;
            background: var(--accent);
            color: #000;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: none;
            box-shadow: 0 0 15px var(--accent-dim);
        }
        #start-btn:hover { background: #fff; }

        /* --- Main UI --- */
        #app {
            display: none;
            width: 95vw;
            max-width: 1000px;
            height: 90vh;
            background: var(--panel);
            border: 2px solid var(--accent-dim);
            box-shadow: 0 0 30px rgba(0,0,0,0.7);
            border-radius: 8px;
            flex-direction: column;
            position: relative;
        }

        /* Top Bar */
        .top-bar {
            height: 60px;
            background: #000;
            border-bottom: 1px solid var(--accent-dim);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }
        h1 { margin: 0; font-size: 1.2rem; color: var(--accent); text-shadow: 0 0 5px var(--accent-dim); }
        
        .midi-status {
            font-size: 0.8rem;
            color: #555;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .midi-active { color: #0f0; text-shadow: 0 0 5px #0f0; }

        /* Synth Grid */
        .controls-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: 1fr 1fr;
            gap: 10px;
            padding: 20px;
            overflow-y: auto;
        }

        .module {
            background: rgba(255,255,255,0.03);
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .module h3 {
            margin: 0 0 10px 0;
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            width: 100%;
            text-align: center;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .knob-row {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Knobs */
        .knob-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 50px;
        }
        .knob {
            width: 40px;
            height: 40px;
            background: var(--knob-bg);
            border-radius: 50%;
            position: relative;
            cursor: ns-resize;
            border: 2px solid #444;
            box-shadow: inset 0 0 5px #000;
        }
        .knob::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 2px; height: 40%;
            background: var(--accent);
            transform-origin: bottom center;
            transform: translate(-50%, -100%) rotate(var(--rotation, -135deg));
            transition: transform 0.05s linear;
        }
        .knob-label {
            font-size: 0.6rem;
            margin-top: 5px;
            text-align: center;
        }

        /* Selectors */
        select {
            background: #000;
            color: var(--accent);
            border: 1px solid var(--accent-dim);
            padding: 5px;
            font-family: inherit;
            width: 100%;
            margin-bottom: 10px;
            cursor: pointer;
        }

        /* Meters */
        .visualizer-container {
            width: 100%;
            height: 40px;
            background: #000;
            margin-top: auto;
            position: relative;
            overflow: hidden;
        }
        #bend-bar {
            position: absolute;
            top: 0; bottom: 0; left: 50%;
            width: 4px;
            background: var(--accent);
            transform: translateX(-50%);
            transition: left 0.1s ease-out;
            opacity: 0.7;
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* --- UPDATED KEYBOARD STYLES (Clean Layout) --- */
        .keyboard {
            position: relative;
            background: #000;
            border-top: 2px solid var(--accent-dim);
            padding: 20px 0;
            display: flex;
            justify-content: center;
            overflow-x: auto;
            /* Height auto to accommodate keys */
        }

        .key {
            position: relative;
            width: 40px;
            height: 180px;
            background: var(--key-w);
            border: 1px solid #ccc;
            border-radius: 0 0 4px 4px;
            margin: 0 1px;
            cursor: pointer;
            z-index: 1;
            /* No flex-grow, fixed width shapes */
        }

        .key.black {
            width: 28px;
            height: 110px;
            background: var(--key-b);
            /* Negative margins to sit On Top of white keys */
            margin-left: -14px;
            margin-right: -14px;
            z-index: 2;
            border: 1px solid #000;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            border-radius: 0 0 2px 2px;
        }

        .key:active, .key.playing {
            background: var(--accent) !important;
            box-shadow: 0 0 20px var(--accent);
        }
        .key.black:active, .key.black.playing {
            background: var(--accent-dim) !important;
        }

        @media(max-width: 800px) {
            .controls-grid { grid-template-columns: repeat(2, 1fr); }
            /* Keyboard scrollable on mobile */
            .keyboard { justify-content: flex-start; }
        }
    </style>
</head>
<body>

    <!-- LOADER -->
    <div id="loader-overlay">
        <h2 style="color: var(--accent);">BOP MATRIX / LEAD SYNTH</h2>
        <div id="loader-status" style="margin-top: 10px; font-size: 0.9rem;">Initializing...</div>
        <button id="start-btn">BOOT SYSTEM</button>
    </div>

    <!-- APP UI -->
    <div id="app">
        <!-- Top Bar -->
        <div class="top-bar">
            <h1>LEAD<span style="color:#fff;">SYNTH</span></h1>
            
            <div style="flex:1; margin: 0 20px; max-width: 200px;">
                <select id="preset-selector">
                    <option value="" disabled selected>Load Preset...</option>
                </select>
            </div>

            <div class="midi-status">
                <span id="midi-led">‚óè</span> MIDI <span id="midi-name">Scanning...</span>
            </div>
            
            <div style="margin-left: 10px;">
                <canvas id="vu-meter" width="50" height="20" style="background:#000; border:1px solid #333;"></canvas>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-grid">
            <!-- OSCILLATORS -->
            <div class="module">
                <h3>Oscillators</h3>
                <div class="knob-row">
                    <div class="knob-container" data-param="oscMix">
                        <div class="knob" id="k-oscMix"></div>
                        <div class="knob-label">Mix 1/2</div>
                    </div>
                    <div class="knob-container" data-param="detune">
                        <div class="knob" id="k-detune"></div>
                        <div class="knob-label">Detune</div>
                    </div>
                    <div class="knob-container" data-param="subLevel">
                        <div class="knob" id="k-subLevel"></div>
                        <div class="knob-label">Sub Vol</div>
                    </div>
                </div>
                <div style="margin-top: 5px; width: 100%;">
                    <select id="osc-type" style="font-size: 0.7rem; margin-bottom: 0;">
                        <option value="sawtooth">Sawtooth</option>
                        <option value="square">Square</option>
                        <option value="triangle">Triangle</option>
                    </select>
                </div>
            </div>

            <!-- FILTER -->
            <div class="module">
                <h3>Filter</h3>
                <div class="knob-row">
                    <div class="knob-container" data-param="cutoff">
                        <div class="knob" id="k-cutoff"></div>
                        <div class="knob-label">Cutoff</div>
                    </div>
                    <div class="knob-container" data-param="resonance">
                        <div class="knob" id="k-resonance"></div>
                        <div class="knob-label">Res</div>
                    </div>
                    <div class="knob-container" data-param="drive">
                        <div class="knob" id="k-drive"></div>
                        <div class="knob-label">Drive</div>
                    </div>
                </div>
            </div>

            <!-- ENVELOPE -->
            <div class="module">
                <h3>Envelope</h3>
                <div class="knob-row">
                    <div class="knob-container" data-param="attack">
                        <div class="knob" id="k-attack"></div>
                        <div class="knob-label">Atk</div>
                    </div>
                    <div class="knob-container" data-param="decay">
                        <div class="knob" id="k-decay"></div>
                        <div class="knob-label">Dec</div>
                    </div>
                    <div class="knob-container" data-param="sustain">
                        <div class="knob" id="k-sustain"></div>
                        <div class="knob-label">Sus</div>
                    </div>
                    <div class="knob-container" data-param="release">
                        <div class="knob" id="k-release"></div>
                        <div class="knob-label">Rel</div>
                    </div>
                </div>
                <div class="knob-row" style="margin-top:5px;">
                     <div class="knob-container" data-param="filterEnv">
                        <div class="knob" id="k-filterEnv"></div>
                        <div class="knob-label">Filt. Env</div>
                    </div>
                </div>
            </div>

            <!-- MODULATION -->
            <div class="module">
                <h3>Mod / LFO</h3>
                <div class="knob-row">
                    <div class="knob-container" data-param="lfoRate">
                        <div class="knob" id="k-lfoRate"></div>
                        <div class="knob-label">Rate</div>
                    </div>
                    <div class="knob-container" data-param="lfoDepth">
                        <div class="knob" id="k-lfoDepth"></div>
                        <div class="knob-label">Depth</div>
                    </div>
                    <div class="knob-container" data-param="glide">
                        <div class="knob" id="k-glide"></div>
                        <div class="knob-label">Glide</div>
                    </div>
                </div>
            </div>

            <!-- EFFECTS -->
            <div class="module" style="grid-column: span 2;">
                <h3>Effects Chain</h3>
                <div class="knob-row">
                    <div class="knob-container" data-param="delayWet">
                        <div class="knob" id="k-delayWet"></div>
                        <div class="knob-label">Delay</div>
                    </div>
                    <div class="knob-container" data-param="delayTime">
                        <div class="knob" id="k-delayTime"></div>
                        <div class="knob-label">Time</div>
                    </div>
                    <div class="knob-container" data-param="reverbWet">
                        <div class="knob" id="k-reverbWet"></div>
                        <div class="knob-label">Reverb</div>
                    </div>
                    <div class="knob-container" data-param="width">
                        <div class="knob" id="k-width"></div>
                        <div class="knob-label">Width</div>
                    </div>
                </div>
            </div>
            
            <!-- MASTER -->
            <div class="module" style="grid-column: span 2;">
                <h3>Performance</h3>
                <div class="visualizer-container">
                    <div id="bend-bar"></div>
                </div>
                <div style="font-size:0.6rem; color:#666; margin-top:5px;">PITCH BEND / MOD WHEEL</div>
            </div>
        </div>

        <!-- Keyboard -->
        <div class="keyboard" id="keyboard"></div>
    </div>

    <!-- LOGIC -->
    <script>
        const runtimeState = {};
        const loaderStatus = document.getElementById('loader-status');
        const startBtn = document.getElementById('start-btn');
        let audioContextStarted = false;

        function setLoaderStatus(msg, isError = false) {
            loaderStatus.textContent = msg;
            if(isError) loaderStatus.style.color = '#ff4444';
        }

        function loadToneJSAndBoot({ toneUrl = 'https://ordinals.com/content/04813d7748d918bd8a3069cb1823ebc9586f0ce16cd6a97a784581ec38d13062i0', setLoaderStatus, runtimeState, boot }) {
            setLoaderStatus('Loading Audio Engine...');
            import(toneUrl)
                .then(() => {
                    runtimeState.Tone = window.Tone;
                    startBtn.style.display = 'block';
                    startBtn.addEventListener('click', () => {
                        startBtn.innerText = "STARTING...";
                        boot();
                    });
                })
                .catch(err => {
                    setLoaderStatus('Failed to load Tone.js. App cannot start.', true);
                });
        }

        class LeadSynth {
            constructor(Tone) {
                this.Tone = Tone;
                this.context = Tone.context;
                this.limiter = new Tone.Limiter(-1);
                this.reverb = new Tone.Reverb({ decay: 4, preDelay: 0.1 }).toDestination();
                this.reverb.wet.value = 0.3;
                this.delay = new Tone.PingPongDelay("8n", 0.2);
                this.delay.wet.value = 0.2;
                this.widener = new Tone.StereoWidener(0.5);
                this.chorus = new Tone.Chorus(4, 2.5, 0.5);
                this.masterFx = [this.chorus, this.widener, this.delay, this.reverb, this.limiter];

                this.synth = new Tone.MonoSynth({
                    volume: -5,
                    oscillator: { type: "sawtooth" },
                    filter: { Q: 2, type: "lowpass", rolloff: -24 },
                    envelope: { attack: 0.005, decay: 0.2, sustain: 0.5, release: 1 },
                    filterEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.5, release: 1, baseFrequency: 200, octaves: 4, exponent: 2 }
                });

                this.subOsc = new Tone.Oscillator().start();
                this.subGain = new Tone.Gain(0);
                this.subOsc.connect(this.subGain);
                this.subGain.chain(...this.masterFx);

                this.vibrato = new Tone.LFO(5, -10, 10).start();
                this.vibratoDepthNode = new Tone.Gain(0);
                this.vibrato.connect(this.vibratoDepthNode);
                this.vibratoDepthNode.connect(this.synth.detune);

                this.synth.chain(...this.masterFx);
                this.params = { glide: 0.1, subVol: 0, pitchBendRange: 2 };
                this.notesHeld = new Set();
            }

            triggerAttack(note, velocity) {
                const freq = this.Tone.Frequency(note).toFrequency();
                this.subOsc.frequency.setValueAtTime(freq / 2, this.context.currentTime);
                if (this.notesHeld.size > 0) {
                    this.synth.triggerAttack(note, this.context.currentTime, velocity); 
                } else {
                    this.synth.triggerAttack(note, this.context.currentTime, velocity);
                    this.subGain.gain.cancelScheduledValues(this.context.currentTime);
                    this.subGain.gain.rampTo(this.params.subVol * velocity, 0.1);
                }
                this.notesHeld.add(note);
            }

            triggerRelease(note) {
                this.notesHeld.delete(note);
                if (this.notesHeld.size === 0) {
                    this.synth.triggerRelease();
                    this.subGain.gain.rampTo(0, 0.2);
                }
            }

            setParam(id, value) {
                switch(id) {
                    case 'cutoff': this.synth.filterEnvelope.baseFrequency = Math.pow(10, value * 3 + 2); break;
                    case 'resonance': this.synth.filter.Q.value = value * 15; break;
                    case 'drive': this.synth.filterEnvelope.octaves = 1 + (value * 6); break;
                    case 'attack': this.synth.envelope.attack = 0.001 + value * 1; break;
                    case 'decay': this.synth.envelope.decay = 0.1 + value * 2; break;
                    case 'sustain': this.synth.envelope.sustain = value; break;
                    case 'release': this.synth.envelope.release = 0.1 + value * 3; break;
                    case 'filterEnv': this.synth.filterEnvelope.amount = value * 10000; break;
                    case 'lfoRate': this.vibrato.frequency.rampTo(value * 20, 0.1); break;
                    case 'lfoDepth': this.vibratoDepthNode.gain.rampTo(value * 50, 0.1); break;
                    case 'glide': this.synth.portamento = value; this.params.glide = value; break;
                    case 'detune': this.synth.detune.value = (value - 0.5) * 100; break;
                    case 'oscMix': this.chorus.depth = value; break;
                    case 'subLevel': this.params.subVol = value * 0.5; if(this.notesHeld.size > 0) this.subGain.gain.rampTo(this.params.subVol, 0.1); break;
                    case 'delayWet': this.delay.wet.value = value; break;
                    case 'delayTime': this.delay.delayTime.value = 0.1 + (value * 0.5); break;
                    case 'reverbWet': this.reverb.wet.value = value; break;
                    case 'width': this.widener.width.value = value; break;
                }
            }

            setOscType(type) { this.synth.oscillator.type = type; }
            setPitchBend(amount) {
                const semitones = this.params.pitchBendRange * amount;
                const cents = semitones * 100;
                this.synth.detune.value = cents;
                this.subOsc.detune.value = cents;
                document.getElementById('bend-bar').style.left = `${50 + (amount * 40)}%`;
            }
            setModWheel(amount) {
                const baseVal = parseFloat(document.getElementById('k-lfoDepth').dataset.val || 0);
                const total = baseVal * 50 + (amount * 50);
                this.vibratoDepthNode.gain.rampTo(total, 0.05);
            }
        }

        const PRESETS = {
            "Init Lead": { type: "sawtooth", k: { cutoff: 0.8, resonance: 0.1, attack: 0.01, decay: 0.5, sustain: 0.8, release: 0.3, lfoDepth: 0.1, delayWet: 0.1, reverbWet: 0.1, drive: 0.2, subLevel: 0.0 } },
            "Saw Lead": { type: "sawtooth", k: { cutoff: 1.0, resonance: 0.2, attack: 0.05, decay: 0.2, sustain: 1.0, release: 0.5, delayWet: 0.3, reverbWet: 0.4, width: 0.7, detune: 0.6, subLevel: 0.2 } },
            "Sync Hook": { type: "square", k: { cutoff: 0.6, resonance: 0.6, filterEnv: 0.7, attack: 0.01, decay: 0.3, sustain: 0.2, release: 0.2, glide: 0.2, drive: 0.5, subLevel: 0.4 } },
            "Shimmer Pluck": { type: "sawtooth", k: { cutoff: 0.4, resonance: 0.3, filterEnv: 0.8, attack: 0.0, decay: 0.2, sustain: 0.0, release: 0.4, delayWet: 0.5, reverbWet: 0.6, width: 1.0 } },
            "Silky Solo": { type: "triangle", k: { cutoff: 0.7, resonance: 0.0, glide: 0.3, attack: 0.1, sustain: 0.9, release: 0.5, lfoRate: 0.6, lfoDepth: 0.3, delayWet: 0.4, subLevel: 0.3 } },
            "Brassy Stack": { type: "sawtooth", k: { cutoff: 0.5, resonance: 0.2, filterEnv: 0.6, attack: 0.1, decay: 0.4, sustain: 0.6, release: 0.4, detune: 0.7, width: 0.8, drive: 0.4 } },
            "EDM Supersaw": { type: "sawtooth", k: { cutoff: 1.0, resonance: 0.1, attack: 0.01, sustain: 1.0, release: 0.6, detune: 0.8, oscMix: 0.9, width: 1.0, reverbWet: 0.5, subLevel: 0.5 } },
            "Soft Glide": { type: "sine", k: { cutoff: 0.3, resonance: 0.0, glide: 0.6, attack: 0.2, sustain: 0.8, release: 0.8, reverbWet: 0.7, delayWet: 0.2 } }
        };

        function boot() {
            const Tone = runtimeState.Tone;
            Tone.start().then(() => {
                Tone.Transport.start();
                const synthEngine = new LeadSynth(Tone);
                runtimeState.synth = synthEngine;
                initUI(synthEngine);
                initMIDI(synthEngine);
                loadPreset("Init Lead");
                startVisualizer(Tone);
                document.getElementById('loader-overlay').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
            });
        }

        const knobs = {};
        function initUI(synth) {
            document.querySelectorAll('.knob-container').forEach(container => {
                const param = container.dataset.param;
                const knobEl = container.querySelector('.knob');
                let val = 0.5;
                knobEl.dataset.val = val; 
                knobs[param] = { el: knobEl, val: val };
                let isDragging = false;
                let startY, startVal;
                knobEl.addEventListener('mousedown', (e) => {
                    isDragging = true; startY = e.clientY; startVal = parseFloat(knobEl.dataset.val);
                    document.body.style.cursor = 'ns-resize';
                });
                window.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    const delta = (startY - e.clientY) * 0.01;
                    let newVal = Math.max(0, Math.min(1, startVal + delta));
                    updateKnob(param, newVal);
                    synth.setParam(param, newVal);
                });
                window.addEventListener('mouseup', () => { isDragging = false; document.body.style.cursor = 'default'; });
            });
            const presetSelect = document.getElementById('preset-selector');
            Object.keys(PRESETS).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name; opt.innerText = name; presetSelect.appendChild(opt);
            });
            presetSelect.addEventListener('change', (e) => loadPreset(e.target.value));
            document.getElementById('osc-type').addEventListener('change', (e) => synth.setOscType(e.target.value));
            createKeyboard(synth);
        }

        function updateKnob(param, value) {
            if(!knobs[param]) return;
            const k = knobs[param];
            k.val = value; k.el.dataset.val = value;
            k.el.style.setProperty('--rotation', `${-135 + (value * 270)}deg`);
        }

        function loadPreset(name) {
            const p = PRESETS[name];
            if(!p) return;
            document.getElementById('osc-type').value = p.type;
            runtimeState.synth.setOscType(p.type);
            for(const [key, val] of Object.entries(p.k)) {
                updateKnob(key, val);
                runtimeState.synth.setParam(key, val);
            }
        }

        function createKeyboard(synth) {
            const kb = document.getElementById('keyboard');
            const startOctave = 3;
            const octaves = 3;
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

            // Updated loop for Linear Generation with CSS negative margin overlap
            for(let i=0; i<octaves * 12 + 1; i++) {
                const noteIndex = i % 12;
                const octave = startOctave + Math.floor(i / 12);
                const noteName = notes[noteIndex];
                const fullName = noteName + octave;
                
                const isBlack = noteName.includes('#');
                const key = document.createElement('div');
                key.className = `key ${isBlack ? 'black' : 'white'}`;
                key.dataset.note = fullName;

                const trigger = (e) => {
                    if(e.buttons !== 1 && e.type !== 'mousedown') return;
                    const rect = key.getBoundingClientRect();
                    const y = (e.clientY - rect.top) / rect.height;
                    const vel = Math.min(1, Math.max(0.2, y + 0.2)); 
                    key.classList.add('playing');
                    synth.triggerAttack(fullName, vel);
                };

                const release = () => {
                    key.classList.remove('playing');
                    synth.triggerRelease(fullName);
                };

                key.addEventListener('mousedown', trigger);
                key.addEventListener('mouseup', release);
                key.addEventListener('mouseleave', release);
                // The magic glissando trigger
                key.addEventListener('mouseenter', (e) => {
                    if(e.buttons === 1) trigger(e);
                });

                kb.appendChild(key);
            }
        }

        function initMIDI(synth) {
            if (!navigator.requestMIDIAccess) { document.getElementById('midi-name').innerText = "Not Supported"; return; }
            navigator.requestMIDIAccess().then(access => {
                const inputs = access.inputs.values();
                for (let input of inputs) { input.onmidimessage = (msg) => handleMIDIMessage(msg, synth); document.getElementById('midi-name').innerText = input.name; document.getElementById('midi-led').classList.add('midi-active'); }
                access.onstatechange = (e) => { if(e.port.state === 'connected') document.getElementById('midi-name').innerText = e.port.name; };
            });
        }

        function handleMIDIMessage(msg, synth) {
            const [status, data1, data2] = msg.data;
            const command = status >> 4;
            if (command === 9 && data2 > 0) {
                const note = runtimeState.Tone.Frequency(data1, "midi").toNote();
                const keyEl = document.querySelector(`.key[data-note="${note}"]`);
                if(keyEl) keyEl.classList.add('playing');
                synth.triggerAttack(note, data2 / 127);
            } 
            else if (command === 8 || (command === 9 && data2 === 0)) {
                const note = runtimeState.Tone.Frequency(data1, "midi").toNote();
                const keyEl = document.querySelector(`.key[data-note="${note}"]`);
                if(keyEl) keyEl.classList.remove('playing');
                synth.triggerRelease(note);
            } 
            else if (command === 11 && data1 === 1) synth.setModWheel(data2 / 127);
            else if (command === 14) {
                const val = (data2 << 7) | data1;
                synth.setPitchBend((val - 8192) / 8192);
            }
        }

        function startVisualizer(Tone) {
            const canvas = document.getElementById('vu-meter');
            const ctx = canvas.getContext('2d');
            const meter = new Tone.Meter();
            runtimeState.synth.synth.connect(meter);
            function draw() {
                requestAnimationFrame(draw);
                const db = meter.getValue();
                let level = Math.max(0, (db + 60) / 60); 
                ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                const w = canvas.width * level;
                const grad = ctx.createLinearGradient(0, 0, canvas.width, 0);
                grad.addColorStop(0, '#007a82'); grad.addColorStop(0.8, '#00f0ff'); grad.addColorStop(1, '#fff');
                ctx.fillStyle = grad; ctx.fillRect(0, 0, w, canvas.height);
            }
            draw();
        }

        loadToneJSAndBoot({ setLoaderStatus, runtimeState, boot });
    </script>
</body>
</html>